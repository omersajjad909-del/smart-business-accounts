[{"filePath":"D:\\projects\\smart-business-accounts\\app\\admin\\permissions\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\api\\accounts\\[id]\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\api\\accounts\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\api\\admin\\roles\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\api\\admin\\user-permissions\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\api\\advance-payment\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\api\\advance\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\api\\ageing\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\api\\attendance\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\api\\backup\\restore\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\api\\backup\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\api\\bank-accounts\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\api\\bank-reconciliation\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\api\\bank-statements\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\api\\budget\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\api\\bulk\\payments\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\api\\companies\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\api\\costumers\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\api\\cpv\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\api\\create-default-user\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\api\\crm\\contacts\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\api\\crm\\interactions\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\api\\crm\\opportunities\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\api\\crv\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\api\\currencies\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\api\\dashboard\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\api\\debug-check\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\api\\delivery-challan\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\api\\email\\send\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\api\\email\\test\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\api\\employees\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\api\\expense-vouchers\\approve\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\api\\expense-vouchers\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\api\\financial-year\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\api\\inventory\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\api\\invoice-taxes\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\api\\items-new\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\api\\jv\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\api\\ledger\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\api\\login\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\api\\logs\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\api\\me\\permissions\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\api\\outward\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\api\\payment-receipts\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\api\\payroll\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\api\\permissions\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\api\\purchase-invoice\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\api\\purchase-order\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\api\\quotation\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\api\\recurring-transactions\\process\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\api\\recurring-transactions\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\api\\reports\\ageing\\customer\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\api\\reports\\ageing\\supplier\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\api\\reports\\annual-statements\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\api\\reports\\balance-sheet\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\api\\reports\\cash-flow\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\api\\reports\\dashboard-charts\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\api\\reports\\dashboard-summary\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\api\\reports\\inventory\\inward\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\api\\reports\\inventory\\stock-summary\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\api\\reports\\ledger\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\api\\reports\\outward\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\api\\reports\\profit-loss\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\api\\reports\\profitability\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\api\\reports\\sales\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\api\\reports\\stock-ledger\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\api\\reports\\stock\\location\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\api\\reports\\stock\\low\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\api\\reports\\stock\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\api\\reports\\tax-summary\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\api\\reports\\trial-balance\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\api\\reports\\year-end\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\api\\sale-return\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\api\\sales-invoice\\[id]\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\api\\sales-invoice\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\api\\search\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\api\\stock-available-for-sale\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\api\\stock-rate\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\api\\stock-report\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\api\\suppliers\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\api\\tax-configuration\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\api\\test-db\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\api\\test-login\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\api\\trial-balance\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\api\\users\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\dashboard\\DashboardContent\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\dashboard\\accounts\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\dashboard\\admin\\permissions\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\dashboard\\admin\\roles\\page.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'userSession?.role'. Either include it or remove the dependency array.","line":48,"column":6,"nodeType":"ArrayExpression","endLine":48,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [userSession?.role]","fix":{"range":[1473,1475],"text":"[userSession?.role]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\nimport { useEffect, useState } from \"react\";\r\nimport { getCurrentUser } from \"@/lib/auth\";\r\n\r\nexport default function UsersPage() {\n  const userSession = getCurrentUser();\n  const isAdmin = userSession?.role === \"ADMIN\";\n\n  const [users, setUsers] = useState<Any[]>([]);\n  const [roles, setRoles] = useState<Any[]>([]); // رولز کے لیے اسٹیٹ\r\n  const [loading, setLoading] = useState(true);\r\n  const [editing, setEditing] = useState(false);\r\n  const [form, setForm] = useState({\r\n    id: null, name: \"\", email: \"\", password: \"\", role: \"ACCOUNTANT\", roleId: \"\", active: true,\r\n  });\r\n\r\n  const fetchData = async () => {\r\n    setLoading(true);\r\n    try {\r\n      // دونوں APIs کو ایک ساتھ کال کرنا\r\n      const [uRes, rRes] = await Promise.all([\r\n        fetch(\"/api/users\", { headers: { \"x-user-role\": \"ADMIN\" } }),\r\n        fetch(\"/api/admin/roles\", { headers: { \"x-user-role\": \"ADMIN\" } })\r\n      ]);\r\n\r\n      const uData = await uRes.json();\r\n      const rData = await rRes.json();\r\n\r\n      // 🔥 اہم چیک: اگر ڈیٹا ایریے نہیں ہے تو خالی ایریے سیٹ کریں\r\n      setUsers(Array.isArray(uData) ? uData : []);\r\n      setRoles(Array.isArray(rData) ? rData : []);\r\n\r\n    } catch (err) {\r\n      console.error(\"Fetch Error:\", err);\r\n      setUsers([]);\r\n      setRoles([]);\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  useEffect(() => {\r\n    if (userSession?.role === \"ADMIN\") {\r\n      fetchData();\r\n    } else {\r\n      setLoading(false);\r\n    }\r\n  }, []);\r\n\r\n  async function save() {\r\n    if (!form.name || !form.email) return alert(\"Fields missing!\");\r\n    const method = editing ? \"PUT\" : \"POST\";\r\n    await fetch(\"/api/users\", {\r\n      method,\r\n      headers: { \"Content-Type\": \"application/json\", \"x-user-role\": \"ADMIN\" },\r\n      body: JSON.stringify(form),\r\n    });\r\n    reset();\r\n    fetchData();\r\n  }\r\n\r\n  const reset = () => {\r\n    setForm({ id: null, name: \"\", email: \"\", password: \"\", role: \"ACCOUNTANT\", roleId: \"\", active: true });\r\n    setEditing(false);\r\n  };\r\n\r\n\n  // Guard - صرف ADMIN رسائی کر سکتے ہیں\n  if (!userSession) return null;\n  if (!isAdmin) {\n    return (\n      <div className=\"p-6\">\n        <div className=\"bg-red-50 border border-red-200 rounded-lg p-6 text-center\">\n          <h2 className=\"text-xl font-bold text-red-600 mb-2\">❌ رسائی مسترد</h2>\n          <p className=\"text-red-700\">صرف ADMIN صارفین رولز کو سنبھال سکتے ہیں</p>\n        </div>\n      </div>\n    );\n  }\n  if (loading) return <div className=\"p-10 text-center\">Loading Data...</div>;\r\n\r\n  return (\r\n    <div className=\"p-8 space-y-6\">\r\n      <h1 className=\"text-2xl font-bold\">User Management</h1>\r\n\r\n      {/* یوزر فارم */}\r\n      <div className=\"bg-white p-6 rounded-lg border shadow-sm\">\r\n        <div className=\"grid grid-cols-1 md:grid-cols-5 gap-4\">\r\n          <input className=\"border p-2 rounded\" placeholder=\"Name\" value={form.name} onChange={e => setForm({...form, name: e.target.value})} />\r\n          <input className=\"border p-2 rounded\" placeholder=\"Email\" value={form.email} onChange={e => setForm({...form, email: e.target.value})} />\r\n          <input className=\"border p-2 rounded\" type=\"password\" placeholder=\"Password\" value={form.password} onChange={e => setForm({...form, password: e.target.value})} />\r\n          \r\n          <select className=\"border p-2 rounded\" value={form.role} onChange={e => setForm({...form, role: e.target.value})}>\r\n            <option value=\"ADMIN\">ADMIN</option>\r\n            <option value=\"ACCOUNTANT\">ACCOUNTANT</option>\r\n          </select>\r\n\r\n          {/* رولز ڈراپ ڈاؤن */}\r\n          <select className=\"border p-2 rounded\" value={form.roleId} onChange={e => setForm({...form, roleId: e.target.value})}>\r\n            <option value=\"\">-- Dynamic Role --</option>\r\n            {/* یہاں چیک لگایا گیا ہے تاکہ کریش نہ ہو */}\r\n            {Array.isArray(roles) && roles.map((r) => (\r\n              <option key={r.id} value={r.id}>{r.name}</option>\r\n            ))}\r\n          </select>\r\n        </div>\r\n        <button onClick={save} className=\"mt-4 bg-black text-white px-6 py-2 rounded\">\r\n          {editing ? \"Update User\" : \"Add User\"}\r\n        </button>\r\n      </div>\r\n\r\n      {/* یوزر ٹیبل */}\r\n      <div className=\"border rounded-lg bg-white overflow-hidden\">\r\n        <table className=\"w-full text-left\">\r\n          <thead className=\"bg-gray-50\">\r\n            <tr>\r\n              <th className=\"p-3\">Name</th>\r\n              <th className=\"p-3\">Email</th>\r\n              <th className=\"p-3\">Role</th>\r\n              <th className=\"p-3\">Actions</th>\r\n            </tr>\r\n          </thead>\r\n          <tbody>\r\n            {Array.isArray(users) && users.map((u) => (\r\n              <tr key={u.id} className=\"border-t\">\r\n                <td className=\"p-3\">{u.name}</td>\r\n                <td className=\"p-3\">{u.email}</td>\r\n                <td className=\"p-3\">{u.roleObject?.name || u.role}</td>\r\n                <td className=\"p-3\">\r\n                  <button onClick={() => { setForm({...u, password: \"\"}); setEditing(true); }} className=\"text-blue-600 mr-2\">Edit</button>\r\n                </td>\r\n              </tr>\r\n            ))}\r\n          </tbody>\r\n        </table>\r\n      </div>\r\n    </div>\r\n  );\r\n}\n\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\dashboard\\advance-payment\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\dashboard\\advance\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\dashboard\\attendance\\page.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchAttendance'. Either include it or remove the dependency array.","line":57,"column":6,"nodeType":"ArrayExpression","endLine":57,"endColumn":33,"suggestions":[{"desc":"Update the dependencies array to be: [selectedEmployeeId, month, fetchAttendance]","fix":{"range":[1429,1456],"text":"[selectedEmployeeId, month, fetchAttendance]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useEffect, useState } from \"react\";\r\nimport { getCurrentUser } from \"@/lib/auth\";\r\n\r\ninterface AttendanceRecord {\r\n  id: string;\r\n  employeeId: string;\r\n  date: string;\r\n  status: string;\r\n  checkIn?: string;\r\n  checkOut?: string;\r\n  remarks?: string;\r\n  employee: { firstName: string; lastName: string };\r\n}\r\n\r\ninterface Employee {\r\n  id: string;\r\n  firstName: string;\r\n  lastName: string;\r\n  department: string;\r\n}\r\n\r\nexport default function AttendancePage() {\r\n  const user = getCurrentUser();\r\n  \r\n  // State\r\n  const [employees, setEmployees] = useState<Employee[]>([]);\r\n  const [records, setRecords] = useState<AttendanceRecord[]>([]);\r\n  const [loading, setLoading] = useState(false);\r\n  \r\n  // Selection\r\n  const [selectedEmployeeId, setSelectedEmployeeId] = useState<string | null>(null);\r\n  const [month, setMonth] = useState(new Date().toISOString().slice(0, 7)); // YYYY-MM\r\n  \r\n  // Form State (for Modal/Inline)\r\n  const [selectedDate, setSelectedDate] = useState<string | null>(null);\r\n  const [formData, setFormData] = useState({\r\n    status: \"PRESENT\",\r\n    checkIn: \"\",\r\n    checkOut: \"\",\r\n    remarks: \"\",\r\n  });\r\n\r\n  /* ================= FETCH DATA ================= */\r\n\r\n  useEffect(() => {\r\n    fetchEmployees();\r\n  }, []);\r\n\r\n  useEffect(() => {\r\n    if (selectedEmployeeId) {\r\n      fetchAttendance(selectedEmployeeId, month);\r\n    } else {\r\n      setRecords([]);\r\n    }\r\n  }, [selectedEmployeeId, month]);\r\n\r\n  async function fetchEmployees() {\r\n    try {\r\n      const res = await fetch(\"/api/employees\");\r\n      const data = await res.json();\r\n      setEmployees(Array.isArray(data) ? data : []);\r\n    } catch {\r\n      setEmployees([]);\r\n    }\r\n  }\r\n\r\n  async function fetchAttendance(empId: string, monthStr: string) {\r\n    if (!user) return;\r\n    setLoading(true);\r\n    try {\r\n      // Fetch specific employee's attendance for the month\r\n      const res = await fetch(`/api/attendance?month=${monthStr}&employeeId=${empId}`, {\r\n        headers: {\r\n          \"x-user-role\": user.role || \"\",\r\n          \"x-user-id\": user.id || \"\",\r\n        },\r\n      });\r\n      const data = await res.json();\r\n      setRecords(Array.isArray(data) ? data : []);\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  }\r\n\r\n  /* ================= HELPERS ================= */\r\n\r\n  // Helper to get local date string YYYY-MM-DD\r\n  function toLocalISOString(date: Date) {\r\n    const year = date.getFullYear();\r\n    const month = String(date.getMonth() + 1).padStart(2, \"0\");\r\n    const day = String(date.getDate()).padStart(2, \"0\");\r\n    return `${year}-${month}-${day}`;\r\n  }\r\n\r\n  function formatPakTime(dateString?: string | Date | null) {\r\n    if (!dateString) return \"--\";\r\n    const d = new Date(dateString);\r\n    if (isNaN(d.getTime())) return \"--\";\r\n    return d.toLocaleTimeString(\"en-PK\", {\r\n      hour: \"numeric\",\r\n      minute: \"2-digit\",\r\n      hour12: true,\r\n      timeZone: \"Asia/Karachi\",\r\n    });\r\n  }\r\n\r\n  // Generate Calendar Days\r\n  const getCalendarDays = () => {\r\n    const [y, m] = month.split(\"-\").map(Number);\r\n    const date = new Date(y, m - 1, 1);\r\n    const days = [];\r\n    \r\n    // Add empty slots for days before the 1st\r\n    const firstDayIndex = date.getDay(); // 0 = Sun\r\n    for (let i = 0; i < firstDayIndex; i++) {\r\n      days.push(null);\r\n    }\r\n    \r\n    // Add actual days\r\n    while (date.getMonth() === m - 1) {\r\n      days.push(new Date(date));\r\n      date.setDate(date.getDate() + 1);\r\n    }\r\n    \r\n    return days;\r\n  };\r\n\r\n  const getRecordForDate = (date: Date) => {\r\n    const dateStr = toLocalISOString(date);\r\n    // Backend returns date as ISO string (UTC), but usually we compare by YYYY-MM-DD\r\n    // If backend stores time as 00:00:00 UTC, then toISOString().slice(0,10) matches.\r\n    // However, we want to match based on the local day we are viewing.\r\n    // The record.date from backend is typically \"2024-01-02T00:00:00.000Z\".\r\n    // If we sent \"2024-01-02\" (local), backend saved \"2024-01-02T00:00:00.000Z\".\r\n    // So checking startWith(\"2024-01-02\") works.\r\n    return records.find(r => r.date.startsWith(dateStr));\r\n  };\r\n\r\n  /* ================= ACTIONS ================= */\r\n\r\n  async function handleSave(e: React.FormEvent) {\r\n    e.preventDefault();\r\n    if (!user || !selectedEmployeeId || !selectedDate) return;\r\n\r\n    setLoading(true);\r\n    try {\r\n      const payload = {\r\n        employeeId: selectedEmployeeId,\r\n        date: selectedDate,\r\n        ...formData\r\n      };\r\n\r\n      // Check if updating existing\r\n      const existing = getRecordForDate(new Date(selectedDate));\r\n      const url = existing \r\n        ? `/api/attendance?id=${existing.id}` \r\n        : \"/api/attendance\";\r\n      \r\n      const method = existing ? \"PUT\" : \"POST\";\r\n\r\n      const res = await fetch(url, {\r\n        method,\r\n        headers: {\r\n          \"Content-Type\": \"application/json\",\r\n          \"x-user-role\": user.role || \"\",\r\n          \"x-user-id\": user.id || \"\",\r\n        },\r\n        body: JSON.stringify(payload),\r\n      });\r\n\r\n      if (!res.ok) {\r\n        const err = await res.json();\r\n        alert(err.error || \"Failed\");\r\n      } else {\r\n        fetchAttendance(selectedEmployeeId, month);\r\n        setSelectedDate(null); // Close form\r\n      }\r\n    } catch (err) {\r\n      console.error(err);\r\n      alert(\"Error saving\");\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  }\r\n\r\n  async function handleDelete(id: string) {\r\n    if (!confirm(\"Delete this record?\")) return;\r\n    if (!user) return;\r\n\r\n    await fetch(`/api/attendance?id=${id}`, {\r\n      method: \"DELETE\",\r\n      headers: {\r\n        \"x-user-role\": user.role || \"\",\r\n        \"x-user-id\": user.id || \"\",\r\n      },\r\n    });\r\n    if (selectedEmployeeId) fetchAttendance(selectedEmployeeId, month);\r\n  }\r\n\r\n  /* ================= RENDER ================= */\r\n\r\n  const calendarDays = getCalendarDays();\r\n  const selectedEmployee = employees.find(e => e.id === selectedEmployeeId);\r\n  const weekDays = [\"Sun\", \"Mon\", \"Tue\", \"Wed\", \"Thu\", \"Fri\", \"Sat\"];\r\n\r\n  // Calculate Sundays that are treated as holidays (either explicitly marked or default)\r\n  const isSunday = (d: Date) => d.getDay() === 0;\r\n  \r\n  // Get all valid dates in the current month view\r\n  const validDatesInMonth = calendarDays.filter((d): d is Date => d !== null);\r\n  \r\n  // Count explicit holidays\r\n  const explicitHolidays = records.filter(r => r.status === \"HOLIDAY\").length;\r\n  \r\n  // Count Sundays that have NO record (default holidays)\r\n  const defaultHolidaySundays = validDatesInMonth.filter(d => {\r\n    if (!isSunday(d)) return false;\r\n    const hasRecord = getRecordForDate(d);\r\n    return !hasRecord;\r\n  }).length;\r\n\r\n  const stats = {\r\n    present: records.filter(r => r.status === \"PRESENT\" || r.status === \"LATE\").length,\r\n    absent: records.filter(r => r.status === \"ABSENT\").length,\r\n    leave: records.filter(r => r.status === \"LEAVE\" || r.status === \"HALF_DAY\").length,\r\n    holiday: explicitHolidays + defaultHolidaySundays,\r\n  };\r\n\r\n  return (\r\n    <div className=\"flex flex-col md:flex-row h-screen bg-gray-50 overflow-hidden\">\r\n      \r\n      {/* SIDEBAR: Employee List */}\r\n      <div className=\"w-full md:w-80 h-60 md:h-full bg-white border-r flex flex-col shadow-lg z-10 shrink-0\">\r\n        <div className=\"p-4 border-b bg-gray-100\">\r\n          <h2 className=\"font-black text-xl mb-1\">Employees</h2>\r\n          <p className=\"text-xs text-gray-500\">Select to view calendar</p>\r\n        </div>\r\n        \r\n        <div className=\"flex-1 overflow-y-auto\">\r\n          {employees.map(emp => (\r\n            <div\r\n              key={emp.id}\r\n              onClick={() => setSelectedEmployeeId(emp.id)}\r\n              className={`p-4 border-b cursor-pointer hover:bg-gray-50 transition-colors ${\r\n                selectedEmployeeId === emp.id ? \"bg-blue-50 border-l-4 border-l-blue-600\" : \"\"\r\n              }`}\r\n            >\r\n              <p className=\"font-bold text-gray-800\">{emp.firstName} {emp.lastName}</p>\r\n              <p className=\"text-xs text-gray-500\">{emp.department}</p>\r\n            </div>\r\n          ))}\r\n          {employees.length === 0 && (\r\n            <div className=\"p-4 text-center text-gray-400 italic\">No employees found</div>\r\n          )}\r\n        </div>\r\n      </div>\r\n\r\n      {/* MAIN CONTENT: Calendar */}\r\n      <div className=\"flex-1 flex flex-col h-full overflow-hidden\">\r\n        \r\n        {/* HEADER */}\r\n        <div className=\"p-6 bg-white border-b flex justify-between items-center shadow-sm\">\r\n          <div>\r\n            <h1 className=\"text-2xl font-black text-gray-900\">\r\n              {selectedEmployee ? `${selectedEmployee.firstName}'s Attendance` : \"Attendance Calendar\"}\r\n            </h1>\r\n            <p className=\"text-sm text-gray-500\">\r\n              {selectedEmployee ? \"Manage daily records\" : \"Select an employee from the list\"}\r\n            </p>\r\n          </div>\r\n          \r\n          <input\r\n            type=\"month\"\r\n            value={month}\r\n            onChange={(e) => setMonth(e.target.value)}\r\n            className=\"border px-4 py-2 rounded-lg font-bold shadow-sm\"\r\n          />\r\n        </div>\r\n\r\n        {/* STATS BOXES */}\r\n        {selectedEmployeeId && (\r\n          <div className=\"grid grid-cols-2 md:grid-cols-5 gap-4 p-6 pb-0\">\r\n            <div className=\"bg-green-100 p-4 rounded-xl border border-green-200\">\r\n              <p className=\"text-green-600 font-bold text-sm uppercase\">Present</p>\r\n              <p className=\"text-3xl font-black text-green-800\">{stats.present}</p>\r\n            </div>\r\n            <div className=\"bg-red-100 p-4 rounded-xl border border-red-200\">\r\n              <p className=\"text-red-600 font-bold text-sm uppercase\">Absent</p>\r\n              <p className=\"text-3xl font-black text-red-800\">{stats.absent}</p>\r\n            </div>\r\n            <div className=\"bg-yellow-100 p-4 rounded-xl border border-yellow-200\">\r\n              <p className=\"text-yellow-600 font-bold text-sm uppercase\">Leaves</p>\r\n              <p className=\"text-3xl font-black text-yellow-800\">{stats.leave}</p>\r\n            </div>\r\n            <div className=\"bg-purple-100 p-4 rounded-xl border border-purple-200\">\r\n              <p className=\"text-purple-600 font-bold text-sm uppercase\">Holidays</p>\r\n              <p className=\"text-3xl font-black text-purple-800\">{stats.holiday}</p>\r\n            </div>\r\n            <div className=\"bg-blue-100 p-4 rounded-xl border border-blue-200\">\r\n              <p className=\"text-blue-600 font-bold text-sm uppercase\">Attendance + Holidays</p>\r\n              <p className=\"text-3xl font-black text-blue-800\">\r\n                {stats.present + stats.absent + stats.leave + stats.holiday}\r\n              </p>\r\n            </div>\r\n          </div>\r\n        )}\r\n\r\n        {/* CALENDAR GRID */}\r\n        {selectedEmployeeId ? (\r\n          <div className=\"flex-1 overflow-auto p-6\">\r\n            \r\n            <div className=\"grid grid-cols-7 gap-px bg-gray-200 border rounded-xl overflow-hidden shadow-sm min-w-[600px]\">\r\n              {/* Weekday Headers */}\r\n              {weekDays.map(day => (\r\n                <div key={day} className=\"bg-gray-100 p-2 text-center font-bold text-gray-500 text-sm\">\r\n                  {day}\r\n                </div>\r\n              ))}\r\n\r\n              {/* Days */}\r\n              {calendarDays.map((date, i) => {\r\n                if (!date) return <div key={i} className=\"bg-white min-h-[100px]\" />;\r\n                \r\n                const record = getRecordForDate(date);\r\n                const dateStr = toLocalISOString(date);\r\n                const isToday = dateStr === toLocalISOString(new Date());\r\n                const isSelected = selectedDate === dateStr;\r\n                const isDefaultHoliday = !record && isSunday(date);\r\n\r\n                return (\r\n                  <div\r\n                    key={i}\r\n                    onClick={() => {\r\n                      setSelectedDate(dateStr);\r\n                      // Pre-fill form if record exists\r\n                      if (record) {\r\n                        setFormData({\r\n                          status: record.status,\r\n                          checkIn: record.checkIn ? new Date(record.checkIn).toTimeString().slice(0, 5) : \"\",\r\n                          checkOut: record.checkOut ? new Date(record.checkOut).toTimeString().slice(0, 5) : \"\",\r\n                          remarks: record.remarks || \"\",\r\n                        });\r\n                      } else {\r\n                         // Reset form for new entry\r\n                         setFormData({\r\n                          status: isSunday(date) ? \"HOLIDAY\" : \"PRESENT\",\r\n                          checkIn: \"\",\r\n                          checkOut: \"\",\r\n                          remarks: \"\",\r\n                        });\r\n                      }\r\n                    }}\r\n                    className={`bg-white min-h-[120px] p-2 hover:bg-gray-50 cursor-pointer transition-colors relative flex flex-col justify-between ${\r\n                      isToday ? \"ring-2 ring-blue-500 inset-0 z-10\" : \"\"\r\n                    } ${isSelected ? \"bg-blue-50\" : \"\"} ${isDefaultHoliday ? \"bg-purple-50/50\" : \"\"}`}\r\n                  >\r\n                    <div className=\"flex justify-between items-start\">\r\n                      <span className={`text-sm font-bold ${isToday ? \"text-blue-600\" : \"text-gray-700\"}`}>\r\n                        {date.getDate()}\r\n                      </span>\r\n                      {record && (\r\n                        <button\r\n                          onClick={(e) => {\r\n                            e.stopPropagation();\r\n                            handleDelete(record.id);\r\n                          }}\r\n                          className=\"text-gray-400 hover:text-red-600 text-xs font-bold px-1\"\r\n                          >\r\n                          ✕\r\n                        </button>\r\n                      )}\r\n                    </div>\r\n\r\n                    {record ? (\r\n                      <div className=\"mt-1 space-y-1\">\r\n                        <span className={`block text-center text-xs font-black py-1 rounded ${\r\n                          record.status === \"PRESENT\" ? \"bg-green-100 text-green-800\" :\r\n                          record.status === \"ABSENT\" ? \"bg-red-100 text-red-800\" :\r\n                          record.status === \"HOLIDAY\" ? \"bg-purple-100 text-purple-800\" :\r\n                          \"bg-yellow-100 text-yellow-800\"\r\n                        }`}>\r\n                          {record.status}\r\n                        </span>\r\n                        {(record.checkIn || record.checkOut) && (\r\n                          <div className=\"text-[10px] text-center text-gray-500 font-mono\">\r\n                            {formatPakTime(record.checkIn)} - {formatPakTime(record.checkOut)}\r\n                          </div>\r\n                        )}\r\n                      </div>\r\n                    ) : isDefaultHoliday ? (\r\n                      <div className=\"mt-1 space-y-1 opacity-60\">\r\n                         <span className=\"block text-center text-xs font-black py-1 rounded bg-purple-50 text-purple-400 border border-purple-100\">\r\n                          HOLIDAY\r\n                        </span>\r\n                      </div>\r\n                    ) : (\r\n                      <div className=\"flex-1 flex items-center justify-center opacity-0 hover:opacity-100\">\r\n                        <span className=\"text-2xl text-gray-200\">+</span>\r\n                      </div>\r\n                    )}\r\n                  </div>\r\n                );\r\n              })}\r\n            </div>\r\n          </div>\r\n        ) : (\r\n          <div className=\"flex-1 flex flex-col items-center justify-center text-gray-400\">\r\n            <div className=\"text-6xl mb-4\">👈</div>\r\n            <p className=\"text-xl font-bold\">Select an employee from the left</p>\r\n            <p>to view and manage their attendance calendar</p>\r\n          </div>\r\n        )}\r\n      </div>\r\n\r\n      {/* EDIT MODAL / SIDEBAR */}\r\n      {selectedDate && selectedEmployeeId && (\r\n        <div className=\"fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4\">\r\n          <div className=\"bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden\">\r\n            <div className=\"p-4 bg-gray-100 border-b flex justify-between items-center\">\r\n              <h3 className=\"font-black text-lg\">\r\n                {new Date(selectedDate).toDateString()}\r\n              </h3>\r\n              <button \r\n                onClick={() => setSelectedDate(null)}\r\n                className=\"text-gray-500 hover:text-black font-bold\"\r\n              >\r\n                ✕\r\n              </button>\r\n            </div>\r\n            \r\n            <form onSubmit={handleSave} className=\"p-6 space-y-4\">\r\n              <div>\r\n                <label className=\"block text-xs font-bold text-gray-500 uppercase mb-1\">Status</label>\r\n                <select\r\n                  className=\"w-full border rounded-lg px-3 py-2 font-bold\"\r\n                  value={formData.status}\r\n                  onChange={(e) => setFormData({ ...formData, status: e.target.value })}\r\n                >\r\n                  <option value=\"PRESENT\">Present</option>\r\n                  <option value=\"ABSENT\">Absent</option>\r\n                  <option value=\"LEAVE\">Leave</option>\r\n                  <option value=\"HALF_DAY\">Half Day</option>\r\n                  <option value=\"LATE\">Late</option>\r\n                  <option value=\"HOLIDAY\">Holiday</option>\r\n                </select>\r\n              </div>\r\n\r\n              <div className=\"flex gap-3\">\r\n                <div className=\"flex-1\">\r\n                  <label className=\"block text-xs font-bold text-gray-500 uppercase mb-1\">Check In</label>\r\n                  <input\r\n                    type=\"time\"\r\n                    className=\"w-full border rounded-lg px-3 py-2\"\r\n                    value={formData.checkIn}\r\n                    onChange={(e) => setFormData({ ...formData, checkIn: e.target.value })}\r\n                  />\r\n                </div>\r\n                <div className=\"flex-1\">\r\n                  <label className=\"block text-xs font-bold text-gray-500 uppercase mb-1\">Check Out</label>\r\n                  <input\r\n                    type=\"time\"\r\n                    className=\"w-full border rounded-lg px-3 py-2\"\r\n                    value={formData.checkOut}\r\n                    onChange={(e) => setFormData({ ...formData, checkOut: e.target.value })}\r\n                  />\r\n                </div>\r\n              </div>\r\n\r\n              <div>\r\n                <label className=\"block text-xs font-bold text-gray-500 uppercase mb-1\">Remarks</label>\r\n                <input\r\n                  type=\"text\"\r\n                  placeholder=\"Optional note...\"\r\n                  className=\"w-full border rounded-lg px-3 py-2\"\r\n                  value={formData.remarks}\r\n                  onChange={(e) => setFormData({ ...formData, remarks: e.target.value })}\r\n                />\r\n              </div>\r\n\r\n              <div className=\"pt-2\">\r\n                <button\r\n                  type=\"submit\"\r\n                  disabled={loading}\r\n                  className=\"w-full bg-black text-white py-3 rounded-xl font-black hover:bg-gray-800 transition-colors disabled:opacity-50\"\r\n                >\r\n                  {loading ? \"Saving...\" : \"Save Record\"}\r\n                </button>\r\n              </div>\r\n            </form>\r\n          </div>\r\n        </div>\r\n      )}\r\n\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\dashboard\\backup-restore\\page.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadBackups'. Either include it or remove the dependency array.","line":66,"column":6,"nodeType":"ArrayExpression","endLine":66,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [loadBackups]","fix":{"range":[1398,1400],"text":"[loadBackups]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { useEffect, useState } from \"react\";\nimport { getCurrentUser } from \"@/lib/auth\";\nimport { PERMISSIONS as _PERMISSIONS } from \"@/lib/permissions\";\ntype AuthUser = {\n  id?: string;\n  role?: string;\n  permissions?: (string | { permission?: string })[];\n  rolePermissions?: (string | { permission?: string })[];\n};\n\n\nfunction userHasPerm(user: AuthUser | null, perm: string): boolean {\n  if (!user) return false;\n\n  const p = perm.toUpperCase();\n\n  if (user.role === \"ADMIN\") return true;\n\n  if (\n    user.permissions?.some(\n      (x) =>\n        (typeof x === \"string\"\n          ? x.toUpperCase()\n          : (x.permission || \"\").toUpperCase()) === p\n    )\n  ) {\n    return true;\n  }\n\n  if (\n    user.rolePermissions?.some(\n      (x) =>\n        (typeof x === \"string\"\n          ? x.toUpperCase()\n          : (x.permission || \"\").toUpperCase()) === p\n    )\n  ) {\n    return true;\n  }\n\n  return false;\n}\n\n\ntype Backup = {\n  id: string;\n  fileName: string;\n  fileSize?: number;\n  backupType: string;\n  status: string;\n  createdAt: string;\n};\n\nexport default function BackupRestorePage() {\n  const [backups, setBackups] = useState<Backup[]>([]);\n  const [loading, setLoading] = useState(false);\n  const [creating, setCreating] = useState(false);\n\n  const user = getCurrentUser();\n  const canAccess = userHasPerm(user, 'BACKUP_RESTORE');\n\n  useEffect(() => {\n    loadBackups();\n  }, []);\n\n  async function loadBackups() {\n    setLoading(true);\n    try {\n      const res = await fetch(\"/api/backup\", {\n        headers: {\n          \"x-user-role\": user?.role || \"\",\n          \"x-user-id\": user?.id || \"\",\n        },\n      });\n      const data = await res.json();\n      if (Array.isArray(data)) {\n        setBackups(data);\n      }\n    } catch (e) {\n      console.error(\"Load error:\", e);\n    } finally {\n      setLoading(false);\n    }\n  }\n\n  async function createBackup() {\n    if (!confirm(\"Create a full backup of all system data?\")) {\n      return;\n    }\n\n    setCreating(true);\n    try {\n      const res = await fetch(\"/api/backup\", {\n        method: \"POST\",\n        headers: {\n          \"Content-Type\": \"application/json\",\n          \"x-user-role\": user?.role || \"\",\n          \"x-user-id\": user?.id || \"\",\n        },\n        body: JSON.stringify({ backupType: \"FULL\" }),\n      });\n\n      if (res.ok) {\n        alert(\"Backup created successfully!\");\n        await loadBackups();\n      } else {\n        const error = await res.json();\n        alert(error.error || \"Backup failed\");\n      }\n    } catch (_e) {\n      alert(\"Backup failed\");\n    } finally {\n      setCreating(false);\n    }\n  }\n\n  async function restoreBackup(backupId: string, fileName: string) {\n    if (!confirm(`Restore from \"${fileName}\"?\\n\\nThis will replace ALL current data!`)) {\n      return;\n    }\n\n    setLoading(true);\n    try {\n      console.log(\"Starting restore from:\", backupId);\n      const res = await fetch(\"/api/backup/restore\", {\n        method: \"POST\",\n        headers: {\n          \"Content-Type\": \"application/json\",\n          \"x-user-role\": user?.role || \"\",\n          \"x-user-id\": user?.id || \"\",\n        },\n        body: JSON.stringify({ backupId }),\n      });\n\n      console.log(\"Restore response status:\", res.status);\n      const result = await res.json();\n      console.log(\"Restore result:\", result);\n\n      if (res.ok) {\n        alert(\"Data restored successfully! Page will refresh...\");\n        // Reload page to show restored data\n        setTimeout(() => {\n          window.location.reload();\n        }, 1000);\n      } else {\n        alert(\"Restore failed: \" + (result.error || \"Unknown error\"));\n      }\n    } catch (e) {\n      console.error(\"Restore error:\", e);\n      alert(\"Restore failed: \" + (e as Error).message);\n    } finally {\n      setLoading(false);\n    }\n  }\n\n  function formatFileSize(bytes?: number): string {\n    if (!bytes) return \"N/A\";\n    if (bytes < 1024) return bytes + \" B\";\n    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(2) + \" KB\";\n    return (bytes / (1024 * 1024)).toFixed(2) + \" MB\";\n  }\n\n  if (!canAccess) {\n    return (\n      <div className=\"p-6\">\n        <div className=\"bg-red-50 border border-red-200 rounded-lg p-6 text-center\">\n          <h2 className=\"text-xl font-bold text-red-600 mb-2\">❌ Access Denied</h2>\n          <p className=\"text-red-700\">You do not have permission to access backup & restore.</p>\n        </div>\n      </div>\n    );\n  }\n  return (\n    <div className=\"p-6 space-y-6\">\n      <div className=\"flex justify-between items-center\">\n        <h1 className=\"text-2xl font-bold\">Data Backup & Restore</h1>\n        <button\n          onClick={createBackup}\n          disabled={creating}\n          className=\"bg-blue-600 text-white px-4 py-2 rounded disabled:opacity-50\"\n        >\n          {creating ? \"Creating Backup...\" : \"+ Create Backup\"}\n        </button>\n      </div>\n\n      <div className=\"bg-yellow-50 border border-yellow-200 p-4 rounded\">\n        <p className=\"text-sm text-yellow-800\">\n          <strong>Note:</strong> Backups are stored locally. For production use,\n          configure cloud storage (AWS S3, Google Cloud Storage, etc.) for\n          automatic backups.\n        </p>\n      </div>\n\n      <div className=\"bg-white border rounded overflow-hidden\">\n        <table className=\"w-full text-sm\">\n          <thead className=\"bg-gray-100\">\n            <tr>\n              <th className=\"p-3 text-left\">File Name</th>\n              <th className=\"p-3 text-left\">Type</th>\n              <th className=\"p-3 text-right\">Size</th>\n              <th className=\"p-3 text-center\">Status</th>\n              <th className=\"p-3 text-left\">Created</th>\n              <th className=\"p-3 text-center\">Action</th>\n            </tr>\n          </thead>\n          <tbody>\n            {loading ? (\n              <tr>\n                <td colSpan={6} className=\"p-4 text-center\">\n                  Loading...\n                </td>\n              </tr>\n            ) : backups.length === 0 ? (\n              <tr>\n                <td colSpan={6} className=\"p-4 text-center text-gray-400\">\n                  No backups found\n                </td>\n              </tr>\n            ) : (\n              backups.map((b) => (\n                <tr key={b.id} className=\"border-t\">\n                  <td className=\"p-3\">{b.fileName}</td>\n                  <td className=\"p-3\">{b.backupType}</td>\n                  <td className=\"p-3 text-right\">{formatFileSize(b.fileSize)}</td>\n                  <td className=\"p-3 text-center\">\n                    <span\n                      className={`px-2 py-1 rounded text-xs ${\n                        b.status === \"COMPLETED\"\n                          ? \"bg-green-100 text-green-800\"\n                          : b.status === \"FAILED\"\n                          ? \"bg-red-100 text-red-800\"\n                          : \"bg-yellow-100 text-yellow-800\"\n                      }`}\n                    >\n                      {b.status}\n                    </span>\n                  </td>\n                  <td className=\"p-3\">\n                    {new Date(b.createdAt).toLocaleString()}\n                  </td>\n                  <td className=\"p-3 text-center\">\n                    {b.status === \"COMPLETED\" && (\n                      <button\n                        onClick={() => restoreBackup(b.id, b.fileName)}\n                        disabled={loading}\n                        className=\"bg-green-600 text-white px-3 py-1 rounded text-sm disabled:opacity-50 hover:bg-green-700\"\n                      >\n                        {loading ? \"Restoring...\" : \"Restore\"}\n                      </button>\n                    )}\n                  </td>\n                </tr>\n              ))\n            )}\n          </tbody>\n        </table>\n      </div>\n    </div>\n  );\n}\n\n\n\n\n","usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\dashboard\\bank-reconciliation\\page.tsx","messages":[],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchStatements'. Either include it or remove the dependency array.","line":75,"column":6,"nodeType":"ArrayExpression","endLine":75,"endColumn":37,"suggestions":[{"desc":"Update the dependencies array to be: [selectedAccount, bankAccounts, fetchStatements]","fix":{"range":[2186,2217],"text":"[selectedAccount, bankAccounts, fetchStatements]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\dashboard\\budget\\page.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadBudgets'. Either include it or remove the dependency array.","line":35,"column":6,"nodeType":"ArrayExpression","endLine":35,"endColumn":12,"suggestions":[{"desc":"Update the dependencies array to be: [loadBudgets, year]","fix":{"range":[875,881],"text":"[loadBudgets, year]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { useEffect, useState } from \"react\";\nimport { getCurrentUser } from \"@/lib/auth\";\nimport { exportToCSV } from \"@/lib/export\";\n\ntype Account = {\n  id: string;\n  name: string;\n  code: string;\n};\n\ntype Budget = {\n  id: string;\n  accountId: string;\n  account: Account;\n  year: number;\n  amount: number;\n  notes?: string | null;\n};\n\nexport default function BudgetPage() {\n  const currentYear = new Date().getFullYear();\n  const [accounts, setAccounts] = useState<Account[]>([]);\n  const [budgets, setBudgets] = useState<Budget[]>([]);\n  const [year, setYear] = useState(currentYear.toString());\n  const [selectedAccount, setSelectedAccount] = useState(\"\");\n  const [amount, setAmount] = useState(\"\");\n  const [notes, setNotes] = useState(\"\");\n  const [loading, setLoading] = useState(false);\n\n  useEffect(() => {\n    loadAccounts();\n    loadBudgets();\n  }, [year]);\n\n  async function loadAccounts() {\n    const user = getCurrentUser();\n    if (!user) return;\n\n    try {\n      const res = await fetch(\"/api/accounts\", {\n        headers: { \"x-user-role\": user.role },\n      });\n      const data = await res.json();\n      setAccounts(Array.isArray(data) ? data : data.accounts || []);\n    } catch (e) {\n      console.error(\"Error loading accounts:\", e);\n    }\n  }\n\n  async function loadBudgets() {\n    setLoading(true);\n    try {\n      const user = getCurrentUser();\n      const res = await fetch(`/api/budget?year=${year}`, {\n        headers: { \"x-user-role\": user?.role || \"ADMIN\" },\n      });\n      const data = await res.json();\n      setBudgets(Array.isArray(data) ? data : []);\n    } catch (e) {\n      console.error(\"Error loading budgets:\", e);\n    } finally {\n      setLoading(false);\n    }\n  }\n\n  async function saveBudget() {\n    if (!selectedAccount || !amount) {\n      alert(\"Account and amount required\");\n      return;\n    }\n\n    setLoading(true);\n    try {\n      const user = getCurrentUser();\n      const res = await fetch(\"/api/budget\", {\n        method: \"POST\",\n        headers: {\n          \"Content-Type\": \"application/json\",\n          \"x-user-role\": user?.role || \"ADMIN\",\n        },\n        body: JSON.stringify({\n          accountId: selectedAccount,\n          year: parseInt(year),\n          amount: parseFloat(amount),\n          description: notes || null,\n        }),\n      });\n\n      const data = await res.json();\n      if (res.ok) {\n        alert(\"Budget saved successfully!\");\n        setSelectedAccount(\"\");\n        setAmount(\"\");\n        setNotes(\"\");\n        loadBudgets();\n      } else {\n        alert(data.error || \"Failed to save budget\");\n      }\n    } catch (e) {\n      console.error(\"Error saving budget:\", e);\n      alert(\"Error saving budget\");\n    } finally {\n      setLoading(false);\n    }\n  }\n\n  async function deleteBudget(id: string) {\n    if (!confirm(\"Are you sure you want to delete this budget?\")) return;\n\n    try {\n      const user = getCurrentUser();\n      const res = await fetch(`/api/budget?id=${id}`, {\n        method: \"DELETE\",\n        headers: { \"x-user-role\": user?.role || \"ADMIN\" },\n      });\n\n      if (res.ok) {\n        alert(\"Budget deleted successfully!\");\n        loadBudgets();\n      } else {\n        const data = await res.json();\n        alert(data.error || \"Failed to delete budget\");\n      }\n    } catch (e) {\n      console.error(\"Error deleting budget:\", e);\n      alert(\"Error deleting budget\");\n    }\n  }\n\n  function exportBudgets() {\n    const exportData = budgets.map((b) => ({\n      account: b.account.name,\n      code: b.account.code,\n      year: b.year,\n      budget: b.amount,\n      notes: b.notes || \"\",\n    }));\n    exportToCSV(exportData, `budget-${year}`);\n  }\n\n  return (\n    <div className=\"p-6 max-w-6xl mx-auto space-y-6\">\n      <h1 className=\"text-2xl font-bold\">Budget Planning</h1>\n\n      {/* FILTERS */}\n      <div className=\"bg-white border rounded-lg p-4 flex gap-4 items-end\">\n        <div>\n          <label className=\"block text-sm font-medium mb-1\">Year</label>\n          <input\n            type=\"number\"\n            value={year}\n            onChange={(e) => setYear(e.target.value)}\n            className=\"border rounded px-3 py-2\"\n            min=\"2020\"\n            max=\"2100\"\n          />\n        </div>\n        {budgets.length > 0 && (\n          <button\n            onClick={exportBudgets}\n            className=\"bg-green-600 text-white px-6 py-2 rounded font-bold\"\n          >\n            📥 Export CSV\n          </button>\n        )}\n      </div>\n\n      {/* ADD BUDGET FORM */}\n      <div className=\"bg-white border rounded-lg p-6 space-y-4\">\n        <h2 className=\"text-xl font-bold\">Add/Update Budget</h2>\n        <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n          <div>\n            <label className=\"block text-sm font-medium mb-1\">Account</label>\n            <select\n              value={selectedAccount}\n              onChange={(e) => setSelectedAccount(e.target.value)}\n              className=\"w-full border rounded px-3 py-2\"\n            >\n              <option value=\"\">Select Account</option>\n              {accounts.map((acc) => (\n                <option key={acc.id} value={acc.id}>\n                  {acc.code} - {acc.name}\n                </option>\n              ))}\n            </select>\n          </div>\n          <div>\n            <label className=\"block text-sm font-medium mb-1\">Amount</label>\n            <input\n              type=\"number\"\n              value={amount}\n              onChange={(e) => setAmount(e.target.value)}\n              placeholder=\"0.00\"\n              className=\"w-full border rounded px-3 py-2\"\n            />\n          </div>\n          <div>\n            <label className=\"block text-sm font-medium mb-1\">Notes</label>\n            <input\n              type=\"text\"\n              value={notes}\n              onChange={(e) => setNotes(e.target.value)}\n              placeholder=\"Optional notes\"\n              className=\"w-full border rounded px-3 py-2\"\n            />\n          </div>\n        </div>\n        <button\n          onClick={saveBudget}\n          disabled={loading || !selectedAccount || !amount}\n          className=\"bg-blue-600 text-white px-6 py-2 rounded font-bold disabled:bg-gray-400\"\n        >\n          {loading ? \"Saving...\" : \"Save Budget\"}\n        </button>\n      </div>\n\n      {/* BUDGETS LIST */}\n      <div className=\"bg-white border rounded-lg p-6\">\n        <h2 className=\"text-xl font-bold mb-4\">Budgets for {year}</h2>\n        {loading ? (\n          <div className=\"text-center py-8\">Loading...</div>\n        ) : budgets.length === 0 ? (\n          <div className=\"text-center py-8 text-gray-500\">\n            No budgets set for {year}\n          </div>\n        ) : (\n          <div className=\"overflow-x-auto\">\n            <table className=\"w-full border\">\n              <thead>\n                <tr className=\"bg-gray-100\">\n                  <th className=\"border p-2 text-left\">Account</th>\n                  <th className=\"border p-2 text-left\">Code</th>\n                  <th className=\"border p-2 text-right\">Budget Amount</th>\n                  <th className=\"border p-2 text-left\">Notes</th>\n                  <th className=\"border p-2 text-center\">Action</th>\n                </tr>\n              </thead>\n              <tbody>\n                {budgets.map((budget) => (\n                  <tr key={budget.id}>\n                    <td className=\"border p-2\">{budget.account.name}</td>\n                    <td className=\"border p-2\">{budget.account.code}</td>\n                    <td className=\"border p-2 text-right font-bold\">\n                      {budget.amount.toLocaleString()}\n                    </td>\n                    <td className=\"border p-2\">{budget.notes || \"-\"}</td>\n                    <td className=\"border p-2 text-center\">\n                      <button\n                        onClick={() => deleteBudget(budget.id)}\n                        className=\"text-red-600 hover:text-red-800\"\n                      >\n                        Delete\n                      </button>\n                    </td>\n                  </tr>\n                ))}\n              </tbody>\n              <tfoot>\n                <tr className=\"bg-gray-50 font-bold\">\n                  <td colSpan={2} className=\"border p-2 text-right\">\n                    Total:\n                  </td>\n                  <td className=\"border p-2 text-right\">\n                    {budgets.reduce((sum, b) => sum + b.amount, 0).toLocaleString()}\n                  </td>\n                  <td colSpan={2} className=\"border p-2\"></td>\n                </tr>\n              </tfoot>\n            </table>\n          </div>\n        )}\n      </div>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\dashboard\\contra\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\dashboard\\cpv\\page.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'loadAccounts', 'loadVouchers', and 'user'. Either include them or remove the dependency array.","line":57,"column":6,"nodeType":"ArrayExpression","endLine":57,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [loadAccounts, loadVouchers, user]","fix":{"range":[1587,1589],"text":"[loadAccounts, loadVouchers, user]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { useEffect, useState } from \"react\";\nimport { getCurrentUser } from \"@/lib/auth\";\nimport { toast } from \"react-hot-toast\";\n\ntype Account = {\n  id: string;\n  name: string;\n  phone?: string | null;\n  partyType?: string | null;\n};\n\ntype Voucher = {\n  id: string;\n  voucherNo: string;\n  date: string;\n  narration: string;\n  accountName: string;\n  accountId: string;\n  amount: number;\n  paymentMode: string;\n  paymentAccountId: string;\n};\n\nexport default function CPVPage() {\n  const today = new Date().toISOString().split(\"T\")[0];\n\n  const [accounts, setAccounts] = useState<Account[]>([]);\n  const [bankAccounts, setBankAccounts] = useState<Any[]>([]);\n  const [vouchers, setVouchers] = useState<Voucher[]>([]);\n  const [showList, setShowList] = useState(false);\n  const [showForm, setShowForm] = useState(true);\n  const [editing, setEditing] = useState<Voucher | null>(null);\n\n  const [accountId, setAccountId] = useState(\"\");\n  const [bankAccountId, setBankAccountId] = useState(\"\");\n  const [amount, setAmount] = useState(\"\");\n  const [date, setDate] = useState(today);\n  const [narration, setNarration] = useState(\"\");\n  const [voucher, setVoucher] = useState<Any>(null);\n  const [saving, setSaving] = useState(false);\n  const [selectedName, setSelectedName] = useState(\"\");\n  const [selectedPhone, setSelectedPhone] = useState(\"\");\n\n  const user = getCurrentUser();\n\n  /* ================= LOAD DATA ================= */\n  useEffect(() => {\n    if (!user) {\n      toast.error(\"Session expired\");\n      return;\n    }\n\n    loadVouchers();\n    loadAccounts();\n  }, []);\n\n  async function loadVouchers() {\n    try {\n      const res = await fetch(\"/api/cpv\", {\n        headers: { \"x-user-role\": user?.role || \"\" },\n      });\n      const data = await res.json();\n      if (Array.isArray(data)) {\n        setVouchers(data);\n      }\n    } catch (e) {\n      console.error(\"Load vouchers error:\", e);\n    }\n  }\n\n  async function loadAccounts() {\n    Promise.all([\n      fetch(\"/api/accounts\", {\n        method: \"GET\",\n        headers: { \"x-user-role\": user?.role || \"\" },\n      }),\n      fetch(\"/api/bank-accounts\", { method: \"GET\" }),\n    ])\n      .then(async ([accountsRes, banksRes]) => {\n        const accountsData = await accountsRes.json();\n        const banksData = await banksRes.json();\n\n        if (Array.isArray(accountsData)) {\n          // CPV میں SUPPLIER + BANKS + دوسرے non-customer accounts\n          setAccounts(\n            accountsData.filter(a =>\n              !a.partyType || (a.partyType !== \"CUSTOMER\")\n            )\n          );\n        }\n\n        const allBanks: Any[] = [];\n        // Removed manual addition of banks from accountsData as banksData already includes them\n        \n        if (Array.isArray(banksData)) {\n          banksData.forEach((bank: Any) => {\n            allBanks.push({\n              id: bank.id,\n              accountId: bank.accountId,\n              name: bank.accountName || `${bank.bankName} - ${bank.accountNo}`,\n              bankName: bank.bankName,\n              accountNo: bank.accountNo,\n            });\n          });\n        }\n        setBankAccounts(allBanks);\n      })\n      .catch(err => {\n        console.error(\"Accounts load error:\", err);\n      });\n  }\n\n  /* ================= SAVE/UPDATE CPV ================= */\n  async function saveCPV() {\n    if (!accountId) {\n      toast.error(\"Account select karein\");\n      return;\n    }\n\n    const amountNum = Number(amount);\n    if (!amount || amount.trim() === \"\" || isNaN(amountNum) || amountNum <= 0) {\n      toast.error(\"Valid amount enter karein (0 se zyada)\");\n      return;\n    }\n\n    setSaving(true);\n\n    try {\n      const url = editing ? \"/api/cpv\" : \"/api/cpv\";\n      const method = editing ? \"PUT\" : \"POST\";\n\n      const res = await fetch(url, {\n        method,\n        headers: {\n          \"Content-Type\": \"application/json\",\n          \"x-user-role\": user?.role || \"\",\n        },\n        body: JSON.stringify(editing ? {\n          id: editing.id,\n          accountId,\n          bankAccountId: bankAccountId || null,\n          paymentMode: bankAccountId ? \"BANK\" : \"CASH\",\n          amount,\n          date,\n          narration,\n        } : {\n          accountId,\n          bankAccountId: bankAccountId || null,\n          paymentMode: bankAccountId ? \"BANK\" : \"CASH\",\n          amount,\n          date,\n          narration,\n        }),\n      });\n\n      const data = await res.json();\n\n      if (!res.ok) {\n        alert(`Error: ${data?.error || \"Save failed\"}`);\n        return;\n      }\n\n      setVoucher(data);\n      alert(editing ? \"CPV updated successfully!\" : \"CPV saved successfully!\");\n      await loadVouchers();\n      resetForm();\n      setShowForm(false);\n      setEditing(null);\n    } catch (e: Any) {\n      alert(`Error: ${e.message || \"Failed to save\"}`);\n    } finally {\n      setSaving(false);\n    }\n  }\n\n  function resetForm() {\n    setAccountId(\"\");\n    setBankAccountId(\"\");\n    setAmount(\"\");\n    setNarration(\"\");\n    setSelectedName(\"\");\n    setSelectedPhone(\"\");\n  }\n\n  function startEdit(v: Voucher) {\n    setEditing(v);\n    setAccountId(v.accountId);\n    setBankAccountId(v.paymentAccountId || \"\");\n    setAmount(v.amount.toString());\n    setDate(v.date);\n    setNarration(v.narration);\n    setShowForm(true);\n    setShowList(false);\n  }\n\n  async function deleteVoucher(id: string) {\n    if (!confirm(\"Are you sure you want to delete this CPV?\")) {\n      return;\n    }\n\n    try {\n      const res = await fetch(`/api/cpv?id=${id}`, {\n        method: \"DELETE\",\n        headers: { \"x-user-role\": user?.role || \"\" },\n      });\n\n      if (res.ok) {\n        alert(\"CPV deleted successfully!\");\n        await loadVouchers();\n      } else {\n        const data = await res.json();\n        alert(data.error || \"Delete failed\");\n      }\n    } catch (_e) {\n      alert(\"Delete failed\");\n    }\n  }\n\n  function printVoucher() {\n    window.print();\n  }\n\n  function sendWhatsApp() {\n    const phoneNo = voucher?.phone || selectedPhone;\n    if (!phoneNo) {\n      toast.error(\"Party ka phone number nahi mila\");\n      return;\n    }\n\n    const phone = String(phoneNo).replace(/\\D/g, \"\");\n    const finalPhone = phone.startsWith('0') ? '92' + phone.substring(1) : phone;\n\n    if (finalPhone.length < 10) {\n      toast.error(\"Phone number theek nahi hai\");\n      return;\n    }\n\n    const msg =\n      `*US TRADERS - PAYMENT ADVICE*\\n` +\n      `--------------------------\\n` +\n      `*Voucher No:* ${voucher.voucherNo}\\n` +\n      `*Paid To:* ${selectedName || voucher.accountName}\\n` +\n      `*Amount:* Rs. ${Number(voucher.amount || amount || 0).toLocaleString()}/-\\n` +\n      `*Date:* ${voucher.date?.split('T')[0] || date}\\n` +\n      `*Narration:* ${narration || \"N/A\"}\\n` +\n      `--------------------------\\n` +\n      `_This is a computer generated confirmation._`;\n\n    window.open(\n      `https://wa.me/${finalPhone}?text=${encodeURIComponent(msg)}`,\n      \"_blank\"\n    );\n  }\n\n  /* ================= UI ================= */\n  return (\n    <div className=\"p-6 space-y-6\">\n      <div className=\"flex justify-between items-center\">\n        <h1 className=\"text-2xl font-bold\">Cash Payment Voucher (CPV)</h1>\n        <div className=\"flex gap-2\">\n          <button\n            onClick={() => {\n              setShowList(!showList);\n              setShowForm(!showForm);\n              setEditing(null);\n            }}\n            className=\"bg-gray-600 text-white px-4 py-2 rounded\"\n          >\n            {showList ? \"Hide List\" : \"Show List\"}\n          </button>\n          <button\n            onClick={() => {\n              setShowForm(true);\n              setShowList(false);\n              setEditing(null);\n              resetForm();\n            }}\n            className=\"bg-blue-600 text-white px-4 py-2 rounded\"\n          >\n            + New CPV\n          </button>\n        </div>\n      </div>\n\n      {/* VOUCHER LIST */}\n      {showList && (\n        <div className=\"bg-white border rounded overflow-x-auto\">\n          <table className=\"w-full text-sm min-w-[800px]\">\n            <thead className=\"bg-gray-100\">\n              <tr>\n                <th className=\"p-3 text-left\">Voucher No</th>\n                <th className=\"p-3 text-left\">Date</th>\n                <th className=\"p-3 text-left\">Paid To</th>\n                <th className=\"p-3 text-right\">Amount</th>\n                <th className=\"p-3 text-left\">Payment Mode</th>\n                <th className=\"p-3 text-left\">Narration</th>\n                <th className=\"p-3 text-center\">Actions</th>\n              </tr>\n            </thead>\n            <tbody>\n              {vouchers.length === 0 ? (\n                <tr>\n                  <td colSpan={7} className=\"p-4 text-center text-gray-400\">\n                    No CPVs found\n                  </td>\n                </tr>\n              ) : (\n                vouchers.map((v) => (\n                  <tr key={v.id} className=\"border-t hover:bg-gray-50\">\n                    <td className=\"p-3 font-bold\">{v.voucherNo}</td>\n                    <td className=\"p-3\">{v.date}</td>\n                    <td className=\"p-3\">{v.accountName}</td>\n                    <td className=\"p-3 text-right\">{v.amount.toLocaleString()}</td>\n                    <td className=\"p-3\">{v.paymentMode}</td>\n                    <td className=\"p-3\">{v.narration}</td>\n                    <td className=\"p-3 text-center space-x-2\">\n                      <button\n                        onClick={() => startEdit(v)}\n                        className=\"text-blue-600 hover:text-blue-800 font-medium text-sm\"\n                      >\n                        Edit\n                      </button>\n                      <button\n                        onClick={() => deleteVoucher(v.id)}\n                        className=\"text-red-600 hover:text-red-800 font-medium text-sm\"\n                      >\n                        Delete\n                      </button>\n                    </td>\n                  </tr>\n                ))\n              )}\n            </tbody>\n          </table>\n        </div>\n      )}\n\n      {/* FORM */}\n      {showForm && (\n        <div className=\"border p-4 space-y-3 bg-white print:hidden\">\n          <h2 className=\"text-xl font-bold\">\n            {editing ? \"Edit CPV\" : \"New CPV\"}\n          </h2>\n\n          <select\n            className=\"border px-3 py-2 w-full\"\n            value={accountId}\n            onChange={(e) => {\n              const id = e.target.value;\n              setAccountId(id);\n              const acc = accounts.find(a => a.id === id);\n              setSelectedName(acc?.name || \"\");\n              setSelectedPhone(acc?.phone || \"\");\n            }}\n          >\n            <option value=\"\">Paid To (Supplier / Bank / Expense)</option>\n            {accounts.map(a => (\n              <option key={a.id} value={a.id}>\n                {a.name} {a.phone ? `(${a.phone})` : \"\"}\n              </option>\n            ))}\n          </select>\n\n          <div>\n            <label className=\"block text-sm font-semibold mb-1\">Payment Method</label>\n            <select\n              className=\"border px-3 py-2 w-full\"\n              value={bankAccountId}\n              onChange={(e) => setBankAccountId(e.target.value)}\n            >\n              <option value=\"\">Cash</option>\n              {bankAccounts.map(bank => (\n                <option key={bank.id} value={bank.id}>\n                  {bank.name}\n                </option>\n              ))}\n            </select>\n          </div>\n\n          <input\n            className=\"border px-3 py-2 w-full\"\n            placeholder=\"Amount\"\n            type=\"number\"\n            step=\"0.01\"\n            value={amount}\n            onChange={(e) => setAmount(e.target.value)}\n          />\n\n          <input\n            type=\"date\"\n            className=\"border px-3 py-2 w-full\"\n            value={date}\n            onChange={(e) => setDate(e.target.value)}\n          />\n\n          <textarea\n            className=\"border px-3 py-2 w-full\"\n            placeholder=\"Narration\"\n            value={narration}\n            onChange={(e) => setNarration(e.target.value)}\n          />\n\n          <div className=\"flex gap-2\">\n            <button\n              onClick={saveCPV}\n              disabled={saving}\n              className=\"bg-black text-white px-4 py-2 flex-1\"\n            >\n              {saving ? \"Saving...\" : editing ? \"Update CPV\" : \"Save CPV\"}\n            </button>\n            <button\n              onClick={() => {\n                setShowForm(false);\n                setEditing(null);\n                resetForm();\n              }}\n              className=\"bg-gray-600 text-white px-4 py-2\"\n            >\n              Cancel\n            </button>\n          </div>\n        </div>\n      )}\n\n      {/* PRINT PREVIEW */}\n      {voucher && (\n        <div className=\"overflow-x-auto\">\n          <div className=\"invoice-print max-w-[210mm] mx-auto bg-white p-8 border-2 border-black text-black shadow-lg min-w-[700px]\">\n            <div className=\"flex justify-between items-start border-b-4 border-black pb-4 mb-8\">\n            <div>\n              <h1 className=\"text-4xl font-black italic tracking-tighter uppercase\">US TRADERS</h1>\n              <p className=\"text-[10px] font-bold tracking-[3px] text-gray-600 uppercase\">Industrial Goods & Services</p>\n            </div>\n            <div className=\"text-right\">\n              <h2 className=\"text-2xl font-black uppercase underline decoration-2 underline-offset-4\">\n                Payment Voucher\n              </h2>\n              <div className=\"mt-2 text-sm font-bold space-y-1\">\n                <p>No: <span className=\"font-mono\">{voucher.voucherNo}</span></p>\n                <p>Date: {voucher.date?.split('T')[0] || date}</p>\n              </div>\n            </div>\n          </div>\n\n          <div className=\"space-y-8 my-10\">\n            <div className=\"flex items-end gap-4 border-b border-gray-300 pb-2\">\n              <span className=\"text-xs font-black uppercase w-32 shrink-0\">Paid To:</span>\n              <span className=\"text-xl font-bold uppercase flex-1 border-b-2 border-black px-2\">\n                {selectedName || voucher.accountName}\n              </span>\n            </div>\n\n            <div className=\"flex items-end gap-4 border-b border-gray-300 pb-2\">\n              <span className=\"text-xs font-black uppercase w-32 shrink-0\">Amount (PKR):</span>\n              <span className=\"text-xl font-bold italic flex-1 border-b-2 border-black px-2\">\n                Rs. {Number(voucher.amount || amount || 0).toLocaleString()}/-\n              </span>\n            </div>\n\n            <div className=\"flex items-start gap-4 border-b border-gray-300 pb-2\">\n              <span className=\"text-xs font-black uppercase w-32 shrink-0\">Description:</span>\n              <span className=\"text-sm font-medium flex-1 border-b border-black px-2 italic\">\n                {narration || \"Official transaction recorded.\"}\n              </span>\n            </div>\n          </div>\n\n          <div className=\"mt-16 flex justify-between items-end px-2\">\n            <div className=\"bg-gray-100 border-4 border-black p-4 flex flex-col min-w-[200px]\">\n              <span className=\"text-[10px] font-black uppercase border-b border-black mb-1\">Net Amount Paid</span>\n              <span className=\"text-3xl font-black italic\">\n                {Number(voucher.amount || amount || 0).toLocaleString()}\n              </span>\n            </div>\n            <div className=\"flex gap-12\">\n              <div className=\"text-center w-32 border-t-2 border-black mt-12 pt-1 font-bold text-[10px] uppercase\">Receiver Sign</div>\n              <div className=\"text-center w-32 border-t-2 border-black mt-12 pt-1 font-bold text-[10px] uppercase\">Accountant</div>\n            </div>\n          </div>\n\n          <div className=\"mt-12 text-[9px] text-gray-400 text-center border-t pt-2 italic\">\n            This is a computer generated voucher for US TRADERS. No signature required if stamped.\n          </div>\n\n          <div className=\"flex gap-3 mt-10 print:hidden justify-center\">\n            <button onClick={printVoucher} className=\"bg-black text-white px-8 py-2 font-bold hover:bg-gray-800 transition-all shadow-md\">\n              Print Now\n            </button>\n            <button onClick={sendWhatsApp} className=\"bg-green-600 text-white px-8 py-2 font-bold hover:bg-green-700 transition-all shadow-md\">\n              WhatsApp\n            </button>\n            <button onClick={() => { setVoucher(null); resetForm(); }} className=\"bg-white text-black border-2 border-black px-8 py-2 font-bold hover:bg-gray-100\">\n              New Entry\n            </button>\n          </div>\n        </div>\n        </div>\n      )}\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\dashboard\\credit-note\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\dashboard\\crm\\contacts\\page.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchContacts'. Either include it or remove the dependency array.","line":32,"column":6,"nodeType":"ArrayExpression","endLine":32,"endColumn":18,"suggestions":[{"desc":"Update the dependencies array to be: [fetchContacts, filterType]","fix":{"range":[726,738],"text":"[fetchContacts, filterType]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState, useEffect } from \"react\";\r\n\r\ninterface Contact {\r\n  id: string;\r\n  name: string;\r\n  email?: string;\r\n  phone: string;\r\n  company: string;\r\n  position?: string;\r\n  type: string;\r\n  isActive: boolean;\r\n}\r\n\r\nexport default function CrmContactsPage() {\r\n  const [contacts, setContacts] = useState<Contact[]>([]);\r\n  const [loading, setLoading] = useState(false);\r\n  const [editing, setEditing] = useState<string | null>(null);\r\n  const [filterType, setFilterType] = useState(\"ALL\");\r\n  const [formData, setFormData] = useState({\r\n    name: \"\",\r\n    email: \"\",\r\n    phone: \"\",\r\n    company: \"\",\r\n    position: \"\",\r\n    type: \"CUSTOMER\",\r\n  });\r\n\r\n  useEffect(() => {\r\n    fetchContacts();\r\n  }, [filterType]);\r\n\r\n  const fetchContacts = async () => {\r\n    setLoading(true);\r\n    try {\r\n      const url =\r\n        filterType === \"ALL\"\r\n          ? \"/api/crm/contacts\"\r\n          : `/api/crm/contacts?type=${filterType}`;\r\n      const response = await fetch(url);\r\n      if (!response.ok) {\r\n        throw new Error(\"Failed to fetch contacts\");\r\n      }\r\n      const data = await response.json();\r\n      setContacts(Array.isArray(data) ? data : []);\r\n    } catch (error) {\r\n      console.error(\"Error fetching contacts:\", error);\r\n      setContacts([]);\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  const handleSubmit = async (e: React.FormEvent) => {\r\n    e.preventDefault();\r\n    setLoading(true);\r\n\r\n    try {\r\n      const url = editing\r\n        ? `/api/crm/contacts?id=${editing}`\r\n        : \"/api/crm/contacts\";\r\n      const method = editing ? \"PUT\" : \"POST\";\r\n\r\n      const response = await fetch(url, {\r\n        method,\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n        body: JSON.stringify(formData),\r\n      });\r\n\r\n      if (response.ok) {\r\n        fetchContacts();\r\n        resetForm();\r\n      } else {\r\n        const error = await response.json();\r\n        alert(error.error);\r\n      }\r\n    } catch (error) {\r\n      console.error(\"Error saving contact:\", error);\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  const handleDelete = async (id: string) => {\r\n    if (!confirm(\"Are you sure you want to delete this contact?\")) return;\r\n\r\n    try {\r\n      await fetch(`/api/crm/contacts?id=${id}`, { method: \"DELETE\" });\r\n      fetchContacts();\r\n    } catch (error) {\r\n      console.error(\"Error deleting contact:\", error);\r\n    }\r\n  };\r\n\r\n  const handleEdit = (contact: Contact) => {\r\n    setEditing(contact.id);\r\n    setFormData({\r\n      name: contact.name,\r\n      email: contact.email || \"\",\r\n      phone: contact.phone,\r\n      company: contact.company,\r\n      position: contact.position || \"\",\r\n      type: contact.type,\r\n    });\r\n  };\r\n\r\n  const resetForm = () => {\r\n    setFormData({\r\n      name: \"\",\r\n      email: \"\",\r\n      phone: \"\",\r\n      company: \"\",\r\n      position: \"\",\r\n      type: \"CUSTOMER\",\r\n    });\r\n    setEditing(null);\r\n  };\r\n\r\n  const getTypeColor = (type: string) => {\r\n    switch (type) {\r\n      case \"CUSTOMER\":\r\n        return \"bg-blue-100 text-blue-800\";\r\n      case \"SUPPLIER\":\r\n        return \"bg-green-100 text-green-800\";\r\n      case \"LEAD\":\r\n        return \"bg-yellow-100 text-yellow-800\";\r\n      case \"PARTNER\":\r\n        return \"bg-purple-100 text-purple-800\";\r\n      default:\r\n        return \"bg-gray-100 text-gray-800\";\r\n    }\r\n  };\r\n\r\n  return (\r\n    <div className=\"p-6 bg-gray-50 min-h-screen\">\r\n      <div className=\"max-w-6xl mx-auto\">\r\n        <h1 className=\"text-3xl font-bold text-gray-900 mb-6\">\r\n          📇 CRM Contacts Management\r\n        </h1>\r\n\r\n        {/* Form */}\r\n        <div className=\"bg-white p-6 rounded-lg shadow mb-6\">\r\n          <form onSubmit={handleSubmit} className=\"space-y-4\">\r\n            <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\r\n              <input\r\n                type=\"text\"\r\n                placeholder=\"Name\"\r\n                value={formData.name}\r\n                onChange={(e) =>\r\n                  setFormData({ ...formData, name: e.target.value })\r\n                }\r\n                required\r\n                className=\"px-3 py-2 border rounded\"\r\n              />\r\n              <input\r\n                type=\"email\"\r\n                placeholder=\"Email\"\r\n                value={formData.email}\r\n                onChange={(e) =>\r\n                  setFormData({ ...formData, email: e.target.value })\r\n                }\r\n                className=\"px-3 py-2 border rounded\"\r\n              />\r\n              <input\r\n                type=\"tel\"\r\n                placeholder=\"Phone\"\r\n                value={formData.phone}\r\n                onChange={(e) =>\r\n                  setFormData({ ...formData, phone: e.target.value })\r\n                }\r\n                required\r\n                className=\"px-3 py-2 border rounded\"\r\n              />\r\n              <input\r\n                type=\"text\"\r\n                placeholder=\"Compaany\"\r\n                value={formData.company}\r\n                onChange={(e) =>\r\n                  setFormData({ ...formData, company: e.target.value })\r\n                }\r\n                required\r\n                className=\"px-3 py-2 border rounded\"\r\n              />\r\n              <input\r\n                type=\"text\"\r\n                placeholder=\"Position\"\r\n                value={formData.position}\r\n                onChange={(e) =>\r\n                  setFormData({ ...formData, position: e.target.value })\r\n                }\r\n                className=\"px-3 py-2 border rounded\"\r\n              />\r\n              <select\r\n                value={formData.type}\r\n                onChange={(e) =>\r\n                  setFormData({ ...formData, type: e.target.value })\r\n                }\r\n                required\r\n                className=\"px-3 py-2 border rounded\"\r\n              >\r\n                <option value=\"CUSTOMER\">Customer</option>\r\n                <option value=\"SUPPLIER\">Supplier</option>\r\n                <option value=\"LEAD\">Lead</option>\r\n                <option value=\"PARTNER\">Partner</option>\r\n              </select>\r\n            </div>\r\n\r\n            <div className=\"flex gap-2\">\r\n              <button\r\n                type=\"submit\"\r\n                disabled={loading}\r\n                className=\"flex-1 bg-blue-600 text-white py-2 rounded font-semibold hover:bg-blue-700\"\r\n              >\r\n                {loading\r\n                  ? \"Loading...\"\r\n                  : editing\r\n                    ? \"Update\"\r\n                    : \"Add\"}\r\n              </button>\r\n              {editing && (\r\n                <button\r\n                  type=\"button\"\r\n                  onClick={resetForm}\r\n                  className=\"px-6 bg-gray-400 text-white py-2 rounded font-semibold hover:bg-gray-500\"\r\n                >\r\n                  Cancel\r\n                </button>\r\n              )}\r\n            </div>\r\n          </form>\r\n        </div>\r\n\r\n        {/* Filter */}\r\n        <div className=\"mb-6 flex gap-2 flex-wrap\">\r\n          {[\"ALL\", \"CUSTOMER\", \"SUPPLIER\", \"LEAD\", \"PARTNER\"].map((type) => (\r\n            <button\r\n              key={type}\r\n              onClick={() => setFilterType(type)}\r\n              className={`px-4 py-2 rounded font-semibold ${\r\n                filterType === type\r\n                  ? \"bg-blue-600 text-white\"\r\n                  : \"bg-white text-gray-700 border\"\r\n              }`}\r\n            >\r\n              {type === \"ALL\" ? \"All\" : type}\r\n            </button>\r\n          ))}\r\n        </div>\r\n\r\n        {/* Table */}\r\n        {loading ? (\r\n          <div className=\"text-center py-8\">Loading...</div>\r\n        ) : (\r\n          <div className=\"bg-white rounded-lg shadow overflow-x-auto\">\r\n            <table className=\"w-full min-w-[1000px]\">\r\n              <thead className=\"bg-gray-100 border-b\">\r\n                <tr>\r\n                  <th className=\"px-6 py-3 text-left\">Name</th>\r\n                  <th className=\"px-6 py-3 text-left\">Phone</th>\r\n                  <th className=\"px-6 py-3 text-left\">Email</th>\r\n                  <th className=\"px-6 py-3 text-left\">Company</th>\r\n                  <th className=\"px-6 py-3 text-left\">Position</th>\r\n                  <th className=\"px-6 py-3 text-left\">Type</th>\r\n                  <th className=\"px-6 py-3 text-center\">Actions</th>\r\n                </tr>\r\n              </thead>\r\n              <tbody>\r\n                {contacts.map((contact) => (\r\n                  <tr key={contact.id} className=\"border-b hover:bg-gray-50\">\r\n                    <td className=\"px-6 py-3 font-semibold\">{contact.name}</td>\r\n                    <td className=\"px-6 py-3\">{contact.phone}</td>\r\n                    <td className=\"px-6 py-3\">{contact.email || \"-\"}</td>\r\n                    <td className=\"px-6 py-3\">{contact.company}</td>\r\n                    <td className=\"px-6 py-3\">{contact.position || \"-\"}</td>\r\n                    <td className=\"px-6 py-3\">\r\n                      <span className={`px-3 py-1 rounded text-sm font-semibold ${getTypeColor(contact.type)}`}>\r\n                        {contact.type}\r\n                      </span>\r\n                    </td>\r\n                    <td className=\"px-6 py-3 text-center space-x-2\">\r\n                      <button\r\n                        onClick={() => handleEdit(contact)}\r\n                        className=\"px-3 py-1 bg-blue-500 text-white rounded text-sm hover:bg-blue-600\"\r\n                      >\r\n                        Edit\r\n                      </button>\r\n                      <button\r\n                        onClick={() => handleDelete(contact.id)}\r\n                        className=\"px-3 py-1 bg-red-500 text-white rounded text-sm hover:bg-red-600\"\r\n                      >\r\n                        Delete\r\n                      </button>\r\n                    </td>\r\n                  </tr>\r\n                ))}\r\n              </tbody>\r\n            </table>\r\n          </div>\r\n        )}\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\dashboard\\crm\\interactions\\page.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchInteractions'. Either include it or remove the dependency array.","line":35,"column":6,"nodeType":"ArrayExpression","endLine":35,"endColumn":18,"suggestions":[{"desc":"Update the dependencies array to be: [fetchInteractions, filterType]","fix":{"range":[916,928],"text":"[fetchInteractions, filterType]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState, useEffect } from \"react\";\r\n\r\ninterface Interaction {\r\n  id: string;\r\n  type: string;\r\n  date: string;\r\n  subject: string;\r\n  description: string;\r\n  outcome?: string;\r\n  nextFollowUp?: string;\r\n  contact: { name: string };\r\n}\r\n\r\nexport default function InteractionsPage() {\r\n  const [interactions, setInteractions] = useState<Interaction[]>([]);\r\n  const [contacts, setContacts] = useState<Any[]>([]);\r\n  const [loading, setLoading] = useState(false);\r\n  const [editing, setEditing] = useState<string | null>(null);\r\n  const [filterType, setFilterType] = useState(\"ALL\");\r\n  const [formData, setFormData] = useState({\r\n    contactId: \"\",\r\n    type: \"CALL\",\r\n    date: new Date().toISOString().split(\"T\")[0],\r\n    subject: \"\",\r\n    description: \"\",\r\n    outcome: \"NEUTRAL\",\r\n    nextFollowUp: \"\",\r\n  });\r\n\r\n  useEffect(() => {\r\n    fetchContacts();\r\n    fetchInteractions();\r\n  }, [filterType]);\r\n\r\n  const fetchContacts = async () => {\r\n    try {\r\n      const response = await fetch(\"/api/crm/contacts\");\r\n      if (!response.ok) {\r\n        throw new Error(\"Failed to fetch contacts\");\r\n      }\r\n      const data = await response.json();\r\n      setContacts(Array.isArray(data) ? data : []);\r\n    } catch (error) {\r\n      console.error(\"Error fetching contacts:\", error);\r\n      setContacts([]);\r\n    }\r\n  };\r\n\r\n  const fetchInteractions = async () => {\r\n    setLoading(true);\r\n    try {\r\n      const url =\r\n        filterType === \"ALL\"\r\n          ? \"/api/crm/interactions\"\r\n          : `/api/crm/interactions?type=${filterType}`;\r\n      const response = await fetch(url);\r\n      if (!response.ok) {\r\n        throw new Error(\"Failed to fetch interactions\");\r\n      }\r\n      const data = await response.json();\r\n      setInteractions(Array.isArray(data) ? data : []);\r\n    } catch (error) {\r\n      console.error(\"Error fetching interactions:\", error);\r\n      setInteractions([]);\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  const handleSubmit = async (e: React.FormEvent) => {\r\n    e.preventDefault();\r\n    setLoading(true);\r\n\r\n    try {\r\n      const url = editing\r\n        ? `/api/crm/interactions?id=${editing}`\r\n        : \"/api/crm/interactions\";\r\n      const method = editing ? \"PUT\" : \"POST\";\r\n\r\n      const response = await fetch(url, {\r\n        method,\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n        body: JSON.stringify(formData),\r\n      });\r\n\r\n      if (response.ok) {\r\n        fetchInteractions();\r\n        resetForm();\r\n      } else {\r\n        const error = await response.json();\r\n        alert(error.error);\r\n      }\r\n    } catch (error) {\r\n      console.error(\"Error saving interaction:\", error);\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  const handleDelete = async (id: string) => {\r\n    if (!confirm(\"Are you sure you want to delete this interaction?\")) return;\r\n\r\n    try {\r\n      await fetch(`/api/crm/interactions?id=${id}`, { method: \"DELETE\" });\r\n      fetchInteractions();\r\n    } catch (error) {\r\n      console.error(\"Error deleting interaction:\", error);\r\n    }\r\n  };\r\n\r\n  const resetForm = () => {\r\n    setFormData({\r\n      contactId: \"\",\r\n      type: \"CALL\",\r\n      date: new Date().toISOString().split(\"T\")[0],\r\n      subject: \"\",\r\n      description: \"\",\r\n      outcome: \"NEUTRAL\",\r\n      nextFollowUp: \"\",\r\n    });\r\n    setEditing(null);\r\n  };\r\n\r\n  const types = [\"CALL\", \"EMAIL\", \"MEETING\", \"MESSAGE\", \"VISIT\"];\r\n\r\n  return (\r\n    <div className=\"p-6 bg-gray-50 min-h-screen\">\r\n      <div className=\"max-w-6xl mx-auto\">\r\n        <h1 className=\"text-3xl font-bold text-gray-900 mb-6\">\r\n          📞 CRM Interaction History\r\n        </h1>\r\n\r\n        {/* Form */}\r\n        <div className=\"bg-white p-6 rounded-lg shadow mb-6\">\r\n          <form onSubmit={handleSubmit} className=\"space-y-4\">\r\n            <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4\">\r\n              <select\r\n                value={formData.contactId}\r\n                onChange={(e) =>\r\n                  setFormData({ ...formData, contactId: e.target.value })\r\n                }\r\n                required\r\n                className=\"px-3 py-2 border rounded\"\r\n              >\r\n                <option value=\"\">Select Contact</option>\r\n                {contacts.map((contact) => (\r\n                  <option key={contact.id} value={contact.id}>\r\n                    {contact.name}\r\n                  </option>\r\n                ))}\r\n              </select>\r\n\r\n              <select\r\n                value={formData.type}\r\n                onChange={(e) =>\r\n                  setFormData({ ...formData, type: e.target.value })\r\n                }\r\n                className=\"px-3 py-2 border rounded\"\r\n              >\r\n                {types.map((type) => (\r\n                  <option key={type} value={type}>\r\n                    {type}\r\n                  </option>\r\n                ))}\r\n              </select>\r\n\r\n              <input\r\n                type=\"date\"\r\n                value={formData.date}\r\n                onChange={(e) =>\r\n                  setFormData({ ...formData, date: e.target.value })\r\n                }\r\n                required\r\n                className=\"px-3 py-2 border rounded\"\r\n              />\r\n\r\n              <select\r\n                value={formData.outcome}\r\n                onChange={(e) =>\r\n                  setFormData({ ...formData, outcome: e.target.value })\r\n                }\r\n                className=\"px-3 py-2 border rounded\"\r\n              >\r\n                <option value=\"POSITIVE\">Positive</option>\r\n                <option value=\"NEUTRAL\">Neutral</option>\r\n                <option value=\"NEGATIVE\">Negative</option>\r\n              </select>\r\n            </div>\r\n\r\n            <input\r\n              type=\"text\"\r\n              placeholder=\"Subject\"\r\n              value={formData.subject}\r\n              onChange={(e) =>\r\n                setFormData({ ...formData, subject: e.target.value })\r\n              }\r\n              required\r\n              className=\"w-full px-3 py-2 border rounded\"\r\n            />\r\n\r\n            <textarea\r\n              placeholder=\"Description\"\r\n              value={formData.description}\r\n              onChange={(e) =>\r\n                setFormData({ ...formData, description: e.target.value })\r\n              }\r\n              className=\"w-full px-3 py-2 border rounded\"\r\n              rows={3}\r\n            />\r\n\r\n            <input\r\n              type=\"date\"\r\n              placeholder=\"Next Follow-up Date\"\r\n              value={formData.nextFollowUp}\r\n              onChange={(e) =>\r\n                setFormData({ ...formData, nextFollowUp: e.target.value })\r\n              }\r\n              className=\"w-full px-3 py-2 border rounded\"\r\n            />\r\n\r\n            <div className=\"flex gap-2\">\r\n              <button\r\n                type=\"submit\"\r\n                disabled={loading}\r\n                className=\"flex-1 bg-blue-600 text-white py-2 rounded font-semibold hover:bg-blue-700\"\r\n              >\r\n                {loading\r\n                  ? \"Loading...\"\r\n                  : editing\r\n                    ? \"Update\"\r\n                    : \"Add\"}\r\n              </button>\r\n              {editing && (\r\n                <button\r\n                  type=\"button\"\r\n                  onClick={resetForm}\r\n                  className=\"px-6 bg-gray-400 text-white py-2 rounded font-semibold hover:bg-gray-500\"\r\n                >\r\n                 Cancel\r\n                </button>\r\n              )}\r\n            </div>\r\n          </form>\r\n        </div>\r\n\r\n        {/* Filter */}\r\n        <div className=\"mb-6 flex gap-2 flex-wrap\">\r\n          {[\"ALL\", ...types].map((type) => (\r\n            <button\r\n              key={type}\r\n              onClick={() => setFilterType(type)}\r\n              className={`px-4 py-2 rounded font-semibold ${\r\n                filterType === type\r\n                  ? \"bg-blue-600 text-white\"\r\n                  : \"bg-white text-gray-700 border\"\r\n              }`}\r\n            >\r\n              {type === \"ALL\" ? \"All\" : type}\r\n            </button>\r\n          ))}\r\n        </div>\r\n\r\n        {/* Table */}\r\n        {loading ? (\r\n          <div className=\"text-center py-8\">Loading...</div>\r\n        ) : (\r\n          <div className=\"bg-white rounded-lg shadow overflow-x-auto\">\r\n            <table className=\"w-full min-w-[1000px]\">\r\n              <thead className=\"bg-gray-100 border-b\">\r\n                <tr>\r\n                  <th className=\"px-6 py-3 text-left\">Name</th>\r\n                  <th className=\"px-6 py-3 text-left\">Type</th>\r\n                  <th className=\"px-6 py-3 text-left\">Subject</th>\r\n                  <th className=\"px-6 py-3 text-left\">Date</th>\r\n                  <th className=\"px-6 py-3 text-left\">Outcome</th>\r\n                  <th className=\"px-6 py-3 text-left\">Next Follow-up</th>\r\n                  <th className=\"px-6 py-3 text-center\">Actions</th>\r\n                </tr>\r\n              </thead>\r\n              <tbody>\r\n                {interactions.map((interaction) => (\r\n                  <tr key={interaction.id} className=\"border-b hover:bg-gray-50\">\r\n                    <td className=\"px-6 py-3 font-semibold\">\r\n                      {interaction.contact.name}\r\n                    </td>\r\n                    <td className=\"px-6 py-3\">{interaction.type}</td>\r\n                    <td className=\"px-6 py-3\">{interaction.subject}</td>\r\n                    <td className=\"px-6 py-3\">\r\n                      {new Date(interaction.date).toLocaleDateString(\"ur-PK\")}\r\n                    </td>\r\n                    <td className=\"px-6 py-3\">\r\n                      <span\r\n                        className={`px-2 py-1 rounded text-sm font-semibold ${\r\n                          interaction.outcome === \"POSITIVE\"\r\n                            ? \"bg-green-100 text-green-800\"\r\n                            : interaction.outcome === \"NEGATIVE\"\r\n                              ? \"bg-red-100 text-red-800\"\r\n                              : \"bg-gray-100 text-gray-800\"\r\n                        }`}\r\n                      >\r\n                        {interaction.outcome}\r\n                      </span>\r\n                    </td>\r\n                    <td className=\"px-6 py-3\">\r\n                      {interaction.nextFollowUp\r\n                        ? new Date(interaction.nextFollowUp).toLocaleDateString(\r\n                            \"en-PK\"\r\n                          )\r\n                        : \"-\"}\r\n                    </td>\r\n                    <td className=\"px-6 py-3 text-center space-x-2\">\r\n                      <button\r\n                        onClick={() => setEditing(interaction.id)}\r\n                        className=\"px-3 py-1 bg-blue-500 text-white rounded text-sm hover:bg-blue-600\"\r\n                      >\r\n                        Edit\r\n                      </button>\r\n                      <button\r\n                        onClick={() => handleDelete(interaction.id)}\r\n                        className=\"px-3 py-1 bg-red-500 text-white rounded text-sm hover:bg-red-600\"\r\n                      >\r\n                       Delete\r\n                      </button>\r\n                    </td>\r\n                  </tr>\r\n                ))}\r\n              </tbody>\r\n            </table>\r\n          </div>\r\n        )}\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\dashboard\\crm\\opportunities\\page.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchOpportunities'. Either include it or remove the dependency array.","line":35,"column":6,"nodeType":"ArrayExpression","endLine":35,"endColumn":19,"suggestions":[{"desc":"Update the dependencies array to be: [fetchOpportunities, filterStage]","fix":{"range":[911,924],"text":"[fetchOpportunities, filterStage]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState, useEffect } from \"react\";\r\n\r\ninterface Opportunity {\r\n  id: string;\r\n  title: string;\r\n  description: string;\r\n  value: number;\r\n  probability: number;\r\n  stage: string;\r\n  expectedCloseDate: string;\r\n  contact: { name: string; company: string };\r\n}\r\n\r\nexport default function OpportunitiesPage() {\r\n  const [opportunities, setOpportunities] = useState<Opportunity[]>([]);\r\n  const [contacts, setContacts] = useState<Any[]>([]);\r\n  const [loading, setLoading] = useState(false);\r\n  const [editing, setEditing] = useState<string | null>(null);\r\n  const [filterStage, setFilterStage] = useState(\"ALL\");\r\n  const [formData, setFormData] = useState({\r\n    contactId: \"\",\r\n    title: \"\",\r\n    description: \"\",\r\n    value: 0,\r\n    probability: 50,\r\n    stage: \"LEAD\",\r\n    expectedCloseDate: \"\",\r\n  });\r\n\r\n  useEffect(() => {\r\n    fetchContacts();\r\n    fetchOpportunities();\r\n  }, [filterStage]);\r\n\r\n  const fetchContacts = async () => {\r\n    try {\r\n      const response = await fetch(\"/api/crm/contacts\");\r\n      if (!response.ok) {\r\n        throw new Error(\"Failed to fetch contacts\");\r\n      }\r\n      const data = await response.json();\r\n      setContacts(Array.isArray(data) ? data : []);\r\n    } catch (error) {\r\n      console.error(\"Error fetching contacts:\", error);\r\n      setContacts([]);\r\n    }\r\n  };\r\n\r\n  const fetchOpportunities = async () => {\r\n    setLoading(true);\r\n    try {\r\n      const url =\r\n        filterStage === \"ALL\"\r\n          ? \"/api/crm/opportunities\"\r\n          : `/api/crm/opportunities?stage=${filterStage}`;\r\n      const response = await fetch(url);\r\n      if (!response.ok) {\r\n        throw new Error(\"Failed to fetch opportunities\");\r\n      }\r\n      const data = await response.json();\r\n      setOpportunities(Array.isArray(data) ? data : []);\r\n    } catch (error) {\r\n      console.error(\"Error fetching opportunities:\", error);\r\n      setOpportunities([]);\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  const handleSubmit = async (e: React.FormEvent) => {\r\n    e.preventDefault();\r\n    setLoading(true);\r\n\r\n    try {\r\n      const url = editing\r\n        ? `/api/crm/opportunities?id=${editing}`\r\n        : \"/api/crm/opportunities\";\r\n      const method = editing ? \"PUT\" : \"POST\";\r\n\r\n      const response = await fetch(url, {\r\n        method,\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n        body: JSON.stringify({\r\n          ...formData,\r\n          value: parseFloat(formData.value.toString()),\r\n          probability: parseInt(formData.probability.toString()),\r\n        }),\r\n      });\r\n\r\n      if (response.ok) {\r\n        fetchOpportunities();\r\n        resetForm();\r\n      } else {\r\n        const error = await response.json();\r\n        alert(error.error);\r\n      }\r\n    } catch (error) {\r\n      console.error(\"Error saving opportunity:\", error);\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  const handleDelete = async (id: string) => {\r\n    if (!confirm(\"Are you sure you want to delete this opportunity?\")) return;\r\n\r\n    try {\r\n      await fetch(`/api/crm/opportunities?id=${id}`, { method: \"DELETE\" });\r\n      fetchOpportunities();\r\n    } catch (error) {\r\n      console.error(\"Error deleting opportunity:\", error);\r\n    }\r\n  };\r\n\r\n  const handleEdit = (opp: Opportunity) => {\r\n    setEditing(opp.id);\r\n    setFormData({\r\n      contactId: opp.contact.name,\r\n      title: opp.title,\r\n      description: opp.description,\r\n      value: opp.value,\r\n      probability: opp.probability,\r\n      stage: opp.stage,\r\n      expectedCloseDate: opp.expectedCloseDate.split(\"T\")[0],\r\n    });\r\n  };\r\n\r\n  const resetForm = () => {\r\n    setFormData({\r\n      contactId: \"\",\r\n      title: \"\",\r\n      description: \"\",\r\n      value: 0,\r\n      probability: 50,\r\n      stage: \"LEAD\",\r\n      expectedCloseDate: \"\",\r\n    });\r\n    setEditing(null);\r\n  };\r\n\r\n  const stages = [\"LEAD\", \"PROSPECT\", \"NEGOTIATION\", \"CLOSE\", \"WON\", \"LOST\"];\r\n  const totalValue = opportunities.reduce((sum, opp) => sum + opp.value, 0);\r\n  const weightedValue = opportunities.reduce(\r\n    (sum, opp) => sum + (opp.value * opp.probability) / 100,\r\n    0\r\n  );\r\n\r\n  return (\r\n    <div className=\"p-6 bg-gray-50 min-h-screen\">\r\n      <div className=\"max-w-6xl mx-auto\">\r\n        <h1 className=\"text-3xl font-bold text-gray-900 mb-6\">\r\n          💼 CRM Opportunities\r\n        </h1>\r\n\r\n        {/* Stats */}\r\n        <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4 mb-6\">\r\n          <div className=\"bg-white p-4 rounded-lg shadow\">\r\n            <div className=\"text-gray-600 text-sm\">Total Opportunities</div>\r\n            <div className=\"text-2xl font-bold text-blue-600\">\r\n              {opportunities.length}\r\n            </div>\r\n          </div>\r\n          <div className=\"bg-white p-4 rounded-lg shadow\">\r\n            <div className=\"text-gray-600 text-sm\">Total Value</div>\r\n            <div className=\"text-2xl font-bold text-green-600\">\r\n              {totalValue.toLocaleString()}\r\n            </div>\r\n          </div>\r\n          <div className=\"bg-white p-4 rounded-lg shadow\">\r\n            <div className=\"text-gray-600 text-sm\">Weighted Value</div>\r\n            <div className=\"text-2xl font-bold text-purple-600\">\r\n              {weightedValue.toLocaleString()}\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        {/* Form */}\r\n        <div className=\"bg-white p-6 rounded-lg shadow mb-6\">\r\n          <form onSubmit={handleSubmit} className=\"space-y-4\">\r\n            <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\r\n              <select\r\n                value={formData.contactId}\r\n                onChange={(e) =>\r\n                  setFormData({ ...formData, contactId: e.target.value })\r\n                }\r\n                required\r\n                className=\"px-3 py-2 border rounded\"\r\n              >\r\n                <option value=\"\">Select Contact</option>\r\n                {contacts.map((contact) => (\r\n                  <option key={contact.id} value={contact.id}>\r\n                    {contact.name} - {contact.company}\r\n                  </option>\r\n                ))}\r\n              </select>\r\n\r\n              <input\r\n                type=\"text\"\r\n                placeholder=\"Title\"\r\n                value={formData.title}\r\n                onChange={(e) =>\r\n                  setFormData({ ...formData, title: e.target.value })\r\n                }\r\n                required\r\n                className=\"px-3 py-2 border rounded\"\r\n              />\r\n\r\n              <input\r\n                type=\"number\"\r\n                placeholder=\"Value\"\r\n                step=\"0.01\"\r\n                value={formData.value}\r\n                onChange={(e) =>\r\n                  setFormData({\r\n                    ...formData,\r\n                    value: parseFloat(e.target.value),\r\n                  })\r\n                }\r\n                required\r\n                className=\"px-3 py-2 border rounded\"\r\n              />\r\n            </div>\r\n\r\n            <textarea\r\n              placeholder=\"Description\"\r\n              value={formData.description}\r\n              onChange={(e) =>\r\n                setFormData({ ...formData, description: e.target.value })\r\n              }\r\n              className=\"w-full px-3 py-2 border rounded\"\r\n            />\r\n\r\n            <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4\">\r\n              <select\r\n                value={formData.stage}\r\n                onChange={(e) =>\r\n                  setFormData({ ...formData, stage: e.target.value })\r\n                }\r\n                className=\"px-3 py-2 border rounded\"\r\n              >\r\n                {stages.map((stage) => (\r\n                  <option key={stage} value={stage}>\r\n                    {stage}\r\n                  </option>\r\n                ))}\r\n              </select>\r\n\r\n              <input\r\n                type=\"number\"\r\n                placeholder=\"Chances (%)\"\r\n                min=\"0\"\r\n                max=\"100\"\r\n                value={formData.probability}\r\n                onChange={(e) =>\r\n                  setFormData({\r\n                    ...formData,\r\n                    probability: parseInt(e.target.value),\r\n                  })\r\n                }\r\n                className=\"px-3 py-2 border rounded\"\r\n              />\r\n\r\n              <input\r\n                type=\"date\"\r\n                value={formData.expectedCloseDate}\r\n                onChange={(e) =>\r\n                  setFormData({\r\n                    ...formData,\r\n                    expectedCloseDate: e.target.value,\r\n                  })\r\n                }\r\n                required\r\n                className=\"px-3 py-2 border rounded col-span-2\"\r\n              />\r\n            </div>\r\n\r\n            <div className=\"flex gap-2\">\r\n              <button\r\n                type=\"submit\"\r\n                disabled={loading}\r\n                className=\"flex-1 bg-blue-600 text-white py-2 rounded font-semibold hover:bg-blue-700\"\r\n              >\r\n                {loading\r\n                  ? \"Loading...\"\r\n                  : editing\r\n                    ? \"Update\"\r\n                    : \"Add\"}\r\n              </button>\r\n              {editing && (\r\n                <button\r\n                  type=\"button\"\r\n                  onClick={resetForm}\r\n                  className=\"px-6 bg-gray-400 text-white py-2 rounded font-semibold hover:bg-gray-500\"\r\n                >\r\n                 Cancel\r\n                </button>\r\n              )}\r\n            </div>\r\n          </form>\r\n        </div>\r\n\r\n        {/* Filter */}\r\n        <div className=\"mb-6 flex gap-2 flex-wrap\">\r\n          {[\"ALL\", ...stages].map((stage) => (\r\n            <button\r\n              key={stage}\r\n              onClick={() => setFilterStage(stage)}\r\n              className={`px-4 py-2 rounded font-semibold ${\r\n                filterStage === stage\r\n                  ? \"bg-blue-600 text-white\"\r\n                  : \"bg-white text-gray-700 border\"\r\n              }`}\r\n            >\r\n              {stage === \"ALL\" ? \"All\" : stage}\r\n            </button>\r\n          ))}\r\n        </div>\r\n\r\n        {/* Table */}\r\n        {loading ? (\r\n          <div className=\"text-center py-8\">Loading...</div>\r\n        ) : (\r\n          <div className=\"bg-white rounded-lg shadow overflow-x-auto\">\r\n            <table className=\"w-full min-w-[1000px]\">\r\n              <thead className=\"bg-gray-100 border-b\">\r\n                <tr>\r\n                  <th className=\"px-6 py-3 text-left\">Title</th>\r\n                  <th className=\"px-6 py-3 text-left\">Contact</th>\r\n                  <th className=\"px-6 py-3 text-left\">Value</th>\r\n                  <th className=\"px-6 py-3 text-left\">Chances (%)</th>\r\n                  <th className=\"px-6 py-3 text-left\">Stage</th>\r\n                  <th className=\"px-6 py-3 text-left\">Expected Close Date</th>\r\n                  <th className=\"px-6 py-3 text-center\">Actions</th>\r\n                </tr>\r\n              </thead>\r\n              <tbody>\r\n                {opportunities.map((opp) => (\r\n                  <tr key={opp.id} className=\"border-b hover:bg-gray-50\">\r\n                    <td className=\"px-6 py-3 font-semibold\">{opp.title}</td>\r\n                    <td className=\"px-6 py-3\">\r\n                      {opp.contact.name} ({opp.contact.company})\r\n                    </td>\r\n                    <td className=\"px-6 py-3\">\r\n                      {opp.value.toLocaleString()}\r\n                    </td>\r\n                    <td className=\"px-6 py-3\">\r\n                      <div className=\"w-full bg-gray-200 rounded-full h-2\">\r\n                        <div\r\n                          className=\"bg-blue-600 h-2 rounded-full\"\r\n                          style={{ width: `${opp.probability}%` }}\r\n                        ></div>\r\n                      </div>\r\n                      <span className=\"text-xs\">{opp.probability}%</span>\r\n                    </td>\r\n                    <td className=\"px-6 py-3\">{opp.stage}</td>\r\n                    <td className=\"px-6 py-3\">\r\n                      {new Date(opp.expectedCloseDate).toLocaleDateString(\r\n                        \"ur-PK\"\r\n                      )}\r\n                    </td>\r\n                    <td className=\"px-6 py-3 text-center space-x-2\">\r\n                      <button\r\n                        onClick={() => handleEdit(opp)}\r\n                        className=\"px-3 py-1 bg-blue-500 text-white rounded text-sm hover:bg-blue-600\"\r\n                      >\r\n                        Edit\r\n                      </button>\r\n                      <button\r\n                        onClick={() => handleDelete(opp.id)}\r\n                        className=\"px-3 py-1 bg-red-500 text-white rounded text-sm hover:bg-red-600\"\r\n                      >\r\n                        Delete\r\n                      </button>\r\n                    </td>\r\n                  </tr>\r\n                ))}\r\n              </tbody>\r\n            </table>\r\n          </div>\r\n        )}\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\dashboard\\crv\\page.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'loadAccounts', 'loadVouchers', and 'user'. Either include them or remove the dependency array.","line":64,"column":6,"nodeType":"ArrayExpression","endLine":64,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [loadAccounts, loadVouchers, user]","fix":{"range":[1670,1672],"text":"[loadAccounts, loadVouchers, user]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { useEffect, useState } from \"react\";\nimport { getCurrentUser } from \"@/lib/auth\";\nimport { toast } from \"react-hot-toast\";\n\ntype Account = {\n  id: string;\n  name: string;\n  phone?: string | null;\n  partyType?: string | null;\n};\n\ntype Voucher = {\n  id: string;\n  voucherNo: string;\n  date: string;\n  narration: string;\n  accountName: string;\n  accountId: string;\n  amount: number;\n  paymentMode: string;\n  paymentAccountId: string;\n};\ntype BankAccount = {\n  id: string;\n  accountId?: string | null;\n  bankName?: string;\n  accountNo?: string;\n  accountName?: string;\n};\n\n\nexport default function CRVPage() {\n  const today = new Date().toISOString().split(\"T\")[0];\n\n  const [customers, setCustomers] = useState<Account[]>([]);\n  const [bankAccounts, setBankAccounts] = useState<Any[]>([]);\n  const [vouchers, setVouchers] = useState<Voucher[]>([]);\n  const [showList, setShowList] = useState(false);\n  const [showForm, setShowForm] = useState(true);\n  const [editing, setEditing] = useState<Voucher | null>(null);\n\n  const [accountId, setAccountId] = useState(\"\");\n  const [bankAccountId, setBankAccountId] = useState(\"\");\n  const [amount, setAmount] = useState(\"\");\n  const [date, setDate] = useState(today);\n  const [narration, setNarration] = useState(\"\");\n  const [voucher, setVoucher] = useState<Any>(null);\n  const [saving, setSaving] = useState(false);\n  const [selectedName, setSelectedName] = useState(\"\");\n  const [selectedPhone, setSelectedPhone] = useState(\"\");\n\n  const user = getCurrentUser();\n\n  useEffect(() => {\n    if (!user) {\n      toast.error(\"Session expired\");\n      return;\n    }\n\n    loadVouchers();\n    loadAccounts();\n  }, []);\n\n  async function loadVouchers() {\n    try {\n      const res = await fetch(\"/api/crv\", {\n        headers: { \"x-user-role\": user?.role || \"\" },\n      });\n      const data = await res.json();\n      if (Array.isArray(data)) {\n        setVouchers(data);\n      }\n    } catch (e) {\n      console.error(\"Load vouchers error:\", e);\n    }\n  }\n\n  async function loadAccounts() {\n    Promise.all([\n      fetch(\"/api/accounts\", {\n        method: \"GET\",\n        headers: { \"x-user-role\": user?.role || \"\" },\n      }),\n      fetch(\"/api/bank-accounts\", { method: \"GET\" }),\n    ])\n      .then(async ([accountsRes, banksRes]) => {\n        const accountsData = await accountsRes.json();\n        const banksData = await banksRes.json();\n\n        if (Array.isArray(accountsData)) {\n          // CRV میں CUSTOMER + BANKS دونوں ہونے چاہیے\n          const filtered = accountsData.filter(a => \n            a.partyType === \"CUSTOMER\" || a.partyType === \"BANKS\" || !a.partyType\n          );\n          setCustomers(filtered);\n        }\n\n        const allBanks: Any[] = [];\n        // Removed manual addition of banks from accountsData as banksData already includes them\n\n        if (Array.isArray(banksData)) {\n  banksData.forEach((bank: BankAccount) => {\n    allBanks.push({\n      id: `BANK-${bank.id}`,\n      rawId: bank.id,\n      source: \"BANK\",\n      name: bank.accountName || `${bank.bankName} - ${bank.accountNo}`,\n    });\n  });\n}\n\n        setBankAccounts(allBanks);\n      })\n      .catch(err => {\n        console.error(\"Accounts load error:\", err);\n      });\n  }\n\n  async function saveCRV() {\n    if (!accountId) {\n      toast.error(\"Customer select karein\");\n      return;\n    }\n\n    const amountNum = Number(amount);\n    if (!amount || amount.trim() === \"\" || isNaN(amountNum) || amountNum <= 0) {\n      toast.error(\"Valid amount enter karein (0 se zyada)\");\n      return;\n    }\n\n    setSaving(true);\n\n    try {\n      const url = \"/api/crv\";\n      const method = editing ? \"PUT\" : \"POST\";\n\n      const res = await fetch(url, {\n        method,\n        headers: {\n          \"Content-Type\": \"application/json\",\n          \"x-user-role\": user?.role || \"\",\n        },\n        body: JSON.stringify(editing ? {\n          id: editing.id,\n          accountId,\n          bankAccountId: bankAccountId || null,\n          paymentMode: bankAccountId ? \"BANK\" : \"CASH\",\n          amount,\n          date,\n          narration,\n        } : {\n          accountId,\n          bankAccountId: bankAccountId || null,\n          paymentMode: bankAccountId ? \"BANK\" : \"CASH\",\n          amount,\n          date,\n          narration,\n        }),\n      });\n\n      const data = await res.json();\n\n      if (!res.ok) {\n        alert(`Error: ${data?.error || \"Save failed\"}`);\n        return;\n      }\n\n      setVoucher(data);\n      alert(editing ? \"CRV updated successfully!\" : \"CRV saved successfully!\");\n      await loadVouchers();\n      resetForm();\n      setShowForm(false);\n      setEditing(null);\n    } catch (e: Any) {\n      alert(`Error: ${e.message || \"Failed to save\"}`);\n    } finally {\n      setSaving(false);\n    }\n  }\n\n  function resetForm() {\n    setAccountId(\"\");\n    setBankAccountId(\"\");\n    setAmount(\"\");\n    setNarration(\"\");\n    setSelectedName(\"\");\n    setSelectedPhone(\"\");\n  }\n\n  function startEdit(v: Voucher) {\n    setEditing(v);\n    setAccountId(v.accountId);\n    setBankAccountId(v.paymentAccountId || \"\");\n    setAmount(v.amount.toString());\n    setDate(v.date);\n    setNarration(v.narration);\n    setShowForm(true);\n    setShowList(false);\n  }\n\n  async function deleteVoucher(id: string) {\n    if (!confirm(\"Are you sure you want to delete this CRV?\")) {\n      return;\n    }\n\n    try {\n      const res = await fetch(`/api/crv?id=${id}`, {\n        method: \"DELETE\",\n        headers: { \"x-user-role\": user?.role || \"\" },\n      });\n\n      if (res.ok) {\n        alert(\"CRV deleted successfully!\");\n        await loadVouchers();\n      } else {\n        const data = await res.json();\n        alert(data.error || \"Delete failed\");\n      }\n    } catch (_e) {\n      alert(\"Delete failed\");\n    }\n  }\n\n  function printVoucher() {\n    window.print();\n  }\n\n  function sendWhatsApp() {\n    const phoneNo = voucher?.phone || selectedPhone;\n    if (!phoneNo) {\n      toast.error(\"Party ka phone number nahi mila\");\n      return;\n    }\n\n    const phone = String(phoneNo).replace(/\\D/g, \"\");\n    const finalPhone = phone.startsWith('0') ? '92' + phone.substring(1) : phone;\n\n    if (finalPhone.length < 10) {\n      toast.error(\"Phone number theek nahi hai\");\n      return;\n    }\n\n    const msg =\n      `*Cash Receipt Voucher*\\n\\n` +\n      `*Received From:* ${voucher.accountName || selectedName}\\n` +\n      `*Amount:* Rs. ${Number(voucher.amount || amount || 0).toLocaleString()}/-\\n` +\n      `*Date:* ${voucher.date?.split('T')[0] || date}\\n` +\n      `*Voucher No:* ${voucher.voucherNo}\\n\\n` +\n      `_US TRADERS_`;\n\n    window.open(\n      `https://wa.me/${finalPhone}?text=${encodeURIComponent(msg)}`,\n      \"_blank\"\n    );\n  }\n\n  return (\n    <div className=\"p-6 space-y-6\">\n      <div className=\"flex justify-between items-center\">\n        <h1 className=\"text-2xl font-bold\">Cash Receipt Voucher (CRV)</h1>\n        <div className=\"flex gap-2\">\n          <button\n            onClick={() => {\n              setShowList(!showList);\n              setShowForm(!showForm);\n              setEditing(null);\n            }}\n            className=\"bg-gray-600 text-white px-4 py-2 rounded\"\n          >\n            {showList ? \"Hide List\" : \"Show List\"}\n          </button>\n          <button\n            onClick={() => {\n              setShowForm(true);\n              setShowList(false);\n              setEditing(null);\n              resetForm();\n            }}\n            className=\"bg-blue-600 text-white px-4 py-2 rounded\"\n          >\n            + New CRV\n          </button>\n        </div>\n      </div>\n\n      {/* VOUCHER LIST */}\n      {showList && (\n        <div className=\"bg-white border rounded overflow-x-auto\">\n          <table className=\"w-full text-sm min-w-[800px]\">\n            <thead className=\"bg-gray-100\">\n              <tr>\n                <th className=\"p-3 text-left\">Voucher No</th>\n                <th className=\"p-3 text-left\">Date</th>\n                <th className=\"p-3 text-left\">Received From</th>\n                <th className=\"p-3 text-right\">Amount</th>\n                <th className=\"p-3 text-left\">Payment Mode</th>\n                <th className=\"p-3 text-left\">Narration</th>\n                <th className=\"p-3 text-center\">Actions</th>\n              </tr>\n            </thead>\n            <tbody>\n              {vouchers.length === 0 ? (\n                <tr>\n                  <td colSpan={7} className=\"p-4 text-center text-gray-400\">\n                    No CRVs found\n                  </td>\n                </tr>\n              ) : (\n                vouchers.map((v) => (\n                  <tr key={v.id} className=\"border-t hover:bg-gray-50\">\n                    <td className=\"p-3 font-bold\">{v.voucherNo}</td>\n                    <td className=\"p-3\">{v.date}</td>\n                    <td className=\"p-3\">{v.accountName}</td>\n                    <td className=\"p-3 text-right\">{v.amount.toLocaleString()}</td>\n                    <td className=\"p-3\">{v.paymentMode}</td>\n                    <td className=\"p-3\">{v.narration}</td>\n                    <td className=\"p-3 text-center space-x-2\">\n                      <button\n                        onClick={() => startEdit(v)}\n                        className=\"text-blue-600 hover:text-blue-800 font-medium text-sm\"\n                      >\n                        Edit\n                      </button>\n                      <button\n                        onClick={() => deleteVoucher(v.id)}\n                        className=\"text-red-600 hover:text-red-800 font-medium text-sm\"\n                      >\n                        Delete\n                      </button>\n                    </td>\n                  </tr>\n                ))\n              )}\n            </tbody>\n          </table>\n        </div>\n      )}\n\n      {/* FORM */}\n      {showForm && (\n        <div className=\"border p-4 space-y-3 bg-white print:hidden\">\n          <h2 className=\"text-xl font-bold\">\n            {editing ? \"Edit CRV\" : \"New CRV\"}\n          </h2>\n\n          <select\n            className=\"border px-3 py-2 w-full\"\n            value={accountId}\n            onChange={(e) => {\n              const id = e.target.value;\n              setAccountId(id);\n              const acc = customers.find(c => c.id === id);\n              setSelectedName(acc?.name || \"\");\n              setSelectedPhone(acc?.phone || \"\");\n            }}\n          >\n            <option value=\"\">Received From (Customer/Bank)</option>\n            {customers.map(c => (\n              <option key={c.id} value={c.id}>\n                {c.name}\n              </option>\n            ))}\n          </select>\n\n          <div>\n            <label className=\"block text-sm font-semibold mb-1\">Payment Method</label>\n            <select\n              className=\"border px-3 py-2 w-full\"\n              value={bankAccountId}\n              onChange={(e) => setBankAccountId(e.target.value)}\n            >\n              <option value=\"\">Cash</option>\n              {bankAccounts.map(bank => (\n               <option key={bank.id} value={bank.rawId}>\n  {bank.name}\n</option>\n\n              ))}\n            </select>\n          </div>\n\n          <input\n            className=\"border px-3 py-2 w-full\"\n            placeholder=\"Amount\"\n            type=\"number\"\n            step=\"0.01\"\n            value={amount}\n            onChange={(e) => setAmount(e.target.value)}\n          />\n\n          <input\n            type=\"date\"\n            className=\"border px-3 py-2 w-full\"\n            value={date}\n            onChange={(e) => setDate(e.target.value)}\n          />\n\n          <textarea\n            className=\"border px-3 py-2 w-full\"\n            placeholder=\"Narration\"\n            value={narration}\n            onChange={(e) => setNarration(e.target.value)}\n          />\n\n          <div className=\"flex gap-2\">\n            <button\n              onClick={saveCRV}\n              disabled={saving}\n              className=\"bg-black text-white px-4 py-2 flex-1\"\n            >\n              {saving ? \"Saving...\" : editing ? \"Update CRV\" : \"Save CRV\"}\n            </button>\n            <button\n              onClick={() => {\n                setShowForm(false);\n                setEditing(null);\n                resetForm();\n              }}\n              className=\"bg-gray-600 text-white px-4 py-2\"\n            >\n              Cancel\n            </button>\n          </div>\n        </div>\n      )}\n\n      {/* PRINT PREVIEW */}\n      {voucher && (\n        <div className=\"overflow-x-auto\">\n          <div className=\"invoice-print max-w-[210mm] mx-auto bg-white p-8 border-2 border-black text-black shadow-lg min-w-[700px]\">\n            <div className=\"flex justify-between items-start border-b-4 border-black pb-4 mb-8\">\n            <div>\n              <h1 className=\"text-4xl font-black italic tracking-tighter uppercase\">US TRADERS</h1>\n              <p className=\"text-[10px] font-bold tracking-[3px] text-gray-600 uppercase\">Industrial Goods & Services</p>\n            </div>\n            <div className=\"text-right\">\n              <h2 className=\"text-2xl font-black uppercase underline decoration-2 underline-offset-4\">\n                Receipt Voucher\n              </h2>\n              <div className=\"mt-2 text-sm font-bold space-y-1\">\n                <p>No: <span className=\"font-mono\">{voucher.voucherNo}</span></p>\n                <p>Date: {voucher.date?.split('T')[0] || date}</p>\n              </div>\n            </div>\n          </div>\n\n          <div className=\"space-y-8 my-10\">\n            <div className=\"flex items-end gap-4 border-b border-gray-300 pb-2\">\n              <span className=\"text-xs font-black uppercase w-32 shrink-0\">Received From:</span>\n              <span className=\"text-xl font-bold uppercase flex-1 border-b-2 border-black px-2\">\n                {voucher.accountName || selectedName}\n              </span>\n            </div>\n\n            <div className=\"flex items-end gap-4 border-b border-gray-300 pb-2\">\n              <span className=\"text-xs font-black uppercase w-32 shrink-0\">Amount (PKR):</span>\n              <span className=\"text-xl font-bold italic flex-1 border-b-2 border-black px-2\">\n                Rs. {Number(voucher.amount || amount || 0).toLocaleString()}/-\n              </span>\n            </div>\n\n            <div className=\"flex items-start gap-4 border-b border-gray-300 pb-2\">\n              <span className=\"text-xs font-black uppercase w-32 shrink-0\">Description:</span>\n              <span className=\"text-sm font-medium flex-1 border-b border-black px-2 italic\">\n                {narration || \"Official transaction recorded.\"}\n              </span>\n            </div>\n          </div>\n\n          <div className=\"mt-16 flex justify-between items-end px-2\">\n            <div className=\"bg-gray-100 border-4 border-black p-4 flex flex-col min-w-[200px]\">\n              <span className=\"text-[10px] font-black uppercase border-b border-black mb-1\">Net Amount Rec</span>\n              <span className=\"text-3xl font-black italic\">\n                {Number(voucher.amount || amount || 0).toLocaleString()}\n              </span>\n            </div>\n            <div className=\"flex gap-12\">\n              <div className=\"text-center w-32 border-t-2 border-black mt-12 pt-1 font-bold text-[10px] uppercase\">Receiver Sign</div>\n              <div className=\"text-center w-32 border-t-2 border-black mt-12 pt-1 font-bold text-[10px] uppercase\">Accountant</div>\n            </div>\n          </div>\n\n          <div className=\"flex gap-3 mt-10 print:hidden justify-center\">\n            <button onClick={printVoucher} className=\"bg-black text-white px-8 py-2 font-bold hover:bg-gray-800 transition-all shadow-md\">\n              Print Now\n            </button>\n            <button onClick={sendWhatsApp} className=\"bg-green-600 text-white px-8 py-2 font-bold hover:bg-green-700 transition-all shadow-md\">\n              WhatsApp\n            </button>\n            <button onClick={() => { setVoucher(null); resetForm(); }} className=\"bg-white text-black border-2 border-black px-8 py-2 font-bold hover:bg-gray-100\">\n              New Entry\n            </button>\n          </div>\n        </div>\n        </div>\n      )}\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\dashboard\\currencies\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\dashboard\\debit-note\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\dashboard\\delivery-challan\\page.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'loadChallans' and 'user'. Either include them or remove the dependency array.","line":113,"column":6,"nodeType":"ArrayExpression","endLine":113,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [loadChallans, user]","fix":{"range":[3525,3527],"text":"[loadChallans, user]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { useEffect, useState } from \"react\";\nimport toast from \"react-hot-toast\";\nimport { getCurrentUser } from \"@/lib/auth\";\nimport { hasPermission } from \"@/lib/hasPermission\";\nimport { PERMISSIONS } from \"@/lib/permissions\";\nimport { useRouter } from \"next/navigation\";\n\n\ntype Account = { id: string; name: string };\ntype Item = {\n  id: string;\n  name: string;\n  description?: string;\n  availableQty: number;\n};\ntype Row = {\n  itemId: string;\n  name: string;\n  description: string;\n  availableQty: number;\n  qty: number | \"\";\n  rate: number | \"\";\n};\n\ntype DeliveryChallan = {\n  id: string;\n  challanNo: string;\n  date: string;\n  customerId: string;\n  customer?: { name: string };\n  driverName?: string;\n  vehicleNo?: string;\n  remarks?: string;\n  items: Array<{ item: { name: string; description?: string }; qty: number; rate?: number }>;\n  status: string;\n};\n\nexport default function DeliveryChallanPage() {\n  const _router = useRouter();\n  const today = new Date().toISOString().slice(0, 10);\n  const user = getCurrentUser();\n\n  const [_authorized, setAuthorized] = useState(false);\n  const [loading, setLoading] = useState(true);\n\n  const [customers, setCustomers] = useState<Account[]>([]);\n  const [items, setItems] = useState<Item[]>([]);\n  const [challans, setChallans] = useState<DeliveryChallan[]>([]);\n  const [showList, setShowList] = useState(false);\n  const [showForm, setShowForm] = useState(true);\n  const [editing, setEditing] = useState<DeliveryChallan | null>(null);\n\n  const [challanNo, setChallanNo] = useState(\"\");\n  const [customerId, setCustomerId] = useState(\"\");\n  const [customerName, setCustomerName] = useState(\"\");\n  const [date, setDate] = useState(today);\n  const [driverName, setDriverName] = useState(\"\");\n  const [vehicleNo, setVehicleNo] = useState(\"\");\n  const [remarks, setRemarks] = useState(\"\");\nconst [searchTerm, _setSearchTerm] = useState(\"\");\n\n\n  const [rows, setRows] = useState<Row[]>([{\n    itemId: \"\", name: \"\", description: \"\", availableQty: 0, qty: \"\", rate: \"\",\n  }]);\n  const [saving, setSaving] = useState(false);\n  const [preview, setPreview] = useState(false);\n  const [savedChallan, setSavedChallan] = useState<Any>(null);\n\n  useEffect(() => {\n    if (!user) {\n      setLoading(false);\n      return;\n    }\n    // Using CREATE_QUOTATION as a proxy permission or if there's a specific one like CREATE_DELIVERY_CHALLAN\n    // Assuming if they can create quotation/invoice, they can create challan.\n    // Ideally we should add CREATE_DELIVERY_CHALLAN to permissions, but for now reuse or check role.\n    if (!hasPermission(user, PERMISSIONS.CREATE_QUOTATION)) { // Fallback permission check\n       // You might want to update permissions lib later\n    }\n    setAuthorized(true);\n    \n    // Load initial data\n    loadChallans();\n    \n    fetch(\"/api/accounts\", {\n      headers: { \"x-user-role\": user.role },\n    })\n      .then(r => r.json())\n      .then(d => {\n        const list = Array.isArray(d) ? d : d.accounts || [];\n        setCustomers(list.filter((a: Any) => a.partyType === \"CUSTOMER\"));\n      });\n\n    fetch(\"/api/stock-available-for-sale\")\n      .then(r => r.json())\n      .then(d => setItems(Array.isArray(d) ? d : []));\n\n    fetch(\"/api/delivery-challan\", {\n        headers: {\n            \"x-user-role\": user.role || \"\",\n            \"x-user-id\": user.id || \"\"\n        }\n    })\n    .then(r => r.json())\n    .then(_d => {\n        // If there's logic to get nextNo from API, otherwise just handle in state\n    });\n\n    setLoading(false);\n  }, []);\n  const shareOnSMS = () => {\n  const msg = \"Your delivery challan details\";\n  window.open(`sms:?body=${encodeURIComponent(msg)}`);\n};\n\n\n  // Keyboard shortcuts\n  useEffect(() => {\n    function handleKeyPress(e: KeyboardEvent) {\n      if (e.code === \"F7\" || e.key === \"F7\") {\n        e.preventDefault();\n        if (showForm && !preview) {\n          setDate(today);\n          setCustomerId(\"\");\n          setCustomerName(\"\");\n          setDriverName(\"\");\n          setVehicleNo(\"\");\n          setRemarks(\"\");\n        }\n      }\n      if (e.code === \"F8\" || e.key === \"F8\") {\n        e.preventDefault();\n        if (showForm && !preview) {\n          const query = prompt(\"Enter search query (Challan No, Customer Name, etc.):\");\n          if (query) {\n            const foundCustomer = customers.find(c => \n              c.name.toLowerCase().includes(query.toLowerCase())\n            );\n            if (foundCustomer) {\n              setCustomerId(foundCustomer.id);\n              setCustomerName(foundCustomer.name);\n            } else {\n              toast.error(`No customer found matching \"${query}\"`);\n            }\n          }\n        }\n      }\n    }\n    document.addEventListener(\"keydown\", handleKeyPress, true);\n    return () => document.removeEventListener(\"keydown\", handleKeyPress, true);\n  }, [today, showForm, preview, customers]);\n\n  async function loadChallans() {\n    try {\n      const res = await fetch(\"/api/delivery-challan\", {\n        headers: {\n          \"x-user-role\": user?.role || \"\",\n          \"x-user-id\": user?.id || \"\"\n        }\n      });\n      const data = await res.json();\n      if (Array.isArray(data)) {\n        setChallans(data);\n      }\n    } catch (e) {\n      console.error(\"Load challans error:\", e);\n    }\n  }\n\n  function addRow() {\n    setRows(r => [\n      ...r,\n      { itemId: \"\", name: \"\", description: \"\", availableQty: 0, qty: \"\", rate: \"\" },\n    ]);\n  }\n\n  function selectItem(index: number, itemId: string) {\n    const item = items.find(i => i.id === itemId);\n    if (!item) return;\n    const copy = [...rows];\n    copy[index] = {\n      ...copy[index],\n      itemId: item.id,\n      name: item.name,\n      description: item.description || \"\",\n      availableQty: item.availableQty,\n      qty: \"\",\n    };\n    setRows(copy);\n  }\n\n  function updateRow(index: number, key: \"qty\" | \"rate\", val: string) {\n    const copy = [...rows];\n    const num = val === \"\" ? \"\" : Number(val);\n    copy[index][key] = num;\n    setRows(copy);\n  }\n\n  async function saveChallan() {\n    const clean = rows.filter(r => r.itemId && r.qty);\n    if (!customerId || !clean.length) {\n      toast.error(\"Customer aur items zaroori hain\");\n      return;\n    }\n\n    setSaving(true);\n    try {\n      const method = editing ? \"PUT\" : \"POST\";\n      const baseBody = {\n        challanNo,\n        customerId,\n        date,\n        driverName: driverName || null,\n        vehicleNo: vehicleNo || null,\n        remarks: remarks || null,\n        items: clean.map(r => ({ itemId: r.itemId, qty: Number(r.qty), rate: Number(r.rate) || 0 })),\n      };\n      const body = editing ? { id: editing.id, ...baseBody } : baseBody;\n\n      const res = await fetch(\"/api/delivery-challan\", {\n        method,\n        headers: { \n          \"Content-Type\": \"application/json\",\n          \"x-user-role\": user?.role || \"\",\n          \"x-user-id\": user?.id || \"\"\n        },\n        body: JSON.stringify(body),\n      });\n      \n      if (!res.ok) {\n        const errorData = await res.json();\n        throw new Error(errorData.error || \"Save failed\");\n      }\n      \n      const data = await res.json();\n      \n      if (data) {\n        setSavedChallan(data);\n        setChallanNo(data.challanNo || challanNo);\n        setCustomerName(customers.find(c => c.id === customerId)?.name || customerName);\n      }\n      \n      setPreview(true);\n      await loadChallans();\n      if (editing) {\n        setEditing(null);\n        setShowForm(false);\n        setShowList(true);\n      }\n      toast.success(\"Delivery Challan saved successfully!\");\n    } catch (e: Any) {\n      toast.error(\"Saving failed: \" + (e.message || \"Unknown error\"));\n    } finally {\n      setSaving(false);\n    }\n  }\n\n  function startEdit(c: DeliveryChallan) {\n    setEditing(c);\n    setChallanNo(c.challanNo);\n    setCustomerId(c.customerId);\n    setCustomerName(c.customer?.name || \"\");\n    setDate(new Date(c.date).toISOString().slice(0, 10));\n    setDriverName(c.driverName || \"\");\n    setVehicleNo(c.vehicleNo || \"\");\n    setRemarks(c.remarks || \"\");\n    setRows(c.items.map((it: Any) => ({\n      itemId: it.itemId || \"\",\n      name: it.item?.name || \"\",\n      description: it.item?.description || \"\",\n      availableQty: 0, // Not needed for edit\n      qty: it.qty.toString(),\n      rate: it.rate ? it.rate.toString() : \"\",\n    })));\n    setShowForm(true);\n    setShowList(false);\n  }\n\n  async function deleteChallan(id: string) {\n    if (!confirm(\"Are you sure you want to delete this delivery challan?\")) return;\n    try {\n      const res = await fetch(`/api/delivery-challan?id=${id}`, {\n        method: \"DELETE\",\n        headers: {\n          \"x-user-role\": user?.role || \"\",\n          \"x-user-id\": user?.id || \"\"\n        },\n      });\n      if (res.ok) {\n        toast.success(\"Delivery Challan deleted successfully\");\n        await loadChallans();\n      } else {\n        const err = await res.json();\n        toast.error(err.error || \"Delete failed\");\n      }\n    } catch (_e) {\n      toast.error(\"Delete failed\");\n    }\n  }\n\n  function resetForm() {\n    setEditing(null);\n    setCustomerId(\"\");\n    setCustomerName(\"\");\n    setDate(today);\n    setDriverName(\"\");\n    setVehicleNo(\"\");\n    setRemarks(\"\");\n    setRows([{ itemId: \"\", name: \"\", description: \"\", availableQty: 0, qty: \"\", rate: \"\" }]);\n    setPreview(false);\n  }\n\n  // Share on WhatsApp\n  const shareOnWhatsApp = () => {\n    if (!savedChallan) {\n      toast.error(\"Please save the challan first\");\n      return;\n    }\n    \n    // Construct a message\n    let message = `*Delivery Challan: ${savedChallan.challanNo}*\\n`;\n    message += `Date: ${new Date(savedChallan.date).toLocaleDateString()}\\n`;\n    message += `Customer: ${customerName}\\n`;\n    if (savedChallan.driverName) message += `Driver: ${savedChallan.driverName}\\n`;\n    if (savedChallan.vehicleNo) message += `Vehicle: ${savedChallan.vehicleNo}\\n`;\n    message += `\\n*Items:*\\n`;\n    \n    savedChallan.items.forEach((item: Any, index: number) => {\n      // Fetch item name from local items if possible, or use from savedChallan if populated\n      // savedChallan.items might not have item details fully if not populated in response, but let's assume API returns it or we use logic\n      // Actually API returns items with included item details in GET but create/update response might vary.\n      // Ideally use local items map if needed or ensure API returns included.\n      // The API create/update returns just the main object usually, but let's trust we can reconstruct or refetch.\n      // Wait, create/update response in my API route above does NOT include relation `items` fully populated with `item` name.\n      // It returns `items` array of created objects.\n      // I should rely on `rows` state for names if savedChallan is fresh, or fetch proper object.\n      // For simplicity, let's use `rows` since it matches the saved state.\n      \n      const row = rows[index];\n      message += `${index + 1}. ${row.name} x ${item.qty} ${row.description ? `(${row.description})` : ''}\\n`;\n    });\n    \n    const url = `https://wa.me/?text=${encodeURIComponent(message)}`;\n    window.open(url, '_blank');\n  };\n\n  if (loading) return <div className=\"p-6\">Loading...</div>;\n  // if (!authorized) return <div className=\"p-6 text-red-600\">Access Denied</div>;\n\n  const filteredChallans = challans.filter(c => {\n  const term = searchTerm.toLowerCase();\n\n  return (\n    c.challanNo?.toLowerCase().includes(term) ||\n    c.customer?.name?.toLowerCase().includes(term) ||\n    c.date?.toLowerCase().includes(term)\n  );\n});\n\n\n  return (\n    <div className=\"p-6 space-y-6\">\n      <div className=\"flex justify-between items-center\">\n        <h1 className=\"text-2xl font-bold\">Delivery Challan</h1>\n        <div className=\"flex gap-2\">\n          <button\n            onClick={() => { setShowList(!showList); setShowForm(!showForm); setEditing(null); }}\n            className=\"bg-gray-600 text-white px-4 py-2 rounded\"\n          >\n            {showList ? \"Hide List\" : \"Show List\"}\n          </button>\n          <button\n            onClick={() => { setShowForm(true); setShowList(false); resetForm(); loadChallans(); }}\n            className=\"bg-blue-600 text-white px-4 py-2 rounded\"\n          >\n            + New Challan\n          </button>\n        </div>\n      </div>\n\n      {/* LIST VIEW */}\n      {showList && (\n        <div className=\"bg-white border rounded overflow-hidden overflow-x-auto\">\n          <table className=\"w-full text-sm min-w-[600px]\">\n            <thead className=\"bg-gray-100\">\n              <tr>\n                <th className=\"p-3 text-left\">Challan No</th>\n                <th className=\"p-3 text-left\">Date</th>\n                <th className=\"p-3 text-left\">Customer</th>\n                <th className=\"p-3 text-left\">Vehicle/Driver</th>\n                <th className=\"p-3 text-left\">Status</th>\n                <th className=\"p-3 text-center\">Actions</th>\n              </tr>\n            </thead>\n            <tbody>\n              {filteredChallans.length === 0 ? (\n                <tr>\n                  <td colSpan={7} className=\"p-4 text-center text-gray-400\">No challans found</td>\n                </tr>\n              ) : (\n                filteredChallans.map(c => (\n                  <tr key={c.id} className=\"border-t hover:bg-gray-50\">\n                    <td className=\"p-3 font-bold\">{c.challanNo}</td>\n                    <td className=\"p-3\">{new Date(c.date).toLocaleDateString()}</td>\n                    <td className=\"p-3\">{c.customer?.name || \"N/A\"}</td>\n                    <td className=\"p-3\">\n                        {c.vehicleNo && <span className=\"block text-xs\">🚗 {c.vehicleNo}</span>}\n                        {c.driverName && <span className=\"block text-xs\">👤 {c.driverName}</span>}\n                    </td>\n                    <td className=\"p-3\">\n                      <span className={`px-2 py-1 rounded text-xs ${c.status === 'DELIVERED' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}`}>\n                        {c.status}\n                      </span>\n                    </td>\n                    <td className=\"p-3 text-center space-x-2\">\n                      <button\n                        onClick={() => startEdit(c)}\n                        className=\"text-blue-600 hover:text-blue-800 font-medium text-sm\"\n                      >\n                        Edit\n                      </button>\n                      <button\n                        onClick={() => deleteChallan(c.id)}\n                        className=\"text-red-600 hover:text-red-800 font-medium text-sm\"\n                      >\n                        Delete\n                      </button>\n                    </td>\n                  </tr>\n                ))\n              )}\n            </tbody>\n          </table>\n        </div>\n      )}\n\n      {/* FORM */}\n      {showForm && (\n        <>\n          <div className=\"flex flex-col md:flex-row justify-between items-center bg-gray-50 p-4 border rounded print:hidden gap-4\">\n            <h1 className=\"text-2xl font-bold\">Delivery Challan ({challanNo || \"New\"})</h1>\n            {!preview ? (\n              <div className=\"flex flex-wrap gap-2\">\n                <button onClick={saveChallan} disabled={saving} className=\"bg-blue-600 text-white px-6 py-2 rounded flex-1 md:flex-none\">\n                  {saving ? \"Saving...\" : editing ? \"Update Challan\" : \"Save & Preview\"}\n                </button>\n                <button onClick={() => { setShowForm(false); setEditing(null); resetForm(); }} className=\"bg-gray-600 text-white px-6 py-2 rounded flex-1 md:flex-none\">\n                  Cancel\n                </button>\n              </div>\n            ) : (\n              <div className=\"flex flex-wrap gap-2\">\n                <button onClick={() => window.print()} className=\"bg-green-600 text-white px-6 py-2 rounded flex-1 md:flex-none\">\n                  Print\n                </button>\n                <button \n                  onClick={shareOnWhatsApp}\n                  className=\"bg-green-500 text-white px-6 py-2 rounded hover:bg-green-600 flex-1 md:flex-none\"\n                >\n                  📱 WhatsApp\n                </button>\n                <button \n                  onClick={shareOnSMS}\n                  className=\"bg-blue-500 text-white px-6 py-2 rounded hover:bg-blue-600 flex-1 md:flex-none\"\n                >\n                  💬 SMS\n                </button>\n                <button onClick={() => setPreview(false)} className=\"bg-yellow-600 text-white px-6 py-2 rounded flex-1 md:flex-none\">\n                  Edit\n                </button>\n                <button onClick={() => { setPreview(false); resetForm(); }} className=\"bg-gray-600 text-white px-6 py-2 rounded flex-1 md:flex-none\">\n                  New Challan\n                </button>\n              </div>\n            )}\n          </div>\n\n          {!preview && (\n            <div className=\"bg-white border p-6 rounded space-y-4\">\n              <div className=\"mb-2 text-xs text-gray-500 italic\">\n                💡 Keyboard Shortcuts: <strong>F7</strong> = Clear Form | <strong>F8</strong> = Search Customer\n              </div>\n              <div className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4\">\n                <input value={challanNo} readOnly className=\"border p-2 bg-gray-100\" placeholder=\"Challan No (Auto)\" />\n                <div>\n                  <label className=\"text-xs font-bold\">Customer</label>\n                  <select className=\"border p-2 w-full\" value={customerId} onChange={e => {\n                    setCustomerId(e.target.value);\n                    setCustomerName(customers.find(c => c.id === e.target.value)?.name || \"\");\n                  }}>\n                    <option value=\"\">Select Customer</option>\n                    {customers.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}\n                  </select>\n                </div>\n                <div>\n                  <label className=\"text-xs font-bold\">Date</label>\n                  <input type=\"date\" className=\"border p-2 w-full\" value={date} onChange={e => setDate(e.target.value)} />\n                </div>\n                <div>\n                  <label className=\"text-xs font-bold\">Status</label>\n                   <input type=\"text\" value=\"PENDING\" disabled className=\"border p-2 w-full bg-gray-100\" />\n                </div>\n              </div>\n\n              <div className=\"grid grid-cols-1 sm:grid-cols-3 gap-4\">\n                 <div>\n                    <label className=\"text-xs font-bold\">Driver Name</label>\n                    <input className=\"border p-2 w-full\" value={driverName} onChange={e => setDriverName(e.target.value)} placeholder=\"Driver Name\" />\n                 </div>\n                 <div>\n                    <label className=\"text-xs font-bold\">Vehicle No</label>\n                    <input className=\"border p-2 w-full\" value={vehicleNo} onChange={e => setVehicleNo(e.target.value)} placeholder=\"Vehicle No\" />\n                 </div>\n                 <div>\n                    <label className=\"text-xs font-bold\">Remarks</label>\n                    <input className=\"border p-2 w-full\" value={remarks} onChange={e => setRemarks(e.target.value)} placeholder=\"Any remarks...\" />\n                 </div>\n              </div>\n\n              <div className=\"overflow-x-auto\">\n                <table className=\"w-full border mt-4 text-sm min-w-[600px]\">\n                  <thead className=\"bg-gray-100\">\n                    <tr>\n                      <th className=\"border p-2 text-left\">Item</th>\n                      <th className=\"border p-2 w-24\">Qty</th>\n                      <th className=\"border p-2 w-32\">Rate (Opt)</th>\n                      <th className=\"border p-2 w-32 text-right\">Amount (Est)</th>\n                    </tr>\n                  </thead>\n                  <tbody>\n                    {rows.map((r, i) => (\n                      <tr key={i}>\n                        <td className=\"border p-2\">\n                          <select className=\"w-full\" value={r.itemId} onChange={e => selectItem(i, e.target.value)}>\n                            <option value=\"\">Select Item</option>\n                            {items.map(it => (\n                              <option key={it.id} value={it.id}>\n                                {it.name} ({it.description})\n                              </option>\n                            ))}\n                          </select>\n                        </td>\n                        <td className=\"border p-2\">\n                          <input type=\"number\" value={r.qty} className=\"w-full text-center\" onChange={e => updateRow(i, \"qty\", e.target.value)} />\n                        </td>\n                        <td className=\"border p-2\">\n                          <input type=\"number\" value={r.rate} className=\"w-full text-center\" onChange={e => updateRow(i, \"rate\", e.target.value)} placeholder=\"Optional\" />\n                        </td>\n                        <td className=\"border p-2 text-right\">\n                          {(Number(r.qty) * Number(r.rate) || 0).toLocaleString()}\n                        </td>\n                      </tr>\n                    ))}\n                  </tbody>\n                </table>\n              </div>\n              <button onClick={addRow} className=\"bg-gray-100 px-4 py-1 rounded\">+ Add Row</button>\n            </div>\n          )}\n\n          {/* PREVIEW */}\n          {preview && (\n            <div className=\"bg-white border p-8 rounded shadow-lg mt-6 print:border-none print:shadow-none\" id=\"print-area\">\n              <div className=\"text-center mb-8\">\n                <h1 className=\"text-3xl font-bold uppercase tracking-wide\">Delivery Challan</h1>\n                <p className=\"text-gray-500\">No: {savedChallan?.challanNo || challanNo}</p>\n              </div>\n\n              <div className=\"flex justify-between mb-8\">\n                <div>\n                  <h3 className=\"font-bold text-gray-700\">Customer:</h3>\n                  <p className=\"text-xl font-bold\">{customerName}</p>\n                  <p className=\"text-sm text-gray-500\">ID: {customerId}</p>\n                </div>\n                <div className=\"text-right\">\n                  <h3 className=\"font-bold text-gray-700\">Details:</h3>\n                  <p>Date: {new Date(date).toLocaleDateString()}</p>\n                  {driverName && <p>Driver: {driverName}</p>}\n                  {vehicleNo && <p>Vehicle: {vehicleNo}</p>}\n                </div>\n              </div>\n\n              <table className=\"w-full mb-8\">\n                <thead>\n                  <tr className=\"bg-gray-800 text-white\">\n                    <th className=\"p-3 text-left\">#</th>\n                    <th className=\"p-3 text-left\">Item Description</th>\n                    <th className=\"p-3 text-right\">Qty</th>\n                    <th className=\"p-3 text-right\">Rate</th>\n                    <th className=\"p-3 text-right\">Amount</th>\n                  </tr>\n                </thead>\n                <tbody>\n                  {rows.map((row, index) => (\n                    <tr key={index} className=\"border-b\">\n                      <td className=\"p-3\">{index + 1}</td>\n                      <td className=\"p-3\">\n                        <span className=\"font-bold block\">{row.name}</span>\n                        <span className=\"text-sm text-gray-500\">{row.description}</span>\n                      </td>\n                      <td className=\"p-3 text-right font-bold\">{row.qty}</td>\n                      <td className=\"p-3 text-right\">{row.rate || \"-\"}</td>\n                      <td className=\"p-3 text-right\">{(Number(row.qty) * Number(row.rate) || 0).toLocaleString()}</td>\n                    </tr>\n                  ))}\n                </tbody>\n              </table>\n\n              {remarks && (\n                <div className=\"mb-8\">\n                  <h3 className=\"font-bold text-gray-700\">Remarks:</h3>\n                  <p className=\"text-gray-600\">{remarks}</p>\n                </div>\n              )}\n\n              <div className=\"flex justify-between mt-12 pt-8 border-t\">\n                <div className=\"text-center w-32\">\n                    <p className=\"border-t border-gray-400 mt-8 pt-2\">Prepared By</p>\n                </div>\n                <div className=\"text-center w-32\">\n                    <p className=\"border-t border-gray-400 mt-8 pt-2\">Checked By</p>\n                </div>\n                <div className=\"text-center w-32\">\n                    <p className=\"border-t border-gray-400 mt-8 pt-2\">Received By</p>\n                </div>\n              </div>\n            </div>\n          )}\n        </>\n      )}\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\dashboard\\email-settings\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\dashboard\\employees\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\dashboard\\expense-vouchers\\page.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchVouchers'. Either include it or remove the dependency array.","line":57,"column":6,"nodeType":"ArrayExpression","endLine":57,"endColumn":20,"suggestions":[{"desc":"Update the dependencies array to be: [fetchVouchers, statusFilter]","fix":{"range":[1412,1426],"text":"[fetchVouchers, statusFilter]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\r\n\r\nimport { useEffect, useState } from 'react';\r\nimport { toast } from 'react-hot-toast';\r\n\r\ninterface ExpenseVoucher {\r\n  id: string;\r\n  voucherNo: string;\r\n  date: string;\r\n  description: string;\r\n  totalAmount: number;\r\n  approvalStatus: string;\r\n  expenseAccount?: { id: string; name: string };\r\n  paymentAccount?: { id: string; name: string };\r\n  items?: ExpenseItem[];\r\n}\r\n\r\n\r\n\r\ninterface ExpenseItem {\r\n  description: string;\r\n  amount: number;\r\n  category: string;\r\n}\r\ntype AccountWithMeta = {\r\n  id: string;\r\n  code?: string;\r\n  name: string;\r\n  type?: string | null;\r\n  partyType?: string | null;\r\n};\r\n\r\n\r\n\r\n\r\nexport default function ExpenseVouchersPage() {\r\n  const [vouchers, setVouchers] = useState<ExpenseVoucher[]>([]);\r\n  const [accounts, setAccounts] = useState<AccountWithMeta[]>([]);\r\n  const [showForm, setShowForm] = useState(true);\r\n  const [items, setItems] = useState<ExpenseItem[]>([\r\n    { description: '', amount: 0, category: '' },\r\n  ]);\r\n  const [formData, setFormData] = useState({\r\n    voucherNo: '',\r\n    date: new Date().toISOString().split('T')[0],\r\n    description: '',\r\n    expenseAccountId: '',\r\n    paymentAccountId: '',\r\n  });\r\n  const [loading, setLoading] = useState(false);\r\n  const [statusFilter, setStatusFilter] = useState('');\r\n  const [editingId, setEditingId] = useState('');\r\n\r\n  useEffect(() => {\r\n    fetchVouchers();\r\n    fetchAccounts();\r\n  }, [statusFilter]);\r\n\r\n  const fetchVouchers = async () => {\r\n    try {\r\n      let url = '/api/expense-vouchers';\r\n      if (statusFilter) url += `?status=${statusFilter}`;\r\n      const response = await fetch(url);\r\n      const data = await response.json();\r\n      setVouchers(data);\r\n    } catch (error) {\r\n      console.error('Error fetching vouchers:', error);\r\n    }\r\n  };\r\n\r\n  const fetchAccounts = async () => {\r\n    try {\r\n      // User role header zaroori hai warna API data nahi degi\r\n      const user = JSON.parse(localStorage.getItem('user') || '{}');\r\n      const role = (user.role || user?.user?.role || 'ADMIN').toUpperCase();\r\n      const response = await fetch('/api/accounts', {\r\n        headers: { 'x-user-role': role }\r\n      });\r\n      const data = await response.json();\r\n      setAccounts(Array.isArray(data) ? data : []);\r\n    } catch (error) {\r\n      console.error('Error fetching accounts:', error);\r\n      setAccounts([]);\r\n    }\r\n  };\r\n\r\n  const handleAddItem = () => {\r\n    setItems([\r\n      ...items,\r\n      { description: '', amount: 0, category: '' },\r\n    ]);\r\n  };\r\n\r\n  const handleRemoveItem = (index: number) => {\r\n    setItems(items.filter((_, i) => i !== index));\r\n  };\r\n\r\n  const handleItemChange = (\r\n    index: number,\r\n    field: string,\r\n    value: Any\r\n  ) => {\r\n    const newItems = [...items];\r\n    newItems[index] = { ...newItems[index], [field]: value };\r\n    setItems(newItems);\r\n  };\r\n\r\n  const totalAmount = items.reduce((sum, item) => sum + item.amount, 0);\r\n\r\n  const handleSubmit = async (e: React.FormEvent) => {\r\n    e.preventDefault();\r\n    setLoading(true);\r\n    try {\r\n      const method = editingId ? 'PUT' : 'POST';\r\n      const url = editingId ? `/api/expense-vouchers?id=${editingId}` : '/api/expense-vouchers';\r\n\r\n      const response = await fetch(url, {\r\n        method,\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({\r\n          id: editingId,\r\n          ...formData,\r\n          totalAmount,\r\n          items: items.map(item => ({\r\n            ...item,\r\n            amount: parseFloat(item.amount.toString()),\r\n          })),\r\n        }),\r\n      });\r\n\r\n      if (response.ok) {\r\n        alert(editingId ? 'Expense voucher updated successfully' : 'Expense voucher saved successfully');\r\n        setFormData({\r\n          voucherNo: '',\r\n          date: new Date().toISOString().split('T')[0],\r\n          description: '',\r\n          expenseAccountId: '',\r\n          paymentAccountId: '',\r\n        });\r\n        setItems([{ description: '', amount: 0, category: '' }]);\r\n        setEditingId('');\r\n        setShowForm(false);\r\n        fetchVouchers();\r\n      }\r\n    } catch (error) {\r\n      console.error('Error saving voucher:', error);\r\n      alert('Error: Failed to save voucher');\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  const handleEdit = (voucher: ExpenseVoucher) => {\r\n    setEditingId(voucher.id);\r\n    setFormData({\r\n      voucherNo: voucher.voucherNo,\r\n      date: new Date(voucher.date).toISOString().split('T')[0],\r\n      description: voucher.description,\r\n      expenseAccountId: voucher.expenseAccount?.id || '',\r\n      paymentAccountId: voucher.paymentAccount?.id || '',\r\n    });\r\n    // Load items if available\r\n    if (voucher.items && voucher.items.length > 0) {\r\n      setItems(voucher.items.map(item => ({\r\n        description: item.description || '',\r\n        amount: item.amount || 0,\r\n        category: item.category || '',\r\n      })));\r\n    }\r\n    setShowForm(true);\r\n  };\r\n\r\n  const handleDelete = async (id: string) => {\r\n    if (!confirm('Are you sure? This cannot be undone.')) return;\r\n\r\n    try {\r\n      const response = await fetch(`/api/expense-vouchers?id=${id}`, {\r\n        method: 'DELETE',\r\n      });\r\n\r\n      if (response.ok) {\r\n        alert('Expense voucher deleted successfully');\r\n        fetchVouchers();\r\n      } else {\r\n        alert('Error: Failed to delete voucher');\r\n      }\r\n    } catch (error) {\r\n      console.error('Error deleting voucher:', error);\r\n      alert('Error: Failed to delete voucher');\r\n    }\r\n  };\r\n\r\n  const handleStatusChange = async (id: string, newStatus: string) => {\r\n    try {\r\n      const response = await fetch(`/api/expense-vouchers?id=${id}`, {\r\n        method: 'PUT',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({ id, approvalStatus: newStatus }),\r\n      });\r\n\r\n      if (response.ok) {\r\n        toast.success(`Status changed to ${newStatus}`);\r\n        fetchVouchers();\r\n      } else {\r\n        toast.error('Error: Failed to update status');\r\n      }\r\n    } catch (error) {\r\n      console.error('Error updating status:', error);\r\n      toast.error('Error: Failed to update status');\r\n    }\r\n  };\r\n\r\n  return (\r\n    <div className=\"p-6 max-w-6xl mx-auto\">\r\n      <div className=\"flex justify-between items-center mb-6\">\r\n        <h1 className=\"text-3xl font-bold\">Expense Vouchers</h1>\r\n        <button\r\n          onClick={() => setShowForm(!showForm)}\r\n          className=\"bg-green-500 text-white px-6 py-2 rounded font-semibold hover:bg-green-600\"\r\n        >\r\n          {showForm ? 'Expense List' : 'New Expense'}\r\n        </button>\r\n      </div>\r\n\r\n      {/* Form */}\r\n      {showForm && (\r\n        <form\r\n          onSubmit={handleSubmit}\r\n          className=\"bg-white p-6 rounded-lg shadow mb-6\"\r\n        >\r\n          {/* Debug: Accounts data show karo */}\r\n          {/* <pre style={{background:'#eee',padding:'8px',marginBottom:'8px',fontSize:'12px',overflow:'auto'}}>{JSON.stringify(accounts, null, 2)}</pre> */}\r\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4 mb-4\">\r\n            <div>\r\n              <label className=\"block text-sm font-semibold mb-2\">Voucher No</label>\r\n              <input\r\n                type=\"text\"\r\n                required\r\n                value={formData.voucherNo}\r\n                onChange={(e) =>\r\n                  setFormData({ ...formData, voucherNo: e.target.value })\r\n                }\r\n                className=\"w-full border border-gray-300 rounded px-3 py-2\"\r\n              />\r\n            </div>\r\n            <div>\r\n              <label className=\"block text-sm font-semibold mb-2\">Date</label>\r\n              <input\r\n                type=\"date\"\r\n                required\r\n                value={formData.date}\r\n                onChange={(e) =>\r\n                  setFormData({ ...formData, date: e.target.value })\r\n                }\r\n                className=\"w-full border border-gray-300 rounded px-3 py-2\"\r\n              />\r\n            </div>\r\n            <div>\r\n              <label className=\"block text-sm font-semibold mb-2\">Expense Account</label>\r\n              <select\r\n                required\r\n                value={formData.expenseAccountId}\r\n                onChange={(e) =>\r\n                  setFormData({\r\n                    ...formData,\r\n                    expenseAccountId: e.target.value,\r\n                  })\r\n                }\r\n                className=\"w-full border border-gray-300 rounded px-3 py-2\"\r\n              >\r\n                <option value=\"\">Select</option>\r\n                {Array.isArray(accounts) &&\r\n                  accounts\r\n                    .filter((acc: AccountWithMeta) => {\r\n                      const n = acc.name.toLowerCase();\r\n                      const t = (acc.type ?? '').toLowerCase();\r\n                      const p = (acc.partyType ?? '').toLowerCase();\r\n\r\n                      return (\r\n                        n.includes('expense') ||\r\n                        t.includes('expense') ||\r\n                        p.includes('expense')\r\n                      );\r\n                    })\r\n\r\n                    .map((account) => (\r\n                      <option key={account.id} value={account.id}>\r\n                        {account.name}\r\n                      </option>\r\n                    ))}\r\n              </select>\r\n            </div>\r\n            <div>\r\n              <label className=\"block text-sm font-semibold mb-2\">Payment Account</label>\r\n              <select\r\n                required\r\n                value={formData.paymentAccountId}\r\n                onChange={(e) =>\r\n                  setFormData({\r\n                    ...formData,\r\n                    paymentAccountId: e.target.value,\r\n                  })\r\n                }\r\n                className=\"w-full border border-gray-300 rounded px-3 py-2\"\r\n              >\r\n                <option value=\"\">Select</option>\r\n                {Array.isArray(accounts) &&\r\n                  accounts\r\n                    .filter((acc) => {\r\n                      const n = acc.name.toLowerCase();\r\n                      const t = (acc.type || '').toLowerCase();\r\n                      const p = (acc.partyType || '').toLowerCase();\r\n                      return (\r\n                        n.includes('cash') ||\r\n                        n.includes('bank') ||\r\n                        t.includes('cash') ||\r\n                        t.includes('bank') ||\r\n                        p.includes('bank')\r\n                      );\r\n                    })\r\n                    .map((account) => (\r\n                      <option key={account.id} value={account.id}>\r\n                        {account.name}\r\n                      </option>\r\n                    ))}\r\n              </select>\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"mb-4\">\r\n            <label className=\"block text-sm font-semibold mb-2\">Description</label>\r\n            <textarea\r\n              value={formData.description}\r\n              onChange={(e) =>\r\n                setFormData({ ...formData, description: e.target.value })\r\n              }\r\n              className=\"w-full border border-gray-300 rounded px-3 py-2\"\r\n              rows={2}\r\n            />\r\n          </div>\r\n\r\n          {/* Items */}\r\n          <div className=\"mb-4\">\r\n            <h3 className=\"font-semibold mb-3\">Expense Details</h3>\r\n            <table className=\"w-full border border-gray-300 rounded\">\r\n              <thead className=\"bg-gray-100\">\r\n                <tr>\r\n                  <th className=\"border px-3 py-2 text-left\">Description</th>\r\n                  <th className=\"border px-3 py-2 text-left\">Category</th>\r\n                  <th className=\"border px-3 py-2 text-right\">Amount</th>\r\n                  <th className=\"border px-3 py-2\">Action</th>\r\n                </tr>\r\n              </thead>\r\n              <tbody>\r\n                {items.map((item, index) => (\r\n                  <tr key={index}>\r\n                    <td className=\"border px-3 py-2\">\r\n                      <input\r\n                        type=\"text\"\r\n                        value={item.description}\r\n                        onChange={(e) =>\r\n                          handleItemChange(index, 'description', e.target.value)\r\n                        }\r\n                        className=\"w-full border border-gray-300 rounded px-2 py-1\"\r\n                        placeholder=\"Description\"\r\n                      />\r\n                    </td>\r\n                    <td className=\"border px-3 py-2\">\r\n                      <select\r\n                        value={item.category}\r\n                        onChange={(e) =>\r\n                          handleItemChange(index, 'category', e.target.value)\r\n                        }\r\n                        className=\"w-full border border-gray-300 rounded px-2 py-1\"\r\n                      >\r\n                        <option value=\"\">Select</option>\r\n                        <option value=\"TRAVEL\">Travel</option>\r\n                        <option value=\"FOOD\">Food</option>\r\n                        <option value=\"SUPPLIES\">Supplies</option>\r\n                        <option value=\"UTILITIES\">Utilities</option>\r\n                        <option value=\"OTHER\">Other</option>\r\n                      </select>\r\n                    </td>\r\n                    <td className=\"border px-3 py-2\">\r\n                      <input\r\n                        type=\"number\"\r\n                        step=\"0.01\"\r\n                        value={item.amount}\r\n                        onChange={(e) =>\r\n                          handleItemChange(index, 'amount', parseFloat(e.target.value))\r\n                        }\r\n                        className=\"w-full border border-gray-300 rounded px-2 py-1 text-right\"\r\n                        placeholder=\"0.00\"\r\n                      />\r\n                    </td>\r\n                    <td className=\"border px-3 py-2\">\r\n                      <button\r\n                        type=\"button\"\r\n                        onClick={() => handleRemoveItem(index)}\r\n                        className=\"text-red-500 hover:text-red-700\"\r\n                      >\r\n                        Delete\r\n                      </button>\r\n                    </td>\r\n                  </tr>\r\n                ))}\r\n              </tbody>\r\n            </table>\r\n            <button\r\n              type=\"button\"\r\n              onClick={handleAddItem}\r\n              className=\"mt-2 text-blue-500 hover:text-blue-700 font-semibold\"\r\n            >\r\n              + Add Item\r\n            </button>\r\n          </div>\r\n\r\n          <div className=\"mb-4 text-right\">\r\n            <span className=\"font-semibold text-lg\">\r\n              Total: {totalAmount.toFixed(2)}\r\n            </span>\r\n          </div>\r\n\r\n          <div className=\"flex gap-4\">\r\n            <button\r\n              type=\"submit\"\r\n              disabled={loading}\r\n              className=\"bg-blue-500 text-white px-6 py-2 rounded font-semibold hover:bg-blue-600 disabled:opacity-50\"\r\n            >\r\n              {loading ? 'Saving...' : editingId ? 'Update' : 'Save'}\r\n            </button>\r\n            <button\r\n              type=\"button\"\r\n              onClick={() => {\r\n                setShowForm(false);\r\n                setEditingId('');\r\n                setFormData({\r\n                  voucherNo: '',\r\n                  date: new Date().toISOString().split('T')[0],\r\n                  description: '',\r\n                  expenseAccountId: '',\r\n                  paymentAccountId: '',\r\n                });\r\n                setItems([{ description: '', amount: 0, category: '' }]);\r\n              }}\r\n              className=\"bg-gray-500 text-white px-6 py-2 rounded font-semibold hover:bg-gray-600\"\r\n            >\r\n              Cancel\r\n            </button>\r\n          </div>\r\n        </form>\r\n      )}\r\n\r\n      {/* Filter */}\r\n      <div className=\"mb-6\">\r\n        <select\r\n          value={statusFilter}\r\n          onChange={(e) => setStatusFilter(e.target.value)}\r\n          className=\"border border-gray-300 rounded px-4 py-2\"\r\n        >\r\n          <option value=\"\">All Status</option>\r\n          <option value=\"DRAFT\">Draft</option>\r\n          <option value=\"PENDING\">Pending</option>\r\n          <option value=\"APPROVED\">Approved</option>\r\n          <option value=\"REJECTED\">Rejected</option>\r\n        </select>\r\n      </div>\r\n\r\n      {/* List */}\r\n      <div className=\"bg-white rounded-lg shadow overflow-x-auto\">\r\n        <table className=\"w-full min-w-[800px]\">\r\n          <thead className=\"bg-gray-100\">\r\n            <tr>\r\n              <th className=\"px-6 py-3 text-left\">Voucher No</th>\r\n              <th className=\"px-6 py-3 text-left\">Date</th>\r\n              <th className=\"px-6 py-3 text-left\">Amount</th>\r\n              <th className=\"px-6 py-3 text-left\">Status</th>\r\n              <th className=\"px-6 py-3 text-left\">Actions</th>\r\n            </tr>\r\n          </thead>\r\n          <tbody>\r\n            {vouchers.map((voucher) => (\r\n              <tr key={voucher.id} className=\"border-b hover:bg-gray-50\">\r\n                <td className=\"px-6 py-3 font-semibold\">{voucher.voucherNo}</td>\r\n                <td className=\"px-6 py-3\">\r\n                  {new Date(voucher.date).toLocaleDateString()}\r\n                </td>\r\n                <td className=\"px-6 py-3\">{voucher.totalAmount.toFixed(2)}</td>\r\n                <td className=\"px-6 py-3\">\r\n                  <span className={`px-3 py-1 rounded text-white text-sm ${voucher.approvalStatus === 'DRAFT' ? 'bg-gray-500' :\r\n                      voucher.approvalStatus === 'PENDING' ? 'bg-yellow-500' :\r\n                        voucher.approvalStatus === 'APPROVED' ? 'bg-green-500' :\r\n                          'bg-red-500'\r\n                    }`}>\r\n                    {voucher.approvalStatus}\r\n                  </span>\r\n                </td>\r\n                <td className=\"px-6 py-3 space-x-2\">\r\n                  <button\r\n                    onClick={() => handleEdit(voucher)}\r\n                    className=\"text-blue-600 hover:text-blue-800 font-medium text-sm\"\r\n                  >\r\n                    Edit\r\n                  </button>\r\n                  {voucher.approvalStatus === 'DRAFT' && (\r\n                    <button\r\n                      onClick={() => handleStatusChange(voucher.id, 'PENDING')}\r\n                      className=\"text-yellow-600 hover:text-yellow-800 font-medium text-sm\"\r\n                    >\r\n                      Submit\r\n                    </button>\r\n                  )}\r\n                  {voucher.approvalStatus === 'PENDING' && (\r\n                    <button\r\n                      onClick={() => handleStatusChange(voucher.id, 'APPROVED')}\r\n                      className=\"text-green-600 hover:text-green-800 font-medium text-sm\"\r\n                    >\r\n                      Approve\r\n                    </button>\r\n                  )}\r\n                  <button\r\n                    onClick={() => handleDelete(voucher.id)}\r\n                    className=\"text-red-500 hover:text-red-700 font-medium text-sm\"\r\n                  >\r\n                    Delete\r\n                  </button>\r\n                </td>\r\n              </tr>\r\n            ))}\r\n          </tbody>\r\n        </table>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\dashboard\\financial-year\\page.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadYears'. Either include it or remove the dependency array.","line":34,"column":6,"nodeType":"ArrayExpression","endLine":34,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [loadYears]","fix":{"range":[920,922],"text":"[loadYears]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { useEffect, useState } from \"react\";\nimport { getCurrentUser } from \"@/lib/auth\";\nimport { hasPermission } from \"@/lib/hasPermission\";\nimport { PERMISSIONS } from \"@/lib/permissions\";\n\ntype FinancialYear = {\n  id: string;\n  year: number;\n  startDate: string;\n  endDate: string;\n  isActive: boolean;\n  isClosed: boolean;\n  closedAt?: string;\n};\n\nexport default function FinancialYearPage() {\n  const [years, setYears] = useState<FinancialYear[]>([]);\n  const [loading, setLoading] = useState(false);\n  const [showForm, setShowForm] = useState(false);\n\n  const [formData, setFormData] = useState({\n    year: new Date().getFullYear().toString(),\n    startDate: `${new Date().getFullYear()}-01-01`,\n    endDate: `${new Date().getFullYear()}-12-31`,\n  });\n\n  const user = getCurrentUser();\n  const canAccess = hasPermission(user, PERMISSIONS.FINANCIAL_YEAR);\n\n  useEffect(() => {\n    loadYears();\n  }, []);\n\n  if (!canAccess) {\n    return <div>Access Denied</div>;\n  }\n\n  async function loadYears() {\n    setLoading(true);\n    try {\n      const res = await fetch(\"/api/financial-year\", {\n        headers: {\n          \"x-user-role\": user?.role || \"\",\n          \"x-user-id\": user?.id || \"\",\n        },\n      });\n      const data = await res.json();\n      if (Array.isArray(data)) {\n        setYears(data);\n      }\n    } catch (e) {\n      console.error(\"Load error:\", e);\n    } finally {\n      setLoading(false);\n    }\n  }\n\n  async function saveYear() {\n    if (!formData.year || !formData.startDate || !formData.endDate) {\n      alert(\"Please fill all fields\");\n      return;\n    }\n\n    setLoading(true);\n    try {\n      const res = await fetch(\"/api/financial-year\", {\n        method: \"POST\",\n        headers: {\n          \"Content-Type\": \"application/json\",\n          \"x-user-role\": user?.role || \"\",\n          \"x-user-id\": user?.id || \"\",\n        },\n        body: JSON.stringify(formData),\n      });\n\n      if (res.ok) {\n        await loadYears();\n        setShowForm(false);\n        setFormData({\n          year: new Date().getFullYear().toString(),\n          startDate: `${new Date().getFullYear()}-01-01`,\n          endDate: `${new Date().getFullYear()}-12-31`,\n        });\n      } else {\n        const error = await res.json();\n        alert(error.error || \"Save failed\");\n      }\n    } catch (_e) {\n      alert(\"Save failed\");\n    } finally {\n      setLoading(false);\n    }\n  }\n\n  async function closeYear(id: string) {\n    if (!confirm(\"Are you sure you want to close this financial year? This action cannot be undone.\")) {\n      return;\n    }\n\n    try {\n      const res = await fetch(\"/api/financial-year\", {\n        method: \"PUT\",\n        headers: {\n          \"Content-Type\": \"application/json\",\n          \"x-user-role\": user?.role || \"\",\n          \"x-user-id\": user?.id || \"\",\n        },\n        body: JSON.stringify({ id, isClosed: true, closedBy: user?.id }),\n      });\n\n      if (res.ok) {\n        await loadYears();\n      }\n    } catch (_e) {\n      alert(\"Close failed\");\n    }\n  }\n\n  return (\n    <div className=\"p-6 space-y-6\">\n      <div className=\"flex justify-between items-center\">\n        <h1 className=\"text-2xl font-bold\">Financial Year Management</h1>\n        <button\n          onClick={() => setShowForm(true)}\n          className=\"bg-blue-600 text-white px-4 py-2 rounded\"\n        >\n          + Add Financial Year\n        </button>\n      </div>\n\n      {showForm && (\n        <div className=\"bg-white border p-6 rounded space-y-4\">\n          <h2 className=\"text-xl font-bold\">New Financial Year</h2>\n\n          <div className=\"grid grid-cols-3 gap-4\">\n            <div>\n              <label className=\"block text-sm font-bold mb-1\">Year *</label>\n              <input\n                type=\"number\"\n                className=\"w-full border p-2 rounded\"\n                value={formData.year}\n                onChange={(e) =>\n                  setFormData({ ...formData, year: e.target.value })\n                }\n              />\n            </div>\n\n            <div>\n              <label className=\"block text-sm font-bold mb-1\">\n                Start Date *\n              </label>\n              <input\n                type=\"date\"\n                className=\"w-full border p-2 rounded\"\n                value={formData.startDate}\n                onChange={(e) =>\n                  setFormData({ ...formData, startDate: e.target.value })\n                }\n              />\n            </div>\n\n            <div>\n              <label className=\"block text-sm font-bold mb-1\">End Date *</label>\n              <input\n                type=\"date\"\n                className=\"w-full border p-2 rounded\"\n                value={formData.endDate}\n                onChange={(e) =>\n                  setFormData({ ...formData, endDate: e.target.value })\n                }\n              />\n            </div>\n          </div>\n\n          <div className=\"flex gap-2\">\n            <button\n              onClick={saveYear}\n              disabled={loading}\n              className=\"bg-green-600 text-white px-6 py-2 rounded\"\n            >\n              {loading ? \"Saving...\" : \"Save\"}\n            </button>\n            <button\n              onClick={() => setShowForm(false)}\n              className=\"bg-gray-600 text-white px-6 py-2 rounded\"\n            >\n              Cancel\n            </button>\n          </div>\n        </div>\n      )}\n\n      <div className=\"bg-white border rounded overflow-hidden\">\n        <table className=\"w-full text-sm\">\n          <thead className=\"bg-gray-100\">\n            <tr>\n              <th className=\"p-3 text-left\">Year</th>\n              <th className=\"p-3 text-left\">Start Date</th>\n              <th className=\"p-3 text-left\">End Date</th>\n              <th className=\"p-3 text-center\">Status</th>\n              <th className=\"p-3 text-center\">Closed</th>\n              <th className=\"p-3 text-center\">Actions</th>\n            </tr>\n          </thead>\n          <tbody>\n            {loading ? (\n              <tr>\n                <td colSpan={6} className=\"p-4 text-center\">\n                  Loading...\n                </td>\n              </tr>\n            ) : years.length === 0 ? (\n              <tr>\n                <td colSpan={6} className=\"p-4 text-center text-gray-400\">\n                  No financial years found\n                </td>\n              </tr>\n            ) : (\n              years.map((y) => (\n                <tr key={y.id} className=\"border-t\">\n                  <td className=\"p-3 font-bold\">{y.year}</td>\n                  <td className=\"p-3\">\n                    {new Date(y.startDate).toLocaleDateString()}\n                  </td>\n                  <td className=\"p-3\">\n                    {new Date(y.endDate).toLocaleDateString()}\n                  </td>\n                  <td className=\"p-3 text-center\">\n                    <span\n                      className={`px-2 py-1 rounded text-xs ${\n                        y.isActive\n                          ? \"bg-green-100 text-green-800\"\n                          : \"bg-gray-100 text-gray-800\"\n                      }`}\n                    >\n                      {y.isActive ? \"Active\" : \"Inactive\"}\n                    </span>\n                  </td>\n                  <td className=\"p-3 text-center\">\n                    <span\n                      className={`px-2 py-1 rounded text-xs ${\n                        y.isClosed\n                          ? \"bg-red-100 text-red-800\"\n                          : \"bg-yellow-100 text-yellow-800\"\n                      }`}\n                    >\n                      {y.isClosed ? \"Closed\" : \"Open\"}\n                    </span>\n                  </td>\n                  <td className=\"p-3 text-center\">\n                    {!y.isClosed && (\n                      <button\n                        onClick={() => closeYear(y.id)}\n                        className=\"text-red-600 hover:underline\"\n                      >\n                        Close Year\n                      </button>\n                    )}\n                  </td>\n                </tr>\n              ))\n            )}\n          </tbody>\n        </table>\n      </div>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\dashboard\\fixed-assets\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\dashboard\\inventory\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\dashboard\\items-new\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\dashboard\\jv\\page.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'loadAccounts', 'loadVouchers', and 'user'. Either include them or remove the dependency array.","line":64,"column":6,"nodeType":"ArrayExpression","endLine":64,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [loadAccounts, loadVouchers, user]","fix":{"range":[1540,1542],"text":"[loadAccounts, loadVouchers, user]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { useEffect, useState } from \"react\";\nimport { getCurrentUser } from \"@/lib/auth\";\nimport { toast } from \"react-hot-toast\";\n\ntype Account = {\n  id: string;\n  name: string;\n  code: string;\n  type: string;\n};\n\ntype Entry = {\n  id: string;\n  accountId: string;\n  accountName: string;\n  amount: string;\n  type: \"DEBIT\" | \"CREDIT\";\n};\n\ntype Voucher = {\n  id: string;\n  voucherNo: string;\n  date: string;\n  narration: string;\n  entries: Array<{\n    accountId: string;\n    accountName: string;\n    amount: number;\n  }>;\n  totalDebit: number;\n  totalCredit: number;\n};\n\nexport default function JVPage() {\n  const today = new Date().toISOString().split(\"T\")[0];\n\n  const [accounts, setAccounts] = useState<Account[]>([]);\n  const [vouchers, setVouchers] = useState<Voucher[]>([]);\n  const [showList, setShowList] = useState(false);\n  const [showForm, setShowForm] = useState(true);\n  const [editing, setEditing] = useState<Voucher | null>(null);\n\n  const [entries, setEntries] = useState<Entry[]>([\n    { id: \"1\", accountId: \"\", accountName: \"\", amount: \"\", type: \"DEBIT\" },\n    { id: \"2\", accountId: \"\", accountName: \"\", amount: \"\", type: \"CREDIT\" },\n  ]);\n  const [date, setDate] = useState(today);\n  const [narration, setNarration] = useState(\"\");\n  const [voucher, setVoucher] = useState<Any>(null);\n  const [saving, setSaving] = useState(false);\n\n  const user = getCurrentUser();\n\n  useEffect(() => {\n    if (!user) {\n      toast.error(\"Session expired\");\n      return;\n    }\n\n    loadVouchers();\n    loadAccounts();\n  }, []);\n\n  async function loadVouchers() {\n    try {\n      const res = await fetch(\"/api/jv\", {\n        headers: { \"x-user-role\": user?.role || \"\" },\n      });\n      const data = await res.json();\n      if (Array.isArray(data)) {\n        setVouchers(data);\n      }\n    } catch (e) {\n      console.error(\"Load vouchers error:\", e);\n    }\n  }\n\n  async function loadAccounts() {\n    fetch(\"/api/accounts\", {\n      method: \"GET\",\n      headers: { \"x-user-role\": user?.role || \"\" },\n    })\n      .then((res) => res.json())\n      .then((data) => {\n        if (Array.isArray(data)) {\n          setAccounts(data);\n        } else {\n          setAccounts(data.accounts || []);\n        }\n      })\n      .catch((err) => {\n        console.error(\"Accounts load error:\", err);\n      });\n  }\n\n  function addEntry() {\n    setEntries([\n      ...entries,\n      {\n        id: Date.now().toString(),\n        accountId: \"\",\n        accountName: \"\",\n        amount: \"\",\n        type: \"DEBIT\",\n      },\n    ]);\n  }\n\n  function removeEntry(id: string) {\n    if (entries.length <= 2) {\n      toast.error(\"At least 2 entries required\");\n      return;\n    }\n    setEntries(entries.filter((e) => e.id !== id));\n  }\n\n  function updateEntry(id: string, field: keyof Entry, value: Any) {\n    setEntries(\n      entries.map((e) => {\n        if (e.id === id) {\n          if (field === \"accountId\") {\n            const account = accounts.find((a) => a.id === value);\n            return {\n              ...e,\n              accountId: value,\n              accountName: account?.name || \"\",\n            };\n          }\n          if (field === \"type\") {\n            const currentAmount = Number(e.amount) || 0;\n            return {\n              ...e,\n              type: value,\n              amount:\n                value === \"DEBIT\"\n                  ? Math.abs(currentAmount).toString()\n                  : (-Math.abs(currentAmount)).toString(),\n            };\n          }\n          if (field === \"amount\") {\n            const numValue = Number(value);\n            if (isNaN(numValue)) {\n              return { ...e, amount: \"\" };\n            }\n            const absValue = Math.abs(numValue);\n            return {\n              ...e,\n              amount:\n                e.type === \"DEBIT\" ? absValue.toString() : (-absValue).toString(),\n            };\n          }\n          return { ...e, [field]: value };\n        }\n        return e;\n      })\n    );\n  }\n\n  const totalDebit = entries.reduce((sum, e) => {\n    const amount = Number(e.amount) || 0;\n    return sum + (amount > 0 ? amount : 0);\n  }, 0);\n\n  const totalCredit = entries.reduce((sum, e) => {\n    const amount = Number(e.amount) || 0;\n    return sum + (amount < 0 ? Math.abs(amount) : 0);\n  }, 0);\n\n  const isBalanced = Math.abs(totalDebit - totalCredit) < 0.01;\n\n  async function saveJV() {\n    if (!isBalanced) {\n      alert(`Debit (${totalDebit}) and Credit (${totalCredit}) must be equal`);\n      return;\n    }\n\n    for (const entry of entries) {\n      if (!entry.accountId) {\n        alert(\"All entries must have an account\");\n        return;\n      }\n      const amount = Number(entry.amount);\n      if (isNaN(amount) || amount === 0) {\n        alert(\"All entries must have non-zero amount\");\n        return;\n      }\n    }\n\n    setSaving(true);\n\n    try {\n      const url = \"/api/jv\";\n      const method = editing ? \"PUT\" : \"POST\";\n\n      const res = await fetch(url, {\n        method,\n        headers: {\n          \"Content-Type\": \"application/json\",\n          \"x-user-role\": user?.role || \"\",\n        },\n        body: JSON.stringify(editing ? {\n          id: editing.id,\n          entries: entries.map((e) => ({\n            accountId: e.accountId,\n            amount: Number(e.amount),\n          })),\n          date,\n          narration,\n        } : {\n          entries: entries.map((e) => ({\n            accountId: e.accountId,\n            amount: Number(e.amount),\n          })),\n          date,\n          narration,\n        }),\n      });\n\n      const data = await res.json();\n\n      if (!res.ok) {\n        alert(`Error: ${data?.error || \"Save failed\"}`);\n        return;\n      }\n\n      setVoucher(data);\n      alert(editing ? \"JV updated successfully!\" : \"Journal Voucher saved successfully!\");\n      await loadVouchers();\n      resetForm();\n      setShowForm(false);\n      setEditing(null);\n    } catch (error: Any) {\n      alert(`Error: ${error.message || \"Failed to save JV\"}`);\n    } finally {\n      setSaving(false);\n    }\n  }\n\n  function resetForm() {\n    setEntries([\n      { id: \"1\", accountId: \"\", accountName: \"\", amount: \"\", type: \"DEBIT\" },\n      { id: \"2\", accountId: \"\", accountName: \"\", amount: \"\", type: \"CREDIT\" },\n    ]);\n    setNarration(\"\");\n    setDate(today);\n  }\n\n  function startEdit(v: Voucher) {\n    setEditing(v);\n    setDate(v.date);\n    setNarration(v.narration);\n    setEntries(\n      v.entries.map((e, idx) => ({\n        id: (idx + 1).toString(),\n        accountId: e.accountId,\n        accountName: e.accountName,\n        amount: e.amount.toString(),\n        type: e.amount > 0 ? \"DEBIT\" : \"CREDIT\",\n      }))\n    );\n    setShowForm(true);\n    setShowList(false);\n  }\n\n  async function deleteVoucher(id: string) {\n    if (!confirm(\"Are you sure you want to delete this JV?\")) {\n      return;\n    }\n\n    try {\n      const res = await fetch(`/api/jv?id=${id}`, {\n        method: \"DELETE\",\n        headers: { \"x-user-role\": user?.role || \"\" },\n      });\n\n      if (res.ok) {\n        toast.success(\"JV deleted successfully!\");\n        await loadVouchers();\n      } else {\n        const data = await res.json();\n        toast.error(data.error || \"Delete failed\");\n      }\n    } catch (_e) {\n      toast.error(\"Delete failed\");\n    }\n  }\n\n  return (\n    <div className=\"p-6 max-w-6xl mx-auto space-y-6\">\n      <div className=\"flex justify-between items-center\">\n        <h1 className=\"text-2xl font-bold\">Journal Voucher (JV)</h1>\n        <div className=\"flex gap-2\">\n          <button\n            onClick={() => {\n              setShowList(!showList);\n              setShowForm(!showForm);\n              setEditing(null);\n            }}\n            className=\"bg-gray-600 text-white px-4 py-2 rounded\"\n          >\n            {showList ? \"Hide List\" : \"Show List\"}\n          </button>\n          <button\n            onClick={() => {\n              setShowForm(true);\n              setShowList(false);\n              setEditing(null);\n              resetForm();\n            }}\n            className=\"bg-blue-600 text-white px-4 py-2 rounded\"\n          >\n            + New JV\n          </button>\n        </div>\n      </div>\n\n      {/* VOUCHER LIST */}\n      {showList && (\n        <div className=\"bg-white border rounded overflow-x-auto\">\n          <table className=\"w-full text-sm min-w-[800px]\">\n            <thead className=\"bg-gray-100\">\n              <tr>\n                <th className=\"p-3 text-left\">Voucher No</th>\n                <th className=\"p-3 text-left\">Date</th>\n                <th className=\"p-3 text-left\">Narration</th>\n                <th className=\"p-3 text-right\">Debit</th>\n                <th className=\"p-3 text-right\">Credit</th>\n                <th className=\"p-3 text-center\">Actions</th>\n              </tr>\n            </thead>\n            <tbody>\n              {vouchers.length === 0 ? (\n                <tr>\n                  <td colSpan={6} className=\"p-4 text-center text-gray-400\">\n                    No JVs found\n                  </td>\n                </tr>\n              ) : (\n                vouchers.map((v) => (\n                  <tr key={v.id} className=\"border-t hover:bg-gray-50\">\n                    <td className=\"p-3 font-bold\">{v.voucherNo}</td>\n                    <td className=\"p-3\">{v.date}</td>\n                    <td className=\"p-3\">{v.narration}</td>\n                    <td className=\"p-3 text-right\">{v.totalDebit.toLocaleString()}</td>\n                    <td className=\"p-3 text-right\">{v.totalCredit.toLocaleString()}</td>\n                    <td className=\"p-3 text-center space-x-2\">\n                      <button\n                        onClick={() => startEdit(v)}\n                        className=\"text-blue-600 hover:text-blue-800 font-medium text-sm\"\n                      >\n                        Edit\n                      </button>\n                      <button\n                        onClick={() => deleteVoucher(v.id)}\n                        className=\"text-red-600 hover:text-red-800 font-medium text-sm\"\n                      >\n                        Delete\n                      </button>\n                    </td>\n                  </tr>\n                ))\n              )}\n            </tbody>\n          </table>\n        </div>\n      )}\n\n      {/* FORM */}\n      {showForm && (\n        <div className=\"bg-white border rounded-lg p-6 space-y-4\">\n          <h2 className=\"text-xl font-bold\">\n            {editing ? \"Edit JV\" : \"New JV\"}\n          </h2>\n\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n            <div>\n              <label className=\"block text-sm font-medium mb-1\">Date</label>\n              <input\n                type=\"date\"\n                value={date}\n                onChange={(e) => setDate(e.target.value)}\n                className=\"w-full border rounded px-3 py-2\"\n              />\n            </div>\n            <div>\n              <label className=\"block text-sm font-medium mb-1\">Narration</label>\n              <input\n                type=\"text\"\n                value={narration}\n                onChange={(e) => setNarration(e.target.value)}\n                placeholder=\"Description of transaction\"\n                className=\"w-full border rounded px-3 py-2\"\n              />\n            </div>\n          </div>\n\n          <div className=\"mt-6\">\n            <div className=\"flex justify-between items-center mb-3\">\n              <h3 className=\"font-bold\">Entries</h3>\n              <button\n                onClick={addEntry}\n                className=\"bg-blue-600 text-white px-4 py-1 rounded text-sm\"\n              >\n                + Add Entry\n              </button>\n            </div>\n\n            <div className=\"overflow-x-auto\">\n              <table className=\"w-full border min-w-[600px]\">\n                <thead>\n                  <tr className=\"bg-gray-100\">\n                    <th className=\"border p-2 text-left\">Account</th>\n                    <th className=\"border p-2 text-center w-24\">Type</th>\n                    <th className=\"border p-2 text-right\">Amount</th>\n                    <th className=\"border p-2 text-center w-20\">Action</th>\n                  </tr>\n                </thead>\n                <tbody>\n                  {entries.map((entry) => (\n                    <tr key={entry.id}>\n                      <td className=\"border p-2\">\n                        <select\n                          value={entry.accountId}\n                          onChange={(e) =>\n                            updateEntry(entry.id, \"accountId\", e.target.value)\n                          }\n                          className=\"w-full border rounded px-2 py-1\"\n                        >\n                          <option value=\"\">Select Account</option>\n                          {accounts.map((acc) => (\n                            <option key={acc.id} value={acc.id}>\n                              {acc.code} - {acc.name}\n                            </option>\n                          ))}\n                        </select>\n                      </td>\n                      <td className=\"border p-2\">\n                        <select\n                          value={entry.type}\n                          onChange={(e) =>\n                            updateEntry(entry.id, \"type\", e.target.value as \"DEBIT\" | \"CREDIT\")\n                          }\n                          className=\"w-full border rounded px-2 py-1\"\n                        >\n                          <option value=\"DEBIT\">Debit</option>\n                          <option value=\"CREDIT\">Credit</option>\n                        </select>\n                      </td>\n                      <td className=\"border p-2\">\n                        <input\n                          type=\"number\"\n                          value={entry.amount}\n                          onChange={(e) =>\n                            updateEntry(entry.id, \"amount\", e.target.value)\n                          }\n                          placeholder=\"0.00\"\n                          className=\"w-full border rounded px-2 py-1 text-right\"\n                        />\n                      </td>\n                      <td className=\"border p-2 text-center\">\n                        {entries.length > 2 && (\n                          <button\n                            onClick={() => removeEntry(entry.id)}\n                            className=\"text-red-600 hover:text-red-800\"\n                          >\n                            ✕\n                          </button>\n                        )}\n                      </td>\n                    </tr>\n                  ))}\n                </tbody>\n                <tfoot>\n                  <tr className=\"bg-gray-50 font-bold\">\n                    <td colSpan={2} className=\"border p-2 text-right\">\n                      Total:\n                    </td>\n                    <td className=\"border p-2 text-right\">\n                      <div className=\"space-y-1\">\n                        <div>\n                          Debit: <span className=\"text-green-600\">{totalDebit.toFixed(2)}</span>\n                        </div>\n                        <div>\n                          Credit: <span className=\"text-blue-600\">{totalCredit.toFixed(2)}</span>\n                        </div>\n                        <div\n                          className={\n                            isBalanced ? \"text-green-600\" : \"text-red-600\"\n                          }\n                        >\n                          {isBalanced ? \"✓ Balanced\" : \"✗ Not Balanced\"}\n                        </div>\n                      </div>\n                    </td>\n                    <td className=\"border p-2\"></td>\n                  </tr>\n                </tfoot>\n              </table>\n            </div>\n          </div>\n\n          <div className=\"flex justify-end gap-2\">\n            <button\n              onClick={() => {\n                setShowForm(false);\n                setEditing(null);\n                resetForm();\n              }}\n              className=\"bg-gray-600 text-white px-6 py-2 rounded font-bold\"\n            >\n              Cancel\n            </button>\n            <button\n              onClick={saveJV}\n              disabled={saving || !isBalanced}\n              className=\"bg-green-600 hover:bg-green-700 disabled:bg-gray-400 text-white px-6 py-2 rounded font-bold\"\n            >\n              {saving ? \"Saving...\" : editing ? \"Update JV\" : \"Save JV\"}\n            </button>\n          </div>\n        </div>\n      )}\n\n      {/* VOUCHER PREVIEW */}\n      {voucher && (\n        <div className=\"bg-white border rounded-lg p-6\">\n          <h2 className=\"text-xl font-bold mb-4\">Journal Voucher Saved</h2>\n          <div className=\"space-y-2\">\n            <p>\n              <strong>Voucher No:</strong> {voucher.voucherNo}\n            </p>\n            <p>\n              <strong>Date:</strong> {voucher.date}\n            </p>\n            <p>\n              <strong>Narration:</strong> {voucher.narration}\n            </p>\n            <div className=\"mt-4\">\n              <h3 className=\"font-bold mb-2\">Entries:</h3>\n              <table className=\"w-full border\">\n                <thead>\n                  <tr className=\"bg-gray-100\">\n                    <th className=\"border p-2 text-left\">Account</th>\n                    <th className=\"border p-2 text-right\">Debit</th>\n                    <th className=\"border p-2 text-right\">Credit</th>\n                  </tr>\n                </thead>\n                <tbody>\n                  {voucher.entries?.map((entry: Any, idx: number) => (\n                    <tr key={idx}>\n                      <td className=\"border p-2\">{entry.account?.name || entry.accountName || \"N/A\"}</td>\n                      <td className=\"border p-2 text-right\">\n                        {entry.amount > 0 ? entry.amount.toFixed(2) : \"-\"}\n                      </td>\n                      <td className=\"border p-2 text-right\">\n                        {entry.amount < 0 ? Math.abs(entry.amount).toFixed(2) : \"-\"}\n                      </td>\n                    </tr>\n                  ))}\n                </tbody>\n                <tfoot>\n                  <tr className=\"bg-gray-50 font-bold\">\n                    <td className=\"border p-2 text-right\">Total:</td>\n                    <td className=\"border p-2 text-right\">{totalDebit.toFixed(2)}</td>\n                    <td className=\"border p-2 text-right\">{totalCredit.toFixed(2)}</td>\n                  </tr>\n                </tfoot>\n              </table>\n            </div>\n            <div className=\"mt-4\">\n              <button\n                onClick={() => window.print()}\n                className=\"bg-blue-600 text-white px-4 py-2 rounded mr-2\"\n              >\n                Print\n              </button>\n              <button\n                onClick={() => {\n                  setVoucher(null);\n                  resetForm();\n                }}\n                className=\"bg-gray-200 text-gray-800 px-4 py-2 rounded\"\n              >\n                New JV\n              </button>\n            </div>\n          </div>\n        </div>\n      )}\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\dashboard\\layout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\dashboard\\loans\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\dashboard\\outward\\page.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'handleInvoiceChange'. Either include it or remove the dependency array.","line":84,"column":6,"nodeType":"ArrayExpression","endLine":84,"endColumn":65,"suggestions":[{"desc":"Update the dependencies array to be: [today, showForm, showPreview, customers, customerInvoices, handleInvoiceChange]","fix":{"range":[2950,3009],"text":"[today, showForm, showPreview, customers, customerInvoices, handleInvoiceChange]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadOutwards'. Either include it or remove the dependency array.","line":103,"column":6,"nodeType":"ArrayExpression","endLine":103,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [loadOutwards]","fix":{"range":[3542,3544],"text":"[loadOutwards]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { useEffect, useState } from \"react\";\nimport { getCurrentUser } from \"@/lib/auth\";\n\ntype Row = { itemId: string; name: string; qty: number | \"\"; maxQty: number };\n\ntype Outward = {\n  id: string;\n  outwardNo: number;\n  date: string;\n  customerId: string;\n  customer?: { name: string };\n  driverName?: string;\n  vehicleNo?: string;\n  remarks?: string;\n  items: Array<{ item: { name: string }; qty: number }>;\n};\n\nexport default function OutwardPage() {\n  const today = new Date().toISOString().slice(0, 10);\n  const user = getCurrentUser();\n\n  const [customers, setCustomers] = useState<Any[]>([]);\n  const [customerInvoices, setCustomerInvoices] = useState<Any[]>([]);\n  const [outwards, setOutwards] = useState<Outward[]>([]);\n  const [showList, setShowList] = useState(false);\n  const [showForm, setShowForm] = useState(true);\n  const [editing, setEditing] = useState<Outward | null>(null);\n\n  const [selectedInvoiceId, setSelectedInvoiceId] = useState(\"\");\n  const [customerId, setCustomerId] = useState(\"\");\n  const [date, setDate] = useState(today);\n  const [driverName, setDriverName] = useState(\"\");\n  const [vehicleNo, setVehicleNo] = useState(\"\");\n  const [remarks, setRemarks] = useState(\"\");\n  const [rows, setRows] = useState<Row[]>([]);\n\n  const [saving, setSaving] = useState(false);\n  const [showPreview, setShowPreview] = useState(false);\n  const [savedData, setSavedData] = useState<Any>(null);\n\n  // Keyboard shortcuts - F7: Clear date/customer, F8: Query dialog\n  useEffect(() => {\n    function handleKeyPress(e: KeyboardEvent) {\n      if (e.code === \"F7\" || e.key === \"F7\") {\n        e.preventDefault();\n        e.stopPropagation();\n        if (showForm && !showPreview) {\n          setDate(today);\n          setCustomerId(\"\");\n          setSelectedInvoiceId(\"\");\n          setRows([]);\n        }\n      }\n      if (e.code === \"F8\" || e.key === \"F8\") {\n        e.preventDefault();\n        e.stopPropagation();\n        if (showForm && !showPreview) {\n          const query = prompt(\"Enter search query (Customer Name, Invoice No, etc.):\");\n          if (query) {\n            const foundCustomer = customers.find(c => \n              c.name.toLowerCase().includes(query.toLowerCase())\n            );\n            if (foundCustomer) {\n              setCustomerId(foundCustomer.id);\n            } else {\n              const foundInvoice = customerInvoices.find(inv =>\n                inv.invoiceNo.toLowerCase().includes(query.toLowerCase())\n              );\n              if (foundInvoice) {\n                setCustomerId(foundInvoice.customerId);\n                handleInvoiceChange(foundInvoice.id);\n              } else {\n                alert(`No customer or invoice found matching \"${query}\"`);\n              }\n            }\n          }\n        }\n      }\n    }\n    document.addEventListener(\"keydown\", handleKeyPress, true);\n    return () => document.removeEventListener(\"keydown\", handleKeyPress, true);\n  }, [today, showForm, showPreview, customers, customerInvoices]);\n\n  useEffect(() => {\n    loadOutwards();\n    const user = getCurrentUser();\n    fetch(\"/api/accounts?type=CUSTOMER\", { \n      headers: { \n        \"x-user-role\": user?.role || \"ADMIN\" \n      } \n    })\n      .then(r => r.json())\n      .then(d => {\n        const data = Array.isArray(d) ? d : (d.accounts || []);\n        setCustomers(data.filter((a: Any) => a.partyType === \"CUSTOMER\"));\n      })\n      .catch(err => {\n        console.error(\"Error loading customers:\", err);\n        alert(\"Failed to load customers\");\n      });\n  }, []);\n\n  async function loadOutwards() {\n    try {\n      const res = await fetch(\"/api/outward\", {\n        headers: { \"x-user-role\": user?.role || \"ADMIN\" },\n      });\n      const data = await res.json();\n      if (Array.isArray(data)) {\n        setOutwards(data);\n      }\n    } catch (e) {\n      console.error(\"Load outwards error:\", e);\n    }\n  }\n\n  useEffect(() => {\n    if (!customerId) {\n      setCustomerInvoices([]);\n      return;\n    }\n\n    const user = getCurrentUser();\n    if (!user) {\n      alert(\"Session expired. Please login again.\");\n      return;\n    }\n\n    fetch(\"/api/sales-invoice\", {\n      headers: {\n        \"x-user-role\": user.role || \"\",\n        \"x-user-id\": user.id || \"\"\n      }\n    })\n      .then(r => {\n        if (!r.ok) {\n          if (r.status === 403) {\n            alert(\"You don't have permission to view sales invoices\");\n            return { invoices: [] };\n          }\n          throw new Error(`Failed to load invoices: ${r.status}`);\n        }\n        return r.json();\n      })\n      .then(d => {\n        if (d?.invoices) {\n          const filtered = d.invoices.filter((inv: Any) => \n            inv.customerId === customerId && inv.status !== \"RETURNED\"\n          );\n          setCustomerInvoices(filtered);\n        } else if (d?.error) {\n          alert(`Error: ${d.error}`);\n        } else {\n          console.error(\"Unexpected response format:\", d);\n          setCustomerInvoices([]);\n        }\n      })\n      .catch(err => {\n        console.error(\"Error loading invoices:\", err);\n        alert(`Failed to load invoices: ${err.message || \"Unknown error\"}`);\n        setCustomerInvoices([]);\n      });\n  }, [customerId]);\n\n  async function handleInvoiceChange(invId: string) {\n    setSelectedInvoiceId(invId);\n    if (!invId) {\n      setRows([]);\n      return;\n    }\n\n    const inv = customerInvoices.find(i => i.id === invId);\n    if (inv && inv.items && Array.isArray(inv.items)) {\n      const autoRows = inv.items.map((it: Any) => ({\n        itemId: it.itemId,\n        name: it.item?.name || it.name || \"Unknown Item\",\n        qty: it.qty,\n        maxQty: it.qty,\n      }));\n      setRows(autoRows);\n    } else {\n      console.error(\"Invoice not found or items missing:\", inv);\n      alert(\"Invoice items not found. Please try selecting the invoice again.\");\n    }\n  }\n\n  function updateRow(i: number, key: keyof Row, val: Any) {\n    const copy = [...rows] as Any;\n    copy[i][key] = val;\n    setRows(copy);\n  }\n\n  async function saveOutward() {\n    const clean = rows.filter(r => r.itemId && Number(r.qty) > 0);\n    if (!customerId || clean.length === 0) return alert(\"Select Customer and Items\");\n\n    setSaving(true);\n    try {\n      const method = editing ? \"PUT\" : \"POST\";\n      const body = editing\n        ? { id: editing.id, customerId, invoiceId: selectedInvoiceId, date, driverName, vehicleNo, remarks, items: clean }\n        : { customerId, invoiceId: selectedInvoiceId, date, driverName, vehicleNo, remarks, items: clean };\n\n      const res = await fetch(\"/api/outward\", {\n        method,\n        headers: { \"Content-Type\": \"application/json\", \"x-user-role\": user?.role || \"ADMIN\" },\n        body: JSON.stringify(body),\n      });\n\n      const data = await res.json();\n      if (!res.ok) throw new Error(data.error);\n\n      setSavedData({ ...data, customerName: customers.find(c => c.id === customerId)?.name });\n      setShowPreview(true);\n      await loadOutwards();\n      if (editing) {\n        setEditing(null);\n        setShowForm(false);\n        setShowList(true);\n      }\n    } catch (err: Any) {\n      alert(err.message);\n    } finally {\n      setSaving(false);\n    }\n  }\n\n  function startEdit(out: Outward) {\n    setEditing(out);\n    setCustomerId(out.customerId);\n    setDate(new Date(out.date).toISOString().slice(0, 10));\n    setDriverName(out.driverName || \"\");\n    setVehicleNo(out.vehicleNo || \"\");\n    setRemarks(out.remarks || \"\");\n    setRows(out.items.map((it: Any) => ({\n      itemId: it.itemId || \"\",\n      name: it.item?.name || \"\",\n      qty: it.qty.toString(),\n      maxQty: it.qty,\n    })));\n    setShowForm(true);\n    setShowList(false);\n  }\n\n  async function deleteOutward(id: string) {\n    if (!confirm(\"Are you sure you want to delete this outward?\")) return;\n    try {\n      const res = await fetch(`/api/outward?id=${id}`, {\n        method: \"DELETE\",\n        headers: { \"x-user-role\": user?.role || \"ADMIN\" },\n      });\n      if (res.ok) {\n        alert(\"Outward deleted successfully\");\n        await loadOutwards();\n      } else {\n        const err = await res.json();\n        alert(err.error || \"Delete failed\");\n      }\n    } catch (_e) {\n      alert(\"Delete failed\");\n    }\n  }\n\n  function resetForm() {\n    setEditing(null);\n    setCustomerId(\"\");\n    setSelectedInvoiceId(\"\");\n    setDate(today);\n    setDriverName(\"\");\n    setVehicleNo(\"\");\n    setRemarks(\"\");\n    setRows([]);\n    setShowPreview(false);\n  }\n\n  if (showPreview) {\n    return (\n      <div className=\"invoice-print p-10 bg-white min-h-screen\">\n        <div className=\"max-w-4xl mx-auto border-2 border-black p-8\">\n           <div className=\"text-center border-b-4 border-black pb-4 mb-6\">\n             <h1 className=\"text-4xl font-black\">US TRADERS</h1>\n             <p className=\"font-bold\">OUTWARD GATE PASS #{savedData.outwardNo}</p>\n           </div>\n           <div className=\"grid grid-cols-1 md:grid-cols-2 mb-6 font-bold\">\n             <div>\n               <p>CUSTOMER: {savedData.customerName}</p>\n               <p>DATE: {date}</p>\n             </div>\n             <div className=\"text-right\">\n               <p>VEHICLE: {vehicleNo}</p>\n               <p>DRIVER: {driverName}</p>\n             </div>\n           </div>\n           <table className=\"w-full border-2 border-black\">\n             <thead>\n               <tr className=\"bg-gray-100\">\n                 <th className=\"border-2 p-2\">Item</th>\n                 <th className=\"border-2 p-2\">Qty</th>\n               </tr>\n             </thead>\n             <tbody>\n               {savedData.items.map((it: Any, i: number) => (\n                 <tr key={i}>\n                   <td className=\"border-2 p-2 font-bold\">{rows[i]?.name}</td>\n                   <td className=\"border-2 p-2 text-center text-xl font-black\">{it.qty}</td>\n                 </tr>\n               ))}\n             </tbody>\n           </table>\n           <div className=\"mt-20 flex justify-between\">\n             <div className=\"border-t-2 border-black w-40 text-center\">Receiver Sign</div>\n             <div className=\"border-t-2 border-black w-40 text-center\">Authorized Sign</div>\n           </div>\n        </div>\n        <div className=\"mt-8 flex gap-4 justify-center no-print\">\n          <button onClick={() => window.print()} className=\"bg-green-600 text-white px-8 py-2 font-bold\">PRINT</button>\n          <button onClick={() => { setShowPreview(false); resetForm(); }} className=\"bg-blue-600 text-white px-8 py-2 font-bold\">NEW</button>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"p-6 max-w-4xl mx-auto bg-white border shadow-xl rounded-xl\">\n      <div className=\"flex justify-between items-center mb-4\">\n        <h1 className=\"text-3xl font-black border-b-4 border-black pb-2 uppercase\">\n          Outward Gate Pass\n        </h1>\n        <div className=\"flex gap-2\">\n          <button\n            onClick={() => { setShowList(!showList); setShowForm(!showForm); setEditing(null); }}\n            className=\"bg-gray-600 text-white px-4 py-2 rounded\"\n          >\n            {showList ? \"Hide List\" : \"Show List\"}\n          </button>\n          <button\n            onClick={() => { setShowForm(true); setShowList(false); resetForm(); }}\n            className=\"bg-blue-600 text-white px-4 py-2 rounded\"\n          >\n            + New Outward\n          </button>\n        </div>\n      </div>\n\n      {/* LIST VIEW */}\n      {showList && (\n        <div className=\"bg-white border rounded overflow-x-auto mb-4\">\n          <table className=\"w-full text-sm min-w-[800px]\">\n            <thead className=\"bg-gray-100\">\n              <tr>\n                <th className=\"p-3 text-left\">Outward No</th>\n                <th className=\"p-3 text-left\">Date</th>\n                <th className=\"p-3 text-left\">Customer</th>\n                <th className=\"p-3 text-left\">Vehicle</th>\n                <th className=\"p-3 text-center\">Actions</th>\n              </tr>\n            </thead>\n            <tbody>\n              {outwards.length === 0 ? (\n                <tr>\n                  <td colSpan={5} className=\"p-4 text-center text-gray-400\">No outwards found</td>\n                </tr>\n              ) : (\n                outwards.map(out => (\n                  <tr key={out.id} className=\"border-t hover:bg-gray-50\">\n                    <td className=\"p-3 font-bold\">#{out.outwardNo}</td>\n                    <td className=\"p-3\">{new Date(out.date).toLocaleDateString()}</td>\n                    <td className=\"p-3\">{out.customer?.name || \"N/A\"}</td>\n                    <td className=\"p-3\">{out.vehicleNo || \"N/A\"}</td>\n                    <td className=\"p-3 text-center space-x-2\">\n                      <button\n                        onClick={() => startEdit(out)}\n                        className=\"text-blue-600 hover:text-blue-800 font-medium text-sm\"\n                      >\n                        Edit\n                      </button>\n                      <button\n                        onClick={() => deleteOutward(out.id)}\n                        className=\"text-red-600 hover:text-red-800 font-medium text-sm\"\n                      >\n                        Delete\n                      </button>\n                    </td>\n                  </tr>\n                ))\n              )}\n            </tbody>\n          </table>\n        </div>\n      )}\n\n      {/* FORM */}\n      {showForm && (\n        <>\n          <div className=\"mb-2 text-xs text-gray-500 italic\">\n            💡 Keyboard Shortcuts: <strong>F7</strong> = Clear Date & Customer | <strong>F8</strong> = Search Query\n          </div>\n          <div className=\"grid grid-cols-2 gap-4 mb-6\">\n            <div className=\"flex flex-col\">\n              <label className=\"text-xs font-bold uppercase\">Customer (F7: Clear, F8: Query)</label>\n              <select\n                className=\"border-2 p-3 rounded font-bold\"\n                value={customerId}\n                onChange={e => { setCustomerId(e.target.value); setSelectedInvoiceId(\"\"); setRows([]); }}\n              >\n                <option value=\"\">Select Customer</option>\n                {customers.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}\n              </select>\n            </div>\n\n            <div className=\"flex flex-col\">\n              <label className=\"text-xs font-bold uppercase\">Select Reference Invoice</label>\n              <select\n                className=\"border-2 p-3 rounded font-bold bg-blue-50\"\n                value={selectedInvoiceId}\n                onChange={e => handleInvoiceChange(e.target.value)}\n                disabled={!customerId}\n              >\n                <option value=\"\">-- Choose Sales Invoice --</option>\n                {customerInvoices.map(inv => (\n                  <option key={inv.id} value={inv.id}>{inv.invoiceNo} (Items: {inv.items.length})</option>\n                ))}\n              </select>\n            </div>\n          </div>\n\n          <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4 mb-6\">\n            <div>\n              <label className=\"text-xs font-bold uppercase\">Date (F7: Clear)</label>\n              <input type=\"date\" className=\"border-2 p-3 rounded font-bold w-full\" value={date} onChange={e => setDate(e.target.value)} />\n            </div>\n            <input className=\"border-2 p-3 rounded font-bold\" placeholder=\"Driver Name\" value={driverName} onChange={e => setDriverName(e.target.value)} />\n            <input className=\"border-2 p-3 rounded font-bold\" placeholder=\"Vehicle No\" value={vehicleNo} onChange={e => setVehicleNo(e.target.value)} />\n          </div>\n\n          <table className=\"w-full border-2 border-black mb-4\">\n            <thead className=\"bg-black text-white text-xs\">\n              <tr>\n                <th className=\"p-3 text-left\">Item Name</th>\n                <th className=\"p-3 w-32 text-center\">Inv Qty</th>\n                <th className=\"p-3 w-32 text-center\">Dispatch Qty</th>\n              </tr>\n            </thead>\n            <tbody>\n              {rows.map((r, i) => (\n                <tr key={i}>\n                  <td className=\"p-2 font-bold border\">{r.name}</td>\n                  <td className=\"p-2 text-center border bg-gray-50\">{r.maxQty}</td>\n                  <td className=\"p-2 border\">\n                    <input\n                      type=\"number\"\n                      className=\"w-full p-2 text-center font-black bg-yellow-50\"\n                      value={r.qty}\n                      onChange={e => updateRow(i, \"qty\", Number(e.target.value))}\n                    />\n                  </td>\n                </tr>\n              ))}\n            </tbody>\n          </table>\n\n          <textarea className=\"w-full border-2 p-3 rounded mb-6\" placeholder=\"Remarks\" value={remarks} onChange={e => setRemarks(e.target.value)} />\n\n          <div className=\"flex gap-2\">\n            <button\n              onClick={saveOutward}\n              disabled={saving || rows.length === 0}\n              className=\"w-full bg-blue-700 text-white font-black py-4 rounded-xl text-xl uppercase\"\n            >\n              {saving ? \"Processing...\" : editing ? \"Update Gate Pass\" : \"Save & Print Gate Pass\"}\n            </button>\n            <button\n              onClick={() => { setShowForm(false); setEditing(null); resetForm(); }}\n              className=\"bg-gray-600 text-white px-6 py-2 rounded\"\n            >\n              Cancel\n            </button>\n          </div>\n        </>\n      )}\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\dashboard\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\dashboard\\parties\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\dashboard\\payment-receipts\\page.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'fetchBankAccounts', 'fetchParties', and 'fetchReceipts'. Either include them or remove the dependency array.","line":57,"column":6,"nodeType":"ArrayExpression","endLine":57,"endColumn":20,"suggestions":[{"desc":"Update the dependencies array to be: [fetchBankAccounts, fetchParties, fetchReceipts, statusFilter]","fix":{"range":[1383,1397],"text":"[fetchBankAccounts, fetchParties, fetchReceipts, statusFilter]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport { useEffect, useState } from 'react';\nimport { getCurrentUser } from '@/lib/auth';\n\ninterface PaymentReceipt {\n  id: string;\n  receiptNo: string;\n  date: string;\n  amount: number;\n  paymentMode: string;\n  referenceNo?: string;\n  status: string;\n  narration?: string;\n  party?: { id: string; name: string };\n}\n\ninterface Party {\n  id: string;\n  code: string;\n  name: string;\n  phone?: string;\n}\n\ninterface BankAccount {\n  id: string;\n  accountNo: string;\n  bankName: string;\n  accountName: string;\n}\n\nexport default function PaymentReceiptsPage() {\n  const user = getCurrentUser();\n  const [receipts, setReceipts] = useState<PaymentReceipt[]>([]);\n  const [parties, setParties] = useState<Party[]>([]);\n  const [bankAccounts, setBankAccounts] = useState<BankAccount[]>([]);\n  const [showForm, setShowForm] = useState(true);\n  const [showList, setShowList] = useState(false);\n  const [formData, setFormData] = useState({\n    receiptNo: '',\n    date: new Date().toISOString().split('T')[0],\n    amount: 0,\n    paymentMode: 'CASH',\n    partyId: '',\n    bankAccountId: '',\n    referenceNo: '',\n    narration: '',\n  });\n  const [loading, setLoading] = useState(false);\n  const [statusFilter, setStatusFilter] = useState('');\n  const [editingId, setEditingId] = useState('');\n\n  useEffect(() => {\n    fetchReceipts();\n    fetchParties();\n    fetchBankAccounts();\n  }, [statusFilter]);\n\n  const fetchBankAccounts = async () => {\n    try {\n      const response = await fetch('/api/bank-accounts', {\n        headers: {\n          'x-user-role': user?.role || 'ADMIN',\n          'x-user-id': user?.id || '',\n        },\n      });\n      \n      if (!response.ok) {\n        console.error('Bank accounts API error:', response.status, response.statusText);\n        setBankAccounts([]);\n        return;\n      }\n      \n      const data = await response.json();\n      if (!Array.isArray(data)) {\n        console.error('Bank accounts API did not return an array:', data);\n        setBankAccounts([]);\n        return;\n      }\n      \n      setBankAccounts(data);\n    } catch (error) {\n      console.error('Error fetching bank accounts:', error);\n      setBankAccounts([]);\n    }\n  };\n\n  const fetchReceipts = async () => {\n    try {\n      let url = '/api/payment-receipts';\n      if (statusFilter) url += `?status=${statusFilter}`;\n      const response = await fetch(url, {\n        headers: {\n          'x-user-role': user?.role || 'ADMIN',\n          'x-user-id': user?.id || '',\n        },\n      });\n      \n      if (!response.ok) {\n        console.error('Payment receipts API error:', response.status, response.statusText);\n        setReceipts([]);\n        return;\n      }\n      \n      const data = await response.json();\n      if (!Array.isArray(data)) {\n        console.error('Payment receipts API did not return an array:', data);\n        setReceipts([]);\n        return;\n      }\n      \n      setReceipts(data);\n    } catch (error) {\n      console.error('Error fetching receipts:', error);\n      setReceipts([]);\n    }\n  };\n\n  const fetchParties = async () => {\n    try {\n      const response = await fetch('/api/accounts', {\n        headers: {\n          'x-user-role': user?.role || 'ADMIN',\n          'x-user-id': user?.id || '',\n        },\n      });\n      \n      if (!response.ok) {\n        console.error('Accounts API error:', response.status, response.statusText);\n        setParties([]);\n        return;\n      }\n      \n      const data = await response.json();\n      if (!Array.isArray(data)) {\n        console.error('Accounts API did not return an array:', data);\n        setParties([]);\n        return;\n      }\n      \n      const filtered = data.filter((acc: Any) => \n        acc.partyType === 'CUSTOMER' || !acc.partyType\n      );\n      setParties(filtered);\n    } catch (error) {\n      console.error('Error fetching parties:', error);\n      setParties([]);\n    }\n  };\n\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault();\n    setLoading(true);\n    try {\n      const method = editingId ? 'PUT' : 'POST';\n      const url = editingId ? `/api/payment-receipts?id=${editingId}` : '/api/payment-receipts';\n      \n      const response = await fetch(url, {\n        method,\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({ id: editingId, ...formData }),\n      });\n\n      if (response.ok) {\n        alert(editingId ? 'Payment receipt updated successfully' : 'Payment receipt saved successfully');\n        setFormData({\n          receiptNo: '',\n          date: new Date().toISOString().split('T')[0],\n          amount: 0,\n          paymentMode: 'CASH',\n          partyId: '',\n          bankAccountId: '',\n          referenceNo: '',\n          narration: '',\n        });\n        setEditingId('');\n        setShowForm(true);\n        setShowList(false);\n        fetchReceipts();\n      }\n    } catch (error) {\n      console.error('Error saving receipt:', error);\n      alert('Error: Failed to save receipt');\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const handleEdit = (receipt: PaymentReceipt) => {\n    setEditingId(receipt.id);\n    setFormData({\n      receiptNo: receipt.receiptNo,\n      date: new Date(receipt.date).toISOString().split('T')[0],\n      amount: receipt.amount,\n      paymentMode: receipt.paymentMode,\n      partyId: receipt.party?.id || '',\n      bankAccountId: '',\n      referenceNo: receipt.referenceNo || '',\n      narration: receipt.narration || '',\n    });\n    setShowForm(true);\n    setShowList(false);\n  };\n\n  const handleDelete = async (id: string) => {\n    if (!confirm('Are you sure? This cannot be undone.')) return;\n    \n    try {\n      const response = await fetch(`/api/payment-receipts?id=${id}`, {\n        method: 'DELETE',\n      });\n\n      if (response.ok) {\n        alert('Payment receipt deleted successfully');\n        fetchReceipts();\n      } else {\n        alert('Error: Failed to delete receipt');\n      }\n    } catch (error) {\n      console.error('Error deleting receipt:', error);\n      alert('Error: Failed to delete receipt');\n    }\n  };\n\n  const handleClearCheque = async (receipt: PaymentReceipt) => {\n    if (!confirm(`Clear cheque ${receipt.referenceNo || receipt.receiptNo}?`)) return;\n    \n    try {\n      const response = await fetch(`/api/payment-receipts?id=${receipt.id}`, {\n        method: 'PUT',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({ \n          id: receipt.id, \n          status: 'CLEARED',\n          date: receipt.date,\n          amount: receipt.amount,\n          paymentMode: receipt.paymentMode,\n          partyId: receipt.party?.id,\n          referenceNo: receipt.referenceNo,\n          narration: receipt.narration,\n        }),\n      });\n\n      if (response.ok) {\n        alert('Cheque marked as cleared');\n        fetchReceipts();\n      } else {\n        alert('Error: Failed to clear cheque');\n      }\n    } catch (error) {\n      console.error('Error clearing cheque:', error);\n      alert('Error: Failed to clear cheque');\n    }\n  };\n\n  return (\n    <div className=\"p-6 max-w-6xl mx-auto\">\n      <div className=\"flex justify-between items-center mb-6\">\n        <h1 className=\"text-3xl font-bold\">Payment Receipts</h1>\n        <button\n          onClick={() => {\n            setShowList(!showList);\n            setShowForm(!showForm);\n          }}\n          className=\"bg-gray-600 text-white px-6 py-2 rounded font-semibold hover:bg-gray-700\"\n        >\n          {showList ? \"Back to Form\" : \"View List\"}\n        </button>\n      </div>\n\n      {/* Form */}\n      {showForm && (\n        <form\n          onSubmit={handleSubmit}\n          className=\"bg-white p-6 rounded-lg shadow mb-6\"\n        >\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4 mb-4\">\n            <div>\n              <label className=\"block text-sm font-semibold mb-2\">\n                Receipt No <span className=\"text-gray-500 text-xs\">(Auto-generated if empty)</span>\n              </label>\n              <input\n                type=\"text\"\n                value={formData.receiptNo}\n                onChange={(e) =>\n                  setFormData({ ...formData, receiptNo: e.target.value })\n                }\n                placeholder=\"Leave empty for auto-generation\"\n                className=\"w-full border border-gray-300 rounded px-3 py-2\"\n              />\n            </div>\n            <div>\n              <label className=\"block text-sm font-semibold mb-2\">Date</label>\n              <input\n                type=\"date\"\n                required\n                value={formData.date}\n                onChange={(e) =>\n                  setFormData({ ...formData, date: e.target.value })\n                }\n                className=\"w-full border border-gray-300 rounded px-3 py-2\"\n              />\n            </div>\n            <div>\n              <label className=\"block text-sm font-semibold mb-2\">Amount</label>\n              <input\n                type=\"number\"\n                required\n                step=\"0.01\"\n                value={formData.amount}\n                onChange={(e) =>\n                  setFormData({\n                    ...formData,\n                    amount: parseFloat(e.target.value),\n                  })\n                }\n                className=\"w-full border border-gray-300 rounded px-3 py-2\"\n              />\n            </div>\n            <div>\n              <label className=\"block text-sm font-semibold mb-2\">Payment Mode</label>\n              <select\n                value={formData.paymentMode}\n                onChange={(e) =>\n                  setFormData({ ...formData, paymentMode: e.target.value, bankAccountId: e.target.value === 'CASH' ? '' : formData.bankAccountId })\n                }\n                className=\"w-full border border-gray-300 rounded px-3 py-2\"\n              >\n                <option value=\"CASH\">Cash</option>\n                <option value=\"CHEQUE\">Cheque</option>\n                <option value=\"BANK_TRANSFER\">Bank Transfer</option>\n              </select>\n            </div>\n            {(formData.paymentMode === 'CHEQUE' || formData.paymentMode === 'BANK_TRANSFER') && (\n              <div>\n                <label className=\"block text-sm font-semibold mb-2\">Bank Account *</label>\n                <select\n                  required\n                  value={formData.bankAccountId}\n                  onChange={(e) =>\n                    setFormData({ ...formData, bankAccountId: e.target.value })\n                  }\n                  className=\"w-full border border-gray-300 rounded px-3 py-2\"\n                >\n                  <option value=\"\">Select Bank Account</option>\n                  {bankAccounts.map((bank) => (\n                    <option key={bank.id} value={bank.id}>\n                      {bank.bankName} - {bank.accountNo} ({bank.accountName})\n                    </option>\n                  ))}\n                </select>\n              </div>\n            )}\n            <div>\n              <label className=\"block text-sm font-semibold mb-2\">Party</label>\n              <select\n                value={formData.partyId}\n                onChange={(e) =>\n                  setFormData({ ...formData, partyId: e.target.value })\n                }\n                className=\"w-full border border-gray-300 rounded px-3 py-2\"\n              >\n                <option value=\"\">Select</option>\n                {parties.map((party) => (\n                  <option key={party.id} value={party.id}>\n                    {party.name}\n                  </option>\n                ))}\n              </select>\n            </div>\n            <div>\n              <label className=\"block text-sm font-semibold mb-2\">Reference No</label>\n              <input\n                type=\"text\"\n                value={formData.referenceNo}\n                onChange={(e) =>\n                  setFormData({ ...formData, referenceNo: e.target.value })\n                }\n                placeholder=\"Cheque No or Transaction ID\"\n                className=\"w-full border border-gray-300 rounded px-3 py-2\"\n              />\n            </div>\n          </div>\n          <div className=\"mb-4\">\n            <label className=\"block text-sm font-semibold mb-2\">Description</label>\n            <textarea\n              value={formData.narration}\n              onChange={(e) =>\n                setFormData({ ...formData, narration: e.target.value })\n              }\n              className=\"w-full border border-gray-300 rounded px-3 py-2\"\n              rows={3}\n            />\n          </div>\n          <div className=\"flex gap-4\">\n            <button\n              type=\"submit\"\n              disabled={loading}\n              className=\"bg-blue-500 text-white px-6 py-2 rounded font-semibold hover:bg-blue-600 disabled:opacity-50\"\n            >\n              {loading ? 'Saving...' : editingId ? 'Update' : 'Save'}\n            </button>\n            <button\n              type=\"button\"\n              onClick={() => {\n                setShowForm(false);\n                setShowList(true);\n                setEditingId('');\n                setFormData({\n                  receiptNo: '',\n                  date: new Date().toISOString().split('T')[0],\n                  amount: 0,\n                  paymentMode: 'CASH',\n                  partyId: '',\n                  bankAccountId: '',\n                  referenceNo: '',\n                  narration: '',\n                });\n              }}\n              className=\"bg-gray-500 text-white px-6 py-2 rounded font-semibold hover:bg-gray-600\"\n            >\n              Clear\n            </button>\n          </div>\n        </form>\n      )}\n\n      {/* Filter */}\n      {showList && (\n        <div className=\"mb-6\">\n          <select\n            value={statusFilter}\n            onChange={(e) => setStatusFilter(e.target.value)}\n            className=\"border border-gray-300 rounded px-4 py-2\"\n          >\n            <option value=\"\">All Status</option>\n            <option value=\"PENDING\">Pending</option>\n            <option value=\"CLEARED\">Cleared</option>\n            <option value=\"BOUNCED\">Bounced</option>\n          </select>\n        </div>\n      )}\n\n      {/* List */}\n      {showList && (\n        <div className=\"bg-white rounded-lg shadow overflow-x-auto\">\n          <table className=\"w-full min-w-[800px]\">\n            <thead className=\"bg-gray-100\">\n              <tr>\n                <th className=\"px-6 py-3 text-left\">Receipt No</th>\n                <th className=\"px-6 py-3 text-left\">Date</th>\n                <th className=\"px-6 py-3 text-left\">Amount</th>\n                <th className=\"px-6 py-3 text-left\">Mode</th>\n                <th className=\"px-6 py-3 text-left\">Party</th>\n                <th className=\"px-6 py-3 text-left\">Status</th>\n                <th className=\"px-6 py-3 text-left\">Actions</th>\n              </tr>\n            </thead>\n            <tbody>\n              {receipts.map((receipt) => (\n                <tr key={receipt.id} className=\"border-b hover:bg-gray-50\">\n                  <td className=\"px-6 py-3 font-semibold\">{receipt.receiptNo}</td>\n                  <td className=\"px-6 py-3\">\n                    {new Date(receipt.date).toLocaleDateString()}\n                  </td>\n                  <td className=\"px-6 py-3\">{receipt.amount.toFixed(2)}</td>\n                  <td className=\"px-6 py-3\">{receipt.paymentMode}</td>\n                  <td className=\"px-6 py-3\">{receipt.party?.name || '-'}</td>\n                  <td className=\"px-6 py-3\">\n                    <span className={`px-3 py-1 rounded text-white text-sm ${\n                      receipt.status === 'PENDING' ? 'bg-yellow-500' :\n                      receipt.status === 'CLEARED' ? 'bg-green-500' :\n                      'bg-red-500'\n                    }`}>\n                      {receipt.status}\n                    </span>\n                  </td>\n                  <td className=\"px-6 py-3 space-x-2\">\n                    {receipt.status === 'PENDING' && receipt.paymentMode === 'CHEQUE' && (\n                      <button\n                        onClick={() => handleClearCheque(receipt)}\n                        className=\"text-green-600 hover:text-green-800 font-medium text-sm\"\n                      >\n                        Clear ✓\n                      </button>\n                    )}\n                    <button\n                      onClick={() => handleEdit(receipt)}\n                      className=\"text-blue-600 hover:text-blue-800 font-medium text-sm\"\n                    >\n                      Edit\n                    </button>\n                    <button\n                      onClick={() => handleDelete(receipt.id)}\n                      className=\"text-red-500 hover:text-red-700 font-medium text-sm\"\n                    >\n                      Delete\n                    </button>\n                  </td>\n                </tr>\n              ))}\n            </tbody>\n          </table>\n        </div>\n      )}\n    </div>\n  );\n}","usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\dashboard\\payroll\\page.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchPayroll'. Either include it or remove the dependency array.","line":53,"column":6,"nodeType":"ArrayExpression","endLine":53,"endColumn":17,"suggestions":[{"desc":"Update the dependencies array to be: [fetchPayroll, monthYear]","fix":{"range":[1574,1585],"text":"[fetchPayroll, monthYear]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'calculateAutoDeductions'. Either include it or remove the dependency array.","line":61,"column":6,"nodeType":"ArrayExpression","endLine":61,"endColumn":68,"suggestions":[{"desc":"Update the dependencies array to be: [formData.employeeId, formData.monthYear, formData.baseSalary, calculateAutoDeductions]","fix":{"range":[1756,1818],"text":"[formData.employeeId, formData.monthYear, formData.baseSalary, calculateAutoDeductions]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useEffect, useState } from \"react\";\r\nimport { getCurrentUser } from \"@/lib/auth\";\r\n\r\ninterface Payroll {\r\n  id: string;\r\n  employeeId: string;\r\n  monthYear: string;\r\n  baseSalary: number;\r\n  allowances: number;\r\n  deductions: number;\r\n  deductionReason?: string;\r\n  additionalCash: number;\r\n  netSalary: number;\r\n  paymentStatus: string;\r\n  employee: { firstName: string; lastName: string; employeeId: string };\r\n}\r\n\r\nexport default function PayrollPage() {\r\n  const user = getCurrentUser();\r\n  const [payroll, setPayroll] = useState<Payroll[]>([]);\r\n  const [employees, setEmployees] = useState<Any[]>([]);\r\n  const [loading, setLoading] = useState(false);\r\n  const [editingId, setEditingId] = useState<string | null>(null);\r\n  const [monthYear, setMonthYear] = useState(() => {\r\n    const d = new Date();\r\n    return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, \"0\")}`;\r\n  });\r\n  const [detectedAdvance, setDetectedAdvance] = useState(0);\r\n\r\n  // Preview State\r\n  const [showPreview, setShowPreview] = useState(false);\r\n\r\n  const [formData, setFormData] = useState({\r\n    employeeId: \"\",\r\n    monthYear: (() => {\r\n      const d = new Date();\r\n      return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, \"0\")}`;\r\n    })(),\r\n    baseSalary: 0,\r\n    allowances: 0,\r\n    deductions: 0,\r\n    deductionReason: \"\",\r\n    additionalCash: 0,\r\n  });\r\n\r\n  useEffect(() => {\r\n    fetchEmployees();\r\n    fetchPayroll();\r\n    // Sync form date with view date for convenience\r\n    setFormData((prev) => ({ ...prev, monthYear }));\r\n  }, [monthYear]);\r\n\r\n  useEffect(() => {\r\n    if (formData.employeeId && formData.monthYear) {\r\n      calculateAutoDeductions();\r\n    } else {\r\n      setDetectedAdvance(0);\r\n    }\r\n  }, [formData.employeeId, formData.monthYear, formData.baseSalary]);\r\n\r\n  async function calculateAutoDeductions() {\r\n    try {\r\n      // 1. Fetch Advances\r\n      const resAdvance = await fetch(\r\n        `/api/advance?employeeId=${formData.employeeId}&status=PENDING&monthYear=${formData.monthYear}`,\r\n      );\r\n      const dataAdvance = await resAdvance.json();\r\n      const advanceTotal = Array.isArray(dataAdvance)\r\n        ? dataAdvance.reduce((sum: number, a: Any) => sum + a.amount, 0)\r\n        : 0;\r\n\r\n      setDetectedAdvance(advanceTotal);\r\n\r\n      // 2. Fetch Attendance (Absents)\r\n      const resAttendance = await fetch(\r\n        `/api/attendance?employeeId=${formData.employeeId}&month=${formData.monthYear}`,\r\n      );\r\n      const dataAttendance = await resAttendance.json();\r\n      const absents = Array.isArray(dataAttendance)\r\n        ? dataAttendance.filter((r: Any) => r.status === \"ABSENT\").length\r\n        : 0;\r\n\r\n      // 3. Check Previous Month Balance (Carry Forward)\r\n      let prevBalanceDeduction = 0;\r\n      try {\r\n        const [year, month] = formData.monthYear.split(\"-\").map(Number);\r\n        \r\n        // Robust previous month calculation avoiding timezone issues\r\n        let prevYear = year;\r\n        let prevMonth = month - 1;\r\n        if (prevMonth === 0) {\r\n          prevMonth = 12;\r\n          prevYear -= 1;\r\n        }\r\n        const prevMonthStr = `${prevYear}-${prevMonth.toString().padStart(2, \"0\")}`;\r\n\r\n        const resPrev = await fetch(\r\n          `/api/payroll?employeeId=${formData.employeeId}&monthYear=${prevMonthStr}`,\r\n          { cache: \"no-store\" },\r\n        );\r\n        const dataPrev = await resPrev.json();\r\n\r\n        if (Array.isArray(dataPrev) && dataPrev.length > 0) {\r\n          const prevRecord = dataPrev[0];\r\n\r\n          // Recalculate Net Salary strictly as (Earnings - Deductions) to ignore any DB inconsistencies\r\n          const prevNetSalary =\r\n            prevRecord.baseSalary +\r\n            (prevRecord.allowances || 0) -\r\n            (prevRecord.deductions || 0);\r\n\r\n          // Actual Balance = Net Salary - Additional Cash\r\n          const prevActualBalance =\r\n            prevNetSalary - (prevRecord.additionalCash || 0);\r\n\r\n          // If Actual Balance is negative, it means they owe us money (Carry Forward)\r\n          if (prevActualBalance < 0) {\r\n            prevBalanceDeduction = Math.abs(prevActualBalance);\r\n          }\r\n        }\r\n      } catch (e) {\r\n        console.error(\"Error checking previous balance\", e);\r\n      }\r\n\r\n      // 4. Calculate Total Deduction\r\n      // Assumption: 30 days per month\r\n      const perDaySalary =\r\n        formData.baseSalary > 0 ? formData.baseSalary / 30 : 0;\r\n      const absentDeduction = Math.round(absents * perDaySalary);\r\n\r\n      const totalDeduction =\r\n        advanceTotal + absentDeduction + prevBalanceDeduction;\r\n\r\n      // 5. Generate Reason\r\n      const parts = [];\r\n      if (prevBalanceDeduction > 0)\r\n        parts.push(`Prev Bal: ${prevBalanceDeduction}`);\r\n      if (absents > 0) parts.push(`${absents} Absent`);\r\n      if (advanceTotal > 0) parts.push(\"Advance\");\r\n\r\n      const reason = parts.join(\", \");\r\n\r\n      // 6. Update Form\r\n      if (totalDeduction > 0) {\r\n        setFormData((prev) => ({\r\n          ...prev,\r\n          deductions: totalDeduction,\r\n          deductionReason: reason,\r\n        }));\r\n      }\r\n    } catch (error) {\r\n      console.error(\"Error calculating deductions\", error);\r\n    }\r\n  }\r\n\r\n  async function fetchEmployees() {\r\n    try {\r\n      const res = await fetch(\"/api/employees\");\r\n      const data = await res.json();\r\n      setEmployees(Array.isArray(data) ? data : []);\r\n    } catch (error) {\r\n      console.error(\"Error fetching employees\", error);\r\n      setEmployees([]);\r\n    }\r\n  }\r\n\r\n  async function fetchPayroll() {\r\n    setLoading(true);\r\n    try {\r\n      const res = await fetch(`/api/payroll?monthYear=${monthYear}`, {\r\n        cache: \"no-store\",\r\n      });\r\n      const data = await res.json();\r\n      setPayroll(Array.isArray(data) ? data : []);\r\n    } catch (error) {\r\n      console.error(\"Error fetching payroll\", error);\r\n      setPayroll([]);\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  }\r\n\r\n  async function handleSubmit(e: React.FormEvent) {\r\n    e.preventDefault();\r\n    if (!user) return alert(\"Login required\");\r\n    setLoading(true);\r\n    await fetch(editingId ? `/api/payroll?id=${editingId}` : \"/api/payroll\", {\r\n      method: editingId ? \"PUT\" : \"POST\",\r\n      headers: {\r\n        \"Content-Type\": \"application/json\",\r\n        \"x-user-role\": user.role,\r\n        \"x-user-id\": user.id,\r\n      },\r\n      body: JSON.stringify(formData),\r\n    });\r\n    setEditingId(null);\r\n    setFormData({\r\n      employeeId: \"\",\r\n      monthYear,\r\n      baseSalary: 0,\r\n      allowances: 0,\r\n      deductions: 0,\r\n      deductionReason: \"\",\r\n      additionalCash: 0,\r\n    });\r\n    await fetchPayroll();\r\n    setLoading(false);\r\n  }\r\n\r\n  function handleEdit(p: Payroll) {\r\n    setEditingId(p.id);\r\n    setFormData({\r\n      employeeId: p.employeeId,\r\n      monthYear: p.monthYear,\r\n      baseSalary: p.baseSalary,\r\n      allowances: p.allowances,\r\n      deductions: p.deductions,\r\n      deductionReason: p.deductionReason || \"\",\r\n      additionalCash: p.additionalCash || 0,\r\n    });\r\n  }\r\n\r\n  async function handleDelete(id: string) {\r\n    if (!confirm(\"Delete this payroll record?\") || !user) return;\r\n    await fetch(`/api/payroll?id=${id}`, {\r\n      method: \"DELETE\",\r\n      headers: { \"x-user-role\": user.role, \"x-user-id\": user.id },\r\n    });\r\n    await fetchPayroll();\r\n  }\r\n\r\n  /* ================= PAYSLIP PRINT ================= */\r\n\r\n  function handlePrintPayslip(p: Payroll) {\r\n    const printWindow = window.open(\"\", \"_blank\");\r\n    if (!printWindow) return alert(\"Please allow popups\");\r\n\r\n    const html = `\r\n      <html>\r\n        <head>\r\n          <title>Payslip - ${p.employee.firstName}</title>\r\n          <style>\r\n            body { font-family: sans-serif; padding: 40px; max-width: 600px; margin: 0 auto; border: 1px solid #ccc; }\r\n            .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 10px; }\r\n            .row { display: flex; justify-content: space-between; margin-bottom: 10px; border-bottom: 1px dashed #eee; padding-bottom: 5px; }\r\n            .label { font-weight: bold; color: #555; }\r\n            .amount { font-family: monospace; font-size: 1.1em; }\r\n            .net-pay { margin-top: 20px; border-top: 2px solid #333; padding-top: 10px; font-size: 1.3em; font-weight: bold; }\r\n            .footer { margin-top: 40px; text-align: center; font-size: 0.8em; color: #888; }\r\n            @media print { body { border: none; } }\r\n          </style>\r\n        </head>\r\n        <body>\r\n          <div class=\"header\">\r\n            <h1>Payslip</h1>\r\n            <p>Period: ${p.monthYear}</p>\r\n          </div>\r\n          <div class=\"row\">\r\n            <span class=\"label\">Employee ID:</span>\r\n            <span>${p.employee.employeeId}</span>\r\n          </div>\r\n          <div class=\"row\">\r\n            <span class=\"label\">Employee Name:</span>\r\n            <span>${p.employee.firstName} ${p.employee.lastName}</span>\r\n          </div>\r\n          <div class=\"row\">\r\n            <span class=\"label\">Basic Salary:</span>\r\n            <span class=\"amount\">${p.baseSalary.toLocaleString()}</span>\r\n          </div>\r\n          <div class=\"row\">\r\n            <span class=\"label\">Allowances:</span>\r\n            <span class=\"amount\">${p.allowances.toLocaleString()}</span>\r\n          </div>\r\n          <div class=\"row\">\r\n            <span class=\"label\">Deductions:</span>\r\n            <span class=\"amount\">-${p.deductions.toLocaleString()}</span>\r\n          </div>\r\n          <div className=\"row net-pay\">\r\n            <span class=\"label\">Pay:</span>\r\n            <span class=\"amount\">${(p.baseSalary + p.allowances - p.deductions).toLocaleString()}</span>\r\n          </div>\r\n          ${\r\n            p.additionalCash > 0\r\n              ? `\r\n            <div class=\"row\">\r\n                <span class=\"label\">Additional Cash (Manual):</span>\r\n                <span class=\"amount\">-${p.additionalCash.toLocaleString()}</span>\r\n            </div>\r\n          `\r\n              : \"\"\r\n          }\r\n          <div class=\"row\" style=\"font-weight: bold; border-top: 1px solid #eee; padding-top: 5px;\">\r\n              <span class=\"label\">Next Month:</span>\r\n              <span class=\"amount\">${(p.baseSalary + p.allowances - p.deductions - (p.additionalCash || 0)).toLocaleString()}</span>\r\n          </div>\r\n          ${\r\n            p.baseSalary +\r\n              p.allowances -\r\n              p.deductions -\r\n              (p.additionalCash || 0) <\r\n            0\r\n              ? `\r\n            <div class=\"row\" style=\"color: red; margin-top: 5px;\">\r\n                <span class=\"label\">Carry Forward to Next Month:</span>\r\n                <span class=\"amount\">${(p.baseSalary + p.allowances - p.deductions - (p.additionalCash || 0)).toLocaleString()}</span>\r\n            </div>\r\n          `\r\n              : \"\"\r\n          }\r\n          <div class=\"row\">\r\n            <span class=\"label\">Reason/Remarks:</span>\r\n            <span>${p.deductionReason || \"-\"}</span>\r\n          </div>\r\n          <div class=\"footer\">\r\n            <p>System Generated Payslip</p>\r\n          </div>\r\n          <script>window.print();</script>\r\n        </body>\r\n      </html>\r\n    `;\r\n    printWindow.document.write(html);\r\n    printWindow.document.close();\r\n  }\r\n\r\n  return (\r\n    <div className=\"p-6 bg-gray-100 min-h-screen print:bg-white print:p-0\">\r\n      <div className=\"max-w-6xl mx-auto space-y-6 print:hidden\">\r\n        {/* HEADER */}\r\n        <div className=\"flex flex-col md:flex-row justify-between items-center gap-4\">\r\n          <div className=\"flex items-center gap-4\">\r\n            <h1 className=\"text-3xl font-black text-gray-800\">💰 Payroll</h1>\r\n            <input\r\n              type=\"month\"\r\n              value={monthYear}\r\n              onChange={(e) => setMonthYear(e.target.value)}\r\n              className=\"border-2 border-blue-500 text-blue-800 font-bold px-3 py-1 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500\"\r\n            />\r\n          </div>\r\n          <div className=\"flex gap-3\">\r\n            <button\r\n              onClick={() => setShowPreview(true)}\r\n              className=\"bg-gray-800 text-white px-4 py-2 rounded-lg font-bold shadow hover:bg-black transition-all\"\r\n            >\r\n              👁️ Show Preview\r\n            </button>\r\n            <button\r\n              onClick={() => window.print()}\r\n              className=\"bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-bold shadow-md transition-all\"\r\n            >\r\n              🖨️ Print Now\r\n            </button>\r\n          </div>\r\n        </div>\r\n\r\n        {/* FORM */}\r\n        <div className=\"bg-white p-6 rounded-xl shadow-sm border\">\r\n          <form\r\n            onSubmit={handleSubmit}\r\n            className=\"grid grid-cols-1 md:grid-cols-4 gap-4\"\r\n          >\r\n            <select\r\n              required\r\n              value={formData.employeeId}\r\n              onChange={(e) => {\r\n                const emp = employees.find((x) => x.id === e.target.value);\r\n                setFormData({\r\n                  ...formData,\r\n                  employeeId: e.target.value,\r\n                  baseSalary: emp?.salary || 0,\r\n                });\r\n              }}\r\n              className=\"border p-2 rounded-lg outline-none\"\r\n            >\r\n              <option value=\"\">Select Employee</option>\r\n              {employees.map((e) => (\r\n                <option key={e.id} value={e.id}>\r\n                  {e.employeeId} - {e.firstName} {e.lastName}\r\n                </option>\r\n              ))}\r\n            </select>\r\n\r\n            <input\r\n              type=\"month\"\r\n              value={formData.monthYear}\r\n              onChange={(e) =>\r\n                setFormData({ ...formData, monthYear: e.target.value })\r\n              }\r\n              className=\"border p-2 rounded-lg\"\r\n            />\r\n            <input\r\n              type=\"number\"\r\n              placeholder=\"Basic Salary\"\r\n              value={formData.baseSalary}\r\n              onChange={(e) =>\r\n                setFormData({ ...formData, baseSalary: +e.target.value || 0 })\r\n              }\r\n              className=\"border p-2 rounded-lg\"\r\n            />\r\n            <button\r\n              disabled={loading}\r\n              className=\"bg-black text-white rounded-lg font-bold py-2 px-4 transition-colors\"\r\n            >\r\n              {editingId ? \"Update Record\" : \"Save Record\"}\r\n            </button>\r\n\r\n            <div className=\"col-span-1 md:col-span-4 grid grid-cols-2 gap-4 mt-2\">\r\n              <input\r\n                type=\"number\"\r\n                placeholder=\"Allowances\"\r\n                value={formData.allowances}\r\n                onChange={(e) =>\r\n                  setFormData({ ...formData, allowances: +e.target.value || 0 })\r\n                }\r\n                className=\"border p-2 rounded-lg\"\r\n              />\r\n              <div className=\"grid grid-cols-2 gap-2\">\r\n                <div className=\"relative\">\r\n                  <input\r\n                    type=\"number\"\r\n                    placeholder=\"Deductions\"\r\n                    value={formData.deductions}\r\n                    onChange={(e) =>\r\n                      setFormData({\r\n                        ...formData,\r\n                        deductions: +e.target.value || 0,\r\n                      })\r\n                    }\r\n                    className=\"border p-2 rounded-lg w-full\"\r\n                  />\r\n                  {detectedAdvance > 0 && (\r\n                    <span className=\"text-xs text-red-500 absolute -bottom-5 left-0\">\r\n                      Advance: {detectedAdvance}\r\n                    </span>\r\n                  )}\r\n                </div>\r\n                <input\r\n                  type=\"text\"\r\n                  placeholder=\"Reason (e.g. Advance)\"\r\n                  value={formData.deductionReason}\r\n                  onChange={(e) =>\r\n                    setFormData({\r\n                      ...formData,\r\n                      deductionReason: e.target.value,\r\n                    })\r\n                  }\r\n                  className=\"border p-2 rounded-lg w-full\"\r\n                />\r\n              </div>\r\n\r\n              {/* NEW FIELD: Additional Cash */}\r\n              <div className=\"col-span-2 mt-2\">\r\n                <label className=\"text-sm font-bold text-gray-700\">\r\n                  Additional Cash (Manual Add):\r\n                </label>\r\n                <input\r\n                  type=\"number\"\r\n                  placeholder=\"e.g. 1000\"\r\n                  value={formData.additionalCash}\r\n                  onChange={(e) =>\r\n                    setFormData({\r\n                      ...formData,\r\n                      additionalCash: +e.target.value || 0,\r\n                    })\r\n                  }\r\n                  className=\"border p-2 rounded-lg w-full border-green-500\"\r\n                />\r\n                <p className=\"text-xs text-gray-500\">\r\n                  This amount is subtracted from Net Salary (increasing\r\n                  deduction/debt). Final Balance carries forward.\r\n                </p>\r\n              </div>\r\n            </div>\r\n          </form>\r\n        </div>\r\n\r\n        {/* MAIN TABLE (Non-Print View) */}\r\n        <div className=\"bg-white rounded-xl shadow border overflow-x-auto\">\r\n          <table className=\"w-full min-w-[800px]\">\r\n            <thead className=\"bg-gray-50 border-b\">\r\n              <tr>\r\n                <th className=\"p-3 text-left\">Emp ID</th>\r\n                <th className=\"p-3 text-left\">Name</th>\r\n                <th className=\"p-3 text-left\">Basic Salary</th>\r\n                <th className=\"p-3 text-center\">Deductions</th>\r\n                <th className=\"p-3 text-center\">Deduction Reason</th>\r\n                <th className=\"p-3 text-center\">Pay</th>\r\n                <th className=\"p-3 text-center\">Paid</th>\r\n                <th className=\"p-3 text-center bg-red-50 text-red-800\">\r\n                  Next Month\r\n                </th>\r\n                <th className=\"p-3 text-center\">Action</th>\r\n              </tr>\r\n            </thead>\r\n            <tbody>\r\n              {payroll.map((p) => (\r\n                <tr key={p.id} className=\"border-b\">\r\n                  <td className=\"p-3 font-medium\">{p.employee.employeeId}</td>\r\n                  <td className=\"p-3\">\r\n                    {p.employee.firstName} {p.employee.lastName}\r\n                  </td>\r\n                  <td className=\"p-3\">{p.baseSalary.toLocaleString()}</td>\r\n                  <td className=\"p-3 text-center font-bold text-red-700\">\r\n                    {p.deductions > 0\r\n                      ? `-${p.deductions.toLocaleString()}`\r\n                      : p.deductions}\r\n                  </td>\r\n                  <td className=\"p-3 text-center font-bold text-red-700\">\r\n                    {p.deductionReason}\r\n                  </td>\r\n                  <td className=\"p-3 text-center font-bold text-gray-700\">\r\n                    {(\r\n                      p.baseSalary +\r\n                      p.allowances -\r\n                      p.deductions\r\n                    ).toLocaleString()}\r\n                  </td>\r\n                  <td className=\"p-3 text-center font-bold text-blue-700\">\r\n                    {p.additionalCash > 0\r\n                      ? `${p.additionalCash.toLocaleString()}`\r\n                      : \"-\"}\r\n                  </td>\r\n                  <td className=\"p-3 text-center font-bold text-green-700 bg-red-50\">\r\n                    {p.baseSalary +\r\n                      p.allowances -\r\n                      p.deductions -\r\n                      (p.additionalCash || 0) <\r\n                    0 ? (\r\n                      <div className=\"bg-red-100 text-red-700 px-2 py-1 rounded-md border border-red-200\">\r\n                        <p className=\"text-[10px] uppercase\">\r\n                          {(\r\n                            p.baseSalary +\r\n                            p.allowances -\r\n                            p.deductions -\r\n                            (p.additionalCash || 0)\r\n                          ).toLocaleString()}\r\n                        </p>\r\n                      </div>\r\n                    ) : (\r\n                      (\r\n                        p.baseSalary +\r\n                        p.allowances -\r\n                        p.deductions -\r\n                        (p.additionalCash || 0)\r\n                      ).toLocaleString()\r\n                    )}\r\n                  </td>\r\n                  <td className=\"p-3 text-center space-x-2 flex justify-center items-center\">\r\n                    <button\r\n                      onClick={() => handlePrintPayslip(p)}\r\n                      className=\"text-gray-600 font-bold bg-gray-200 px-2 py-1 rounded text-xs hover:bg-gray-300\"\r\n                    >\r\n                      Slip\r\n                    </button>\r\n                    <button\r\n                      onClick={() => handleEdit(p)}\r\n                      className=\"text-blue-600 font-bold\"\r\n                    >\r\n                      Edit\r\n                    </button>\r\n                    <button\r\n                      onClick={() => handleDelete(p.id)}\r\n                      className=\"text-red-600 font-bold\"\r\n                    >\r\n                      Delete\r\n                    </button>\r\n                  </td>\r\n                </tr>\r\n              ))}\r\n            </tbody>\r\n            <tfoot>\r\n              <tr className=\"bg-gray-100 font-bold\">\r\n                <td\r\n                  colSpan={2}\r\n                  className=\"border border-gray-400 p-2 text-right\"\r\n                >\r\n                  TOTALS:\r\n                </td>\r\n                <td className=\"border border-gray-400 p-2 text-center\">\r\n                  {payroll\r\n                    .reduce((sum, p) => sum + p.baseSalary, 0)\r\n                    .toLocaleString()}\r\n                </td>\r\n                <td className=\"border border-gray-400 p-2 text-center text-red-600\">\r\n                  -\r\n                  {payroll\r\n                    .reduce((sum, p) => sum + p.deductions, 0)\r\n                    .toLocaleString()}\r\n                </td>\r\n\r\n                <td className=\"border border-gray-400 p-2\"></td>\r\n                <td className=\"border border-gray-400 p-2\"></td>\r\n                <td className=\"border border-gray-400 p-2 text-center text-blue-600\">\r\n                  {payroll\r\n                    .reduce((sum, p) => sum + (p.additionalCash || 0), 0)\r\n                    .toLocaleString()}\r\n                </td>\r\n                <td className=\"border border-gray-400 p-2 text-center text-red-800 bg-gray-50\">\r\n                  {payroll\r\n                    .reduce((sum, p) => {\r\n                      const pay = p.baseSalary + p.allowances - p.deductions;\r\n                      const balance = pay - (p.additionalCash || 0);\r\n                      return balance < 0 ? sum + balance : sum;\r\n                    }, 0)\r\n                    .toLocaleString()}\r\n                </td>\r\n              </tr>\r\n            </tfoot>\r\n          </table>\r\n        </div>\r\n      </div>\r\n\r\n      {/* --- ACTUAL PRINTING CONTENT (Hidden on screen, shown on print) --- */}\r\n      <div className=\"invoice-print hidden print:block font-serif text-black p-8\">\r\n        <div className=\"text-center mb-8\">\r\n          <h1 className=\"text-3xl font-bold uppercase tracking-widest\">\r\n            Payroll Report\r\n          </h1>\r\n          <p className=\"text-lg\">\r\n            For the Month of:{\" \"}\r\n            <span className=\"font-bold underline\">{monthYear}</span>\r\n          </p>\r\n        </div>\r\n        <table className=\"w-full border-2 border-black\">\r\n          <thead>\r\n            <tr className=\"bg-gray-200\">\r\n              <th className=\"border-2 border-black p-2\">ID</th>\r\n              <th className=\"border-2 border-black p-2\">Employee Name</th>\r\n              <th className=\"border-2 border-black p-2\">Basic</th>\r\n              <th className=\"border-2 border-black p-2\">Deductions</th>\r\n              <th className=\"border-2 border-black p-2\">Deduction reason</th>\r\n\r\n              <th className=\"border-2 border-black p-2\">Pay</th>\r\n              <th className=\"border-2 border-black p-2\">Paid</th>\r\n              <th className=\"border-2 border-black p-2 bg-red-100\">\r\n                Next Month\r\n              </th>\r\n            </tr>\r\n          </thead>\r\n          <tbody>\r\n            {payroll.map((p) => (\r\n              <tr key={p.id}>\r\n                <td className=\"border-2 border-black p-2 text-center\">\r\n                  {p.employee.employeeId}\r\n                </td>\r\n                <td className=\"border-2 border-black p-2\">\r\n                  {p.employee.firstName} {p.employee.lastName}\r\n                </td>\r\n                <td className=\"border-2 border-black p-2 text-center\">\r\n                  {p.baseSalary.toLocaleString()}\r\n                </td>\r\n                <td className=\"border-2 border-black p-2 text-center text-red-600 font-bold\">\r\n                  {p.deductions > 0\r\n                    ? `-${p.deductions.toLocaleString()}`\r\n                    : p.deductions}\r\n                </td>\r\n                {/* {p.deductions > 0 ? p.deductions.toLocaleString() : \"-\"} */}\r\n                <td className=\"border-2 border-black p-2 text-center\">\r\n                  {p.deductionReason || \"-\"}\r\n                </td>\r\n                <td className=\"border-2 border-black p-2 text-center font-bold\">\r\n                  {(\r\n                    p.baseSalary +\r\n                    p.allowances -\r\n                    p.deductions\r\n                  ).toLocaleString()}\r\n                </td>\r\n                <td className=\"border-2 border-black p-2 text-center text-blue-600 font-bold\">\r\n                  {p.additionalCash > 0\r\n                    ? p.additionalCash.toLocaleString()\r\n                    : \"-\"}\r\n                </td>\r\n                <td className=\"border-2 border-black p-2 text-center text-red-800 font-bold bg-red-50\">\r\n                  {p.baseSalary +\r\n                    p.allowances -\r\n                    p.deductions -\r\n                    (p.additionalCash || 0) <\r\n                  0 ? (\r\n                    <div className=\"flex flex-col items-center\">\r\n                      {/* <span className=\"text-black\">0</span> */}\r\n                      <span className=\"text-red-600 text-[10px] whitespace-nowrap\">\r\n                        {(\r\n                          p.baseSalary +\r\n                          p.allowances -\r\n                          p.deductions -\r\n                          (p.additionalCash || 0)\r\n                        ).toLocaleString()}\r\n                      </span>\r\n                    </div>\r\n                  ) : (\r\n                    (\r\n                      p.baseSalary +\r\n                      p.allowances -\r\n                      p.deductions -\r\n                      (p.additionalCash || 0)\r\n                    ).toLocaleString()\r\n                  )}\r\n                </td>\r\n              </tr>\r\n            ))}\r\n          </tbody>\r\n          <tfoot>\r\n            <tr className=\"bg-gray-100 font-bold\">\r\n              <td colSpan={2} className=\"border border-gray-400 p-2 text-right\">\r\n                TOTALS:\r\n              </td>\r\n              <td className=\"border border-gray-400 p-2 text-center\">\r\n                {payroll\r\n                  .reduce((sum, p) => sum + p.baseSalary, 0)\r\n                  .toLocaleString()}\r\n              </td>\r\n              <td className=\"border border-gray-400 p-2 text-center text-red-600\">\r\n                -\r\n                {payroll\r\n                  .reduce((sum, p) => sum + p.deductions, 0)\r\n                  .toLocaleString()}\r\n              </td>\r\n\r\n              <td className=\"border border-gray-400 p-2\"></td>\r\n              <td className=\"border border-gray-400 p-2\"></td>\r\n              <td className=\"border border-gray-400 p-2 text-center text-blue-600\">\r\n                {payroll\r\n                  .reduce((sum, p) => sum + (p.additionalCash || 0), 0)\r\n                  .toLocaleString()}\r\n              </td>\r\n\r\n              <td className=\"border border-gray-400 p-2 text-center text-red-800 bg-gray-50\">\r\n                {payroll\r\n                  .reduce((sum, p) => {\r\n                    const pay = p.baseSalary + p.allowances - p.deductions;\r\n                    const balance = pay - (p.additionalCash || 0);\r\n                    return balance < 0 ? sum + balance : sum;\r\n                  }, 0)\r\n                  .toLocaleString()}\r\n              </td>\r\n            </tr>\r\n          </tfoot>\r\n        </table>\r\n        <div className=\"flex justify-between mt-20 px-10\">\r\n          <div className=\"border-t-2 border-black w-40 text-center pt-2 font-bold\">\r\n            Prepared By\r\n          </div>\r\n          <div className=\"border-t-2 border-black w-40 text-center pt-2 font-bold\">\r\n            Approved By\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      {/* --- PREVIEW MODAL --- */}\r\n      {showPreview && (\r\n        <div className=\"fixed inset-0 bg-black bg-opacity-70 z-50 flex flex-col items-center overflow-auto p-4 md:p-10 print:hidden\">\r\n          <div className=\"flex w-full max-w-[210mm] justify-between mb-4\">\r\n            <h2 className=\"text-white text-xl font-bold italic\">\r\n              Print Preview (A4 View)\r\n            </h2>\r\n            <div className=\"flex gap-2\">\r\n              <button\r\n                onClick={() => window.print()}\r\n                className=\"bg-blue-500 text-white px-4 py-1 rounded shadow font-bold\"\r\n              >\r\n                Print Now\r\n              </button>\r\n              <button\r\n                onClick={() => setShowPreview(false)}\r\n                className=\"bg-red-500 text-white px-4 py-1 rounded shadow font-bold\"\r\n              >\r\n                Close\r\n              </button>\r\n            </div>\r\n          </div>\r\n\r\n          {/* This mimics the paper */}\r\n          <div className=\"bg-white w-full max-w-[210mm] min-h-[297mm] p-[20mm] shadow-2xl rounded-sm text-black\">\r\n            <div className=\"text-center mb-8 border-b-2 border-gray-100 pb-4\">\r\n              <h1 className=\"text-2xl font-bold uppercase tracking-widest text-gray-800\">\r\n                Payroll Report\r\n              </h1>\r\n              <p className=\"text-gray-600 mt-1\">\r\n                Month Year: <span className=\"font-bold\">{monthYear}</span>\r\n              </p>\r\n            </div>\r\n\r\n            <table className=\"w-full border-collapse border border-gray-400\">\r\n              <thead className=\"bg-gray-50\">\r\n                <tr>\r\n                  <th className=\"border border-gray-400 p-2 text-sm\">ID</th>\r\n                  <th className=\"border border-gray-400 p-2 text-sm text-left\">\r\n                    Employee\r\n                  </th>\r\n                  <th className=\"border border-gray-400 p-2 text-sm\">Basic</th>\r\n                  <th className=\"border border-gray-400 p-2 text-sm text-red-600\">\r\n                    Deduction\r\n                  </th>\r\n                  <th className=\"border border-gray-400 p-2 text-sm text-red-600\">\r\n                    Deduction Reason\r\n                  </th>\r\n\r\n                  <th className=\"border border-gray-400 p-2 text-sm\">Net</th>\r\n                  <th className=\"border border-gray-400 p-2 text-sm text-blue-600\">\r\n                    Paid\r\n                  </th>\r\n                  <th className=\"border border-gray-400 p-2 text-sm text-red-800\">\r\n                    Next Month\r\n                  </th>\r\n                </tr>\r\n              </thead>\r\n              <tbody>\r\n                {payroll.map((p) => (\r\n                  <tr key={p.id}>\r\n                    <td className=\"border border-gray-400 p-2 text-center text-sm\">\r\n                      {p.employee.employeeId}\r\n                    </td>\r\n                    <td className=\"border border-gray-400 p-2 text-sm\">\r\n                      {p.employee.firstName} {p.employee.lastName}\r\n                    </td>\r\n                    <td className=\"border border-gray-400 p-2 text-center text-sm\">\r\n                      {p.baseSalary.toLocaleString()}\r\n                    </td>\r\n                    <td className=\"border border-gray-400 p-2 text-center text-sm text-red-600\">\r\n                      {p.deductions > 0\r\n                        ? `-${p.deductions.toLocaleString()}`\r\n                        : p.deductions}\r\n                    </td>\r\n                    <td className=\"border border-gray-400 p-2 text-center text-sm text-red-600\">\r\n                      {p.deductionReason}\r\n                    </td>\r\n                    <td className=\"border border-gray-400 p-2 text-center text-sm font-bold\">\r\n                      {(\r\n                        p.baseSalary +\r\n                        p.allowances -\r\n                        p.deductions\r\n                      ).toLocaleString()}\r\n                    </td>\r\n                    <td className=\"border border-gray-400 p-2 text-center text-sm text-blue-600 font-bold\">\r\n                      {p.additionalCash > 0\r\n                        ? `${p.additionalCash.toLocaleString()}`\r\n                        : \"-\"}\r\n                    </td>\r\n\r\n                    <td className=\"border border-gray-400 p-2 text-center text-sm text-red-800 font-bold bg-gray-50\">\r\n                      {p.baseSalary +\r\n                        p.allowances -\r\n                        p.deductions -\r\n                        (p.additionalCash || 0) <\r\n                      0 ? (\r\n                        <div className=\"flex flex-col items-center\">\r\n                          {/* <span className=\"text-black\">0</span> */}\r\n                          <span className=\"text-red-600 text-sm font-bold whitespace-nowrap\">\r\n                            {(\r\n                              p.baseSalary +\r\n                              p.allowances -\r\n                              p.deductions -\r\n                              (p.additionalCash || 0)\r\n                            ).toLocaleString()}\r\n                          </span>\r\n                        </div>\r\n                      ) : (\r\n                        (\r\n                          p.baseSalary +\r\n                          p.allowances -\r\n                          p.deductions -\r\n                          (p.additionalCash || 0)\r\n                        ).toLocaleString()\r\n                      )}\r\n                    </td>\r\n                  </tr>\r\n                ))}\r\n              </tbody>\r\n              <tfoot>\r\n                <tr className=\"bg-gray-100 font-bold\">\r\n                  <td\r\n                    colSpan={2}\r\n                    className=\"border border-gray-400 p-2 text-right\"\r\n                  >\r\n                    TOTALS:\r\n                  </td>\r\n                  <td className=\"border border-gray-400 p-2 text-center\">\r\n                    {payroll\r\n                      .reduce((sum, p) => sum + p.baseSalary, 0)\r\n                      .toLocaleString()}\r\n                  </td>\r\n                  <td className=\"border border-gray-400 p-2 text-center text-red-600\">\r\n                    -\r\n                    {payroll\r\n                      .reduce((sum, p) => sum + p.deductions, 0)\r\n                      .toLocaleString()}\r\n                  </td>\r\n\r\n                  <td className=\"border border-gray-400 p-2\"></td>\r\n                  <td className=\"border border-gray-400 p-2\"></td>\r\n                  <td className=\"border border-gray-400 p-2 text-center text-blue-600\">\r\n                    {payroll\r\n                      .reduce((sum, p) => sum + (p.additionalCash || 0), 0)\r\n                      .toLocaleString()}\r\n                  </td>\r\n\r\n                  <td className=\"border border-gray-400 p-2 text-center text-red-800 bg-gray-50\">\r\n                    {payroll\r\n                      .reduce((sum, p) => {\r\n                        const pay = p.baseSalary + p.allowances - p.deductions;\r\n                        const balance = pay - (p.additionalCash || 0);\r\n                        return balance < 0 ? sum + balance : sum;\r\n                      }, 0)\r\n                      .toLocaleString()}\r\n                  </td>\r\n                </tr>\r\n              </tfoot>\r\n            </table>\r\n\r\n            <div className=\"flex justify-between mt-32 px-5\">\r\n              <div className=\"border-t border-black w-32 text-center pt-1 text-xs font-bold uppercase\">\r\n                Prepared By\r\n              </div>\r\n              <div className=\"border-t border-black w-32 text-center pt-1 text-xs font-bold uppercase\">\r\n                Approved By\r\n              </div>\r\n            </div>\r\n\r\n            <div className=\"mt-20 text-[10px] text-gray-400 text-center\">\r\n              System Generated Report - {new Date().toLocaleString()}\r\n            </div>\r\n          </div>\r\n        </div>\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\dashboard\\petty-cash\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\dashboard\\phase1-guide\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\dashboard\\purchase-invoice\\page.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'handleSupplierChange'. Either include it or remove the dependency array.","line":143,"column":6,"nodeType":"ArrayExpression","endLine":143,"endColumn":47,"suggestions":[{"desc":"Update the dependencies array to be: [today, showForm, showPreview, suppliers, handleSupplierChange]","fix":{"range":[4235,4276],"text":"[today, showForm, showPreview, suppliers, handleSupplierChange]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'loadInvoices' and 'user?.role'. Either include them or remove the dependency array.","line":167,"column":6,"nodeType":"ArrayExpression","endLine":167,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [loadInvoices, user?.role]","fix":{"range":[5014,5016],"text":"[loadInvoices, user?.role]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'user?.role'. Either include it or remove the dependency array.","line":182,"column":6,"nodeType":"ArrayExpression","endLine":182,"endColumn":15,"suggestions":[{"desc":"Update the dependencies array to be: [queryId, user?.role]","fix":{"range":[5388,5397],"text":"[queryId, user?.role]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { Suspense, useEffect, useRef, useState } from \"react\";\nimport { useSearchParams } from \"next/navigation\";\nimport toast from \"react-hot-toast\";\nimport dynamic from \"next/dynamic\";\nimport { getCurrentUser } from \"@/lib/auth\";\n\nconst Barcode = dynamic(() => import(\"react-barcode\"), { \n  ssr: false,\n  loading: () => <p>Loading Barcode...</p>\n});\nimport { QRCodeSVG } from \"qrcode.react\";\n\ntype Supplier = { id: string; name: string; partyType: string };\n\ntype POItem = {\n  itemId: string;\n  qty: number;\n  rate: number;\n  invoicedQty: number;\n  item: {\n    id: string;\n    name: string;\n    description?: string | null;\n  };\n};\n\ntype PurchaseOrder = {\n  id: string;\n  poNo: string;\n  supplierId: string;\n  items: POItem[];\n};\n\ntype PurchaseInvoice = {\n  id: string;\n  invoiceNo: string;\n  date: string;\n  supplierId: string;\n  supplier?: { name: string };\n  total: number;\n  items: Array<{ item: { name: string }; qty: number; rate: number }>;\n};\n\ntype Row = {\n  itemId: string;\n  name: string;\n  description?: string | null;\n  qty: number | \"\";\n  rate: number | \"\";\n};\n\ntype TaxConfig = {\n  id: string;\n  taxType: string;\n  taxCode: string;\n  taxRate: number;\n  description?: string;\n};\n\nfunction PurchaseInvoiceContent() {\n  const searchParams = useSearchParams();\n  const queryId = searchParams.get(\"id\");\n  const today = new Date().toISOString().slice(0, 10);\n  const user = getCurrentUser();\n\n  const [suppliers, setSuppliers] = useState<Supplier[]>([]);\n  const [allPOs, setAllPOs] = useState<PurchaseOrder[]>([]);\n  const [filteredPOs, setFilteredPOs] = useState<PurchaseOrder[]>([]);\n  const [invoices, setInvoices] = useState<PurchaseInvoice[]>([]);\n  const [showList, setShowList] = useState(false);\n  const [showForm, setShowForm] = useState(true);\n  const [editing, setEditing] = useState<PurchaseInvoice | null>(null);\n\nconst [searchTerm, setSearchTerm] = useState(\"\");\n\n\n  const [supplierId, setSupplierId] = useState(\"\");\n  const [supplierName, setSupplierName] = useState(\"\");\n  const [selectedPoId, setSelectedPoId] = useState(\"\");\n  const [invoiceId, setInvoiceId] = useState(\"\");\n  const [date, setDate] = useState(today);\n  const [location, setLocation] = useState(\"MAIN\");\n  const [freight, setFreight] = useState<number | \"\">(\"\");\n\n  const [rows, setRows] = useState<Row[]>([\n    { itemId: \"\", name: \"\", description: \"\", qty: \"\", rate: \"\" },\n  ]);\n\n  const [saving, setSaving] = useState(false);\n  const [showPreview, setShowPreview] = useState(false);\n  const [origin, setOrigin] = useState(\"\");\n\n  useEffect(() => {\n    setOrigin(window.location.origin);\n  }, []);\n\n  const [sendingEmail, setSendingEmail] = useState(false);\n  const [savedInvoiceId, setSavedInvoiceId] = useState<string | null>(null);\n  \n  // Tax states\n  const [applyTax, setApplyTax] = useState(false);\n  const [selectedTaxId, setSelectedTaxId] = useState(\"\");\n  const [taxes, setTaxes] = useState<TaxConfig[]>([]);\n\n  const supplierRef = useRef<HTMLSelectElement>(null);\n\n  // Keyboard shortcuts - F7: Clear date/supplier, F8: Query dialog\n  useEffect(() => {\n    function handleKeyPress(e: KeyboardEvent) {\n      if (e.code === \"F7\" || e.key === \"F7\") {\n        e.preventDefault();\n        e.stopPropagation();\n        if (showForm && !showPreview) {\n          setDate(today);\n          setSupplierId(\"\");\n          setSupplierName(\"\");\n        }\n      }\n      if (e.code === \"F8\" || e.key === \"F8\") {\n        e.preventDefault();\n        e.stopPropagation();\n        if (showForm && !showPreview) {\n          const query = prompt(\"Enter search query (Invoice No, Supplier Name, etc.):\");\n          if (query) {\n            const foundSupplier = suppliers.find(s => \n              s.name.toLowerCase().includes(query.toLowerCase())\n            );\n            if (foundSupplier) {\n              setSupplierId(foundSupplier.id);\n              setSupplierName(foundSupplier.name);\n              handleSupplierChange(foundSupplier.id);\n            } else {\n              toast.error(`No supplier found matching \"${query}\"`);\n            }\n          }\n        }\n      }\n    }\n    document.addEventListener(\"keydown\", handleKeyPress, true);\n    return () => document.removeEventListener(\"keydown\", handleKeyPress, true);\n  }, [today, showForm, showPreview, suppliers]);\n\n  useEffect(() => {\n    loadInvoices();\n    fetch(\"/api/accounts\", { headers: { \"x-user-role\": user?.role || \"ADMIN\" } })\n      .then(r => r.json())\n      .then(d => {\n        const list = Array.isArray(d) ? d : d.accounts;\n        setSuppliers(list.filter((a: Any) => a.partyType === \"SUPPLIER\"));\n      });\n\n    // Load tax configurations\n    fetch(\"/api/tax-configuration\")\n      .then(r => r.json())\n      .then(d => setTaxes(Array.isArray(d) ? d : []))\n      .catch(err => console.log(\"Tax config error:\", err));\n\n    fetch(\"/api/purchase-invoice\", {\n      headers: { \"x-user-role\": user?.role || \"ADMIN\" },\n    })\n      .then(r => r.json())\n      .then(data => {\n        if (Array.isArray(data)) setAllPOs(data);\n      });\n  }, []);\n\n  useEffect(() => {\n    if (queryId) {\n      fetch(`/api/purchase-invoice?id=${queryId}`, {\n         headers: { \"x-user-role\": user?.role || \"ADMIN\" }\n      })\n      .then(r => r.json())\n      .then(data => {\n         if (data && !data.error) {\n            startEdit(data);\n         }\n      })\n      .catch(e => console.error(\"Error loading invoice:\", e));\n    }\n  }, [queryId]);\n\n  async function loadInvoices() {\n    try {\n      const res = await fetch(\"/api/purchase-invoice?type=invoices\", {\n        headers: { \"x-user-role\": user?.role || \"ADMIN\" },\n      });\n      const data = await res.json();\n      if (Array.isArray(data)) {\n        setInvoices(data);\n      }\n    } catch (e) {\n      console.error(\"Load invoices error:\", e);\n    }\n  }\n\n  function handleSupplierChange(id: string) {\n    setSupplierId(id);\n    const s = suppliers.find(x => x.id === id);\n    setSupplierName(s?.name || \"\");\n    const pos = allPOs.filter(p => p.supplierId === id);\n    setFilteredPOs(pos);\n    setSelectedPoId(\"\");\n    setRows([{ itemId: \"\", name: \"\", description: \"\", qty: \"\", rate: \"\" }]);\n  }\n\n  function handlePoSelection(poId: string) {\n    setSelectedPoId(poId);\n    const po = filteredPOs.find(p => p.id === poId);\n    if (!po) return;\n\n    setRows(\n      po.items\n        .map(pi => ({\n          itemId: pi.itemId,\n          name: pi.item.name,\n          description: pi.item.description || \"\",\n          qty: Math.max(0, pi.qty - pi.invoicedQty),\n          rate: pi.rate,\n        }))\n        .filter(r => r.qty > 0)\n    );\n  }\n\n  function updateRow(index: number, key: \"qty\" | \"rate\", value: string) {\n    const copy = [...rows];\n    copy[index][key] = value === \"\" ? \"\" : Number(value);\n    setRows(copy);\n  }\n\n  const total = rows.reduce((s, r) => s + (Number(r.qty) * Number(r.rate) || 0), 0);\n  const selectedTax = taxes.find(t => t.id === selectedTaxId);\n  const taxAmount = applyTax && selectedTax ? (total * (selectedTax.taxRate / 100)) : 0;\n  const netTotal = total + (Number(freight) || 0) + taxAmount;\n\n  async function saveInvoice() {\n    const clean = rows.filter(r => r.itemId && r.qty !== \"\" && Number(r.qty) > 0);\n    if (!supplierId || clean.length === 0) {\n      toast.error(\"Supplier and item are required\");\n      return;\n    }\n\n    setSaving(true);\n    try {\n      const method = editing ? \"PUT\" : \"POST\";\n      const baseBody = {\n        supplierId,\n        poId: selectedPoId,\n        date,\n        location,\n        freight: Number(freight) || 0,\n        items: clean,\n        applyTax,\n        taxConfigId: applyTax ? selectedTaxId : null,\n      };\n      const body = editing ? { id: editing.id, ...baseBody } : baseBody;\n\n      const res = await fetch(\"/api/purchase-invoice\", {\n        method,\n        headers: { \"Content-Type\": \"application/json\", \"x-user-role\": user?.role || \"ADMIN\" },\n        body: JSON.stringify(body),\n      });\n\n      const contentType = res.headers.get(\"content-type\") || \"\";\n      let data: Any = null;\n      if (contentType.includes(\"application/json\")) {\n        try {\n          data = await res.json();\n        } catch {\n          data = null;\n        }\n      } else {\n        try {\n          const text = await res.text();\n          data = text || null;\n        } catch {\n          data = null;\n        }\n      }\n      if (res.ok && data) {\n        setInvoiceId((typeof data === \"object\" && data.invoiceNo) ? data.invoiceNo : (data?.id || invoiceId));\n        setSavedInvoiceId((typeof data === \"object\" && data.id) ? data.id : (editing?.id || null));\n        setShowPreview(true);\n        await loadInvoices();\n        if (editing) {\n          setEditing(null);\n          setShowForm(false);\n          setShowList(true);\n        }\n        toast.success(\"Invoice saved successfully!\");\n      } else {\n        const msg = (data && typeof data === \"object\" && data.error)\n          ? data.error\n          : (typeof data === \"string\" && data.trim().length > 0)\n            ? data\n            : \"Save failed (empty/invalid response)\";\n        toast.error(\"Error: \" + msg);\n      }\n    } catch (err: Any) {\n      toast.error(\"System Error: \" + err.message);\n    } finally {\n      setSaving(false);\n    }\n  }\n\n\n  function startEdit(inv: PurchaseInvoice) {\n    setEditing(inv);\n    setInvoiceId(inv.invoiceNo);\n    setSupplierId(inv.supplierId);\n    setSupplierName(inv.supplier?.name || \"\");\n    setDate(new Date(inv.date).toISOString().slice(0, 10));\n    setRows(inv.items.map((it: Any) => ({\n      itemId: it.itemId || \"\",\n      name: it.item?.name || \"\",\n      description: it.item?.description || \"\",\n      qty: it.qty.toString(),\n      rate: it.rate.toString(),\n    })));\n    setShowForm(true);\n    setShowList(false);\n  }\n\n  async function deleteInvoice(id: string) {\n    if (!confirm(\"Are you sure you want to delete this invoice?\")) return;\n    try {\n      const res = await fetch(`/api/purchase-invoice?id=${id}`, {\n        method: \"DELETE\",\n        headers: { \"x-user-role\": user?.role || \"ADMIN\" },\n      });\n      if (res.ok) {\n        toast.success(\"Invoice deleted successfully\");\n        await loadInvoices();\n      } else {\n        const err = await res.json();\n        toast.error(err.error || \"Delete failed\");\n      }\n    } catch (_e) {\n      toast.error(\"Delete failed\");\n    }\n  }\n\n  function resetForm() {\n    setEditing(null);\n    setSupplierId(\"\");\n    setSupplierName(\"\");\n    setSelectedPoId(\"\");\n    setDate(today);\n    setLocation(\"MAIN\");\n    setFreight(\"\");\n    setRows([{ itemId: \"\", name: \"\", description: \"\", qty: \"\", rate: \"\" }]);\n    setApplyTax(false);\n    setSelectedTaxId(\"\");\n    setShowPreview(false);\n    setSavedInvoiceId(null);\n  }\n\n  async function sendInvoiceEmail() {\n    if (!savedInvoiceId) {\n      toast.error(\"Please save the invoice first\");\n      return;\n    }\n\n    const supplierEmail = prompt(\"Enter supplier email address:\");\n    if (!supplierEmail || !supplierEmail.includes(\"@\")) {\n      toast.error(\"Please enter a valid email address\");\n      return;\n    }\n\n    setSendingEmail(true);\n    try {\n      const res = await fetch(\"/api/email/send\", {\n        method: \"POST\",\n        headers: {\n          \"Content-Type\": \"application/json\",\n          \"x-user-role\": user?.role || \"\",\n          \"x-user-id\": user?.id || \"\",\n        },\n        body: JSON.stringify({\n          type: \"purchase-invoice\",\n          invoiceId: savedInvoiceId,\n          to: supplierEmail,\n        }),\n      });\n\n      const data = await res.json();\n      if (res.ok) {\n        toast.success(\"✅ Email sent successfully!\");\n      } else {\n        toast.error(`❌ Failed to send email: ${data.error || \"Unknown error\"}`);\n      }\n    } catch (_error) {\n      toast.error(\"❌ Failed to send email. Please check email configuration.\");\n    } finally {\n      setSendingEmail(false);\n    }\n  }\n  const filteredInvoices = invoices.filter(inv => {\n  if (!searchTerm.trim()) return true;\n\n  const term = searchTerm.toLowerCase();\n\n  return (\n    inv.invoiceNo?.toLowerCase().includes(term) ||\n    inv.supplier?.name?.toLowerCase().includes(term) ||\n    inv.date?.toLowerCase().includes(term)\n  );\n});\n\n\n  return (\n    <div className=\"p-6 max-w-6xl mx-auto space-y-6\">\n      <div className=\"flex justify-between items-center\">\n        <h1 className=\"text-xl font-bold\">Purchase Invoice</h1>\n        <div className=\"flex gap-2\">\n          <button\n            onClick={() => { setShowList(!showList); setShowForm(!showForm); setEditing(null); }}\n            className=\"bg-gray-600 text-white px-4 py-2 rounded\"\n          >\n            {showList ? \"Hide List\" : \"Show List\"}\n          </button>\n          <button\n            onClick={() => { setShowForm(true); setShowList(false); resetForm(); }}\n            className=\"bg-blue-600 text-white px-4 py-2 rounded\"\n          >\n            + New Invoice\n          </button>\n        </div>\n      </div>\n\n      {/* LIST VIEW */}\n      {showList && (\n        <div className=\"bg-white border rounded overflow-x-auto\">\n          <table className=\"w-full text-sm min-w-[800px]\">\n            <thead className=\"bg-gray-100\">\n              <tr>\n                <th className=\"p-3 text-left\">Invoice No</th>\n                <th className=\"p-3 text-left\">Date</th>\n                <th className=\"p-3 text-left\">Supplier</th>\n                <th className=\"p-3 text-right\">Total</th>\n                <th className=\"p-3 text-center\">Actions</th>\n              </tr>\n            </thead>\n            <tbody>\n              {filteredInvoices.length === 0 ? (\n                <tr>\n                  <td colSpan={5} className=\"p-4 text-center text-gray-400\">No invoices found</td>\n                </tr>\n              ) : (\n                filteredInvoices.map(inv => (\n                  <tr key={inv.id} className=\"border-t hover:bg-gray-50\">\n                    <td className=\"p-3 font-bold\">{inv.invoiceNo}</td>\n                    <td className=\"p-3\">{new Date(inv.date).toLocaleDateString()}</td>\n                    <td className=\"p-3\">{inv.supplier?.name || \"N/A\"}</td>\n                    <td className=\"p-3 text-right\">{inv.total.toLocaleString()}</td>\n                    <td className=\"p-3 text-center space-x-2\">\n                      <button\n                        onClick={() => startEdit(inv)}\n                        className=\"text-blue-600 hover:text-blue-800 font-medium text-sm\"\n                      >\n                        Edit\n                      </button>\n                      <button\n                        onClick={() => deleteInvoice(inv.id)}\n                        className=\"text-red-600 hover:text-red-800 font-medium text-sm\"\n                      >\n                        Delete\n                      </button>\n                    </td>\n                  </tr>\n                ))\n              )}\n            </tbody>\n          </table>\n        </div>\n      )}\n\n      {/* FORM */}\n      {showForm && (\n        <>\n          <div className=\"flex justify-between items-center bg-gray-50 p-4 border rounded print:hidden\">\n            <div>\n              <h1 className=\"text-xl font-bold\">\n                {editing ? \"Edit Invoice\" : \"Purchase Invoice\"}\n              </h1>\n              {invoiceId && (\n                <div className=\"mt-1\">\n                   <Barcode value={invoiceId} width={1} height={30} fontSize={12} displayValue={true} />\n                </div>\n              )}\n            </div>\n            <div className=\"flex gap-3\">\n              {!showPreview ? (\n                <button onClick={saveInvoice} disabled={saving} className=\"bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded font-bold shadow-md transition-all\">\n                  {saving ? \"Saving...\" : editing ? \"Update Invoice\" : \"Save & Preview\"}\n                </button>\n              ) : (\n              \n                <>\n\n                <input\n  type=\"text\"\n  placeholder=\"Search invoices...\"\n  value={searchTerm}\n  onChange={(e) => setSearchTerm(e.target.value)}\n  className=\"border px-3 py-2 rounded w-full md:w-64\"\n/>\n\n                  <button onClick={() => window.print()} className=\"bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded font-bold shadow-md\">\n                    Print / Download PDF\n                  </button>\n                  <button \n                    onClick={sendInvoiceEmail} \n                    disabled={sendingEmail}\n                    className=\"bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded font-bold shadow-md disabled:bg-gray-400\"\n                  >\n                    {sendingEmail ? \"Sending...\" : \"📧 Email\"}\n                  </button>\n                  <button onClick={() => setShowPreview(false)} className=\"bg-gray-200 hover:bg-gray-300 text-gray-800 px-6 py-2 rounded border font-bold\">\n                    Back to Edit\n                  </button>\n                </>\n              )}\n              <button onClick={() => { setShowForm(false); setEditing(null); resetForm(); }} className=\"bg-gray-600 text-white px-6 py-2 rounded font-bold\">\n                Cancel\n              </button>\n            </div>\n          </div>\n\n          {!showPreview && (\n            <div className=\"bg-white border p-6 rounded space-y-6 shadow-sm\">\n              <div className=\"mb-2 text-xs text-gray-500 italic\">\n                💡 Keyboard Shortcuts: <strong>F7</strong> = Clear Date & Supplier | <strong>F8</strong> = Search Query\n              </div>\n              <div className=\"grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4\">\n                <div>\n                  <label className=\"text-xs font-bold\">Supplier (F7: Clear, F8: Query)</label>\n                  <select ref={supplierRef} className=\"border p-2 rounded w-full\" value={supplierId} onChange={e => handleSupplierChange(e.target.value)}>\n                    <option value=\"\">Select Supplier</option>\n                    {suppliers.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}\n                  </select>\n                </div>\n\n                <select className=\"border p-2 bg-yellow-50 rounded\" value={selectedPoId} onChange={e => handlePoSelection(e.target.value)}>\n                  <option value=\"\">-- Select PO --</option>\n                  {filteredPOs.map(p => <option key={p.id} value={p.id}>{p.poNo}</option>)}\n                </select>\n\n                <div>\n                  <label className=\"text-xs font-bold\">Date (F7: Clear)</label>\n                  <input type=\"date\" className=\"border p-2 rounded w-full\" value={date} onChange={e => setDate(e.target.value)} />\n                </div>\n\n                <select className=\"border p-2 rounded\" value={location} onChange={e => setLocation(e.target.value)}>\n                  <option value=\"MAIN\">Main</option>\n                  <option value=\"SHOP\">Shop</option>\n                </select>\n              </div>\n\n              <div className=\"overflow-x-auto\">\n                <table className=\"w-full border text-sm min-w-[600px]\">\n                  <thead className=\"bg-gray-100 font-bold\">\n                  <tr>\n                    <th className=\"border p-2 text-left\">Item</th>\n                    <th className=\"border p-2 w-24 text-center\">Qty</th>\n                    <th className=\"border p-2 w-32 text-center\">Rate</th>\n                    <th className=\"border p-2 w-32 text-right\">Amount</th>\n                  </tr>\n                </thead>\n                <tbody>\n                  {rows.map((r, i) => (\n                    <tr key={i} className=\"hover:bg-gray-50\">\n                      <td className=\"border p-2\">\n                        <div className=\"font-medium uppercase\">{r.name}</div>\n                        {r.description && <div className=\"text-xs text-gray-500\">{r.description}</div>}\n                      </td>\n                      <td className=\"border p-2\">\n                        <input type=\"number\" className=\"w-full text-center outline-none\" value={r.qty} onChange={e => updateRow(i, \"qty\", e.target.value)} />\n                      </td>\n                      <td className=\"border p-2\">\n                        <input type=\"number\" className=\"w-full text-center outline-none\" value={r.rate} onChange={e => updateRow(i, \"rate\", e.target.value)} />\n                      </td>\n                      <td className=\"border p-2 text-right font-mono font-bold\">{(Number(r.qty) * Number(r.rate) || 0).toLocaleString()}</td>\n                    </tr>\n                  ))}\n                </tbody>\n                </table>\n              </div>\n\n              <div className=\"flex justify-end\">\n                <div className=\"w-80 p-4 border bg-gray-50 rounded space-y-2\">\n                  <div className=\"flex justify-between text-sm\"><span>Gross Total:</span><span>{total.toLocaleString()}</span></div>\n                  <div className=\"flex justify-between items-center text-sm\">\n                    <span>Freight:</span>\n                    <input type=\"number\" className=\"border w-32 text-right p-1 rounded\" value={freight} onChange={e => setFreight(e.target.value === \"\" ? \"\" : Number(e.target.value))} />\n                  </div>\n                  \n                  {/* Tax Section */}\n                  <div className=\"border-t pt-2 space-y-2\">\n                    <button\n                      type=\"button\"\n                      onClick={() => {\n                        setApplyTax(!applyTax);\n                        if (!applyTax) setSelectedTaxId(\"\");\n                      }}\n                      className={`w-full py-1 px-2 rounded font-semibold text-sm ${\n                        applyTax ? \"bg-blue-600 text-white\" : \"bg-gray-200 text-gray-700\"\n                      }`}\n                    >\n                      {applyTax ? \"✓ Tax Applied\" : \"+ Add Tax\"}\n                    </button>\n                    \n                    {applyTax && (\n                      <div className=\"space-y-2\">\n                        <select\n                          value={selectedTaxId}\n                          onChange={e => setSelectedTaxId(e.target.value)}\n                          className=\"w-full border p-1 text-sm\"\n                        >\n                          <option value=\"\">Select Tax</option>\n                          {taxes.map(tax => (\n                            <option key={tax.id} value={tax.id}>\n                              {tax.taxType} ({tax.taxCode}) - {tax.taxRate}%\n                            </option>\n                          ))}\n                        </select>\n                        {selectedTax && (\n                          <div className=\"flex justify-between text-sm text-blue-600\">\n                            <span>{selectedTax.taxType} ({selectedTax.taxRate}%)</span>\n                            <span>{taxAmount.toLocaleString()}</span>\n                          </div>\n                        )}\n                      </div>\n                    )}\n                  </div>\n                  \n                  <div className=\"flex justify-between font-black text-lg border-t pt-2 text-blue-900 uppercase\"><span>Net Payable:</span><span>{netTotal.toLocaleString()}</span></div>\n                </div>\n              </div>\n            </div>\n          )}\n\n          {/* PREVIEW */}\n          {showPreview && (\n            <div className=\"invoice-print bg-white mx-auto text-black\">\n              <div className=\"flex justify-between border-b-4 border-black pb-4 mb-6\">\n                <div>\n                  <h1 className=\"text-4xl font-black italic tracking-tighter\">US TRADERS</h1>\n                  <p className=\"text-[10px] font-bold uppercase tracking-[3px] text-gray-600\">Industrial Goods & Services</p>\n                </div>\n                <div className=\"text-right\">\n                  <h2 className=\"text-2xl font-black uppercase underline\">Purchase Invoice</h2>\n                  <p className=\"text-sm font-bold mt-1\">INV #: {invoiceId}</p>\n                  <p className=\"text-sm\">Date: {date}</p>\n                  {invoiceId && (\n                    <div className=\"flex flex-col items-end gap-2 mt-2\">\n                      <div className=\"text-center\">\n                        <Barcode value={invoiceId} width={1.5} height={40} fontSize={14} displayValue={false} />\n                        <span className=\"text-[10px] font-bold\">INV ID: {invoiceId}</span>\n                      </div>\n                      \n                      {origin && (\n                        <div className=\"flex flex-col items-center mt-2 border-t pt-2\">\n                          <QRCodeSVG value={`${origin}/view/purchase-invoice?id=${invoiceId}`} size={80} />\n                          <span className=\"text-[10px] font-bold mt-1 bg-black text-white px-1\">SCAN FOR ONLINE BILL</span>\n                        </div>\n                      )}\n                    </div>\n                  )}\n                </div>\n              </div>\n\n              <div className=\"mb-6\">\n                <p className=\"text-[10px] uppercase font-bold text-gray-400\">Vendor / Supplier:</p>\n                <p className=\"text-xl font-black uppercase\">{supplierName}</p>\n                <p className=\"text-xs font-bold italic\">Location: {location}</p>\n              </div>\n\n              <table className=\"w-full text-sm border-collapse border border-black\">\n                <thead>\n                  <tr className=\"bg-black text-white border border-black uppercase text-[10px]\">\n                    <th className=\"p-2 border border-black text-center w-12\">Sr.</th>\n                    <th className=\"p-2 border border-black text-left\">Description of Items</th>\n                    <th className=\"p-2 border border-black text-center w-24\">Qty</th>\n                    <th className=\"p-2 border border-black text-center w-32\">Rate</th>\n                    <th className=\"p-2 border border-black text-right w-36\">Total</th>\n                  </tr>\n                </thead>\n                <tbody>\n                  {rows.map((r, i) => (\n                    <tr key={i} className=\"border border-black font-bold\">\n                      <td className=\"p-3 border border-black text-center\">{i + 1}</td>\n                      <td className=\"p-3 border border-black\">\n                        <div className=\"uppercase\">{r.name}</div>\n                        {r.description && <div className=\"text-[10px] font-normal leading-tight lowercase text-gray-600\">{r.description}</div>}\n                      </td>\n                      <td className=\"p-3 border border-black text-center\">{r.qty}</td>\n                      <td className=\"p-3 border border-black text-center\">{Number(r.rate).toLocaleString()}</td>\n                      <td className=\"p-3 border border-black text-right font-mono\">{(Number(r.qty) * Number(r.rate)).toLocaleString()}</td>\n                    </tr>\n                  ))}\n                </tbody>\n              </table>\n\n              <div className=\"flex justify-end mt-4\">\n                <div className=\"w-72 space-y-1\">\n                  <div className=\"flex justify-between text-[11px] font-bold border-b border-black pb-1\"><span>SUB-TOTAL:</span><span>{total.toLocaleString()}</span></div>\n                  <div className=\"flex justify-between text-[11px] font-bold border-b border-black pb-1\"><span>FREIGHT:</span><span>{Number(freight || 0).toLocaleString()}</span></div>\n                  {selectedTax && (\n                    <div className=\"flex justify-between text-[11px] font-bold border-b border-black pb-1\">\n                      <span>{selectedTax.taxType.toUpperCase()} ({selectedTax.taxRate}%):</span>\n                      <span>{taxAmount.toLocaleString()}</span>\n                    </div>\n                  )}\n                  <div className=\"flex justify-between text-2xl font-black border-t-2 border-black pt-1 bg-gray-50 p-2\">\n                    <span>NET:</span>\n                    <span>{netTotal.toLocaleString()}</span>\n                  </div>\n                </div>\n              </div>\n\n              <div className=\"mt-32 flex justify-between px-10\">\n                <div className=\"text-center w-48 border-t-2 border-black pt-1 text-[10px] font-bold uppercase\">Prepared By</div>\n                <div className=\"text-center w-48 border-t-2 border-black pt-1 text-[10px] font-bold uppercase\">Authorized Sign</div>\n              </div>\n            </div>\n          )}\n        </>\n      )}\n    </div>\n  );\n}\n\nexport default function PurchaseInvoicePage() {\n  return (\n    <Suspense fallback={<div className=\"p-4 text-center\">Loading Invoice...</div>}>\n      <PurchaseInvoiceContent />\n    </Suspense>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\dashboard\\purchase-order\\page.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'loadPOs' and 'user?.role'. Either include them or remove the dependency array.","line":94,"column":6,"nodeType":"ArrayExpression","endLine":94,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [loadPOs, user?.role]","fix":{"range":[3291,3293],"text":"[loadPOs, user?.role]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\nimport { useEffect, useState } from \"react\";\nimport toast from \"react-hot-toast\";\nimport { getCurrentUser } from \"@/lib/auth\";\n\ntype PO = {\n  id: string;\n  poNo: string;\n  date: string;\n  supplierId: string;\n  supplier?: { name: string };\n  remarks?: string;\n  items: Array<{ item: { name: string }; qty: number; rate: number }>;\n};\n\nexport default function PurchaseOrderPage() {\n  const today = new Date().toISOString().slice(0, 10);\n  const user = getCurrentUser();\n\n  const [suppliers, setSuppliers] = useState<Any[]>([]);\n  const [items, setItems] = useState<Any[]>([]);\n  const [pos, setPos] = useState<PO[]>([]);\n  const [showList, setShowList] = useState(false);\n  const [showForm, setShowForm] = useState(true);\n  const [editing, setEditing] = useState<PO | null>(null);\n\n  const [poNo, setPoNo] = useState(\"\");\n  const [supplierId, setSupplierId] = useState(\"\");\n  const [supplierName, setSupplierName] = useState(\"\");\n  const [date, setDate] = useState(today);\n  const [remarks, setRemarks] = useState(\"\");\n  const [rows, setRows] = useState([{ itemId: \"\", name: \"\", desc: \"\", qty: \"\", rate: \"\" }]);\n  const [saving, setSaving] = useState(false);\n  const [preview, setPreview] = useState(false);\n  const [sendingEmail, setSendingEmail] = useState(false);\n  const [savedPO, setSavedPO] = useState<PO | null>(null);\n\n  // Email Modal State\n  const [emailModalOpen, setEmailModalOpen] = useState(false);\n  const [recipientEmail, setRecipientEmail] = useState(\"\");\n\n\n  // Keyboard shortcuts - F7: Clear date/customer, F8: Query dialog\n  useEffect(() => {\n    function handleKeyPress(e: KeyboardEvent) {\n      // Use code for function keys\n      if (e.code === \"F7\" || e.key === \"F7\") {\n        e.preventDefault();\n        e.stopPropagation();\n        if (showForm && !preview) {\n          setDate(today);\n          setSupplierId(\"\");\n          setSupplierName(\"\");\n        }\n      }\n      if (e.code === \"F8\" || e.key === \"F8\") {\n        e.preventDefault();\n        e.stopPropagation();\n        if (showForm && !preview) {\n          // Open query/search dialog\n          const query = prompt(\"Enter search query (Invoice No, Supplier Name, etc.):\");\n          if (query) {\n            // Search in suppliers\n            const foundSupplier = suppliers.find(s =>\n              s.name.toLowerCase().includes(query.toLowerCase())\n            );\n            if (foundSupplier) {\n              setSupplierId(foundSupplier.id);\n              setSupplierName(foundSupplier.name);\n            } else {\n              toast.error(`No supplier found matching \"${query}\"`);\n            }\n          }\n        }\n      }\n    }\n    document.addEventListener(\"keydown\", handleKeyPress, true);\n    return () => document.removeEventListener(\"keydown\", handleKeyPress, true);\n  }, [today, showForm, preview, suppliers]);\n\n  /* LOAD DATA */\n  useEffect(() => {\n    loadPOs();\n    fetch(\"/api/accounts\", { headers: { \"x-user-role\": user?.role || \"ADMIN\" } })\n      .then(r => r.json())\n      .then(d => {\n        const list = Array.isArray(d) ? d : d.accounts;\n        setSuppliers((list || []).filter((a: Any) => a.partyType === \"SUPPLIER\"));\n      });\n\n    fetch(\"/api/items-new\", { headers: { \"x-user-role\": user?.role || \"ADMIN\" } })\n      .then(r => r.json())\n      .then(setItems);\n  }, []);\n\n  async function loadPOs() {\n    try {\n      // Load next PO number\n      const nextRes = await fetch(\"/api/purchase-order?nextNo=true\", { headers: { \"x-user-role\": user?.role || \"ADMIN\" } });\n      const nextData = await nextRes.json();\n      if (nextData?.poNo) setPoNo(nextData.poNo);\n\n      // Load all POs\n      const res = await fetch(\"/api/purchase-order\", { headers: { \"x-user-role\": user?.role || \"ADMIN\" } });\n      const data = await res.json();\n      if (Array.isArray(data)) {\n        setPos(data);\n      }\n    } catch (e) {\n      console.error(\"Load POs error:\", e);\n    }\n  }\n\n  function updateRow(i: number, key: string, val: Any) {\n    const copy = [...rows];\n    (copy[i] as Any)[key] = val;\n    setRows(copy);\n  }\n\n  function addRow() {\n    setRows([...rows, { itemId: \"\", name: \"\", desc: \"\", qty: \"\", rate: \"\" }]);\n  }\n\n  const total = rows.reduce((s, r) => s + (r.qty && r.rate ? Number(r.qty) * Number(r.rate) : 0), 0);\n\n  async function savePO() {\n    const clean = rows.filter(r => r.itemId && r.qty);\n    if (!supplierId || clean.length === 0) { toast.error(\"Supplier aur items zaroori hain\"); return; }\n    setSaving(true);\n    try {\n      const method = editing ? \"PUT\" : \"POST\";\n      const body = editing\n        ? { id: editing.id, poNo, supplierId, date, remarks, items: clean }\n        : { poNo, supplierId, date, remarks, items: clean };\n\n      const res = await fetch(\"/api/purchase-order\", {\n        method,\n        headers: { \"Content-Type\": \"application/json\", \"x-user-role\": user?.role || \"ADMIN\" },\n        body: JSON.stringify(body),\n      });\n      if (res.ok) {\n        const data = await res.json();\n        setSavedPO(data);   // 🔥 IMPORTANT\n        setPreview(true);\n        await loadPOs();\n\n\n        if (editing) {\n          setEditing(null);\n          setShowForm(false);\n          setShowList(true);\n        }\n      }\n      else {\n        const err = await res.json();\n        alert(err.error || \"Saving failed\");\n      }\n    } catch (_err) { alert(\"Error saving PO\"); }\n    finally { setSaving(false); }\n  }\n\n  function startEdit(po: PO) {\n    setEditing(po);\n    setPoNo(po.poNo);\n    setSupplierId(po.supplierId);\n    setSupplierName(po.supplier?.name || \"\");\n    setDate(new Date(po.date).toISOString().slice(0, 10));\n    setRemarks(po.remarks || \"\");\n    setRows(po.items.map((it: Any) => ({\n      itemId: it.itemId || \"\",\n      name: it.item?.name || \"\",\n      desc: it.item?.description || \"\",\n      qty: it.qty.toString(),\n      rate: it.rate.toString(),\n    })));\n    setShowForm(true);\n    setShowList(false);\n  }\n\n  async function deletePO(id: string) {\n    if (!confirm(\"Are you sure you want to delete this PO?\")) return;\n    try {\n      const res = await fetch(`/api/purchase-order?id=${id}`, {\n        method: \"DELETE\",\n        headers: { \"x-user-role\": user?.role || \"ADMIN\" },\n      });\n      if (res.ok) {\n        alert(\"PO deleted successfully\");\n        await loadPOs();\n      } else {\n        const err = await res.json();\n        alert(err.error || \"Delete failed\");\n      }\n    } catch (_e) {\n      alert(\"Delete failed\");\n    }\n  }\n\n  function resetForm() {\n    setEditing(null);\n    setPoNo(\"\");\n    setSupplierId(\"\");\n    setSupplierName(\"\");\n    setDate(today);\n    setRemarks(\"\");\n    setRows([{ itemId: \"\", name: \"\", desc: \"\", qty: \"\", rate: \"\" }]);\n    setPreview(false);\n  }\n\n  function openEmailModal() {\n    if (!preview) {\n      toast.error(\"Please save and preview the PO first\");\n      return;\n    }\n    // Try to find supplier email\n    const supplier = suppliers.find(s => s.id === supplierId);\n    setRecipientEmail(supplier?.email || \"\");\n    setEmailModalOpen(true);\n  }\n\n  async function confirmSendEmail() {\n    if (!recipientEmail || !recipientEmail.includes(\"@\")) {\n      toast.error(\"Please enter a valid email address\");\n      return;\n    }\n\n    setSendingEmail(true);\n    try {\n      const res = await fetch(\"/api/email/send\", {\n        method: \"POST\",\n        headers: {\n          \"Content-Type\": \"application/json\",\n          \"x-user-role\": user?.role || \"\",\n          \"x-user-id\": user?.id || \"\",\n        },\n        body: JSON.stringify({\n          type: \"purchase-order\",\n          invoiceId: savedPO?.id,\n          to: recipientEmail,\n        }),\n      });\n\n      const data = await res.json();\n      if (res.ok) {\n        toast.success(\"✅ Email sent successfully!\");\n        setEmailModalOpen(false);\n      } else {\n        toast.error(data.error || \"Failed to send email\");\n      }\n    } catch (_error) {\n      toast.error(\"Failed to send email. Please check email configuration.\");\n    } finally {\n      setSendingEmail(false);\n    }\n  }\n\n  return (\n    <div className=\"p-6 max-w-5xl mx-auto space-y-6 text-black\">\n      <div className=\"flex justify-between items-center\">\n        <h1 className=\"text-xl font-bold\">Purchase Order</h1>\n        <div className=\"flex gap-2\">\n          <button\n            onClick={() => { setShowList(!showList); setShowForm(!showForm); setEditing(null); }}\n            className=\"bg-gray-600 text-white px-4 py-2 rounded\"\n          >\n            {showList ? \"Hide List\" : \"Show List\"}\n          </button>\n          <button\n            onClick={() => { setShowForm(true); setShowList(false); resetForm(); loadPOs(); }}\n            className=\"bg-blue-600 text-white px-4 py-2 rounded\"\n          >\n            + New PO\n          </button>\n        </div>\n      </div>\n\n      {/* LIST VIEW */}\n      {showList && (\n        <div className=\"bg-white border rounded overflow-x-auto\">\n          <table className=\"w-full text-sm min-w-[800px]\">\n            <thead className=\"bg-gray-100\">\n              <tr>\n                <th className=\"p-3 text-left\">PO No</th>\n                <th className=\"p-3 text-left\">Date</th>\n                <th className=\"p-3 text-left\">Supplier</th>\n                <th className=\"p-3 text-right\">Items</th>\n                <th className=\"p-3 text-center\">Actions</th>\n              </tr>\n            </thead>\n            <tbody>\n              {pos.length === 0 ? (\n                <tr>\n                  <td colSpan={5} className=\"p-4 text-center text-gray-400\">No POs found</td>\n                </tr>\n              ) : (\n                pos.map(po => (\n                  <tr key={po.id} className=\"border-t hover:bg-gray-50\">\n                    <td className=\"p-3 font-bold\">{po.poNo}</td>\n                    <td className=\"p-3\">{new Date(po.date).toLocaleDateString()}</td>\n                    <td className=\"p-3\">{po.supplier?.name || \"N/A\"}</td>\n                    <td className=\"p-3 text-right\">{po.items?.length || 0}</td>\n                    <td className=\"p-3 text-center space-x-2\">\n                      <button\n                        onClick={() => startEdit(po)}\n                        className=\"text-blue-600 hover:text-blue-800 font-medium text-sm\"\n                      >\n                        Edit\n                      </button>\n                      <button\n                        onClick={() => deletePO(po.id)}\n                        className=\"text-red-600 hover:text-red-800 font-medium text-sm\"\n                      >\n                        Delete\n                      </button>\n                    </td>\n                  </tr>\n                ))\n              )}\n            </tbody>\n          </table>\n        </div>\n      )}\n\n      {/* FORM */}\n      {showForm && (\n        <>\n          <div className=\"flex justify-between items-center bg-gray-50 p-4 border rounded-lg print:hidden font-sans\">\n            <h1 className=\"text-xl font-bold\">{editing ? \"Edit PO\" : \"Create Purchase Order\"}</h1>\n            <div className=\"flex gap-3\">\n              {!preview ? (\n                <button\n                  onClick={savePO}\n                  disabled={saving}\n                  className=\"bg-blue-600 text-white px-6 py-2 rounded font-bold uppercase\"\n                >\n                  {saving ? \"Saving...\" : editing ? \"Update PO\" : \"Save & Preview\"}\n                </button>\n              ) : (\n                <>\n                  <button\n                    onClick={() => window.print()}\n                    className=\"bg-green-600 text-white px-6 py-2 rounded font-bold uppercase\"\n                  >\n                    Print / Download PDF\n                  </button>\n                  <button\n                    onClick={openEmailModal}\n                    disabled={sendingEmail}\n                    className=\"bg-blue-600 text-white px-6 py-2 rounded font-bold uppercase disabled:bg-gray-400\"\n                  >\n                    {sendingEmail ? \"Sending...\" : \"📧 Email\"}\n                  </button>\n                  <button\n                    onClick={() => setPreview(false)}\n                    className=\"bg-gray-200 text-gray-800 px-6 py-2 rounded font-bold uppercase border\"\n                  >\n                    Back to Edit\n                  </button>\n                </>\n              )}\n              <button\n                onClick={() => {\n                  setShowForm(false);\n                  setEditing(null);\n                  resetForm();\n                }}\n                className=\"bg-gray-600 text-white px-6 py-2 rounded font-bold uppercase\"\n              >\n                Cancel\n              </button>\n            </div>\n          </div>\n\n          {!preview && (\n            <div className=\"bg-white border p-8 rounded-xl shadow-sm space-y-6\">\n              <div className=\"mb-2 text-xs text-gray-500 italic\">\n                💡 Keyboard Shortcuts: <strong>F7</strong> = Clear Date & Supplier | <strong>F8</strong> = Search Query\n              </div>\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6 font-sans\">\n                <div><label className=\"text-xs font-bold uppercase text-gray-500\">PO Number</label><input className=\"border w-full p-2 bg-gray-50 rounded font-bold\" value={poNo} disabled /></div>\n                <div><label className=\"text-xs font-bold uppercase text-gray-500\">Order Date (F7: Clear)</label><input type=\"date\" className=\"border w-full p-2 rounded font-bold\" value={date} onChange={e => setDate(e.target.value)} /></div>\n              </div>\n              <div>\n                <label className=\"text-xs font-bold uppercase text-gray-500\">Select Supplier (F7: Clear, F8: Query)</label>\n                <select className=\"border p-2 w-full rounded font-bold\" value={supplierId} onChange={e => {\n                  setSupplierId(e.target.value);\n                  const s = suppliers.find(x => x.id === e.target.value);\n                  setSupplierName(s?.name || \"\");\n                }}>\n                  <option value=\"\">-- Choose Supplier --</option>\n                  {suppliers.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}\n                </select>\n              </div>\n\n              <table className=\"w-full text-left font-sans\">\n                <thead className=\"border-b-2\">\n                  <tr className=\"text-xs uppercase text-gray-400\">\n                    <th className=\"pb-2\">Item Description</th>\n                    <th className=\"w-24 text-center pb-2\">Qty</th>\n                    <th className=\"w-32 text-right pb-2\">Rate</th>\n                    <th className=\"w-32 text-right pb-2\">Amount</th>\n                  </tr>\n                </thead>\n                <tbody>\n                  {rows.map((r, i) => (\n                    <tr key={i} className=\"border-b\">\n                      <td className=\"py-3\">\n                        <select className=\"w-full p-1 border rounded font-bold\" value={r.itemId} onChange={e => {\n                          const it = items.find(x => x.id === e.target.value);\n                          if (!it) return;\n                          updateRow(i, \"itemId\", it.id);\n                          updateRow(i, \"name\", it.name);\n                          updateRow(i, \"desc\", it.description || \"\");\n                        }}>\n                          <option value=\"\">Select Item</option>\n                          {items.map(it => <option key={it.id} value={it.id}>{it.name} ({it.description})</option>)}\n                        </select>\n                      </td>\n                      <td><input type=\"number\" className=\"w-full text-center border rounded p-1 font-bold\" value={r.qty} onChange={e => updateRow(i, \"qty\", e.target.value)} /></td>\n                      <td><input type=\"number\" className=\"w-full text-right border rounded p-1 font-bold\" value={r.rate} onChange={e => updateRow(i, \"rate\", e.target.value)} /></td>\n                      <td className=\"text-right font-black\">{(Number(r.qty) * Number(r.rate)).toLocaleString()}</td>\n                    </tr>\n                  ))}\n                </tbody>\n              </table>\n              <button onClick={addRow} className=\"text-blue-600 font-bold uppercase text-xs\">+ Add New Row</button>\n              <textarea className=\"border w-full p-3 rounded h-24 font-sans text-sm\" placeholder=\"Any Special Remarks...\" value={remarks} onChange={e => setRemarks(e.target.value)} />\n              <div className=\"text-right text-3xl font-black text-blue-700\">Rs. {total.toLocaleString()}</div>\n            </div>\n          )}\n\n          {/* PREVIEW */}\n          {preview && (\n            <div className=\"invoice-print bg-white border-2 p-12 shadow-2xl rounded-sm mx-auto min-h-[297mm] print:shadow-none print:border-0 print:p-0 text-black\">\n              <div className=\"flex justify-between items-start border-b-4 border-black pb-6 mb-8\">\n                <div>\n                  <h1 className=\"text-4xl font-black tracking-tighter\">US TRADERS</h1>\n                  <p className=\"text-xs uppercase tracking-widest font-bold text-gray-500\">Premium Quality Industrial Suppliers</p>\n                </div>\n                <div className=\"text-right\">\n                  <h2 className=\"text-2xl font-black uppercase italic\">Purchase Order</h2>\n                  <div className=\"mt-2 text-sm font-bold\">\n                    <p>{poNo}</p>\n                    <p>Date: {date}</p>\n                  </div>\n                </div>\n              </div>\n\n              <div className=\"mb-10 bg-gray-100 p-4 border-l-8 border-black\">\n                <h3 className=\"text-[10px] uppercase font-black text-gray-400\">Vendor / Supplier:</h3>\n                <p className=\"text-xl font-black uppercase underline\">{supplierName}</p>\n              </div>\n\n              <table className=\"w-full border-collapse\">\n                <thead>\n                  <tr className=\"bg-black text-white text-xs uppercase\">\n                    <th className=\"p-3 text-left w-12\">#</th>\n                    <th className=\"p-3 text-left\">Item Name</th>\n                    <th className=\"p-3 text-left\">Description</th>\n                    <th className=\"p-3 text-center w-20\">Qty</th>\n                    <th className=\"p-3 text-right w-28\">Rate</th>\n                    <th className=\"p-3 text-right w-28\">Total</th>\n                  </tr>\n                </thead>\n                <tbody>\n                  {rows.map((r, i) => (\n                    <tr key={i} className=\"border-b-2 border-black font-bold\">\n                      <td className=\"p-3 text-gray-500\">{i + 1}</td>\n                      <td className=\"p-3 uppercase\">{r.name}</td>\n                      <td className=\"p-3 text-xs text-gray-600 italic leading-tight\">{r.desc}</td>\n                      <td className=\"p-3 text-center\">{r.qty}</td>\n                      <td className=\"p-3 text-right\">{Number(r.rate).toLocaleString()}</td>\n                      <td className=\"p-3 text-right font-black\">{(Number(r.qty) * Number(r.rate)).toLocaleString()}</td>\n                    </tr>\n                  ))}\n                </tbody>\n              </table>\n\n              <div className=\"mt-12 grid grid-cols-1 md:grid-cols-2 gap-10\">\n                <div>\n                  {remarks && (\n                    <div className=\"space-y-1\">\n                      <h4 className=\"text-[10px] uppercase font-black text-gray-400\">Remarks:</h4>\n                      <p className=\"text-sm border-l-4 border-gray-300 pl-3 font-medium italic\">{remarks}</p>\n                    </div>\n                  )}\n                </div>\n                <div className=\"space-y-4\">\n                  <div className=\"flex justify-between items-center text-xl border-t-4 border-black pt-3 font-black uppercase\">\n                    <span>Net Total:</span>\n                    <span>Rs. {total.toLocaleString()}</span>\n                  </div>\n                  <div className=\"pt-20 flex justify-between gap-4\">\n                    <div className=\"flex-1 border-t-2 border-black text-center text-[9px] font-black uppercase pt-1\">Prepared By</div>\n                    <div className=\"flex-1 border-t-2 border-black text-center text-[9px] font-black uppercase pt-1\">Authorized</div>\n                  </div>\n                </div>\n              </div>\n            </div>\n          )}\n        </>\n      )}\n      {/* EMAIL MODAL */}\n      {emailModalOpen && (\n        <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50\">\n          <div className=\"bg-white p-6 rounded shadow-lg w-96\">\n            <h2 className=\"text-xl font-bold mb-4\">Send Email</h2>\n            <div className=\"mb-4\">\n              <label className=\"block text-sm font-bold mb-2\">Recipient Email</label>\n              <input\n                type=\"email\"\n                value={recipientEmail}\n                onChange={(e) => setRecipientEmail(e.target.value)}\n                className=\"w-full border p-2 rounded\"\n                placeholder=\"supplier@example.com\"\n              />\n            </div>\n            <div className=\"flex justify-end gap-2\">\n              <button\n                onClick={() => setEmailModalOpen(false)}\n                className=\"bg-gray-500 text-white px-4 py-2 rounded\"\n              >\n                Cancel\n              </button>\n              <button\n                onClick={confirmSendEmail}\n                disabled={sendingEmail}\n                className=\"bg-blue-600 text-white px-4 py-2 rounded disabled:opacity-50\"\n              >\n                {sendingEmail ? \"Sending...\" : \"Send\"}\n              </button>\n            </div>\n          </div>\n        </div>\n      )}\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\dashboard\\purchase-print\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\dashboard\\quotation\\page.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'loadQuotations' and 'user'. Either include them or remove the dependency array.","line":125,"column":6,"nodeType":"ArrayExpression","endLine":125,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [loadQuotations, user]","fix":{"range":[3574,3576],"text":"[loadQuotations, user]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { useEffect, useState } from \"react\";\nimport toast from \"react-hot-toast\";\nimport { getCurrentUser } from \"@/lib/auth\";\nimport { hasPermission } from \"@/lib/hasPermission\";\nimport { PERMISSIONS } from \"@/lib/permissions\";\nimport { useRouter } from \"next/navigation\";\n\ntype Account = { id: string; name: string };\ntype Item = {\n  id: string;\n  name: string;\n  description?: string;\n  availableQty: number;\n};\ntype Row = {\n  itemId: string;\n  name: string;\n  description: string;\n  availableQty: number;\n  qty: number | \"\";\n  rate: number | \"\";\n};\n\ntype Quotation = {\n  id: string;\n  quotationNo: string;\n  date: string;\n  customerId: string;\n  customer?: { name: string };\n  total: number;\n  items: Array<{ item: { name: string; description?: string }; qty: number; rate: number }>;\n  status: string;\n};\n\ntype TaxConfig = {\n  id: string;\n  taxType: string;\n  taxCode: string;\n  taxRate: number;\n  description?: string;\n};\n\nexport default function QuotationPage() {\n  const _router = useRouter();\n  const today = new Date().toISOString().slice(0, 10);\n  const user = getCurrentUser();\n\n  const [authorized, setAuthorized] = useState(false);\n  const [loading, setLoading] = useState(true);\n\n  const [customers, setCustomers] = useState<Account[]>([]);\n  const [items, setItems] = useState<Item[]>([]);\n  const [quotations, setQuotations] = useState<Quotation[]>([]);\n  const [showList, setShowList] = useState(false);\n  const [showForm, setShowForm] = useState(true);\n  const [editing, setEditing] = useState<Quotation | null>(null);\n\n  const [quotationNo, setQuotationNo] = useState(\"\");\n  const [customerId, setCustomerId] = useState(\"\");\n  const [customerName, setCustomerName] = useState(\"\");\n  const [date, setDate] = useState(today);\n  const [validUntil, setValidUntil] = useState(\"\");\n  const [rows, setRows] = useState<Row[]>([{\n    itemId: \"\", name: \"\", description: \"\", availableQty: 0, qty: \"\", rate: \"\",\n  }]);\n  const [searchTerm, _setSearchTerm] = useState(\"\");\n\n  const [saving, setSaving] = useState(false);\n  const [preview, setPreview] = useState(false);\n  const [savedQuotation, setSavedQuotation] = useState<Any>(null);\n  const [_sendingEmail, _setSendingEmail] = useState(false);\n  const [hideRates, setHideRates] = useState(false);\n  \n  // Tax states\n  const [applyTax, setApplyTax] = useState(false);\n  const [selectedTaxId, setSelectedTaxId] = useState(\"\");\n  const [taxes, setTaxes] = useState<TaxConfig[]>([]);\n\n  useEffect(() => {\n    if (!user) {\n      setLoading(false);\n      return;\n    }\n    if (!hasPermission(user, PERMISSIONS.CREATE_QUOTATION)) {\n      setLoading(false);\n      return;\n    }\n    setAuthorized(true);\n    \n    // Load initial data\n    loadQuotations();\n    \n    fetch(\"/api/accounts\", {\n      headers: { \"x-user-role\": user.role },\n    })\n      .then(r => r.json())\n      .then(d => {\n        const list = Array.isArray(d) ? d : d.accounts || [];\n        setCustomers(list.filter((a: Any) => a.partyType === \"CUSTOMER\"));\n      });\n\n    fetch(\"/api/items-new\")\n      .then(r => r.json())\n      .then(d => setItems(Array.isArray(d) ? d : []));\n\n    fetch(\"/api/tax-configuration\")\n      .then(r => r.json())\n      .then(d => setTaxes(Array.isArray(d) ? d : []))\n      .catch(err => console.log(\"Tax config error:\", err));\n      \n    fetch(\"/api/quotation\", {\n        headers: {\n            \"x-user-role\": user.role || \"\",\n            \"x-user-id\": user.id || \"\"\n        }\n    })\n    .then(r => r.json())\n    .then(d => {\n        if(d?.nextNo) setQuotationNo(d.nextNo);\n    });\n\n    setLoading(false);\n  }, []);\n\n  // Keyboard shortcuts\n  useEffect(() => {\n    function handleKeyPress(e: KeyboardEvent) {\n      if (e.code === \"F7\" || e.key === \"F7\") {\n        e.preventDefault();\n        if (showForm && !preview) {\n          setDate(today);\n          setCustomerId(\"\");\n          setCustomerName(\"\");\n        }\n      }\n      if (e.code === \"F8\" || e.key === \"F8\") {\n        e.preventDefault();\n        if (showForm && !preview) {\n          const query = prompt(\"Enter search query (Quotation No, Customer Name, etc.):\");\n          if (query) {\n            const foundCustomer = customers.find(c => \n              c.name.toLowerCase().includes(query.toLowerCase())\n            );\n            if (foundCustomer) {\n              setCustomerId(foundCustomer.id);\n              setCustomerName(foundCustomer.name);\n            } else {\n              toast.error(`No customer found matching \"${query}\"`);\n            }\n          }\n        }\n      }\n    }\n    document.addEventListener(\"keydown\", handleKeyPress, true);\n    return () => document.removeEventListener(\"keydown\", handleKeyPress, true);\n  }, [today, showForm, preview, customers]);\n\n  async function loadQuotations() {\n    try {\n      const res = await fetch(\"/api/quotation\", {\n        headers: {\n          \"x-user-role\": user?.role || \"\",\n          \"x-user-id\": user?.id || \"\"\n        }\n      });\n      const data = await res.json();\n      if (data?.quotations) {\n        setQuotations(data.quotations);\n      }\n    } catch (e) {\n      console.error(\"Load quotations error:\", e);\n    }\n  }\n\n  function addRow() {\n    setRows(r => [\n      ...r,\n      { itemId: \"\", name: \"\", description: \"\", availableQty: 0, qty: \"\", rate: \"\" },\n    ]);\n  }\n\n  function selectItem(index: number, itemId: string) {\n    const item = items.find(i => i.id === itemId);\n    if (!item) return;\n    const copy = [...rows];\n    copy[index] = {\n      ...copy[index],\n      itemId: item.id,\n      name: item.name,\n      description: item.description || \"\",\n      availableQty: item.availableQty,\n      qty: \"\",\n    };\n    setRows(copy);\n  }\n\n  function updateRow(index: number, key: \"qty\" | \"rate\", val: string) {\n    const copy = [...rows];\n    const num = val === \"\" ? \"\" : Number(val);\n    copy[index][key] = num;\n    setRows(copy);\n  }\n\n  const total = rows.reduce((s, r) => s + (Number(r.qty) * Number(r.rate) || 0), 0);\n  const selectedTax = taxes.find(t => t.id === selectedTaxId);\n  const taxAmount = applyTax && selectedTax ? (total * (selectedTax.taxRate / 100)) : 0;\n  const netTotal = total + taxAmount;\n\n  async function saveQuotation() {\n    const clean = rows.filter(r => r.itemId && r.qty && r.rate);\n    if (!customerId || !clean.length) {\n      toast.error(\"Customer aur items zaroori hain\");\n      return;\n    }\n\n    setSaving(true);\n    try {\n      const method = editing ? \"PUT\" : \"POST\";\n      const baseBody = {\n        quotationNo,\n        customerId,\n        date,\n        validUntil: validUntil || null,\n        items: clean.map(r => {\n          const qty = Number(r.qty);\n          const rate = Number(r.rate);\n          return { itemId: r.itemId, qty, rate, amount: qty * rate };\n        }),\n        applyTax,\n        taxConfigId: applyTax ? selectedTaxId : null,\n      };\n      const body = editing ? { id: editing.id, ...baseBody } : baseBody;\n\n      const res = await fetch(\"/api/quotation\", {\n        method,\n        headers: { \n          \"Content-Type\": \"application/json\",\n          \"x-user-role\": user?.role || \"\",\n          \"x-user-id\": user?.id || \"\"\n        },\n        body: JSON.stringify(body),\n      });\n      \n      if (!res.ok) {\n        const errorData = await res.json();\n        throw new Error(errorData.error || \"Save failed\");\n      }\n      \n      const data = await res.json();\n      \n      if (data.quotation) {\n        setSavedQuotation(data.quotation);\n        setQuotationNo(data.quotationNo || quotationNo);\n        setCustomerName(data.quotation.customer?.name || customerName);\n      }\n      \n      setPreview(true);\n      await loadQuotations();\n      if (editing) {\n        setEditing(null);\n        setShowForm(false);\n        setShowList(true);\n      }\n      toast.success(\"Quotation saved successfully!\");\n    } catch (e: Any) {\n      toast.error(\"Saving failed: \" + (e.message || \"Unknown error\"));\n    } finally {\n      setSaving(false);\n    }\n  }\n\n  function startEdit(q: Quotation) {\n    setEditing(q);\n    setQuotationNo(q.quotationNo);\n    setCustomerId(q.customerId);\n    setCustomerName(q.customer?.name || \"\");\n    setDate(new Date(q.date).toISOString().slice(0, 10));\n    setRows(q.items.map((it: Any) => ({\n      itemId: it.itemId || \"\",\n      name: it.item?.name || \"\",\n      description: it.item?.description || \"\",\n      availableQty: 0, // Not needed for edit\n      qty: it.qty.toString(),\n      rate: it.rate.toString(),\n    })));\n    setShowForm(true);\n    setShowList(false);\n  }\n\n  async function deleteQuotation(id: string) {\n    if (!confirm(\"Are you sure you want to delete this quotation?\")) return;\n    try {\n      const res = await fetch(`/api/quotation?id=${id}`, {\n        method: \"DELETE\",\n        headers: {\n          \"x-user-role\": user?.role || \"\",\n          \"x-user-id\": user?.id || \"\"\n        },\n      });\n      if (res.ok) {\n        toast.success(\"Quotation deleted successfully\");\n        await loadQuotations();\n      } else {\n        const err = await res.json();\n        toast.error(err.error || \"Delete failed\");\n      }\n    } catch (_e) {\n      toast.error(\"Delete failed\");\n    }\n  }\n\n  function resetForm() {\n    setEditing(null);\n    setCustomerId(\"\");\n    setCustomerName(\"\");\n    setDate(today);\n    setValidUntil(\"\");\n    setRows([{ itemId: \"\", name: \"\", description: \"\", availableQty: 0, qty: \"\", rate: \"\" }]);\n    setApplyTax(false);\n    setSelectedTaxId(\"\");\n    setPreview(false);\n  }\n\n  // Share on WhatsApp\n  const shareOnWhatsApp = () => {\n    if (!savedQuotation) {\n      toast.error(\"Please save the quotation first\");\n      return;\n    }\n    \n    // Construct a message\n    let message = `*Quotation: ${savedQuotation.quotationNo}*\\n`;\n    message += `Date: ${new Date(savedQuotation.date).toLocaleDateString()}\\n`;\n    message += `Customer: ${customerName}\\n\\n`;\n    message += `*Items:*\\n`;\n    \n    savedQuotation.items.forEach((item: Any, index: number) => {\n      message += `${index + 1}. ${item.item.name} x ${item.qty} @ ${item.rate} = ${(item.qty * item.rate).toLocaleString()}\\n`;\n    });\n    \n    message += `\\n*Total Amount: ${savedQuotation.total.toLocaleString()}*`;\n    \n    const url = `https://wa.me/?text=${encodeURIComponent(message)}`;\n    window.open(url, '_blank');\n  };\n\n  // Share on SMS\n  const shareOnSMS = () => {\n    if (!savedQuotation) {\n      toast.error(\"Please save the quotation first\");\n      return;\n    }\n    \n    // Construct a message (shorter for SMS)\n    let message = `Quotation: ${savedQuotation.quotationNo}\\n`;\n    message += `Date: ${new Date(savedQuotation.date).toLocaleDateString()}\\n`;\n    message += `Customer: ${customerName}\\n`;\n    message += `Total: ${savedQuotation.total.toLocaleString()}`;\n    \n    const url = `sms:?body=${encodeURIComponent(message)}`;\n    window.open(url, '_blank');\n  };\n\n  if (loading) return <div className=\"p-6\">Loading...</div>;\n  if (!authorized) return <div className=\"p-6 text-red-600\">Access Denied</div>;\n\n  const filteredQuotations = quotations.filter(q => {\n  if (!searchTerm.trim()) return true;\n\n  const term = searchTerm.toLowerCase();\n\n  return (\n    q.quotationNo?.toLowerCase().includes(term) ||\n    q.customer?.name?.toLowerCase().includes(term) ||\n    q.date?.toLowerCase().includes(term) ||\n    q.status?.toLowerCase().includes(term)\n  );\n});\n\n\n\n  return (\n    <div className=\"p-6 space-y-6\">\n      <div className=\"flex justify-between items-center\">\n        <h1 className=\"text-2xl font-bold\">Quotation / Estimate</h1>\n        <div className=\"flex gap-2\">\n          <button\n            onClick={() => { setShowList(!showList); setShowForm(!showForm); setEditing(null); }}\n            className=\"bg-gray-600 text-white px-4 py-2 rounded\"\n          >\n            {showList ? \"Hide List\" : \"Show List\"}\n          </button>\n          <button\n            onClick={() => { setShowForm(true); setShowList(false); resetForm(); loadQuotations(); }}\n            className=\"bg-blue-600 text-white px-4 py-2 rounded\"\n          >\n            + New Quotation\n          </button>\n        </div>\n      </div>\n\n      {/* LIST VIEW */}\n      {showList && (\n        <div className=\"bg-white border rounded overflow-hidden\">\n          <table className=\"w-full text-sm\">\n            <thead className=\"bg-gray-100\">\n              <tr>\n                <th className=\"p-3 text-left\">Quotation No</th>\n                <th className=\"p-3 text-left\">Date</th>\n                <th className=\"p-3 text-left\">Customer</th>\n                <th className=\"p-3 text-right\">Total</th>\n                <th className=\"p-3 text-left\">Status</th>\n                <th className=\"p-3 text-center\">Actions</th>\n              </tr>\n            </thead>\n            <tbody>\n              {filteredQuotations.length === 0 ? (\n                <tr>\n                  <td colSpan={6} className=\"p-4 text-center text-gray-400\">No quotations found</td>\n                </tr>\n              ) : (\n                filteredQuotations.map(q => (\n                  <tr key={q.id} className=\"border-t hover:bg-gray-50\">\n                    <td className=\"p-3 font-bold\">{q.quotationNo}</td>\n                    <td className=\"p-3\">{new Date(q.date).toLocaleDateString()}</td>\n                    <td className=\"p-3\">{q.customer?.name || \"N/A\"}</td>\n                    <td className=\"p-3 text-right\">{q.total.toLocaleString()}</td>\n                    <td className=\"p-3\">\n                      <span className={`px-2 py-1 rounded text-xs ${q.status === 'APPROVED' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}`}>\n                        {q.status}\n                      </span>\n                    </td>\n                    <td className=\"p-3 text-center space-x-2\">\n                      <button\n                        onClick={() => startEdit(q)}\n                        className=\"text-blue-600 hover:text-blue-800 font-medium text-sm\"\n                      >\n                        Edit\n                      </button>\n                      <button\n                        onClick={() => deleteQuotation(q.id)}\n                        className=\"text-red-600 hover:text-red-800 font-medium text-sm\"\n                      >\n                        Delete\n                      </button>\n                    </td>\n                  </tr>\n                ))\n              )}\n            </tbody>\n          </table>\n        </div>\n      )}\n\n      {/* FORM */}\n      {showForm && (\n        <>\n          <div className=\"flex flex-col md:flex-row justify-between items-center bg-gray-50 p-4 border rounded print:hidden gap-4\">\n            <h1 className=\"text-2xl font-bold\">Quotation ({quotationNo})</h1>\n            {!preview ? (\n              <div className=\"flex flex-wrap gap-2\">\n                <button onClick={saveQuotation} disabled={saving} className=\"bg-blue-600 text-white px-6 py-2 rounded flex-1 md:flex-none\">\n                  {saving ? \"Saving...\" : editing ? \"Update Quotation\" : \"Save & Preview\"}\n                </button>\n                <button onClick={() => { setShowForm(false); setEditing(null); resetForm(); }} className=\"bg-gray-600 text-white px-6 py-2 rounded flex-1 md:flex-none\">\n                  Cancel\n                </button>\n              </div>\n            ) : (\n              <div className=\"flex flex-wrap gap-2\">\n                <button onClick={() => window.print()} className=\"bg-green-600 text-white px-6 py-2 rounded flex-1 md:flex-none\">\n                  Print\n                </button>\n                <button \n                  onClick={() => setHideRates(!hideRates)} \n                  className=\"bg-purple-600 text-white px-6 py-2 rounded flex-1 md:flex-none\"\n                >\n                  {hideRates ? \"Show Rates\" : \"Hide Rates\"}\n                </button>\n                <button \n                  onClick={shareOnWhatsApp}\n                  className=\"bg-green-500 text-white px-6 py-2 rounded hover:bg-green-600 flex-1 md:flex-none\"\n                >\n                  📱 WhatsApp\n                </button>\n                <button \n                  onClick={shareOnSMS}\n                  className=\"bg-blue-500 text-white px-6 py-2 rounded hover:bg-blue-600 flex-1 md:flex-none\"\n                >\n                  💬 SMS\n                </button>\n                <button onClick={() => setPreview(false)} className=\"bg-yellow-600 text-white px-6 py-2 rounded flex-1 md:flex-none\">\n                  Edit\n                </button>\n                <button onClick={() => { setPreview(false); resetForm(); }} className=\"bg-gray-600 text-white px-6 py-2 rounded flex-1 md:flex-none\">\n                  New Quotation\n                </button>\n              </div>\n            )}\n          </div>\n\n          {!preview && (\n            <div className=\"bg-white border p-6 rounded space-y-4\">\n              <div className=\"mb-2 text-xs text-gray-500 italic\">\n                💡 Keyboard Shortcuts: <strong>F7</strong> = Clear Date & Customer | <strong>F8</strong> = Search Query\n              </div>\n              <div className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4\">\n                <input value={quotationNo} readOnly className=\"border p-2 bg-gray-100\" placeholder=\"Quotation No\" />\n                <div>\n                  <label className=\"text-xs font-bold\">Customer (F7: Clear, F8: Query)</label>\n                  <select className=\"border p-2 w-full\" value={customerId} onChange={e => {\n                    setCustomerId(e.target.value);\n                    setCustomerName(customers.find(c => c.id === e.target.value)?.name || \"\");\n                  }}>\n                    <option value=\"\">Select Customer</option>\n                    {customers.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}\n                  </select>\n                </div>\n                <div>\n                  <label className=\"text-xs font-bold\">Date</label>\n                  <input type=\"date\" className=\"border p-2 w-full\" value={date} onChange={e => setDate(e.target.value)} />\n                </div>\n                <div>\n                  <label className=\"text-xs font-bold\">Valid Until</label>\n                  <input type=\"date\" className=\"border p-2 w-full\" value={validUntil} onChange={e => setValidUntil(e.target.value)} />\n                </div>\n              </div>\n\n              <div className=\"overflow-x-auto\">\n                <table className=\"w-full border mt-4 text-sm min-w-[600px]\">\n                  <thead className=\"bg-gray-100\">\n                    <tr>\n                      <th className=\"border p-2 text-left\">Item</th>\n                      <th className=\"border p-2 w-24\">Qty</th>\n                      <th className=\"border p-2 w-32\">Rate</th>\n                      <th className=\"border p-2 w-32 text-right\">Amount</th>\n                    </tr>\n                  </thead>\n                  <tbody>\n                    {rows.map((r, i) => (\n                      <tr key={i}>\n                        <td className=\"border p-2\">\n                          <select className=\"w-full\" value={r.itemId} onChange={e => selectItem(i, e.target.value)}>\n                            <option value=\"\">Select Item</option>\n                            {items.map(it => (\n                              <option key={it.id} value={it.id}>\n                                {it.name} ({it.description})\n                              </option>\n                            ))}\n                          </select>\n                        </td>\n                        <td className=\"border p-2\">\n                          <input type=\"number\" value={r.qty} className=\"w-full text-center\" onChange={e => updateRow(i, \"qty\", e.target.value)} />\n                        </td>\n                        <td className=\"border p-2\">\n                          <input type=\"number\" value={r.rate} className=\"w-full text-center\" onChange={e => updateRow(i, \"rate\", e.target.value)} />\n                        </td>\n                        <td className=\"border p-2 text-right\">\n                          {(Number(r.qty) * Number(r.rate) || 0).toLocaleString()}\n                        </td>\n                      </tr>\n                    ))}\n                  </tbody>\n                </table>\n              </div>\n              <button onClick={addRow} className=\"bg-gray-100 px-4 py-1 rounded\">+ Add Row</button>\n\n              <div className=\"flex justify-end pt-4\">\n                <div className=\"w-full md:w-64 space-y-2\">\n                  <div className=\"flex justify-between\"><span>Total</span><span>{total.toLocaleString()}</span></div>\n                  \n                  {/* Tax Section */}\n                  <div className=\"border-t pt-2 space-y-2\">\n                    <button\n                      type=\"button\"\n                      onClick={() => {\n                        setApplyTax(!applyTax);\n                        if (!applyTax) setSelectedTaxId(\"\");\n                      }}\n                      className={`w-full py-1 px-2 rounded font-semibold text-sm ${\n                        applyTax ? \"bg-blue-600 text-white\" : \"bg-gray-200 text-gray-700\"\n                      }`}\n                    >\n                      {applyTax ? \"✓ Tax Applied\" : \"+ Add Tax\"}\n                    </button>\n                    \n                    {applyTax && (\n                      <div className=\"space-y-2\">\n                        <select\n                          value={selectedTaxId}\n                          onChange={e => setSelectedTaxId(e.target.value)}\n                          className=\"w-full border p-1 text-sm\"\n                        >\n                          <option value=\"\">Select Tax</option>\n                          {taxes.map(t => (\n                            <option key={t.id} value={t.id}>\n                              {t.taxType} - {t.taxCode} ({t.taxRate}%)\n                            </option>\n                          ))}\n                        </select>\n                        {selectedTax && (\n                           <div className=\"flex justify-between text-sm\">\n                             <span>Tax ({selectedTax.taxRate}%)</span>\n                             <span>{taxAmount.toLocaleString()}</span>\n                           </div>\n                        )}\n                      </div>\n                    )}\n                  </div>\n\n                  <div className=\"flex justify-between font-bold border-t pt-2\">\n                    <span>Net Total</span>\n                    <span>{netTotal.toLocaleString()}</span>\n                  </div>\n                </div>\n              </div>\n            </div>\n          )}\n\n          {/* PREVIEW SECTION */}\n          {preview && savedQuotation && (\n            <div className=\"bg-white p-8 border rounded shadow-lg max-w-4xl mx-auto print:shadow-none print:border-none\">\n              <div className=\"text-center mb-8\">\n                <h1 className=\"text-3xl font-bold uppercase tracking-wider\">Quotation</h1>\n                <p className=\"text-gray-500\">Date: {new Date(savedQuotation.date).toLocaleDateString()}</p>\n                <p className=\"text-gray-500 font-bold\">#{savedQuotation.quotationNo}</p>\n              </div>\n\n              <div className=\"flex justify-between mb-8\">\n                <div>\n                  <h3 className=\"font-bold text-gray-700\">Bill To:</h3>\n                  <p className=\"text-lg font-semibold\">{customerName}</p>\n                </div>\n                <div className=\"text-right\">\n                  <h3 className=\"font-bold text-gray-700\">Details:</h3>\n                  {savedQuotation.validUntil && (\n                     <p>Valid Until: {new Date(savedQuotation.validUntil).toLocaleDateString()}</p>\n                  )}\n                </div>\n              </div>\n\n              <table className=\"w-full mb-8\">\n                <thead>\n                  <tr className=\"bg-gray-100 border-b-2 border-gray-300\">\n                    <th className=\"text-left py-2 px-4\">Item</th>\n                    <th className=\"text-center py-2 px-4\">Qty</th>\n                    {!hideRates && <th className=\"text-right py-2 px-4\">Rate</th>}\n                    {!hideRates && <th className=\"text-right py-2 px-4\">Amount</th>}\n                  </tr>\n                </thead>\n                <tbody>\n                  {savedQuotation.items.map((item: Any, i: number) => (\n                    <tr key={i} className=\"border-b\">\n                      <td className=\"py-2 px-4\">\n                        <p className=\"font-bold\">{item.item.name}</p>\n                        {item.item.description && <p className=\"text-xs text-gray-500\">{item.item.description}</p>}\n                      </td>\n                      <td className=\"text-center py-2 px-4\">{item.qty}</td>\n                      {!hideRates && <td className=\"text-right py-2 px-4\">{item.rate.toLocaleString()}</td>}\n                      {!hideRates && <td className=\"text-right py-2 px-4\">{(item.qty * item.rate).toLocaleString()}</td>}\n                    </tr>\n                  ))}\n                </tbody>\n              </table>\n\n              {!hideRates && (\n              <div className=\"flex justify-end\">\n                <div className=\"w-64 space-y-2\">\n                  <div className=\"flex justify-between text-gray-600\">\n                    <span>Subtotal:</span>\n                    <span>{savedQuotation.total.toLocaleString()}</span>\n                  </div>\n                  {/* You might want to display tax here if saved in quotation */}\n                  <div className=\"flex justify-between font-bold text-xl border-t pt-2\">\n                    <span>Total:</span>\n                    <span>{savedQuotation.total.toLocaleString()}</span>\n                  </div>\n                </div>\n              </div>\n              )}\n              \n              <div className=\"mt-12 pt-8 border-t text-center text-gray-500 text-sm\">\n                <p>Thank you for your business!</p>\n              </div>\n            </div>\n          )}\n        </>\n      )}\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\dashboard\\recurring-transactions\\page.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'loadAccounts' and 'loadTransactions'. Either include them or remove the dependency array.","line":46,"column":6,"nodeType":"ArrayExpression","endLine":46,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [loadAccounts, loadTransactions]","fix":{"range":[1242,1244],"text":"[loadAccounts, loadTransactions]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { useEffect, useState } from \"react\";\nimport { getCurrentUser } from \"@/lib/auth\";\nimport { hasPermission } from \"@/lib/hasPermission\";\nimport { PERMISSIONS } from \"@/lib/permissions\";\n\ntype RecurringTransaction = {\n  id: string;\n  accountId: string;\n  account: { name: string };\n  type: string;\n  frequency: string;\n  amount: number;\n  description: string;\n  narration?: string;\n  nextDate: string;\n  lastRun?: string;\n  isActive: boolean;\n};\n\nexport default function RecurringTransactionsPage() {\n  const [transactions, setTransactions] = useState<RecurringTransaction[]>([]);\n  const [loading, setLoading] = useState(false);\n  const [showForm, setShowForm] = useState(false);\n  const [editing, setEditing] = useState<RecurringTransaction | null>(null);\n\n  const [formData, setFormData] = useState({\n    accountId: \"\",\n    type: \"EXPENSE\",\n    frequency: \"MONTHLY\",\n    amount: \"\",\n    description: \"\",\n    narration: \"\",\n    nextDate: new Date().toISOString().slice(0, 10),\n  });\n\n  const [accounts, setAccounts] = useState<Any[]>([]);\n\n  const user = getCurrentUser();\n  const canAccess = hasPermission(user, PERMISSIONS.RECURRING_TRANSACTIONS);\n\n  useEffect(() => {\n    loadTransactions();\n    loadAccounts();\n  }, []);\n\n  if (!canAccess) {\n    return <div>Access Denied</div>;\n  }\n\n  async function loadTransactions() {\n    setLoading(true);\n    try {\n      const res = await fetch(\"/api/recurring-transactions\", {\n        headers: {\n          \"x-user-role\": user?.role || \"\",\n          \"x-user-id\": user?.id || \"\",\n        },\n      });\n      const data = await res.json();\n      if (Array.isArray(data)) {\n        setTransactions(data);\n      }\n    } catch (e) {\n      console.error(\"Load error:\", e);\n    } finally {\n      setLoading(false);\n    }\n  }\n\n  async function loadAccounts() {\n    try {\n      const res = await fetch(\"/api/accounts\", {\n        headers: { \"x-user-role\": user?.role || \"\" },\n      });\n      const data = await res.json();\n      const list = Array.isArray(data) ? data : data.accounts || [];\n      setAccounts(list);\n    } catch (e) {\n      console.error(\"Accounts load error:\", e);\n    }\n  }\n\n  async function saveTransaction() {\n    if (!formData.accountId || !formData.amount || !formData.description) {\n      alert(\"Please fill all required fields\");\n      return;\n    }\n\n    setLoading(true);\n    try {\n      const url = editing\n        ? \"/api/recurring-transactions\"\n        : \"/api/recurring-transactions\";\n      const method = editing ? \"PUT\" : \"POST\";\n\n      const res = await fetch(url, {\n        method,\n        headers: {\n          \"Content-Type\": \"application/json\",\n          \"x-user-role\": user?.role || \"\",\n          \"x-user-id\": user?.id || \"\",\n        },\n        body: JSON.stringify(editing ? { id: editing.id, ...formData } : formData),\n      });\n\n      if (res.ok) {\n        await loadTransactions();\n        setShowForm(false);\n        setEditing(null);\n        setFormData({\n          accountId: \"\",\n          type: \"EXPENSE\",\n          frequency: \"MONTHLY\",\n          amount: \"\",\n          description: \"\",\n          narration: \"\",\n          nextDate: new Date().toISOString().slice(0, 10),\n        });\n      } else {\n        const error = await res.json();\n        alert(error.error || \"Save failed\");\n      }\n    } catch (_e) {\n      alert(\"Save failed\");\n    } finally {\n      setLoading(false);\n    }\n  }\n\n  async function toggleActive(id: string, currentStatus: boolean) {\n    try {\n      const res = await fetch(\"/api/recurring-transactions\", {\n        method: \"PUT\",\n        headers: {\n          \"Content-Type\": \"application/json\",\n          \"x-user-role\": user?.role || \"\",\n          \"x-user-id\": user?.id || \"\",\n        },\n        body: JSON.stringify({ id, isActive: !currentStatus }),\n      });\n\n      if (res.ok) {\n        await loadTransactions();\n      }\n    } catch (_e) {\n      alert(\"Update failed\");\n    }\n  }\n\n  async function deleteTransaction(id: string) {\n    if (!confirm(\"Are you sure you want to delete this recurring transaction?\")) {\n      return;\n    }\n\n    try {\n      const res = await fetch(`/api/recurring-transactions?id=${id}`, {\n        method: \"DELETE\",\n        headers: {\n          \"x-user-role\": user?.role || \"\",\n          \"x-user-id\": user?.id || \"\",\n        },\n      });\n\n      if (res.ok) {\n        await loadTransactions();\n      }\n    } catch (_e) {\n      alert(\"Delete failed\");\n    }\n  }\n\n  function startEdit(t: RecurringTransaction) {\n    setEditing(t);\n    setFormData({\n      accountId: t.accountId,\n      type: t.type,\n      frequency: t.frequency,\n      amount: t.amount.toString(),\n      description: t.description,\n      narration: t.narration || \"\",\n      nextDate: new Date(t.nextDate).toISOString().slice(0, 10),\n    });\n    setShowForm(true);\n  }\n\n  return (\n    <div className=\"p-6 space-y-6\">\n      <div className=\"flex justify-between items-center\">\n        <h1 className=\"text-2xl font-bold\">Recurring Transactions</h1>\n        <button\n          onClick={() => {\n            setShowForm(true);\n            setEditing(null);\n            setFormData({\n              accountId: \"\",\n              type: \"EXPENSE\",\n              frequency: \"MONTHLY\",\n              amount: \"\",\n              description: \"\",\n              narration: \"\",\n              nextDate: new Date().toISOString().slice(0, 10),\n            });\n          }}\n          className=\"bg-blue-600 text-white px-4 py-2 rounded\"\n        >\n          + Add Recurring Transaction\n        </button>\n      </div>\n\n      {showForm && (\n        <div className=\"bg-white border p-6 rounded space-y-4\">\n          <h2 className=\"text-xl font-bold\">\n            {editing ? \"Edit\" : \"New\"} Recurring Transaction\n          </h2>\n\n          <div className=\"grid grid-cols-2 gap-4\">\n            <div>\n              <label className=\"block text-sm font-bold mb-1\">Account *</label>\n              <select\n                className=\"w-full border p-2 rounded\"\n                value={formData.accountId}\n                onChange={(e) =>\n                  setFormData({ ...formData, accountId: e.target.value })\n                }\n              >\n                <option value=\"\">Select Account</option>\n                {accounts.map((a) => (\n                  <option key={a.id} value={a.id}>\n                    {a.name}\n                  </option>\n                ))}\n              </select>\n            </div>\n\n            <div>\n              <label className=\"block text-sm font-bold mb-1\">Type *</label>\n              <select\n                className=\"w-full border p-2 rounded\"\n                value={formData.type}\n                onChange={(e) =>\n                  setFormData({ ...formData, type: e.target.value })\n                }\n              >\n                <option value=\"CPV\">Cash Payment (CPV)</option>\n                <option value=\"CRV\">Cash Receipt (CRV)</option>\n                <option value=\"EXPENSE\">Expense</option>\n                <option value=\"PAYMENT\">Payment</option>\n              </select>\n            </div>\n\n            <div>\n              <label className=\"block text-sm font-bold mb-1\">\n                Frequency *\n              </label>\n              <select\n                className=\"w-full border p-2 rounded\"\n                value={formData.frequency}\n                onChange={(e) =>\n                  setFormData({ ...formData, frequency: e.target.value })\n                }\n              >\n                <option value=\"DAILY\">Daily</option>\n                <option value=\"WEEKLY\">Weekly</option>\n                <option value=\"MONTHLY\">Monthly</option>\n                <option value=\"QUARTERLY\">Quarterly</option>\n                <option value=\"YEARLY\">Yearly</option>\n              </select>\n            </div>\n\n            <div>\n              <label className=\"block text-sm font-bold mb-1\">Amount *</label>\n              <input\n                type=\"number\"\n                className=\"w-full border p-2 rounded\"\n                value={formData.amount}\n                onChange={(e) =>\n                  setFormData({ ...formData, amount: e.target.value })\n                }\n              />\n            </div>\n\n            <div className=\"col-span-2\">\n              <label className=\"block text-sm font-bold mb-1\">\n                Description *\n              </label>\n              <input\n                type=\"text\"\n                className=\"w-full border p-2 rounded\"\n                value={formData.description}\n                onChange={(e) =>\n                  setFormData({ ...formData, description: e.target.value })\n                }\n              />\n            </div>\n\n            <div className=\"col-span-2\">\n              <label className=\"block text-sm font-bold mb-1\">Narration</label>\n              <input\n                type=\"text\"\n                className=\"w-full border p-2 rounded\"\n                value={formData.narration}\n                onChange={(e) =>\n                  setFormData({ ...formData, narration: e.target.value })\n                }\n              />\n            </div>\n\n            <div>\n              <label className=\"block text-sm font-bold mb-1\">Next Date *</label>\n              <input\n                type=\"date\"\n                className=\"w-full border p-2 rounded\"\n                value={formData.nextDate}\n                onChange={(e) =>\n                  setFormData({ ...formData, nextDate: e.target.value })\n                }\n              />\n            </div>\n          </div>\n\n          <div className=\"flex gap-2\">\n            <button\n              onClick={saveTransaction}\n              disabled={loading}\n              className=\"bg-green-600 text-white px-6 py-2 rounded\"\n            >\n              {loading ? \"Saving...\" : \"Save\"}\n            </button>\n            <button\n              onClick={() => {\n                setShowForm(false);\n                setEditing(null);\n              }}\n              className=\"bg-gray-600 text-white px-6 py-2 rounded\"\n            >\n              Cancel\n            </button>\n          </div>\n        </div>\n      )}\n\n      <div className=\"bg-white border rounded overflow-hidden\">\n        <table className=\"w-full text-sm\">\n          <thead className=\"bg-gray-100\">\n            <tr>\n              <th className=\"p-3 text-left\">Account</th>\n              <th className=\"p-3 text-left\">Type</th>\n              <th className=\"p-3 text-left\">Frequency</th>\n              <th className=\"p-3 text-right\">Amount</th>\n              <th className=\"p-3 text-left\">Description</th>\n              <th className=\"p-3 text-left\">Next Date</th>\n              <th className=\"p-3 text-left\">Last Run</th>\n              <th className=\"p-3 text-center\">Status</th>\n              <th className=\"p-3 text-center\">Actions</th>\n            </tr>\n          </thead>\n          <tbody>\n            {loading ? (\n              <tr>\n                <td colSpan={9} className=\"p-4 text-center\">\n                  Loading...\n                </td>\n              </tr>\n            ) : transactions.length === 0 ? (\n              <tr>\n                <td colSpan={9} className=\"p-4 text-center text-gray-400\">\n                  No recurring transactions found\n                </td>\n              </tr>\n            ) : (\n              transactions.map((t) => (\n                <tr key={t.id} className=\"border-t\">\n                  <td className=\"p-3\">{t.account.name}</td>\n                  <td className=\"p-3\">{t.type}</td>\n                  <td className=\"p-3\">{t.frequency}</td>\n                  <td className=\"p-3 text-right\">\n                    {t.amount.toLocaleString()}\n                  </td>\n                  <td className=\"p-3\">{t.description}</td>\n                  <td className=\"p-3\">\n                    {new Date(t.nextDate).toLocaleDateString()}\n                  </td>\n                  <td className=\"p-3\">\n                    {t.lastRun\n                      ? new Date(t.lastRun).toLocaleDateString()\n                      : \"Never\"}\n                  </td>\n                  <td className=\"p-3 text-center\">\n                    <span\n                      className={`px-2 py-1 rounded text-xs ${\n                        t.isActive\n                          ? \"bg-green-100 text-green-800\"\n                          : \"bg-gray-100 text-gray-800\"\n                      }`}\n                    >\n                      {t.isActive ? \"Active\" : \"Inactive\"}\n                    </span>\n                  </td>\n                  <td className=\"p-3 text-center\">\n                    <div className=\"flex gap-2 justify-center\">\n                      <button\n                        onClick={() => startEdit(t)}\n                        className=\"text-blue-600 hover:underline\"\n                      >\n                        Edit\n                      </button>\n                      <button\n                        onClick={() => toggleActive(t.id, t.isActive)}\n                        className=\"text-yellow-600 hover:underline\"\n                      >\n                        {t.isActive ? \"Deactivate\" : \"Activate\"}\n                      </button>\n                      <button\n                        onClick={() => deleteTransaction(t.id)}\n                        className=\"text-red-600 hover:underline\"\n                      >\n                        Delete\n                      </button>\n                    </div>\n                  </td>\n                </tr>\n              ))\n            )}\n          </tbody>\n        </table>\n      </div>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\dashboard\\reports\\ageing\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\dashboard\\reports\\annual-statements\\page.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadReport'. Either include it or remove the dependency array.","line":18,"column":6,"nodeType":"ArrayExpression","endLine":18,"endColumn":12,"suggestions":[{"desc":"Update the dependencies array to be: [loadReport, year]","fix":{"range":[546,552],"text":"[loadReport, year]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useEffect, useState } from \"react\";\r\nimport { getCurrentUser } from \"@/lib/auth\";\r\nimport { exportToCSV } from \"@/lib/export\";\r\nimport { exportToPDF } from \"@/lib/pdf-export\";\r\n\r\nexport default function AnnualStatementsPage() {\r\n  const currentYear = new Date().getFullYear();\r\n  const [year, setYear] = useState(currentYear.toString());\r\n  const [data, setData] = useState<Any>(null);\r\n  const [loading, setLoading] = useState(false);\r\n\r\n  const user = getCurrentUser();\r\n\r\n  useEffect(() => {\r\n    loadReport();\r\n  }, [year]);\r\n\r\n  async function loadReport() {\r\n    setLoading(true);\r\n    try {\r\n      const res = await fetch(`/api/reports/annual-statements?year=${year}`, {\r\n        headers: { \"x-user-role\": user?.role || \"ADMIN\" },\r\n      });\r\n      const result = await res.json();\r\n      if (result.year) {\r\n        setData(result);\r\n      }\r\n    } catch (e) {\r\n      console.error(e);\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  }\r\n\r\n  if (!data) {\r\n    return (\r\n      <div className=\"p-6\">\r\n        <h1 className=\"text-2xl font-bold\">Annual Financial Statements</h1>\r\n        <div className=\"mt-4\">Loading...</div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <div className=\"p-6 space-y-6\">\r\n      <div className=\"flex justify-between items-center\">\r\n        <h1 className=\"text-2xl font-bold\">\r\n          Annual Financial Statements - {year}\r\n        </h1>\r\n        <div className=\"flex gap-2\">\r\n          <input\r\n            type=\"number\"\r\n            className=\"border p-2 rounded\"\r\n            value={year}\r\n            onChange={(e) => setYear(e.target.value)}\r\n            min=\"2020\"\r\n            max=\"2100\"\r\n          />\r\n          <button\r\n            onClick={loadReport}\r\n            className=\"bg-blue-600 text-white px-6 py-2 rounded\"\r\n          >\r\n            {loading ? \"Loading...\" : \"Load\"}\r\n          </button>\r\n          {data && (\r\n            <>\r\n              <button\r\n                onClick={() => exportToCSV(data.accounts, `annual-statements-${year}`)}\r\n                className=\"bg-green-600 text-white px-6 py-2 rounded\"\r\n              >\r\n                Export CSV\r\n              </button>\r\n              <button\r\n                onClick={() =>\r\n                  exportToPDF(\r\n                    data.accounts,\r\n                    `Annual Statements ${year}`,\r\n                    [\"code\", \"name\", \"type\", \"openingBalance\", \"transactions\", \"closingBalance\"]\r\n                  )\r\n                }\r\n                className=\"bg-red-600 text-white px-6 py-2 rounded\"\r\n              >\r\n                Export PDF\r\n              </button>\r\n            </>\r\n          )}\r\n        </div>\r\n      </div>\r\n\r\n      {/* Balance Sheet Summary */}\r\n      <div className=\"grid grid-cols-2 gap-4\">\r\n        <div className=\"bg-white border rounded p-4\">\r\n          <h2 className=\"text-xl font-bold mb-4\">Balance Sheet</h2>\r\n          <div className=\"space-y-2\">\r\n            <div className=\"flex justify-between\">\r\n              <span>Assets:</span>\r\n              <span className=\"font-bold\">\r\n                {data.balanceSheet.assets.toLocaleString()}\r\n              </span>\r\n            </div>\r\n            <div className=\"flex justify-between\">\r\n              <span>Liabilities:</span>\r\n              <span className=\"font-bold\">\r\n                {data.balanceSheet.liabilities.toLocaleString()}\r\n              </span>\r\n            </div>\r\n            <div className=\"flex justify-between\">\r\n              <span>Equity:</span>\r\n              <span className=\"font-bold\">\r\n                {data.balanceSheet.equity.toLocaleString()}\r\n              </span>\r\n            </div>\r\n            <div className=\"border-t pt-2 mt-2\">\r\n              <div className=\"flex justify-between font-bold\">\r\n                <span>Total:</span>\r\n                <span>{data.balanceSheet.total.toLocaleString()}</span>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        <div className=\"bg-white border rounded p-4\">\r\n          <h2 className=\"text-xl font-bold mb-4\">Profit & Loss</h2>\r\n          <div className=\"space-y-2\">\r\n            <div className=\"flex justify-between\">\r\n              <span>Income:</span>\r\n              <span className=\"font-bold text-green-600\">\r\n                {data.profitLoss.income.toLocaleString()}\r\n              </span>\r\n            </div>\r\n            <div className=\"flex justify-between\">\r\n              <span>Expenses:</span>\r\n              <span className=\"font-bold text-red-600\">\r\n                {data.profitLoss.expenses.toLocaleString()}\r\n              </span>\r\n            </div>\r\n            <div className=\"border-t pt-2 mt-2\">\r\n              <div className=\"flex justify-between font-bold\">\r\n                <span>Net Profit:</span>\r\n                <span\r\n                  className={\r\n                    data.profitLoss.netProfit >= 0\r\n                      ? \"text-green-600\"\r\n                      : \"text-red-600\"\r\n                  }\r\n                >\r\n                  {data.profitLoss.netProfit.toLocaleString()}\r\n                </span>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Account Details */}\r\n      <div className=\"bg-white border rounded overflow-hidden\">\r\n        <h2 className=\"text-xl font-bold p-4 border-b\">Account Details</h2>\r\n        <table className=\"w-full text-sm\">\r\n          <thead className=\"bg-gray-100\">\r\n            <tr>\r\n              <th className=\"p-3 text-left\">Code</th>\r\n              <th className=\"p-3 text-left\">Account Name</th>\r\n              <th className=\"p-3 text-left\">Type</th>\r\n              <th className=\"p-3 text-right\">Opening</th>\r\n              <th className=\"p-3 text-right\">Transactions</th>\r\n              <th className=\"p-3 text-right\">Closing</th>\r\n            </tr>\r\n          </thead>\r\n          <tbody>\r\n            {data.accounts.map((acc: Any, i: number) => (\r\n              <tr key={i} className=\"border-t\">\r\n                <td className=\"p-3\">{acc.code}</td>\r\n                <td className=\"p-3\">{acc.name}</td>\r\n                <td className=\"p-3\">{acc.type}</td>\r\n                <td className=\"p-3 text-right\">\r\n                  {acc.openingBalance.toLocaleString()}\r\n                </td>\r\n                <td className=\"p-3 text-right\">\r\n                  {acc.transactions.toLocaleString()}\r\n                </td>\r\n                <td className=\"p-3 text-right font-bold\">\r\n                  {acc.closingBalance.toLocaleString()}\r\n                </td>\r\n              </tr>\r\n            ))}\r\n          </tbody>\r\n        </table>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\dashboard\\reports\\balance-sheet\\page.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'load'. Either include it or remove the dependency array.","line":21,"column":6,"nodeType":"ArrayExpression","endLine":21,"endColumn":12,"suggestions":[{"desc":"Update the dependencies array to be: [date, load]","fix":{"range":[622,628],"text":"[date, load]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\nimport { useEffect, useState } from \"react\";\nimport { getCurrentUser } from \"@/lib/auth\";\n\nexport default function DetailedBalanceSheet() {\n  const [date, setDate] = useState(new Date().toISOString().slice(0, 10));\n  const [data, setData] = useState<Any>(null);\n  const [loading, setLoading] = useState(false);\n  const [sendingEmail, setSendingEmail] = useState(false);\n\n  const load = async () => {\n    setLoading(true);\n    const res = await fetch(`/api/reports/balance-sheet?date=${date}`);\n    const d = await res.json();\n    setData(d);\n    setLoading(false);\n  };\n\n  useEffect(() => {\n    load();\n  }, [date]);\n\n  return (\n    <div className=\"p-4 max-w-4xl mx-auto bg-white border shadow-lg font-sans text-sm\">\n      <div className=\"flex justify-between items-center border-b-4 border-black pb-2 mb-4\">\n        <div className=\"text-left\">\n          <h1 className=\"text-2xl font-black uppercase\">US TRADERS</h1>\n          <h2 className=\"text-md font-bold italic\">Final Balance Sheet Statement</h2>\n        </div>\n        <div className=\"flex gap-1 print:hidden\">\n          <input\n            type=\"date\"\n            value={date}\n            onChange={e => setDate(e.target.value)}\n            className=\"border-2 border-black p-1 text-xs font-bold\"\n          />\n          <button\n            onClick={load}\n            className=\"bg-black text-white px-4 py-1 text-xs font-bold uppercase\"\n          >\n            Search\n          </button>\n          <button\n            onClick={() => window.print()}\n            className=\"bg-blue-600 text-white px-4 py-1 text-xs font-bold uppercase\"\n          >\n            Print\n          </button>\n          <button\n            onClick={async () => {\n              const email = window.prompt(\"Report email kis address par bhejni hai?\");\n              if (!email || !email.includes(\"@\")) return;\n              setSendingEmail(true);\n              try {\n                const user = getCurrentUser();\n                const res = await fetch(\"/api/email/send\", {\n                  method: \"POST\",\n                  headers: {\n                    \"Content-Type\": \"application/json\",\n                    \"x-user-role\": user?.role || \"\",\n                    \"x-user-id\": user?.id || \"\",\n                  },\n                  body: JSON.stringify({\n                    type: \"custom\",\n                    to: email,\n                    subject: `Balance Sheet as on ${date}`,\n                    message: \"Balance Sheet report from US TRADERS system.\",\n                  }),\n                });\n                const data = await res.json();\n                if (res.ok) {\n                  alert(\"Email bhej di gayi hai\");\n                } else {\n                  alert(data.error || \"Email send nahi ho saki\");\n                }\n              } catch (_e) {\n                alert(\"Email send karte waqt error aayi\");\n              } finally {\n                setSendingEmail(false);\n              }\n            }}\n            disabled={sendingEmail}\n            className=\"bg-green-600 text-white px-4 py-1 text-xs font-bold uppercase disabled:bg-gray-400\"\n          >\n            {sendingEmail ? \"Sending...\" : \"Email\"}\n          </button>\n        </div>\n      </div>\n\n      {loading ? <p className=\"text-center font-bold\">Syncing Records...</p> : (\n        <div className=\"space-y-6\">\n          \n          {/* TWO COLUMN FORMAT - Assets (DR) and Liabilities (CR) */}\n          <div className=\"grid grid-cols-2 gap-4\">\n            \n            {/* LEFT SIDE - ASSETS (DEBIT) */}\n            <div className=\"border border-black\">\n              <h3 className=\"bg-blue-900 text-white px-2 py-1 font-bold uppercase italic text-center\">Assets & Receivables (DR)</h3>\n              <table className=\"w-full\">\n                <thead className=\"bg-gray-100 border-b border-black text-[10px]\">\n                  <tr>\n                    <th className=\"text-left p-2\">Particulars</th>\n                    <th className=\"text-right p-2 w-32\">Amount</th>\n                  </tr>\n                </thead>\n                <tbody>\n                  {data?.assets && data.assets.length > 0 ? data.assets.map((a: Any, i: number) => (\n                    <tr key={i} className=\"border-b border-gray-100\">\n                      <td className=\"p-2 font-semibold uppercase text-[11px]\">{a.name}</td>\n                      <td className=\"p-2 text-right font-mono text-[11px]\">{Math.abs(a.amount).toLocaleString()}</td>\n                    </tr>\n                  )) : (\n                    <tr><td colSpan={2} className=\"p-2 text-center text-gray-400\">No Assets</td></tr>\n                  )}\n                </tbody>\n                <tfoot>\n                  <tr className=\"bg-blue-50 font-black border-t-2 border-black\">\n                    <td className=\"p-2 uppercase text-[12px]\">Total Assets</td>\n                    <td className=\"p-2 text-right font-mono text-[12px] border-t-2 border-black\">{data?.totalAssets ? data.totalAssets.toLocaleString() : '0'}</td>\n                  </tr>\n                </tfoot>\n              </table>\n            </div>\n\n            {/* RIGHT SIDE - LIABILITIES & EQUITY (CREDIT) */}\n            <div className=\"border border-black\">\n              <h3 className=\"bg-red-800 text-white px-2 py-1 font-bold uppercase italic text-center\">Liabilities & Equity (CR)</h3>\n              <table className=\"w-full\">\n                <thead className=\"bg-gray-100 border-b border-black text-[10px]\">\n                  <tr>\n                    <th className=\"text-left p-2\">Particulars</th>\n                    <th className=\"text-right p-2 w-32\">Amount</th>\n                  </tr>\n                </thead>\n                <tbody>\n                  {data?.liabilities && data.liabilities.length > 0 && data.liabilities.map((l: Any, i: number) => (\n                    <tr key={i} className=\"border-b border-gray-100\">\n                      <td className=\"p-2 font-semibold uppercase text-[11px]\">{l.name}</td>\n                      <td className=\"p-2 text-right font-mono text-[11px]\">{Math.abs(l.amount).toLocaleString()}</td>\n                    </tr>\n                  ))}\n                  {data?.equity && data.equity.length > 0 && data.equity.map((e: Any, i: number) => (\n                    <tr key={`eq-${i}`} className=\"border-b border-gray-100 bg-green-50\">\n                      <td className=\"p-2 font-semibold uppercase text-[11px]\">{e.name}</td>\n                      <td className=\"p-2 text-right font-mono text-[11px]\">{Math.abs(e.amount).toLocaleString()}</td>\n                    </tr>\n                  ))}\n                  {data?.netProfit !== undefined && (\n                    <tr className=\"border-b border-gray-100 bg-green-100\">\n                      <td className=\"p-2 font-semibold uppercase text-[11px]\">Net Profit/Loss</td>\n                      <td className=\"p-2 text-right font-mono text-[11px]\">{Math.abs(data.netProfit).toLocaleString()}</td>\n                    </tr>\n                  )}\n                </tbody>\n                <tfoot>\n                  <tr className=\"bg-red-50 font-black border-t-2 border-black\">\n                    <td className=\"p-2 uppercase text-[12px]\">Total Liabilities & Equity</td>\n                    <td className=\"p-2 text-right font-mono text-[12px] border-t-2 border-black\">\n                      {(data?.totalLiabilities || 0) + (data?.totalEquity || 0)}\n                    </td>\n                  </tr>\n                </tfoot>\n              </table>\n            </div>\n\n          </div>\n\n          <div className={`p-4 text-center border-2 border-black font-black uppercase text-xl rounded ${data?.isBalanced ? 'text-green-700 bg-green-100' : 'text-red-700 bg-red-100'}`}>\n            {data?.isBalanced\n              ? `✔ BALANCED - Assets = Liabilities + Equity`\n              : `❌ OUT OF BALANCE - Difference: ${Math.abs((data?.totalAssets || 0) - ((data?.totalLiabilities || 0) + (data?.totalEquity || 0))).toLocaleString()}`}\n          </div>\n\n        </div>\n      )}\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\dashboard\\reports\\cash-flow\\page.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadReport'. Either include it or remove the dependency array.","line":40,"column":6,"nodeType":"ArrayExpression","endLine":40,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [loadReport]","fix":{"range":[1099,1101],"text":"[loadReport]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useEffect, useState } from \"react\";\r\nimport { getCurrentUser } from \"@/lib/auth\";\r\nimport { exportToCSV } from \"@/lib/export\";\r\n\r\nexport default function CashFlowPage() {\r\n  const today = new Date().toISOString().slice(0, 10);\r\n  const [from, setFrom] = useState(\"2026-01-01\");\r\n  const [to, setTo] = useState(today);\r\n  const [data, setData] = useState<Any>(null);\r\n  const [loading, setLoading] = useState(false);\r\n\r\n  async function loadReport() {\r\n    setLoading(true);\r\n    try {\r\n      const user = getCurrentUser();\r\n      const res = await fetch(\r\n        `/api/reports/cash-flow?from=${from}&to=${to}`,\r\n        {\r\n          headers: { \"x-user-role\": user?.role || \"ADMIN\" },\r\n        }\r\n      );\r\n      const result = await res.json();\r\n      if (res.ok) {\r\n        setData(result);\r\n      } else {\r\n        alert(result.error || \"Failed to load cash flow\");\r\n      }\r\n    } catch (e) {\r\n      console.error(e);\r\n      alert(\"Error loading cash flow report\");\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  }\r\n\r\n  useEffect(() => {\r\n    loadReport();\r\n  }, []);\r\n\r\n  function exportReport() {\r\n    if (!data) return;\r\n    const exportData = [\r\n      ...data.operating.items.map((item: Any) => ({\r\n        category: \"Operating\",\r\n        date: item.date,\r\n        voucherNo: item.voucherNo,\r\n        description: item.description,\r\n        type: item.type,\r\n        amount: item.amount,\r\n      })),\r\n      ...data.investing.items.map((item: Any) => ({\r\n        category: \"Investing\",\r\n        date: item.date,\r\n        voucherNo: item.voucherNo,\r\n        description: item.description,\r\n        type: item.type,\r\n        amount: item.amount,\r\n      })),\r\n      ...data.financing.items.map((item: Any) => ({\r\n        category: \"Financing\",\r\n        date: item.date,\r\n        voucherNo: item.voucherNo,\r\n        description: item.description,\r\n        type: item.type,\r\n        amount: item.amount,\r\n      })),\r\n    ];\r\n    exportToCSV(exportData, \"cash-flow-report\");\r\n  }\r\n\r\n  return (\r\n    <div className=\"p-6 max-w-7xl mx-auto space-y-6\">\r\n      <h1 className=\"text-3xl font-bold\">Cash Flow Statement</h1>\r\n\r\n      {/* FILTERS */}\r\n      <div className=\"bg-white border rounded-lg p-4 flex gap-4 items-end print:hidden\">\r\n        <div>\r\n          <label className=\"block text-sm font-medium mb-1\">From</label>\r\n          <input\r\n            type=\"date\"\r\n            value={from}\r\n            onChange={(e) => setFrom(e.target.value)}\r\n            className=\"border rounded px-3 py-2\"\r\n          />\r\n        </div>\r\n        <div>\r\n          <label className=\"block text-sm font-medium mb-1\">To</label>\r\n          <input\r\n            type=\"date\"\r\n            value={to}\r\n            onChange={(e) => setTo(e.target.value)}\r\n            className=\"border rounded px-3 py-2\"\r\n          />\r\n        </div>\r\n        <button\r\n          onClick={loadReport}\r\n          disabled={loading}\r\n          className=\"bg-blue-600 text-white px-6 py-2 rounded font-bold\"\r\n        >\r\n          {loading ? \"Loading...\" : \"Load Report\"}\r\n        </button>\r\n        {data && (\r\n          <button\r\n            onClick={exportReport}\r\n            className=\"bg-green-600 text-white px-6 py-2 rounded font-bold\"\r\n          >\r\n            📥 Export CSV\r\n          </button>\r\n        )}\r\n      </div>\r\n\r\n      {/* REPORT */}\r\n      {data && (\r\n        <div className=\"bg-white border rounded-lg p-6 space-y-6\">\r\n          <div className=\"text-center border-b pb-4\">\r\n            <h2 className=\"text-2xl font-bold\">Cash Flow Statement</h2>\r\n            <p className=\"text-gray-600\">\r\n              {data.period.from} to {data.period.to}\r\n            </p>\r\n          </div>\r\n\r\n          {/* OPERATING ACTIVITIES */}\r\n          <div>\r\n            <h3 className=\"text-xl font-bold mb-3\">Operating Activities</h3>\r\n            <div className=\"space-y-2 mb-4\">\r\n              <div className=\"flex justify-between\">\r\n                <span>Cash Inflow:</span>\r\n                <span className=\"text-green-600 font-bold\">\r\n                  {data.operating.inflow.toFixed(2)}\r\n                </span>\r\n              </div>\r\n              <div className=\"flex justify-between\">\r\n                <span>Cash Outflow:</span>\r\n                <span className=\"text-red-600 font-bold\">\r\n                  {data.operating.outflow.toFixed(2)}\r\n                </span>\r\n              </div>\r\n              <div className=\"flex justify-between border-t pt-2 font-bold\">\r\n                <span>Net Cash from Operations:</span>\r\n                <span\r\n                  className={\r\n                    data.operating.net >= 0 ? \"text-green-600\" : \"text-red-600\"\r\n                  }\r\n                >\r\n                  {data.operating.net.toFixed(2)}\r\n                </span>\r\n              </div>\r\n            </div>\r\n          </div>\r\n\r\n          {/* INVESTING ACTIVITIES */}\r\n          <div>\r\n            <h3 className=\"text-xl font-bold mb-3\">Investing Activities</h3>\r\n            <div className=\"space-y-2 mb-4\">\r\n              <div className=\"flex justify-between\">\r\n                <span>Cash Inflow:</span>\r\n                <span className=\"text-green-600 font-bold\">\r\n                  {data.investing.inflow.toFixed(2)}\r\n                </span>\r\n              </div>\r\n              <div className=\"flex justify-between\">\r\n                <span>Cash Outflow:</span>\r\n                <span className=\"text-red-600 font-bold\">\r\n                  {data.investing.outflow.toFixed(2)}\r\n                </span>\r\n              </div>\r\n              <div className=\"flex justify-between border-t pt-2 font-bold\">\r\n                <span>Net Cash from Investing:</span>\r\n                <span\r\n                  className={\r\n                    data.investing.net >= 0 ? \"text-green-600\" : \"text-red-600\"\r\n                  }\r\n                >\r\n                  {data.investing.net.toFixed(2)}\r\n                </span>\r\n              </div>\r\n            </div>\r\n          </div>\r\n\r\n          {/* FINANCING ACTIVITIES */}\r\n          <div>\r\n            <h3 className=\"text-xl font-bold mb-3\">Financing Activities</h3>\r\n            <div className=\"space-y-2 mb-4\">\r\n              <div className=\"flex justify-between\">\r\n                <span>Cash Inflow:</span>\r\n                <span className=\"text-green-600 font-bold\">\r\n                  {data.financing.inflow.toFixed(2)}\r\n                </span>\r\n              </div>\r\n              <div className=\"flex justify-between\">\r\n                <span>Cash Outflow:</span>\r\n                <span className=\"text-red-600 font-bold\">\r\n                  {data.financing.outflow.toFixed(2)}\r\n                </span>\r\n              </div>\r\n              <div className=\"flex justify-between border-t pt-2 font-bold\">\r\n                <span>Net Cash from Financing:</span>\r\n                <span\r\n                  className={\r\n                    data.financing.net >= 0 ? \"text-green-600\" : \"text-red-600\"\r\n                  }\r\n                >\r\n                  {data.financing.net.toFixed(2)}\r\n                </span>\r\n              </div>\r\n            </div>\r\n          </div>\r\n\r\n          {/* NET CASH FLOW */}\r\n          <div className=\"border-t-2 border-black pt-4\">\r\n            <div className=\"flex justify-between text-2xl font-bold\">\r\n              <span>Net Increase/Decrease in Cash:</span>\r\n              <span\r\n                className={data.netCashFlow >= 0 ? \"text-green-600\" : \"text-red-600\"}\r\n              >\r\n                {data.netCashFlow.toFixed(2)}\r\n              </span>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\dashboard\\reports\\inventory\\inward\\page.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadReport'. Either include it or remove the dependency array.","line":40,"column":40,"nodeType":"ArrayExpression","endLine":40,"endColumn":42,"suggestions":[{"desc":"Update the dependencies array to be: [loadReport]","fix":{"range":[1211,1213],"text":"[loadReport]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useEffect, useState } from \"react\";\r\nimport { getCurrentUser } from \"@/lib/auth\";\r\n\r\ntype InwardRow = {\r\n    date: string;\r\n    type: string;\r\n    supplierName: string;\r\n    itemName: string;\r\n    description?: string;\r\n    qty: number;\r\n    rate: number;\r\n    amount: number;\r\n};\r\n\r\nexport default function InwardReportPage() {\r\n    const today = new Date().toISOString().slice(0, 10);\r\n    const [fromDate, setFromDate] = useState(\"2025-01-01\");\r\n    const [toDate, setToDate] = useState(today);\r\n    const [rows, setRows] = useState<InwardRow[]>([]);\r\n    const [loading, setLoading] = useState(false);\r\n\r\n    async function loadReport() {\r\n        setLoading(true);\r\n        const user = getCurrentUser();\r\n        try {\r\n            const res = await fetch(`/api/reports/inventory/inward?from=${fromDate}&to=${toDate}`, {\r\n                headers: { \"x-user-role\": user?.role || \"ADMIN\" }\r\n            });\r\n            const json = await res.json();\r\n            setRows(Array.isArray(json) ? json : []);\r\n        } catch (error) {\r\n            console.error(error);\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    }\r\n\r\n    useEffect(() => { loadReport(); }, []);\r\n\r\n    // 🛡️ Safe Calculation to avoid null errors\r\n    const totalQty = rows.reduce((s, r) => s + (Number(r.qty) || 0), 0);\r\n    const totalAmount = rows.reduce((s, r) => s + (Number(r.amount) || 0), 0);\r\n\r\n    return (\r\n        <div className=\"p-6 max-w-7xl mx-auto space-y-6 font-bold\">\r\n            <h1 className=\"text-3xl font-black uppercase italic border-b-4 border-black pb-2\">Inward Inventory Report</h1>\r\n\r\n            {/* FILTER BAR */}\r\n            <div className=\"flex gap-4 items-end flex-wrap bg-white p-4 border-2 border-black shadow-[4px_4px_0px_0px_rgba(0,0,0,1)]\">\r\n                <div className=\"flex flex-col gap-1\">\r\n                    <label className=\"text-xs font-bold uppercase\">From Date</label>\r\n                    <input type=\"date\" className=\"border-2 border-black px-3 py-2 outline-none\" value={fromDate} onChange={e => setFromDate(e.target.value)} />\r\n                </div>\r\n                <div className=\"flex flex-col gap-1\">\r\n                    <label className=\"text-xs font-bold uppercase\">To Date</label>\r\n                    <input type=\"date\" className=\"border-2 border-black px-3 py-2 outline-none\" value={toDate} onChange={e => setToDate(e.target.value)} />\r\n                </div>\r\n                <button onClick={loadReport} className=\"bg-black text-white px-8 py-2.5 font-bold uppercase hover:bg-gray-800\">\r\n                    Show Report\r\n                </button>\r\n            </div>\r\n\r\n            <div className=\"border-2 border-black bg-white overflow-hidden shadow-[8px_8px_0px_0px_rgba(0,0,0,1)]\">\r\n                <table className=\"w-full text-sm\">\r\n                    <thead className=\"bg-black text-white\">\r\n                        <tr>\r\n                            <th className=\"p-3 text-left\">DATE</th>\r\n                            <th className=\"p-3 text-left\">SUPPLIER</th>\r\n                            <th className=\"p-3 text-left\">ITEM</th>\r\n                            <th className=\"p-3 text-right\">QTY</th>\r\n                            <th className=\"p-3 text-right\">RATE</th>\r\n                            <th className=\"p-3 text-right\">AMOUNT</th>\r\n                        </tr>\r\n                    </thead>\r\n                    <tbody className=\"divide-y-2 divide-black\">\r\n                        {loading ? (\r\n                            <tr><td colSpan={6} className=\"p-10 text-center animate-pulse\">LOADING...</td></tr>\r\n                        ) : rows.length === 0 ? (\r\n                            <tr><td colSpan={6} className=\"p-10 text-center text-gray-400\">NO DATA FOUND</td></tr>\r\n                        ) : (\r\n                            rows.map((r, i) => (\r\n                                <tr key={i} className=\"hover:bg-yellow-50\">\r\n                                    <td className=\"p-3 border-r-2 border-black uppercase\">{r.date}</td>\r\n                                    <td className=\"p-3 border-r-2 border-black text-blue-800 uppercase\">{r.supplierName}</td>\r\n                                    <td className=\"p-3 border-r-2 border-black uppercase\">{r.itemName} {r.description ? `(${r.description})` : \"\"}</td>\r\n                                    {/* 🛡️ Added Fallback || 0 to prevent crash */}\r\n                                    <td className=\"p-3 border-r-2 border-black text-right\">{(r.qty || 0).toLocaleString()}</td>\r\n                                    <td className=\"p-3 border-r-2 border-black text-right\">{(r.rate || 0).toLocaleString()}</td>\r\n                                    <td className=\"p-3 text-right bg-gray-50\">{(r.amount || 0).toLocaleString()}</td>\r\n                                </tr>\r\n                            ))\r\n                        )}\r\n                    </tbody>\r\n                    {!loading && rows.length > 0 && (\r\n                        <tfoot className=\"bg-black text-white font-black\">\r\n                            <tr>\r\n                                <td colSpan={3} className=\"p-3 text-right\">TOTAL INWARD</td>\r\n                                <td className=\"p-3 text-right\">{totalQty.toLocaleString()}</td>\r\n                                <td className=\"p-3\"></td>\r\n                                <td className=\"p-3 text-right\">{totalAmount.toLocaleString()}</td>\r\n                            </tr>\r\n                        </tfoot>\r\n                    )}\r\n                </table>\r\n            </div>\r\n        </div>\r\n    );\r\n}","usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\dashboard\\reports\\inventory\\stock-summary\\page.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadStock'. Either include it or remove the dependency array.","line":36,"column":37,"nodeType":"ArrayExpression","endLine":36,"endColumn":47,"suggestions":[{"desc":"Update the dependencies array to be: [asOnDate, loadStock]","fix":{"range":[978,988],"text":"[asOnDate, loadStock]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useEffect, useState } from \"react\";\r\nimport { getCurrentUser } from \"@/lib/auth\";\r\n\r\ntype StockRow = {\r\n  itemId: string;\r\n  itemName: string;\r\n  description: string;\r\n  unit: string;\r\n  stockQty: number;\r\n};\r\n\r\nexport default function StockSummaryPage() {\r\n  const today = new Date().toISOString().slice(0, 10);\r\n  const [asOnDate, setAsOnDate] = useState(today);\r\n  const [rows, setRows] = useState<StockRow[]>([]);\r\n  const [loading, setLoading] = useState(false);\r\n\r\n  async function loadStock() {\r\n    setLoading(true);\r\n    const user = getCurrentUser();\r\n    try {\r\n      const res = await fetch(`/api/reports/inventory/stock-summary?date=${asOnDate}`, {\r\n        headers: { \"x-user-role\": user?.role || \"\" }\r\n      });\r\n      const json = await res.json();\r\n      setRows(Array.isArray(json) ? json : []);\r\n    } catch (e) {\r\n      console.error(e);\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  }\r\n\r\n  useEffect(() => { loadStock(); }, [asOnDate]);\r\n\r\n  return (\r\n    <div className=\"p-6 max-w-5xl mx-auto space-y-6\">\r\n      <div className=\"flex justify-between items-end border-b-4 border-black pb-4\">\r\n        <div>\r\n          <h1 className=\"text-3xl font-black uppercase italic\">Current Stock Status</h1>\r\n          <p className=\"text-sm font-bold text-gray-500 uppercase tracking-widest\">Inventory Balance Report</p>\r\n        </div>\r\n        <div className=\"flex gap-2\">\r\n          <input type=\"date\" value={asOnDate} onChange={e => setAsOnDate(e.target.value)} className=\"border-2 border-black px-4 py-2 font-bold outline-none\" />\r\n          <button onClick={loadStock} className=\"bg-black text-white px-6 py-2 font-bold uppercase hover:bg-gray-800 transition-all\">Refresh</button>\r\n        </div>\r\n      </div>\r\n\r\n      <div className=\"bg-white border-2 border-black shadow-[8px_8px_0px_0px_rgba(0,0,0,1)] overflow-hidden\">\r\n        <table className=\"w-full text-sm border-collapse\">\r\n          <thead className=\"bg-black text-white uppercase font-black\">\r\n            <tr>\r\n              <th className=\"p-4 text-left border-r border-gray-700\">Item Description</th>\r\n              <th className=\"p-4 text-center border-r border-gray-700 w-32\">Unit</th>\r\n              <th className=\"p-4 text-right w-48\">Available Qty</th>\r\n            </tr>\r\n          </thead>\r\n          <tbody className=\"font-bold uppercase\">\r\n            {loading ? (\r\n              <tr><td colSpan={3} className=\"p-10 text-center animate-pulse\">Checking Warehouse...</td></tr>\r\n            ) : rows.length === 0 ? (\r\n              <tr><td colSpan={3} className=\"p-10 text-center text-gray-400 italic\">No Stock Found.</td></tr>\r\n            ) : (\r\n              rows.map((r, i) => (\r\n                <tr key={i} className=\"border-b-2 border-black hover:bg-yellow-50 transition-colors\">\r\n                  <td className=\"p-4 border-r-2 border-black\">\r\n                    <div>{r.itemName}</div>\r\n                    <div className=\"text-[10px] text-gray-500 normal-case\">\r\n                      {r.description || \"\"}\r\n                    </div>\r\n                  </td>\r\n                  <td className=\"p-4 text-center border-r-2 border-black text-gray-600\">{r.unit}</td>\r\n                  <td className={`p-4 text-right text-lg ${r.stockQty < 5 ? 'text-red-600 bg-red-50' : 'text-blue-700'}`}>\r\n                    {r.stockQty.toLocaleString()}\r\n                  </td>\r\n                </tr>\r\n              ))\r\n            )}\r\n          </tbody>\r\n        </table>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\dashboard\\reports\\ledger\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\dashboard\\reports\\outward\\page.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadReport'. Either include it or remove the dependency array.","line":51,"column":38,"nodeType":"ArrayExpression","endLine":51,"endColumn":40,"suggestions":[{"desc":"Update the dependencies array to be: [loadReport]","fix":{"range":[1751,1753],"text":"[loadReport]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { useEffect, useState } from \"react\";\nimport { getCurrentUser } from \"@/lib/auth\";\nimport { exportToCSV } from \"@/lib/export\";\n\nexport default function OutwardReportPage() {\n  const today = new Date().toISOString().slice(0, 10);\n  const [fromDate, setFromDate] = useState(today);\n  const [toDate, setToDate] = useState(today);\n  const [customerId, setCustomerId] = useState(\"\");\n  const [customers, setCustomers] = useState<Any[]>([]);\n  const [rows, setRows] = useState<Any[]>([]);\n  const [loading, setLoading] = useState(false);\n\n  // 🛠️ کسٹمرز لوڈ کرنا (With Safety Fix)\n  useEffect(() => {\n    fetch(\"/api/accounts\")\n      .then((r) => r.json())\n      .then((d) => {\n        // چیک کریں کہ d ایرے ہے، اگر نہیں تو خالی ایرے سیٹ کریں\n        const data = Array.isArray(d) ? d : (d.accounts || []);\n        setCustomers(data.filter((a: Any) => a.partyType === \"CUSTOMER\"));\n      })\n      .catch(err => console.error(\"Customer fetch error:\", err));\n  }, []);\n\n  // 🛠️ رپورٹ ڈیٹا لوڈ کرنا (With Auth Headers)\n  async function loadReport() {\n    setLoading(true);\n    const user = getCurrentUser(); // رول حاصل کریں\n    try {\n      const res = await fetch(`/api/reports/outward?from=${fromDate}&to=${toDate}&customerId=${customerId}`, {\n        method: \"GET\",\n        headers: {\n          \"x-user-role\": user?.role || \"ADMIN\" // یہ ہیڈر لازمی ہے\n        },\n        cache: 'no-store'\n      });\n      const data = await res.json();\n      // اگر ڈیٹا ایرے نہیں ہے تو خالی ایرے سیٹ کریں تاکہ کریش نہ ہو\n      setRows(Array.isArray(data) ? data : []);\n    } catch (error) {\n      console.error(\"Report load error:\", error);\n      setRows([]);\n    } finally {\n      setLoading(false);\n    }\n  }\n\n  useEffect(() => { loadReport(); }, []);\n\n  const totalQty = rows.reduce((sum, r) => sum + (Number(r.qty) || 0), 0);\n\n  return (\n    <div className=\"p-6 max-w-7xl mx-auto space-y-6 bg-white min-h-screen font-bold\">\n      \n      {/* --- FILTERS --- */}\n      <div className=\"flex flex-wrap gap-4 bg-gray-50 p-6 border-2 border-black shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] print:hidden\">\n        <div className=\"flex flex-col gap-1\">\n          <label className=\"text-[10px] font-bold uppercase text-gray-400\">From</label>\n          <input type=\"date\" className=\"border-2 border-black p-2 outline-none\" value={fromDate} onChange={(e) => setFromDate(e.target.value)} />\n        </div>\n        <div className=\"flex flex-col gap-1\">\n          <label className=\"text-[10px] font-bold uppercase text-gray-400\">To</label>\n          <input type=\"date\" className=\"border-2 border-black p-2 outline-none\" value={toDate} onChange={(e) => setToDate(e.target.value)} />\n        </div>\n        <div className=\"flex flex-col gap-1 min-w-[200px]\">\n          <label className=\"text-[10px] font-bold uppercase text-gray-400\">Customer</label>\n          <select className=\"border-2 border-black p-2 outline-none\" value={customerId} onChange={(e) => setCustomerId(e.target.value)}>\n            <option value=\"\">All Customers</option>\n            {customers.map((c) => (<option key={c.id} value={c.id}>{c.name}</option>))}\n          </select>\n        </div>\n        <div className=\"flex gap-2 mt-5\">\n          <button onClick={loadReport} className=\"bg-black text-white px-6 rounded-none font-black uppercase text-xs h-10 hover:bg-gray-800\">\n            {loading ? \"Loading...\" : \"Filter\"}\n          </button>\n          <button onClick={() => window.print()} className=\"bg-blue-600 text-white px-6 rounded-none font-black uppercase text-xs h-10\">Print</button>\n          {rows.length > 0 && (\n            <button \n              onClick={() => exportToCSV(rows, \"outward-report\")} \n              className=\"bg-green-600 text-white px-6 rounded-none font-black uppercase text-xs h-10\"\n            >\n              📥 CSV\n            </button>\n          )}\n        </div>\n      </div>\n\n      {/* --- REPORT VIEW --- */}\n      <div className=\"invoice-print\">\n        <div className=\"mb-6 border-b-4 border-black pb-4 text-center\">\n          <h1 className=\"text-4xl font-black uppercase italic\">US TRADERS</h1>\n          <p className=\"text-sm font-bold uppercase tracking-widest text-gray-600\">Outward Dispatch Report</p>\n          <p className=\"text-xs\">{fromDate} TO {toDate}</p>\n        </div>\n\n        <table className=\"w-full border-collapse border-2 border-black\">\n          <thead>\n            <tr className=\"bg-black text-white\">\n              <th className=\"p-2 border border-black text-xs uppercase\">GP #</th>\n              <th className=\"p-2 border border-black text-xs uppercase\">Date</th>\n              <th className=\"p-2 border border-black text-xs uppercase text-left\">Customer</th>\n              <th className=\"p-2 border border-black text-xs uppercase text-left\">Vehicle / Driver</th>\n              <th className=\"p-2 border border-black text-xs uppercase text-left\">Item Name</th>\n              <th className=\"p-2 border border-black text-xs uppercase\">Qty</th>\n            </tr>\n          </thead>\n          <tbody className=\"text-sm\">\n            {rows.length === 0 && !loading ? (\n              <tr><td colSpan={6} className=\"p-10 text-center font-bold italic text-gray-400 uppercase\">No Dispatch Records Found</td></tr>\n            ) : (\n              rows.map((r, i) => (\n                <tr key={i} className=\"border-b-2 border-black hover:bg-yellow-50\">\n                  <td className=\"p-2 border-r-2 border-black text-center font-black\">#{r.outwardNo}</td>\n                  <td className=\"p-2 border-r-2 border-black text-center\">{r.date}</td>\n                  <td className=\"p-2 border-r-2 border-black font-black uppercase text-blue-900\">{r.customerName}</td>\n                  <td className=\"p-2 border-r-2 border-black\">\n                    <div className=\"font-black uppercase\">{r.vehicleNo}</div>\n                    <div className=\"text-[9px] uppercase text-gray-500\">Driver: {r.driverName}</div>\n                  </td>\n                  <td className=\"p-2 border-r-2 border-black uppercase\">\n                    <div>{r.itemName}</div>\n                    <div className=\"text-[9px] text-gray-500 normal-case\">\n                      {r.description || \"\"}\n                    </div>\n                  </td>\n                  <td className=\"p-2 text-center font-black text-lg\">{r.qty}</td>\n                </tr>\n              ))\n            )}\n          </tbody>\n          <tfoot>\n            <tr className=\"bg-black text-white\">\n              <td colSpan={5} className=\"p-3 text-right font-black uppercase\">Total Dispatched Quantity:</td>\n              <td className=\"p-3 text-center font-black text-2xl\">{totalQty}</td>\n            </tr>\n          </tfoot>\n        </table>\n\n        {/* Signatures */}\n        <div className=\"hidden print:flex justify-between mt-24 px-10\">\n          <div className=\"text-center border-t-4 border-black w-48 pt-2 text-xs font-black uppercase\">Warehouse Manager</div>\n          <div className=\"text-center border-t-4 border-black w-48 pt-2 text-xs font-black uppercase\">Authorized Officer</div>\n        </div>\n      </div>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\dashboard\\reports\\profit-loss\\page.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'load'. Either include it or remove the dependency array.","line":25,"column":6,"nodeType":"ArrayExpression","endLine":25,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [load]","fix":{"range":[692,694],"text":"[load]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\nimport { useEffect, useState } from \"react\";\nimport { getCurrentUser } from \"@/lib/auth\";\n\nexport default function ProfitLossFinal() {\n  const [from, setFrom] = useState(\"2026-01-01\");\n  const [to, setTo] = useState(\"2026-01-08\");\n  const [report, setReport] = useState<Any>(null);\n  const [_loading, setLoading] = useState(false);\n  const [sendingEmail, setSendingEmail] = useState(false);\n\n  const load = async () => {\n    setLoading(true);\n    try {\n      const res = await fetch(`/api/reports/profit-loss?from=${from}&to=${to}`);\n      const d = await res.json();\n      setReport(d);\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  useEffect(() => {\n    load();\n  }, []);\n\n  return (\n    <div className=\"p-4 max-w-[1200px] mx-auto font-sans bg-white min-h-screen\">\n      <div className=\"flex justify-between items-center border-b-4 border-black pb-2 mb-4\">\n        <h1 className=\"text-3xl font-black italic uppercase tracking-tighter\">Trading & P&L Statement</h1>\n        <div className=\"flex gap-1 print:hidden\">\n          <input type=\"date\" value={from} onChange={e => setFrom(e.target.value)} className=\"border-2 border-black p-1 text-xs font-bold\" />\n          <input type=\"date\" value={to} onChange={e => setTo(e.target.value)} className=\"border-2 border-black p-1 text-xs font-bold\" />\n          <button onClick={load} className=\"bg-black text-white px-4 py-1 text-xs font-bold uppercase\">Search</button>\n          <button onClick={() => window.print()} className=\"bg-blue-600 text-white px-4 py-1 text-xs font-bold uppercase\">Print</button>\n          <button\n            onClick={async () => {\n              const email = window.prompt(\"Report email kis address par bhejni hai?\");\n              if (!email || !email.includes(\"@\")) return;\n              setSendingEmail(true);\n              try {\n                const user = getCurrentUser();\n                const res = await fetch(\"/api/email/send\", {\n                  method: \"POST\",\n                  headers: {\n                    \"Content-Type\": \"application/json\",\n                    \"x-user-role\": user?.role || \"\",\n                    \"x-user-id\": user?.id || \"\",\n                  },\n                  body: JSON.stringify({\n                    type: \"custom\",\n                    to: email,\n                    subject: `Profit & Loss ${from} to ${to}`,\n                    message: \"Profit & Loss report from US TRADERS system.\",\n                  }),\n                });\n                const data = await res.json();\n                if (res.ok) {\n                  alert(\"Email bhej di gayi hai\");\n                } else {\n                  alert(data.error || \"Email send nahi ho saki\");\n                }\n              } catch (_e) {\n                alert(\"Email send karte waqt error aayi\");\n              } finally {\n                setSendingEmail(false);\n              }\n            }}\n            disabled={sendingEmail}\n            className=\"bg-green-600 text-white px-4 py-1 text-xs font-bold uppercase disabled:bg-gray-400\"\n          >\n            {sendingEmail ? \"Sending...\" : \"Email\"}\n          </button>\n        </div>\n      </div>\n\n      <div className=\"grid grid-cols-2 border-2 border-black\">\n        <div className=\"border-r-2 border-black min-h-[450px]\">\n          <div className=\"bg-black text-white p-2 font-bold uppercase text-center italic text-[11px] tracking-widest\">Expenses / Outwards</div>\n          <table className=\"w-full\">\n            <tbody className=\"divide-y divide-gray-100\">\n              {report?.expense && report.expense.length > 0 ? report.expense.map((item: Any, i: number) => (\n                <tr key={i} className=\"hover:bg-red-50 transition-colors\">\n                  <td className=\"p-2 uppercase font-bold text-gray-700 text-[11px]\">{item.name}</td>\n                  <td className=\"p-2 text-right font-black text-[12px]\">{Math.abs(item.amount).toLocaleString()}</td>\n                </tr>\n              )) : (\n                <tr><td colSpan={2} className=\"p-2 text-center text-gray-400\">No expenses</td></tr>\n              )}\n            </tbody>\n          </table>\n        </div>\n\n        <div className=\"min-h-[450px]\">\n          <div className=\"bg-gray-800 text-white p-2 font-bold uppercase text-center italic text-[11px] tracking-widest\">Income / Inwards</div>\n          <table className=\"w-full\">\n            <tbody className=\"divide-y divide-gray-100\">\n              {report?.income && report.income.length > 0 ? report.income.map((item: Any, i: number) => (\n                <tr key={i} className=\"hover:bg-green-50 transition-colors\">\n                  <td className=\"p-2 uppercase font-bold text-gray-700 text-[11px]\">{item.name}</td>\n                  <td className=\"p-2 text-right font-black text-[12px]\">{Math.abs(item.amount).toLocaleString()}</td>\n                </tr>\n              )) : (\n                <tr><td colSpan={2} className=\"p-2 text-center text-gray-400\">No income</td></tr>\n              )}\n            </tbody>\n          </table>\n        </div>\n      </div>\n\n      <div className=\"grid grid-cols-3 gap-4 mt-6\">\n        <div className=\"border-2 border-black p-3 bg-gray-50 flex justify-between items-center shadow-[3px_3px_0px_0px_rgba(0,0,0,1)]\">\n           <span className=\"text-[10px] font-black uppercase\">Total Revenue</span>\n           <span className=\"text-xl font-black\">{report?.totalIncome.toLocaleString()}</span>\n        </div>\n        <div className=\"border-2 border-black p-3 bg-gray-50 flex justify-between items-center shadow-[3px_3px_0px_0px_rgba(0,0,0,1)]\">\n           <span className=\"text-[10px] font-black uppercase\">Total Expenses</span>\n           <span className=\"text-xl font-black\">{report?.totalExpense.toLocaleString()}</span>\n        </div>\n        <div className={`border-2 border-black p-3 flex justify-between items-center shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] ${report?.netProfit >= 0 ? \"bg-green-400\" : \"bg-red-500 text-white\"}`}>\n           <span className=\"text-[10px] font-black uppercase italic\">Net Profit/Loss</span>\n           <span className=\"text-2xl font-black\">{report?.netProfit.toLocaleString()}</span>\n        </div>\n      </div>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\dashboard\\reports\\profitability\\page.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadReport'. Either include it or remove the dependency array.","line":35,"column":6,"nodeType":"ArrayExpression","endLine":35,"endColumn":15,"suggestions":[{"desc":"Update the dependencies array to be: [groupBy, loadReport]","fix":{"range":[996,1005],"text":"[groupBy, loadReport]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useEffect, useState } from \"react\";\r\nimport { getCurrentUser } from \"@/lib/auth\";\r\nimport { exportToCSV } from \"@/lib/export\";\r\nimport { exportToPDF } from \"@/lib/pdf-export\";\r\n\r\ntype ProfitabilityData = {\r\n  customerId?: string;\r\n  customerName?: string;\r\n  itemId?: string;\r\n  itemName?: string;\r\n  invoiceCount?: number;\r\n  quantitySold?: number;\r\n  totalSales: number;\r\n  totalCost: number;\r\n  totalProfit: number;\r\n  profitMargin: number;\r\n  averagePrice?: number;\r\n  averageCost?: number;\r\n};\r\n\r\nexport default function ProfitabilityPage() {\r\n  const today = new Date().toISOString().slice(0, 10);\r\n  const [from, setFrom] = useState(\"2026-01-01\");\r\n  const [to, setTo] = useState(today);\r\n  const [groupBy, setGroupBy] = useState<\"customer\" | \"product\">(\"customer\");\r\n  const [data, setData] = useState<ProfitabilityData[]>([]);\r\n  const [loading, setLoading] = useState(false);\r\n\r\n  const user = getCurrentUser();\r\n\r\n  useEffect(() => {\r\n    loadReport();\r\n  }, [groupBy]);\r\n\r\n  async function loadReport() {\r\n    setLoading(true);\r\n    try {\r\n      const res = await fetch(\r\n        `/api/reports/profitability?from=${from}&to=${to}&groupBy=${groupBy}`,\r\n        {\r\n          headers: { \"x-user-role\": user?.role || \"ADMIN\" },\r\n        }\r\n      );\r\n      const result = await res.json();\r\n      if (Array.isArray(result)) {\r\n        setData(result);\r\n      }\r\n    } catch (e) {\r\n      console.error(e);\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  }\r\n\r\n  const totalSales = data.reduce((sum, d) => sum + d.totalSales, 0);\r\n  const totalCost = data.reduce((sum, d) => sum + d.totalCost, 0);\r\n  const totalProfit = totalSales - totalCost;\r\n  const overallMargin = totalSales > 0 ? (totalProfit / totalSales) * 100 : 0;\r\n\r\n  return (\r\n    <div className=\"p-6 space-y-6\">\r\n      <h1 className=\"text-2xl font-bold\">Profitability Report</h1>\r\n\r\n      <div className=\"flex gap-4 items-end bg-white p-4 border rounded\">\r\n        <div>\r\n          <label className=\"block text-sm font-bold mb-1\">Group By</label>\r\n          <select\r\n            className=\"border p-2 rounded\"\r\n            value={groupBy}\r\n            onChange={(e) =>\r\n              setGroupBy(e.target.value as \"customer\" | \"product\")\r\n            }\r\n          >\r\n            <option value=\"customer\">By Customer</option>\r\n            <option value=\"product\">By Product</option>\r\n          </select>\r\n        </div>\r\n        <div>\r\n          <label className=\"block text-sm font-bold mb-1\">From</label>\r\n          <input\r\n            type=\"date\"\r\n            className=\"border p-2 rounded\"\r\n            value={from}\r\n            onChange={(e) => setFrom(e.target.value)}\r\n          />\r\n        </div>\r\n        <div>\r\n          <label className=\"block text-sm font-bold mb-1\">To</label>\r\n          <input\r\n            type=\"date\"\r\n            className=\"border p-2 rounded\"\r\n            value={to}\r\n            onChange={(e) => setTo(e.target.value)}\r\n          />\r\n        </div>\r\n        <button\r\n          onClick={loadReport}\r\n          className=\"bg-blue-600 text-white px-6 py-2 rounded\"\r\n        >\r\n          {loading ? \"Loading...\" : \"Load Report\"}\r\n        </button>\r\n        {data.length > 0 && (\r\n          <>\r\n            <button\r\n              onClick={() => exportToCSV(data, \"profitability\")}\r\n              className=\"bg-green-600 text-white px-6 py-2 rounded\"\r\n            >\r\n              Export CSV\r\n            </button>\r\n            <button\r\n              onClick={() =>\r\n                exportToPDF(\r\n                  data,\r\n                  \"Profitability Report\",\r\n                  Object.keys(data[0] || {})\r\n                )\r\n              }\r\n              className=\"bg-red-600 text-white px-6 py-2 rounded\"\r\n            >\r\n              Export PDF\r\n            </button>\r\n          </>\r\n        )}\r\n      </div>\r\n\r\n      {data.length > 0 && (\r\n        <div className=\"bg-white border rounded p-4\">\r\n          <div className=\"grid grid-cols-4 gap-4\">\r\n            <div className=\"bg-blue-50 p-4 rounded\">\r\n              <p className=\"text-sm text-gray-600\">Total Sales</p>\r\n              <p className=\"text-2xl font-bold\">{totalSales.toLocaleString()}</p>\r\n            </div>\r\n            <div className=\"bg-red-50 p-4 rounded\">\r\n              <p className=\"text-sm text-gray-600\">Total Cost</p>\r\n              <p className=\"text-2xl font-bold\">{totalCost.toLocaleString()}</p>\r\n            </div>\r\n            <div className=\"bg-green-50 p-4 rounded\">\r\n              <p className=\"text-sm text-gray-600\">Total Profit</p>\r\n              <p className=\"text-2xl font-bold\">{totalProfit.toLocaleString()}</p>\r\n            </div>\r\n            <div className=\"bg-yellow-50 p-4 rounded\">\r\n              <p className=\"text-sm text-gray-600\">Profit Margin</p>\r\n              <p className=\"text-2xl font-bold\">\r\n                {overallMargin.toFixed(2)}%\r\n              </p>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      )}\r\n\r\n      <div className=\"bg-white border rounded overflow-hidden\">\r\n        <table className=\"w-full text-sm\">\r\n          <thead className=\"bg-gray-100\">\r\n            <tr>\r\n              {groupBy === \"customer\" ? (\r\n                <>\r\n                  <th className=\"p-3 text-left\">Customer</th>\r\n                  <th className=\"p-3 text-right\">Invoices</th>\r\n                </>\r\n              ) : (\r\n                <>\r\n                  <th className=\"p-3 text-left\">Product</th>\r\n                  <th className=\"p-3 text-right\">Qty Sold</th>\r\n                </>\r\n              )}\r\n              <th className=\"p-3 text-right\">Sales</th>\r\n              <th className=\"p-3 text-right\">Cost</th>\r\n              <th className=\"p-3 text-right\">Profit</th>\r\n              <th className=\"p-3 text-right\">Margin %</th>\r\n              {groupBy === \"product\" && (\r\n                <>\r\n                  <th className=\"p-3 text-right\">Avg Price</th>\r\n                  <th className=\"p-3 text-right\">Avg Cost</th>\r\n                </>\r\n              )}\r\n            </tr>\r\n          </thead>\r\n          <tbody>\r\n            {loading ? (\r\n              <tr>\r\n                <td colSpan={groupBy === \"customer\" ? 6 : 8} className=\"p-4 text-center\">\r\n                  Loading...\r\n                </td>\r\n              </tr>\r\n            ) : data.length === 0 ? (\r\n              <tr>\r\n                <td colSpan={groupBy === \"customer\" ? 6 : 8} className=\"p-4 text-center text-gray-400\">\r\n                  No data found\r\n                </td>\r\n              </tr>\r\n            ) : (\r\n              data.map((d, i) => (\r\n                <tr key={i} className=\"border-t\">\r\n                  <td className=\"p-3 font-bold\">\r\n                    {groupBy === \"customer\" ? d.customerName : d.itemName}\r\n                  </td>\r\n                  <td className=\"p-3 text-right\">\r\n                    {groupBy === \"customer\"\r\n                      ? d.invoiceCount\r\n                      : d.quantitySold}\r\n                  </td>\r\n                  <td className=\"p-3 text-right\">\r\n                    {d.totalSales.toLocaleString()}\r\n                  </td>\r\n                  <td className=\"p-3 text-right\">{d.totalCost.toLocaleString()}</td>\r\n                  <td className=\"p-3 text-right font-bold\">\r\n                    {d.totalProfit.toLocaleString()}\r\n                  </td>\r\n                  <td className=\"p-3 text-right\">\r\n                    <span\r\n                      className={`px-2 py-1 rounded ${\r\n                        d.profitMargin >= 20\r\n                          ? \"bg-green-100 text-green-800\"\r\n                          : d.profitMargin >= 10\r\n                          ? \"bg-yellow-100 text-yellow-800\"\r\n                          : \"bg-red-100 text-red-800\"\r\n                      }`}\r\n                    >\r\n                      {d.profitMargin.toFixed(2)}%\r\n                    </span>\r\n                  </td>\r\n                  {groupBy === \"product\" && (\r\n                    <>\r\n                      <td className=\"p-3 text-right\">\r\n                        {d.averagePrice?.toLocaleString() || \"N/A\"}\r\n                      </td>\r\n                      <td className=\"p-3 text-right\">\r\n                        {d.averageCost?.toLocaleString() || \"N/A\"}\r\n                      </td>\r\n                    </>\r\n                  )}\r\n                </tr>\r\n              ))\r\n            )}\r\n          </tbody>\r\n        </table>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\dashboard\\reports\\sales\\page.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadReport'. Either include it or remove the dependency array.","line":60,"column":38,"nodeType":"ArrayExpression","endLine":60,"endColumn":40,"suggestions":[{"desc":"Update the dependencies array to be: [loadReport]","fix":{"range":[1667,1669],"text":"[loadReport]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { useEffect, useState } from \"react\";\nimport { getCurrentUser } from \"@/lib/auth\";\nimport { exportToCSV } from \"@/lib/export\";\n\ntype Account = { id: string; name: string };\ntype Row = {\n  date: string;\n  invoiceNo: string;\n  customer: string;\n  item: string;\n  qty: number;\n  rate: number;\n  amount: number;\n};\n\nexport default function SalesReportPage() {\n  const today = new Date().toISOString().slice(0, 10);\n  const [customers, setCustomers] = useState<Account[]>([]);\n  const [customerId, setCustomerId] = useState(\"\");\n  const [from, setFrom] = useState(\"2026-01-01\");\n  const [to, setTo] = useState(today);\n  const [rows, setRows] = useState<Row[]>([]);\n  const [loading, setLoading] = useState(false);\n\n  useEffect(() => {\n    const user = getCurrentUser();\n    if (!user) return;\n    fetch(\"/api/accounts\", { headers: { \"x-user-role\": user.role } })\n      .then(r => r.json())\n      .then(d => setCustomers((Array.isArray(d) ? d : []).filter((a: Any) => a.partyType === \"CUSTOMER\")))\n      .catch(err => console.error(\"Customer fetch error:\", err));\n  }, []);\n\n  async function loadReport() {\n    setLoading(true);\n    const user = getCurrentUser();\n    \n    const qs = new URLSearchParams({\n      from,\n      to,\n      ...(customerId && { customerId }),\n    });\n\n    try {\n      const res = await fetch(`/api/reports/sales?${qs}`, {\n        headers: { \"x-user-role\": user?.role || \"ADMIN\" }\n      });\n      const data = await res.json();\n      setRows(Array.isArray(data) ? data : []);\n    } catch (e) {\n      console.error(e);\n      setRows([]);\n    } finally {\n      setLoading(false);\n    }\n  }\n\n  useEffect(() => { loadReport(); }, []);\n\n  // 📊 CALCULATE TOTALS\n  const totalQty = rows.reduce((s, r) => s + (Number(r.qty) || 0), 0);\n  const totalAmount = rows.reduce((s, r) => s + (Number(r.amount) || 0), 0);\n\n  return (\n    <div className=\"p-6 space-y-6 max-w-7xl mx-auto font-bold\">\n      <h1 className=\"text-3xl font-black uppercase italic border-b-4 border-black pb-2\">Sales Report</h1>\n\n      {/* FILTER BAR */}\n      <div className=\"flex gap-4 flex-wrap items-end bg-white p-4 border-2 border-black shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] print:hidden\">\n        <div className=\"flex flex-col gap-1\">\n          <label className=\"text-xs uppercase\">Customer</label>\n          <select className=\"border-2 border-black px-3 py-2 outline-none w-48\" value={customerId} onChange={e => setCustomerId(e.target.value)}>\n            <option value=\"\">All Customers</option>\n            {customers.map(c => (<option key={c.id} value={c.id}>{c.name}</option>))}\n          </select>\n        </div>\n        <div className=\"flex flex-col gap-1\">\n          <label className=\"text-xs uppercase\">From</label>\n          <input type=\"date\" className=\"border-2 border-black px-3 py-2 outline-none\" value={from} onChange={e => setFrom(e.target.value)} />\n        </div>\n        <div className=\"flex flex-col gap-1\">\n          <label className=\"text-xs uppercase\">To</label>\n          <input type=\"date\" className=\"border-2 border-black px-3 py-2 outline-none\" value={to} onChange={e => setTo(e.target.value)} />\n        </div>\n        <button onClick={loadReport} className=\"bg-black text-white px-8 py-2.5 font-black uppercase hover:bg-gray-800 transition-all\">\n          {loading ? \"Loading...\" : \"Show Report\"}\n        </button>\n        {rows.length > 0 && (\n          <button \n            onClick={() => exportToCSV(rows, \"sales-report\")} \n            className=\"bg-green-600 text-white px-6 py-2.5 font-black uppercase hover:bg-green-700 transition-all\"\n          >\n            📥 Export CSV\n          </button>\n        )}\n      </div>\n\n      {/* TABLE */}\n      <div className=\"border-2 border-black bg-white overflow-hidden shadow-[8px_8px_0px_0px_rgba(0,0,0,1)]\">\n        <table className=\"w-full text-sm border-collapse\">\n          <thead className=\"bg-black text-white\">\n            <tr>\n              <th className=\"p-3 text-left border-r border-gray-700\">DATE</th>\n              <th className=\"p-3 text-left border-r border-gray-700\">INVOICE</th>\n              <th className=\"p-3 text-left border-r border-gray-700\">CUSTOMER</th>\n              <th className=\"p-3 text-left border-r border-gray-700\">ITEM</th>\n              <th className=\"p-3 text-right border-r border-gray-700 w-24\">QTY</th>\n              <th className=\"p-3 text-right border-r border-gray-700 w-32\">RATE</th>\n              <th className=\"p-3 text-right w-40\">AMOUNT</th>\n            </tr>\n          </thead>\n\n          <tbody className=\"divide-y-2 divide-black uppercase\">\n            {loading ? (\n              <tr><td colSpan={7} className=\"p-10 text-center animate-pulse\">Fetching Data...</td></tr>\n            ) : rows.length === 0 ? (\n              <tr><td colSpan={7} className=\"p-10 text-center text-gray-400 italic\">No Sales Data Found</td></tr>\n            ) : (\n              rows.map((r, i) => (\n                <tr key={i} className=\"hover:bg-yellow-50\">\n                  <td className=\"p-3 border-r-2 border-black\">{r.date}</td>\n                  <td className=\"p-3 border-r-2 border-black\">#{r.invoiceNo}</td>\n                  <td className=\"p-3 border-r-2 border-black text-blue-900\">{r.customer}</td>\n                  <td className=\"p-3 border-r-2 border-black\">{r.item}</td>\n                  <td className=\"p-3 border-r-2 border-black text-right\">{(r.qty || 0).toLocaleString()}</td>\n                  <td className=\"p-3 border-r-2 border-black text-right\">{(r.rate || 0).toLocaleString()}</td>\n                  <td className=\"p-3 text-right font-black bg-gray-50\">{(r.amount || 0).toLocaleString()}</td>\n                </tr>\n              ))\n            )}\n          </tbody>\n\n          {/* 📊 FOOTER WITH QTY AND AMOUNT TOTAL */}\n          {rows.length > 0 && (\n            <tfoot className=\"bg-black text-white font-black\">\n              <tr>\n                <td colSpan={4} className=\"p-4 text-right uppercase tracking-widest border-r border-gray-800\">Grand Total</td>\n                <td className=\"p-4 text-right text-lg border-r border-gray-800 bg-gray-900\">\n                  {totalQty.toLocaleString()}\n                </td>\n                <td className=\"p-4 border-r border-gray-800 bg-gray-900\"></td>\n                <td className=\"p-4 text-right text-xl bg-gray-900\">\n                  {totalAmount.toLocaleString()}\n                </td>\n              </tr>\n            </tfoot>\n          )}\n        </table>\n      </div>\n    </div>\n  );\n}","usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\dashboard\\reports\\stock-ledger\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\dashboard\\reports\\stock\\location\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\dashboard\\reports\\stock\\low\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\dashboard\\reports\\stock\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\dashboard\\reports\\tax-summary\\page.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadReport'. Either include it or remove the dependency array.","line":30,"column":6,"nodeType":"ArrayExpression","endLine":30,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [loadReport]","fix":{"range":[800,802],"text":"[loadReport]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useEffect, useState } from \"react\";\r\nimport { getCurrentUser } from \"@/lib/auth\";\r\nimport { exportToCSV } from \"@/lib/export\";\r\nimport { exportToPDF } from \"@/lib/pdf-export\";\r\n\r\ntype TaxSummary = {\r\n  taxType: string;\r\n  taxCode: string;\r\n  taxRate: number;\r\n  invoiceCount: number;\r\n  totalSubtotal: number;\r\n  totalTaxAmount: number;\r\n  totalAmount: number;\r\n  averageTaxRate: number;\r\n};\r\n\r\nexport default function TaxSummaryPage() {\r\n  const today = new Date().toISOString().slice(0, 10);\r\n  const [from, setFrom] = useState(\"2026-01-01\");\r\n  const [to, setTo] = useState(today);\r\n  const [data, setData] = useState<TaxSummary[]>([]);\r\n  const [loading, setLoading] = useState(false);\r\n\r\n  const user = getCurrentUser();\r\n\r\n  useEffect(() => {\r\n    loadReport();\r\n  }, []);\r\n\r\n  async function loadReport() {\r\n    setLoading(true);\r\n    try {\r\n      const res = await fetch(\r\n        `/api/reports/tax-summary?from=${from}&to=${to}`,\r\n        {\r\n          headers: { \"x-user-role\": user?.role || \"ADMIN\" },\r\n        }\r\n      );\r\n      const result = await res.json();\r\n      if (Array.isArray(result)) {\r\n        setData(result);\r\n      }\r\n    } catch (e) {\r\n      console.error(e);\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  }\r\n\r\n  const totalTax = data.reduce((sum, d) => sum + d.totalTaxAmount, 0);\r\n  const totalAmount = data.reduce((sum, d) => sum + d.totalAmount, 0);\r\n\r\n  return (\r\n    <div className=\"p-6 space-y-6\">\r\n      <h1 className=\"text-2xl font-bold\">Tax Summary Report</h1>\r\n\r\n      <div className=\"flex gap-4 items-end bg-white p-4 border rounded\">\r\n        <div>\r\n          <label className=\"block text-sm font-bold mb-1\">From</label>\r\n          <input\r\n            type=\"date\"\r\n            className=\"border p-2 rounded\"\r\n            value={from}\r\n            onChange={(e) => setFrom(e.target.value)}\r\n          />\r\n        </div>\r\n        <div>\r\n          <label className=\"block text-sm font-bold mb-1\">To</label>\r\n          <input\r\n            type=\"date\"\r\n            className=\"border p-2 rounded\"\r\n            value={to}\r\n            onChange={(e) => setTo(e.target.value)}\r\n          />\r\n        </div>\r\n        <button\r\n          onClick={loadReport}\r\n          className=\"bg-blue-600 text-white px-6 py-2 rounded\"\r\n        >\r\n          {loading ? \"Loading...\" : \"Load Report\"}\r\n        </button>\r\n        {data.length > 0 && (\r\n          <>\r\n            <button\r\n              onClick={() => exportToCSV(data, \"tax-summary\")}\r\n              className=\"bg-green-600 text-white px-6 py-2 rounded\"\r\n            >\r\n              Export CSV\r\n            </button>\r\n            <button\r\n              onClick={() =>\r\n                exportToPDF(\r\n                  data,\r\n                  \"Tax Summary Report\",\r\n                  Object.keys(data[0] || {})\r\n                )\r\n              }\r\n              className=\"bg-red-600 text-white px-6 py-2 rounded\"\r\n            >\r\n              Export PDF\r\n            </button>\r\n          </>\r\n        )}\r\n      </div>\r\n\r\n      {data.length > 0 && (\r\n        <div className=\"bg-white border rounded p-4\">\r\n          <div className=\"grid grid-cols-3 gap-4 mb-4\">\r\n            <div className=\"bg-blue-50 p-4 rounded\">\r\n              <p className=\"text-sm text-gray-600\">Total Tax Amount</p>\r\n              <p className=\"text-2xl font-bold\">{totalTax.toLocaleString()}</p>\r\n            </div>\r\n            <div className=\"bg-green-50 p-4 rounded\">\r\n              <p className=\"text-sm text-gray-600\">Total Amount</p>\r\n              <p className=\"text-2xl font-bold\">\r\n                {totalAmount.toLocaleString()}\r\n              </p>\r\n            </div>\r\n            <div className=\"bg-yellow-50 p-4 rounded\">\r\n              <p className=\"text-sm text-gray-600\">Tax Types</p>\r\n              <p className=\"text-2xl font-bold\">{data.length}</p>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      )}\r\n\r\n      <div className=\"bg-white border rounded overflow-hidden\">\r\n        <table className=\"w-full text-sm\">\r\n          <thead className=\"bg-gray-100\">\r\n            <tr>\r\n              <th className=\"p-3 text-left\">Tax Type</th>\r\n              <th className=\"p-3 text-left\">Tax Code</th>\r\n              <th className=\"p-3 text-right\">Tax Rate (%)</th>\r\n              <th className=\"p-3 text-right\">Invoices</th>\r\n              <th className=\"p-3 text-right\">Subtotal</th>\r\n              <th className=\"p-3 text-right\">Tax Amount</th>\r\n              <th className=\"p-3 text-right\">Total Amount</th>\r\n            </tr>\r\n          </thead>\r\n          <tbody>\r\n            {loading ? (\r\n              <tr>\r\n                <td colSpan={7} className=\"p-4 text-center\">\r\n                  Loading...\r\n                </td>\r\n              </tr>\r\n            ) : data.length === 0 ? (\r\n              <tr>\r\n                <td colSpan={7} className=\"p-4 text-center text-gray-400\">\r\n                  No tax data found\r\n                </td>\r\n              </tr>\r\n            ) : (\r\n              data.map((d, i) => (\r\n                <tr key={i} className=\"border-t\">\r\n                  <td className=\"p-3 font-bold\">{d.taxType}</td>\r\n                  <td className=\"p-3\">{d.taxCode}</td>\r\n                  <td className=\"p-3 text-right\">{d.taxRate}%</td>\r\n                  <td className=\"p-3 text-right\">{d.invoiceCount}</td>\r\n                  <td className=\"p-3 text-right\">\r\n                    {d.totalSubtotal.toLocaleString()}\r\n                  </td>\r\n                  <td className=\"p-3 text-right font-bold\">\r\n                    {d.totalTaxAmount.toLocaleString()}\r\n                  </td>\r\n                  <td className=\"p-3 text-right\">\r\n                    {d.totalAmount.toLocaleString()}\r\n                  </td>\r\n                </tr>\r\n              ))\r\n            )}\r\n          </tbody>\r\n        </table>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\dashboard\\reports\\trial-balance\\page.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadReport'. Either include it or remove the dependency array.","line":30,"column":38,"nodeType":"ArrayExpression","endLine":30,"endColumn":40,"suggestions":[{"desc":"Update the dependencies array to be: [loadReport]","fix":{"range":[994,996],"text":"[loadReport]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\nimport { useEffect, useState } from \"react\";\nimport { getCurrentUser } from \"@/lib/auth\";\n\nexport default function CategorizedTrialBalance() {\n   const today = new Date().toISOString().slice(0, 10);\n  const [rows, setRows] = useState<Any[]>([]);\n  const [_totals, setTotals] = useState<Any>(null);\n  const [loading, setLoading] = useState(false);\n  const [sendingEmail, setSendingEmail] = useState(false);\n\n  const [fromDate, setFromDate] = useState(\"2026-01-01\");\n    const [toDate, setToDate] = useState(today);\n  const loadReport = async () => {\n    setLoading(true);\n    try {\n      const user = getCurrentUser();\n      const res = await fetch(\n        `/api/reports/trial-balance?from=${fromDate}&to=${toDate}`,\n        { headers: { \"x-user-role\": user?.role || \"\" } }\n      );\n      const data = await res.json();\n      setRows(data.rows || []);\n      setTotals(data.totals || null);\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  useEffect(() => { loadReport(); }, []);\n\n  const categories = Array.from(new Set(rows.map(r => r.category)));\n\n  /* ================= GRAND TOTAL CALCULATION (All Columns) ================= */\n  const grand = rows.reduce(\n    (a, r) => ({\n      opD: a.opD + (r.opDebit || 0),\n      opC: a.opC + (r.opCredit || 0),\n      trD: a.trD + (r.transDebit || 0),\n      trC: a.trC + (r.transCredit || 0),\n      clD: a.clD + (r.clDebit || 0),\n      clC: a.clC + (r.clCredit || 0),\n    }),\n    { opD: 0, opC: 0, trD: 0, trC: 0, clD: 0, clC: 0 }\n  );\n\n  const difference = grand.clD - grand.clC;\n\n  return (\n    <div className=\"max-w-[1200px] mx-auto p-4 font-sans text-[11px] bg-white\">\n\n      {/* SEARCH FILTERS */}\n      <div className=\"flex flex-col sm:flex-row flex-wrap gap-4 mb-6 print:hidden border-b pb-4\">\n        <input type=\"date\" value={fromDate} onChange={e => setFromDate(e.target.value)} className=\"border p-1.5\" />\n        <input type=\"date\" value={toDate} onChange={e => setToDate(e.target.value)} className=\"border p-1.5\" />\n        <button onClick={loadReport} className=\"bg-black text-white px-6 py-1.5 font-bold uppercase\">Generate</button>\n        <button onClick={() => window.print()} className=\"bg-blue-600 text-white px-4 py-1.5 font-bold uppercase text-xs\">Print</button>\n        <button\n          onClick={async () => {\n            const email = window.prompt(\"Report email kis address par bhejni hai?\");\n            if (!email || !email.includes(\"@\")) return;\n            setSendingEmail(true);\n            try {\n              const user = getCurrentUser();\n              const res = await fetch(\"/api/email/send\", {\n                method: \"POST\",\n                headers: {\n                  \"Content-Type\": \"application/json\",\n                  \"x-user-role\": user?.role || \"\",\n                  \"x-user-id\": user?.id || \"\",\n                },\n                body: JSON.stringify({\n                  type: \"custom\",\n                  to: email,\n                  subject: `Trial Balance ${fromDate} to ${toDate}`,\n                  message: \"Trial Balance report attached from US TRADERS system.\",\n                }),\n              });\n              const data = await res.json();\n              if (res.ok) {\n                alert(\"Email bhej di gayi hai\");\n              } else {\n                alert(data.error || \"Email send nahi ho saki\");\n              }\n            } catch (_e) {\n              alert(\"Email send karte waqt error aayi\");\n            } finally {\n              setSendingEmail(false);\n            }\n          }}\n          disabled={sendingEmail}\n          className=\"bg-green-600 text-white px-4 py-1.5 font-bold uppercase text-xs disabled:bg-gray-400\"\n        >\n          {sendingEmail ? \"Sending...\" : \"Email\"}\n        </button>\n      </div>\n\n      {loading ? (\n        <div className=\"p-20 text-center font-bold uppercase tracking-widest\">Loading Report...</div>\n      ) : (\n        <div className=\"space-y-8\">\n          {/* HEADER */}\n          <div className=\"text-center\">\n            <h1 className=\"text-2xl font-black\">US TRADERS</h1>\n            <h2 className=\"text-sm font-bold border-b-2 border-black inline-block px-10 pb-1 italic\">TRIAL BALANCE</h2>\n          </div>\n\n          {categories.map(cat => {\n            const list = rows.filter(r => r.category === cat);\n            return (\n              <div key={cat} className=\"border border-gray-300 overflow-x-auto\">\n                <div className=\"bg-gray-100 p-1.5 px-3 font-black text-blue-900 border-b border-gray-300 uppercase italic min-w-[800px]\">\n                  {cat}\n                </div>\n                <table className=\"w-full min-w-[800px]\">\n                  <thead>\n                    <tr className=\"bg-gray-50 text-[10px] uppercase font-bold border-b border-gray-300\">\n                      <th className=\"p-1 text-left w-20\">Code</th>\n                      <th className=\"p-1 text-left\">Description</th>\n                      <th className=\"p-1 text-right w-24\">Op Dr</th>\n                      <th className=\"p-1 text-right w-24\">Op Cr</th>\n                      <th className=\"p-1 text-right w-24\">Tr Dr</th>\n                      <th className=\"p-1 text-right w-24\">Tr Cr</th>\n                      <th className=\"p-1 text-right w-24 bg-gray-50\">Cl Dr</th>\n                      <th className=\"p-1 text-right w-24 bg-gray-50\">Cl Cr</th>\n                    </tr>\n                  </thead>\n                  <tbody>\n                    {list.map((r, i) => (\n                      <tr key={i} className=\"border-b border-gray-100 hover:bg-yellow-50\">\n                        <td className=\"p-1 text-gray-500\">{r.code}</td>\n                        <td className=\"p-1 font-bold uppercase\">{r.name}</td>\n                        <td className=\"p-1 text-right\">{r.opDebit?.toLocaleString() || \"0\"}</td>\n                        <td className=\"p-1 text-right\">{r.opCredit?.toLocaleString() || \"0\"}</td>\n                        <td className=\"p-1 text-right\">{r.transDebit?.toLocaleString() || \"0\"}</td>\n                        <td className=\"p-1 text-right\">{r.transCredit?.toLocaleString() || \"0\"}</td>\n                        <td className=\"p-1 text-right font-bold italic\">{r.clDebit?.toLocaleString() || \"0\"}</td>\n                        <td className=\"p-1 text-right font-bold italic\">{r.clCredit?.toLocaleString() || \"0\"}</td>\n                      </tr>\n                    ))}\n                  </tbody>\n                </table>\n              </div>\n            );\n          })}\n\n          {/* 🏁 FINAL TOTAL (ALL COLUMNS) */}\n          <div className=\"mt-10 overflow-x-auto\">\n            <div className=\"bg-black text-white p-2 font-black uppercase tracking-tighter italic min-w-[800px]\">\n              Grand Report Summary (Consolidated)\n            </div>\n            <table className=\"w-full border-2 border-black min-w-[800px]\">\n              <thead className=\"bg-gray-200 font-black text-[10px] uppercase border-b-2 border-black\">\n                <tr>\n                  <th className=\"p-2 text-left\">Total Summary</th>\n                  <th className=\"p-2 text-right w-24\">Op Dr</th>\n                  <th className=\"p-2 text-right w-24\">Op Cr</th>\n                  <th className=\"p-2 text-right w-24\">Tr Dr</th>\n                  <th className=\"p-2 text-right w-24\">Tr Cr</th>\n                  <th className=\"p-2 text-right w-24 bg-yellow-100 text-black\">Cl Dr</th>\n                  <th className=\"p-2 text-right w-24 bg-yellow-100 text-black\">Cl Cr</th>\n                </tr>\n              </thead>\n              <tbody>\n                <tr className=\"font-black text-[13px] bg-white\">\n                  <td className=\"p-3 italic uppercase\">Final Grand Totals:</td>\n                  <td className=\"p-3 text-right\">{grand.opD.toLocaleString()}</td>\n                  <td className=\"p-3 text-right\">{grand.opC.toLocaleString()}</td>\n                  <td className=\"p-3 text-right text-blue-700\">{grand.trD.toLocaleString()}</td>\n                  <td className=\"p-3 text-right text-blue-700\">{grand.trC.toLocaleString()}</td>\n                  <td className=\"p-3 text-right bg-yellow-50\">{grand.clD.toLocaleString()}</td>\n                  <td className=\"p-3 text-right bg-yellow-50\">{grand.clC.toLocaleString()}</td>\n                </tr>\n              </tbody>\n            </table>\n\n            {/* Difference Section */}\n            <div className=\"flex justify-between items-center mt-4 border-t-2 border-black pt-2\">\n              <div className=\"text-[10px] font-bold uppercase text-gray-400 italic\">\n                Verified by: US TRADERS Accounting System\n              </div>\n              <div className=\"text-right\">\n                <span className=\"text-sm font-bold uppercase mr-4\">Final Difference:</span>\n                <span className={`text-2xl font-black italic ${difference === 0 ? \"text-green-600\" : \"text-red-600\"}`}>\n                  {Math.abs(difference).toLocaleString()} PKR\n                </span>\n              </div>\n            </div>\n          </div>\n        </div>\n      )}\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\dashboard\\reports\\year-end\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\dashboard\\roles-permissions\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\dashboard\\sale-return\\page.tsx","messages":[],"suppressedMessages":[{"ruleId":"react-hooks/set-state-in-effect","severity":1,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nD:\\projects\\smart-business-accounts\\app\\dashboard\\sale-return\\page.tsx:160:5\n  158 |   /* eslint-disable react-hooks/set-state-in-effect */\n  159 |   useEffect(() => {\n> 160 |     loadReturns();\n      |     ^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  161 |     const user = getCurrentUser();\n  162 |     if (!user) {\n  163 |       alert(\"Session expired. Please login again.\");","line":160,"column":5,"nodeType":null,"endLine":160,"endColumn":16,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\dashboard\\sales-invoice\\page.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'loadInvoices' and 'user'. Either include them or remove the dependency array.","line":168,"column":6,"nodeType":"ArrayExpression","endLine":168,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [loadInvoices, user]","fix":{"range":[5408,5410],"text":"[loadInvoices, user]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'invoiceNo'. Either include it or remove the dependency array. You can also do a functional update 'setInvoiceNo(i => ...)' if you only need 'invoiceNo' in the 'setInvoiceNo' call.","line":190,"column":6,"nodeType":"ArrayExpression","endLine":190,"endColumn":21,"suggestions":[{"desc":"Update the dependencies array to be: [invoiceNo, queryId, user]","fix":{"range":[6042,6057],"text":"[invoiceNo, queryId, user]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { Suspense, useEffect, useRef as _useRef, useState } from \"react\";\nimport { useSearchParams } from \"next/navigation\";\nimport toast from \"react-hot-toast\";\nimport dynamic from \"next/dynamic\";\nimport { getCurrentUser } from \"@/lib/auth\";\n\nconst Barcode = dynamic(() => import(\"react-barcode\"), { \n  ssr: false,\n  loading: () => <p>Loading Barcode...</p>\n});\nimport { QRCodeSVG } from \"qrcode.react\";\nimport { hasPermission } from \"@/lib/hasPermission\";\nimport { PERMISSIONS } from \"@/lib/permissions\";\n\ntype Account = { id: string; name: string };\ntype Item = {\n  id: string;\n  name: string;\n  description?: string;\n  availableQty: number;\n  barcode?: string;\n};\ntype Row = {\n  itemId: string;\n  name: string;\n  description: string;\n  availableQty: number;\n  qty: number | \"\";\n  rate: number | \"\";\n};\n\ntype SalesInvoice = {\n  id: string;\n  invoiceNo: string;\n  date: string;\n  customerId: string;\n  customer?: { name: string };\n  total: number;\n  items: Array<{ item: { name: string; description?: string }; qty: number; rate: number }>;\n  driverName?: string;\n  vehicleNo?: string;\n};\n\ntype TaxConfig = {\n  id: string;\n  taxType: string;\n  taxCode: string;\n  taxRate: number;\n  description?: string;\n};\n\nfunction SalesInvoiceContent() {\n  const searchParams = useSearchParams();\n  const queryId = searchParams.get(\"id\");\n  const today = new Date().toISOString().slice(0, 10);\n  const user = getCurrentUser();\n  const canCreate = hasPermission(user, PERMISSIONS.CREATE_SALES_INVOICE);\n\n  const [customers, setCustomers] = useState<Account[]>([]);\n  const [items, setItems] = useState<Item[]>([]);\n  const [invoices, setInvoices] = useState<SalesInvoice[]>([]);\n  const [showList, setShowList] = useState(false);\n  const [showForm, setShowForm] = useState(true);\n  const [editing, setEditing] = useState<SalesInvoice | null>(null);\n\n  const [invoiceNo, setInvoiceNo] = useState(\"\");\n  const [customerId, setCustomerId] = useState(\"\");\n  const [customerName, setCustomerName] = useState(\"\");\n  const [date, setDate] = useState(today);\n  const [location, setLocation] = useState(\"MAIN\");\n  const [driverName, setDriverName] = useState(\"\");\n  const [vehicleNo, setVehicleNo] = useState(\"\");\n  const [rows, setRows] = useState<Row[]>([{\n    itemId: \"\", name: \"\", description: \"\", availableQty: 0, qty: \"\", rate: \"\",\n  }]);\n  const [freight, setFreight] = useState<number | \"\">(\"\");\n  const [saving, setSaving] = useState(false);\n  const [preview, setPreview] = useState(false);\n  const [savedInvoice, setSavedInvoice] = useState<Any>(null);\n  const [sendingEmail, setSendingEmail] = useState(false);\n  const [previewMode, setPreviewMode] = useState<\"INVOICE\" | \"DELIVERY\">(\"INVOICE\");\n  const [searchTerm, _setSearchTerm] = useState(\"\");\n  const [scanCode, setScanCode] = useState(\"\");\n  const [origin, setOrigin] = useState(\"\");\n\n  useEffect(() => {\n    setOrigin(window.location.origin);\n  }, []);\n\n  // Tax states\n  const [applyTax, setApplyTax] = useState(false);\n  const [selectedTaxId, setSelectedTaxId] = useState(\"\");\n  const [taxes, setTaxes] = useState<TaxConfig[]>([]);\n\n  // Keyboard shortcuts - F7: Clear date/customer, F8: Query dialog\n  useEffect(() => {\n    function handleKeyPress(e: KeyboardEvent) {\n      if (e.code === \"F7\" || e.key === \"F7\") {\n        e.preventDefault();\n        e.stopPropagation();\n        if (showForm && !preview) {\n          setDate(today);\n          setCustomerId(\"\");\n          setCustomerName(\"\");\n        }\n      }\n      if (e.code === \"F8\" || e.key === \"F8\") {\n        e.preventDefault();\n        e.stopPropagation();\n        if (showForm && !preview) {\n          const query = prompt(\"Enter search query (Invoice No, Customer Name, etc.):\");\n          if (query) {\n            const foundCustomer = customers.find(c =>\n              c.name.toLowerCase().includes(query.toLowerCase())\n            );\n            if (foundCustomer) {\n              setCustomerId(foundCustomer.id);\n              setCustomerName(foundCustomer.name);\n            } else {\n              toast.error(`No customer found matching \"${query}\"`);\n            }\n          }\n        }\n      }\n    }\n    document.addEventListener(\"keydown\", handleKeyPress, true);\n    return () => document.removeEventListener(\"keydown\", handleKeyPress, true);\n  }, [today, showForm, preview, customers]);\n\n  useEffect(() => {\n    if (!user || !user.id) return;\n    loadInvoices();\n    fetch(\"/api/accounts\", {\n      headers: { \"x-user-role\": user.role },\n    })\n      .then(r => r.json())\n      .then(d => {\n        const list = Array.isArray(d) ? d : d.accounts || [];\n        setCustomers(list.filter((a: Any) => a.partyType === \"CUSTOMER\"));\n      });\n\n    fetch(\"/api/stock-available-for-sale\")\n      .then(r => r.json())\n      .then(d => setItems(Array.isArray(d) ? d : []));\n\n    // Load tax configurations\n    fetch(\"/api/tax-configuration\")\n      .then(r => r.json())\n      .then(d => setTaxes(Array.isArray(d) ? d : []))\n      .catch(err => console.log(\"Tax config error:\", err));\n\n    fetch(\"/api/sales-invoice\", {\n      headers: {\n        \"x-user-role\": user.role || \"\",\n        \"x-user-id\": user.id || \"\"\n      }\n    })\n      .then(r => {\n        if (r.status === 403) throw new Error(\"No Permission\");\n        return r.json();\n      })\n      .then(d => {\n        if (d?.nextNo) setInvoiceNo(d.nextNo);\n      })\n      .catch (_err => console.log(\"Access Denied or Error\"));\n  }, []);\n\n  useEffect(() => {\n    if (!queryId || !user) return;\n    fetch(`/api/sales-invoice?id=${queryId}`, {\n      headers: {\n        \"x-user-role\": user.role || \"\",\n        \"x-user-id\": user.id || \"\"\n      }\n    })\n      .then(r => r.json())\n      .then(inv => {\n        if (inv && !inv.error) {\n          setSavedInvoice(inv);\n          setInvoiceNo(inv.invoiceNo || invoiceNo);\n          setCustomerName(inv.customer?.name || inv.customerName || \"\");\n          setPreview(true);\n          setShowForm(true);\n          setShowList(false);\n        }\n      })\n      .catch(e => console.error(\"Error loading sales invoice:\", e));\n  }, [queryId, user]);\n\n  async function loadInvoices() {\n    try {\n      const res = await fetch(\"/api/sales-invoice\", {\n        headers: {\n          \"x-user-role\": user?.role || \"\",\n          \"x-user-id\": user?.id || \"\"\n        }\n      });\n      const data = await res.json();\n      if (data?.invoices) {\n        setInvoices(data.invoices);\n      }\n    } catch (e) {\n      console.error(\"Load invoices error:\", e);\n    }\n  }\n\n  function handleScan(e: React.KeyboardEvent<HTMLInputElement>) {\n    if (e.key === \"Enter\") {\n      e.preventDefault(); // Prevent form submission\n      if (!scanCode) return;\n\n      const found = items.find(\n        (i) => i.barcode === scanCode || i.id === scanCode // Fallback to ID if needed\n      );\n\n      if (found) {\n        // Add to rows\n        const newRow: Row = {\n          itemId: found.id,\n          name: found.name,\n          description: found.description || \"\",\n          availableQty: found.availableQty,\n          qty: 1,\n          rate: \"\", // or fetch default rate if available\n        };\n\n        // If the last row is empty, replace it. Otherwise append.\n        const lastRow = rows[rows.length - 1];\n        if (!lastRow.itemId) {\n          const newRows = [...rows];\n          newRows[rows.length - 1] = newRow;\n          setRows(newRows);\n        } else {\n          setRows([...rows, newRow]);\n        }\n\n        toast.success(`Added ${found.name}`);\n        setScanCode(\"\");\n      } else {\n        toast.error(\"Item not found\");\n        setScanCode(\"\");\n      }\n    }\n  }\n\n  function addRow() {\n    setRows(r => [\n      ...r,\n      { itemId: \"\", name: \"\", description: \"\", availableQty: 0, qty: \"\", rate: \"\" },\n    ]);\n  }\n\n  function selectItem(index: number, itemId: string) {\n    const item = items.find(i => i.id === itemId);\n    if (!item) return;\n    const copy = [...rows];\n    copy[index] = {\n      ...copy[index],\n      itemId: item.id,\n      name: item.name,\n      description: item.description || \"\",\n      availableQty: item.availableQty,\n      qty: \"\",\n    };\n    setRows(copy);\n  }\n\n  function updateRow(index: number, key: \"qty\" | \"rate\", val: string) {\n    const copy = [...rows];\n    const num = val === \"\" ? \"\" : Number(val);\n    if (key === \"qty\" && num !== \"\" && num > copy[index].availableQty) return;\n    copy[index][key] = num;\n    setRows(copy);\n  }\n\n  const total = rows.reduce((s, r) => s + (Number(r.qty) * Number(r.rate) || 0), 0);\n  const selectedTax = taxes.find(t => t.id === selectedTaxId);\n  const taxAmount = applyTax && selectedTax ? (total * (selectedTax.taxRate / 100)) : 0;\n  const netTotal = total + (freight === \"\" ? 0 : Number(freight)) + taxAmount;\n\n  const filteredInvoices = invoices.filter(inv => {\n    const term = searchTerm.toLowerCase();\n    return (\n      inv.invoiceNo.toLowerCase().includes(term) ||\n      (inv.customer?.name || \"\").toLowerCase().includes(term) ||\n      inv.total.toString().includes(term)\n    );\n  });\n\n  async function saveInvoice() {\n    const clean = rows.filter(r => r.itemId && r.qty && r.rate);\n    if (!customerId || !clean.length) {\n      toast.error(\"Customer aur items zaroori hain\");\n      return;\n    }\n\n    setSaving(true);\n    try {\n      const method = editing ? \"PUT\" : \"POST\";\n      const baseBody = {\n        invoiceNo,\n        customerId,\n        date,\n        location,\n        driverName,\n        vehicleNo,\n        freight: freight || 0,\n        items: clean.map(r => ({ itemId: r.itemId, qty: Number(r.qty), rate: Number(r.rate) })),\n        applyTax,\n        taxConfigId: applyTax ? selectedTaxId : null,\n      };\n      const body = editing ? { id: editing.id, ...baseBody } : baseBody;\n\n      const res = await fetch(\"/api/sales-invoice\", {\n        method,\n        credentials: \"include\",\n        headers: {\n          \"Content-Type\": \"application/json\",\n          \"x-user-role\": user?.role || \"\",\n          \"x-user-id\": user?.id || \"\"\n        },\n        body: JSON.stringify(body),\n      });\n\n      if (!res.ok) {\n        const errorData = await res.json();\n        throw new Error(errorData.error || \"Save failed\");\n      }\n\n      const data = await res.json();\n\n      if (data.invoice) {\n        setSavedInvoice(data.invoice);\n        setInvoiceNo(data.invoiceNo || invoiceNo);\n        setCustomerName(data.invoice.customer?.name || customerName);\n      }\n\n      setPreview(true);\n      await loadInvoices();\n      if (editing) {\n        setEditing(null);\n        setShowForm(false);\n        setShowList(true);\n      }\n      toast.success(\"Invoice saved successfully!\");\n    } catch (e: Any) {\n      toast.error(\"Saving failed: \" + (e.message || \"Unknown error\"));\n    } finally {\n      setSaving(false);\n    }\n  }\n\n  function startEdit(inv: SalesInvoice) {\n    setEditing(inv);\n    setInvoiceNo(inv.invoiceNo);\n    setCustomerId(inv.customerId);\n    setCustomerName(inv.customer?.name || \"\");\n    setDate(new Date(inv.date).toISOString().slice(0, 10));\n    setDriverName(inv.driverName || \"\");\n    setVehicleNo(inv.vehicleNo || \"\");\n    setRows(inv.items.map((it: Any) => ({\n      itemId: it.itemId || \"\",\n      name: it.item?.name || \"\",\n      description: it.item?.description || \"\",\n      availableQty: it.qty || 0,\n      qty: it.qty.toString(),\n      rate: it.rate.toString(),\n    })));\n    setShowForm(true);\n    setShowList(false);\n  }\n\n  async function deleteInvoice(id: string) {\n    if (!confirm(\"Are you sure you want to delete this invoice?\")) return;\n    try {\n      const res = await fetch(`/api/sales-invoice?id=${id}`, {\n        method: \"DELETE\",\n        headers: {\n          \"x-user-role\": user?.role || \"\",\n          \"x-user-id\": user?.id || \"\"\n        },\n      });\n      if (res.ok) {\n        toast.success(\"Invoice deleted successfully\");\n        await loadInvoices();\n      } else {\n        const err = await res.json();\n        toast.error(err.error || \"Delete failed\");\n      }\n    } catch (_e) {\n      toast.error(\"Delete failed\");\n    }\n  }\n\n  function resetForm() {\n    setEditing(null);\n    setCustomerId(\"\");\n    setCustomerName(\"\");\n    setDate(today);\n    setLocation(\"MAIN\");\n    setDriverName(\"\");\n    setVehicleNo(\"\");\n    setFreight(\"\");\n    setRows([{ itemId: \"\", name: \"\", description: \"\", availableQty: 0, qty: \"\", rate: \"\" }]);\n    setApplyTax(false);\n    setSelectedTaxId(\"\");\n    setPreview(false);\n  }\n\n  async function sendInvoiceEmail() {\n    if (!savedInvoice || !savedInvoice.id) {\n      alert(\"Please save the invoice first\");\n      return;\n    }\n\n    const customerEmail = prompt(\"Enter customer email address:\");\n    if (!customerEmail || !customerEmail.includes(\"@\")) {\n      alert(\"Please enter a valid email address\");\n      return;\n    }\n\n    setSendingEmail(true);\n    try {\n      const res = await fetch(\"/api/email/send\", {\n        method: \"POST\",\n        headers: {\n          \"Content-Type\": \"application/json\",\n          \"x-user-role\": user?.role || \"\",\n          \"x-user-id\": user?.id || \"\",\n        },\n        body: JSON.stringify({\n          type: \"sales-invoice\",\n          invoiceId: savedInvoice.id,\n          to: customerEmail,\n        }),\n      });\n\n      const data = await res.json();\n      if (res.ok) {\n        alert(\"✅ Email sent successfully!\");\n      } else {\n        alert(`❌ Failed to send email: ${data.error || \"Unknown error\"}`);\n      }\n    } catch (_error) {\n      alert(\"❌ Failed to send email. Please check email configuration.\");\n    } finally {\n      setSendingEmail(false);\n    }\n  }\n\n  const shareOnWhatsApp = () => {\n    if (!savedInvoice) {\n      toast.error(\"Please save the invoice first\");\n      return;\n    }\n\n    // Construct a message\n    let message = `*Sales Invoice: ${savedInvoice.invoiceNo}*\\n`;\n    message += `Date: ${new Date(savedInvoice.date).toLocaleDateString()}\\n`;\n    message += `Customer: ${customerName}\\n\\n`;\n    message += `*Items:*\\n`;\n\n    savedInvoice.items.forEach((item: Any, index: number) => {\n      message += `${index + 1}. ${item.item.name} x ${item.qty} @ ${item.rate} = ${(item.qty * item.rate).toLocaleString()}\\n`;\n    });\n\n    message += `\\n*Total Amount: ${savedInvoice.total.toLocaleString()}*`;\n\n    const url = `https://wa.me/?text=${encodeURIComponent(message)}`;\n    window.open(url, '_blank');\n  };\n\n  const _shareOnSMS = () => {\n    if (!savedInvoice) {\n      toast.error(\"Please save the invoice first\");\n      return;\n    }\n\n    // Construct a message (shorter for SMS)\n    let message = `Invoice: ${savedInvoice.invoiceNo}\\n`;\n    message += `Date: ${new Date(savedInvoice.date).toLocaleDateString()}\\n`;\n    message += `Customer: ${customerName}\\n`;\n    message += `Total: ${savedInvoice.total.toLocaleString()}`;\n\n    const url = `sms:?body=${encodeURIComponent(message)}`;\n    window.open(url, '_blank');\n  };\n\n  if (!canCreate) {\n    return <div>Access Denied</div>;\n  }\n\n  return (\n    <div className=\"p-6 space-y-6\">\n      <div className=\"flex justify-between items-center\">\n        <h1 className=\"text-2xl font-bold\">Sales Invoice</h1>\n        <div className=\"flex gap-2\">\n          <button\n            onClick={() => { setShowList(!showList); setShowForm(!showForm); setEditing(null); }}\n            className=\"bg-gray-600 text-white px-4 py-2 rounded\"\n          >\n            {showList ? \"Hide List\" : \"Show List\"}\n          </button>\n          <button\n            onClick={() => { setShowForm(true); setShowList(false); resetForm(); loadInvoices(); }}\n            className=\"bg-blue-600 text-white px-4 py-2 rounded\"\n          >\n            + New Invoice\n          </button>\n        </div>\n      </div>\n\n      {/* LIST VIEW */}\n      {showList && (\n        <div className=\"bg-white border rounded overflow-hidden\">\n          {/* <div className=\"p-4 border-b bg-gray-50\">\n            <input\n              type=\"text\"\n              placeholder=\"Search by Invoice No, Customer, Amount...\"\n              className=\"w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500\"\n              value={searchTerm}\n              onChange={(e) => setSearchTerm(e.target.value)}\n            />\n          </div> */}\n          <table className=\"w-full text-sm\">\n            <thead className=\"bg-gray-100\">\n              <tr>\n                <th className=\"p-3 text-left\">Invoice No</th>\n                <th className=\"p-3 text-left\">Date</th>\n                <th className=\"p-3 text-left\">Customer</th>\n                <th className=\"p-3 text-right\">Total</th>\n                <th className=\"p-3 text-center\">Actions</th>\n              </tr>\n            </thead>\n            <tbody>\n              {filteredInvoices.length === 0 ? (\n                <tr>\n                  <td colSpan={5} className=\"p-4 text-center text-gray-400\">No invoices found</td>\n                </tr>\n              ) : (\n                filteredInvoices.map(inv => (\n                  <tr key={inv.id} className=\"border-t hover:bg-gray-50\">\n                    <td className=\"p-3 font-bold\">{inv.invoiceNo}</td>\n                    <td className=\"p-3\">{new Date(inv.date).toLocaleDateString()}</td>\n                    <td className=\"p-3\">{inv.customer?.name || \"N/A\"}</td>\n                    <td className=\"p-3 text-right\">{inv.total.toLocaleString()}</td>\n                    <td className=\"p-3 text-center space-x-2\">\n                      <button\n                        onClick={() => startEdit(inv)}\n                        className=\"text-blue-600 hover:text-blue-800 font-medium text-sm\"\n                      >\n                        Edit\n                      </button>\n                      <button\n                        onClick={() => deleteInvoice(inv.id)}\n                        className=\"text-red-600 hover:text-red-800 font-medium text-sm\"\n                      >\n                        Delete\n                      </button>\n                    </td>\n                  </tr>\n                ))\n              )}\n            </tbody>\n          </table>\n        </div>\n      )}\n\n      {/* FORM */}\n      {showForm && (\n        <>\n          <div className=\"flex flex-col md:flex-row justify-between items-center bg-gray-50 p-4 border rounded print:hidden gap-4\">\n            <div>\n              <h1 className=\"text-2xl font-bold\">Sales Invoice ({invoiceNo})</h1>\n              {(invoiceNo && invoiceNo !== \"SI-1\") && (\n                 <div className=\"mt-1\">\n                   <Barcode value={invoiceNo} width={1} height={30} fontSize={12} displayValue={true} />\n                 </div>\n              )}\n            </div>\n            {!preview ? (\n              <div className=\"flex flex-wrap gap-2\">\n                <button onClick={saveInvoice} disabled={saving} className=\"bg-blue-600 text-white px-6 py-2 rounded flex-1 md:flex-none\">\n                  {saving ? \"Saving...\" : editing ? \"Update Invoice\" : \"Save & Preview\"}\n                </button>\n                <button onClick={() => { setShowForm(false); setEditing(null); resetForm(); }} className=\"bg-gray-600 text-white px-6 py-2 rounded flex-1 md:flex-none\">\n                  Cancel\n                </button>\n              </div>\n            ) : (\n              <div className=\"flex flex-wrap gap-2\">\n                <button onClick={() => window.print()} className=\"bg-green-600 text-white px-6 py-2 rounded flex-1 md:flex-none\">\n                  Print\n                </button>\n                <button\n                  onClick={() => setPreviewMode(prev => prev === \"INVOICE\" ? \"DELIVERY\" : \"INVOICE\")}\n                  className=\"bg-purple-600 text-white px-6 py-2 rounded flex-1 md:flex-none\"\n                >\n                  {previewMode === \"DELIVERY\" ? \"Show Rates\" : \"Hide Rates\"}\n                </button>\n                <button\n                  onClick={sendInvoiceEmail}\n                  disabled={sendingEmail}\n                  className=\"bg-blue-600 text-white px-6 py-2 rounded disabled:bg-gray-400 flex-1 md:flex-none\"\n                >\n                  {sendingEmail ? \"Sending...\" : \"📧 Email\"}\n                </button>\n                <button\n                  onClick={shareOnWhatsApp}\n                  className=\"bg-green-500 text-white px-6 py-2 rounded hover:bg-green-600 flex-1 md:flex-none\"\n                >\n                  📱 WhatsApp\n                </button>\n                <button onClick={() => setPreview(false)} className=\"bg-yellow-600 text-white px-6 py-2 rounded flex-1 md:flex-none\">\n                  Edit\n                </button>\n                <button onClick={() => { setPreview(false); resetForm(); }} className=\"bg-gray-600 text-white px-6 py-2 rounded flex-1 md:flex-none\">\n                  New Invoice\n                </button>\n              </div>\n            )}\n          </div>\n\n          {!preview && (\n            <div className=\"bg-white border p-6 rounded space-y-4\">\n              <div className=\"mb-2 text-xs text-gray-500 italic\">\n                💡 Keyboard Shortcuts: <strong>F7</strong> = Clear Date & Customer | <strong>F8</strong> = Search Query\n              </div>\n              <div className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4\">\n                <input value={invoiceNo} readOnly className=\"border p-2 bg-gray-100\" />\n                <div>\n                  <label className=\"text-xs font-bold\">Customer (F7: Clear, F8: Query)</label>\n                  <select className=\"border p-2 w-full\" value={customerId} onChange={e => {\n                    setCustomerId(e.target.value);\n                    setCustomerName(customers.find(c => c.id === e.target.value)?.name || \"\");\n                  }}>\n                    <option value=\"\">Select Customer</option>\n                    {customers.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}\n                  </select>\n                </div>\n                <div>\n                  <label className=\"text-xs font-bold\">Date (F7: Clear)</label>\n                  <input type=\"date\" className=\"border p-2 w-full\" value={date} onChange={e => setDate(e.target.value)} />\n                </div>\n                <div className=\"flex flex-col\">\n                  <label className=\"text-xs font-bold\">Location</label>\n                  <select className=\"border p-2\" value={location} onChange={e => setLocation(e.target.value)}>\n                    <option value=\"MAIN\">Main</option>\n                    <option value=\"SHOP\">Shop</option>\n                  </select>\n                </div>\n                <div className=\"flex flex-col\">\n                  <label className=\"text-xs font-bold\">Driver Name</label>\n                  <input type=\"text\" className=\"border p-2\" value={driverName} onChange={e => setDriverName(e.target.value)} placeholder=\"Driver Name\" />\n                </div>\n                <div className=\"flex flex-col\">\n                  <label className=\"text-xs font-bold\">Vehicle No</label>\n                  <input type=\"text\" className=\"border p-2\" value={vehicleNo} onChange={e => setVehicleNo(e.target.value)} placeholder=\"Vehicle No\" />\n                </div>\n              </div>\n\n              {/* 📟 BARCODE SCANNER SECTION */}\n              <div className=\"flex items-center gap-4 bg-blue-50 p-4 rounded border border-blue-200 shadow-sm\">\n                <span className=\"text-3xl\">📟</span>\n                <div className=\"flex-1\">\n                  <label className=\"text-xs font-bold text-blue-800 block mb-1\">SCAN BARCODE / SKU TO ADD ITEM</label>\n                  <input\n                    value={scanCode}\n                    onChange={(e) => setScanCode(e.target.value)}\n                    onKeyDown={handleScan}\n                    placeholder=\"Click here and scan barcode...\"\n                    className=\"border-2 border-blue-400 p-2 w-full rounded text-lg font-mono focus:ring-4 focus:ring-blue-200 outline-none transition-all\"\n                  />\n                </div>\n              </div>\n\n              <div className=\"overflow-x-auto\">\n                <table className=\"w-full border mt-4 text-sm min-w-[600px]\">\n                  <thead className=\"bg-gray-100\">\n                    <tr>\n                      <th className=\"border p-2 text-left\">Item</th>\n                      <th className=\"border p-2 w-24\">Qty</th>\n                      <th className=\"border p-2 w-32\">Rate</th>\n                      <th className=\"border p-2 w-32 text-right\">Amount</th>\n                    </tr>\n                  </thead>\n                  <tbody>\n                    {rows.map((r, i) => (\n                      <tr key={i}>\n                        <td className=\"border p-2\">\n                          <select className=\"w-full\" value={r.itemId} onChange={e => selectItem(i, e.target.value)}>\n                            <option value=\"\">Select Item</option>\n                            {items.map(it => (\n                              <option key={it.id} value={it.id}>\n                                {it.name} ({it.description}) — Stock {it.availableQty}\n                              </option>\n                            ))}\n                          </select>\n                        </td>\n                        <td className=\"border p-2\">\n                          <input type=\"number\" value={r.qty} className=\"w-full text-center\" onChange={e => updateRow(i, \"qty\", e.target.value)} />\n                        </td>\n                        <td className=\"border p-2\">\n                          <input type=\"number\" value={r.rate} className=\"w-full text-center\" onChange={e => updateRow(i, \"rate\", e.target.value)} />\n                        </td>\n                        <td className=\"border p-2 text-right\">\n                          {(Number(r.qty) * Number(r.rate) || 0).toLocaleString()}\n                        </td>\n                      </tr>\n                    ))}\n                  </tbody>\n                </table>\n              </div>\n              <button onClick={addRow} className=\"bg-gray-100 px-4 py-1 rounded\">+ Add Row</button>\n\n              <div className=\"flex justify-end pt-4\">\n                <div className=\"w-full md:w-64 space-y-2\">\n                  <div className=\"flex justify-between\"><span>Total</span><span>{total.toLocaleString()}</span></div>\n                  <div className=\"flex justify-between items-center\">\n                    <span>Freight</span>\n                    <input type=\"number\" value={freight} onChange={e => setFreight(e.target.value === \"\" ? \"\" : Number(e.target.value))} className=\"border w-32 text-right p-1\" />\n                  </div>\n\n                  {/* Tax Section */}\n                  <div className=\"border-t pt-2 space-y-2\">\n                    <button\n                      type=\"button\"\n                      onClick={() => {\n                        setApplyTax(!applyTax);\n                        if (!applyTax) setSelectedTaxId(\"\");\n                      }}\n                      className={`w-full py-1 px-2 rounded font-semibold text-sm ${applyTax ? \"bg-blue-600 text-white\" : \"bg-gray-200 text-gray-700\"\n                        }`}\n                    >\n                      {applyTax ? \"✓ Tax Applied\" : \"+ Add Tax\"}\n                    </button>\n\n                    {applyTax && (\n                      <div className=\"space-y-2\">\n                        <select\n                          value={selectedTaxId}\n                          onChange={e => setSelectedTaxId(e.target.value)}\n                          className=\"w-full border p-1 text-sm\"\n                        >\n                          <option value=\"\">Select Tax</option>\n                          {taxes.map(tax => (\n                            <option key={tax.id} value={tax.id}>\n                              {tax.taxType} ({tax.taxCode}) - {tax.taxRate}%\n                            </option>\n                          ))}\n                        </select>\n                        {selectedTax && (\n                          <div className=\"flex justify-between text-sm text-blue-600\">\n                            <span>{selectedTax.taxType} ({selectedTax.taxRate}%)</span>\n                            <span>{taxAmount.toLocaleString()}</span>\n                          </div>\n                        )}\n                      </div>\n                    )}\n                  </div>\n\n                  <div className=\"flex justify-between font-bold border-t pt-2 text-lg\"><span>Net Total</span><span>{netTotal.toLocaleString()}</span></div>\n                </div>\n              </div>\n            </div>\n          )}\n\n          {/* PREVIEW */}\n          {preview && (\n            <div className=\"invoice-print bg-white p-10 border shadow-lg mx-auto print:border-0 print:p-0 print:shadow-none min-h-[297mm]\">\n              <div className=\"flex justify-between items-start border-b-2 border-black pb-4 mb-6\">\n                <div>\n                  <h1 className=\"text-4xl font-black\">{previewMode === \"DELIVERY\" ? \"DELIVERY NOTE\" : \"SALES INVOICE\"}</h1>\n                  <p className=\"text-gray-600\">US Traders</p>\n                </div>\n                <div className=\"text-right\">\n                  <p><b>Invoice #:</b> {savedInvoice?.invoiceNo || invoiceNo}</p>\n                  <p><b>Date:</b> {savedInvoice?.date ? new Date(savedInvoice.date).toISOString().slice(0, 10) : date}</p>\n                  <p><b>Location:</b> {location}</p>\n                  {(savedInvoice?.invoiceNo || invoiceNo) && (\n                    <div className=\"flex flex-col items-end gap-2 mt-2\">\n                      <div className=\"text-center\">\n                        <Barcode value={savedInvoice?.invoiceNo || invoiceNo} width={1.5} height={40} fontSize={14} displayValue={false} />\n                        <span className=\"text-[10px] font-bold\">INV ID: {savedInvoice?.invoiceNo || invoiceNo}</span>\n                      </div>\n\n                      {origin && (\n                        <div className=\"flex flex-col items-center mt-2 border-t pt-2\">\n                          <QRCodeSVG value={`${origin}/view/sales-invoice?id=${savedInvoice?.id || queryId}`} size={80} />\n                          <span className=\"text-[10px] font-bold mt-1 bg-black text-white px-1\">SCAN FOR ONLINE BILL</span>\n                        </div>\n                      )}\n                    </div>\n                  )}\n                </div>\n              </div>\n\n              <div className=\"mb-8 grid grid-cols-2\">\n                <div>\n                  <h3 className=\"text-gray-500 uppercase text-xs font-bold mb-1\">Bill To:</h3>\n                  <p className=\"text-xl font-bold\">{savedInvoice?.customer?.name || customerName || \"Not Selected\"}</p>\n                </div>\n                <div className=\"text-right\">\n                  {(savedInvoice?.driverName || driverName) && (\n                    <p><b>Driver:</b> {savedInvoice?.driverName || driverName}</p>\n                  )}\n                  {(savedInvoice?.vehicleNo || vehicleNo) && (\n                    <p><b>Vehicle:</b> {savedInvoice?.vehicleNo || vehicleNo}</p>\n                  )}\n                </div>\n              </div>\n\n              <table className=\"w-full border-collapse mb-8\">\n                <thead>\n                  <tr className=\"border-y-2 border-black\">\n                    <th className=\"py-2 text-left\">Description</th>\n                    <th className=\"py-2 text-center w-24\">Qty</th>\n                    {previewMode === \"INVOICE\" && <th className=\"py-2 text-right w-32\">Rate</th>}\n                    {previewMode === \"INVOICE\" && <th className=\"py-2 text-right w-32\">Amount</th>}\n                  </tr>\n                </thead>\n                <tbody>\n                  {(savedInvoice?.items || rows.filter(r => r.itemId)).map((r: Any, i: number) => {\n                    const itemName = r.item?.name || r.name || \"Unknown\";\n                    const itemDesc = r.item?.description || r.description || \"\";\n                    const qty = r.qty || 0;\n                    const rate = r.rate || 0;\n                    const amount = qty * rate;\n\n                    return (\n                      <tr key={i} className=\"border-b border-gray-200\">\n                        <td className=\"py-3\">\n                          <p className=\"font-bold\">{itemName}</p>\n                          {itemDesc && <p className=\"text-sm text-gray-600\">{itemDesc}</p>}\n                        </td>\n                        <td className=\"py-3 text-center\">{qty}</td>\n                        {previewMode === \"INVOICE\" && <td className=\"py-3 text-right\">{Number(rate).toLocaleString()}</td>}\n                        {previewMode === \"INVOICE\" && <td className=\"py-3 text-right font-semibold\">{amount.toLocaleString()}</td>}\n                      </tr>\n                    );\n                  })}\n                </tbody>\n              </table>\n\n              {previewMode === \"INVOICE\" && (\n                <div className=\"flex justify-end\">\n                  <div className=\"w-72 space-y-2\">\n                    <div className=\"flex justify-between\">\n                      <span>Subtotal:</span>\n                      <span>{total.toLocaleString()}</span>\n                    </div>\n                    <div className=\"flex justify-between\">\n                      <span>Freight:</span>\n                      <span>{Number(freight || 0).toLocaleString()}</span>\n                    </div>\n                    {selectedTax && (\n                      <div className=\"flex justify-between\">\n                        <span>{selectedTax.taxType.toUpperCase()} ({selectedTax.taxRate}%):</span>\n                        <span>{taxAmount.toLocaleString()}</span>\n                      </div>\n                    )}\n                    <div className=\"flex justify-between border-t-2 border-black pt-2 text-xl font-bold\">\n                      <span>Net Total:</span>\n                      <span>{netTotal.toLocaleString()}</span>\n                    </div>\n                  </div>\n                </div>\n              )}\n\n              <div>\n                <span className=\"font-bold\">Prepared by</span>\n                <span className=\"w-72\">_____________________</span>\n              </div>\n              <div>\n                <span className=\"font-bold\">Recieved by</span>\n                <span className=\"w-72\">_____________________</span>\n              </div>\n\n              <div className=\"mt-20 border-t pt-4 text-center text-gray-400 text-sm\">\n                Thank you for your business!\n              </div>\n            </div>\n          )}\n        </>\n      )}\n    </div>\n  );\n}\n\nexport default function SalesInvoicePage() {\n  return (\n    <Suspense fallback={<div className=\"p-4 text-center\">Loading Invoice...</div>}>\n      <SalesInvoiceContent />\n    </Suspense>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\dashboard\\stock-rate\\page.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'headers' and 'loadRates'. Either include them or remove the dependency array.","line":48,"column":6,"nodeType":"ArrayExpression","endLine":48,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [headers, loadRates]","fix":{"range":[1089,1091],"text":"[headers, loadRates]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { useEffect, useState } from \"react\";\nimport toast from \"react-hot-toast\";\n\ntype Item = {\n  id: string;\n  name: string;\n  description?: string;\n};\n\ntype Rate = {\n  id: string;\n  rate: number;\n  date: string;\n  item: Item;\n  itemId: string;\n};\n\nexport default function StockRatePage() {\n  const today = new Date().toISOString().slice(0, 10);\n\n  const [items, setItems] = useState<Item[]>([]);\n  const [rates, setRates] = useState<Rate[]>([]);\n  const [editingId, setEditingId] = useState<string | null>(null);\n\n  const [itemId, setItemId] = useState(\"\");\n  const [rate, setRate] = useState(\"\");\n  const [date, setDate] = useState(today);\n\n  const headers = {\n    \"Content-Type\": \"application/json\",\n    \"x-user-role\": \"ADMIN\", // 🔴 REQUIRED\n  };\n\n  function loadRates() {\n    fetch(\"/api/stock-rate\", { headers })\n      .then(r => r.json())\n      .then(d => setRates(Array.isArray(d) ? d : []));\n  }\n\n  useEffect(() => {\n    fetch(\"/api/items-new\", { headers })\n      .then(r => r.json())\n      .then(d => setItems(Array.isArray(d) ? d : []));\n\n    loadRates();\n  }, []);\n\n  async function saveRate() {\n    if (!itemId || !rate) {\n      toast.error(\"Item aur rate zaroori hai\");\n      return;\n    }\n\n    const method = editingId ? \"PUT\" : \"POST\";\n    const body = editingId \n      ? { id: editingId, itemId, rate, date }\n      : { itemId, rate, date };\n\n    const res = await fetch(\"/api/stock-rate\", {\n      method,\n      headers,\n      body: JSON.stringify(body),\n    });\n\n    if (!res.ok) {\n      const err = await res.json();\n      toast.error(err.error || \"Save failed\");\n      return;\n    }\n\n    toast.success(editingId ? \"Rate updated\" : \"Rate saved\");\n    resetForm();\n    loadRates();\n  }\n\n  function handleEdit(r: Rate) {\n    setEditingId(r.id);\n    setItemId(r.itemId);\n    setRate(r.rate.toString());\n    setDate(new Date(r.date).toISOString().slice(0, 10));\n    window.scrollTo({ top: 0, behavior: 'smooth' });\n  }\n\n  function resetForm() {\n    setEditingId(null);\n    setItemId(\"\");\n    setRate(\"\");\n    setDate(today);\n  }\n\n  async function handleDelete(id: string) {\n    if (!confirm(\"Are you sure you want to delete this rate?\")) {\n      return;\n    }\n\n    try {\n      const res = await fetch(`/api/stock-rate?id=${id}`, {\n        method: \"DELETE\",\n        headers: { \"x-user-role\": \"ADMIN\" },\n      });\n\n      if (res.ok) {\n        toast.success(\"Rate deleted successfully\");\n        loadRates();\n      } else {\n        const err = await res.json();\n        toast.error(err.error || \"Delete failed\");\n      }\n    } catch (_err) {\n      toast.error(\"Delete failed\");\n    }\n  }\n\n  return (\n    <div className=\"p-4 md:p-6 max-w-3xl space-y-6\">\n\n      <h1 className=\"text-xl md:text-2xl font-semibold\">Stock Rate</h1>\n\n      {/* FORM */}\n      <div className=\"border p-4 bg-white space-y-3 rounded-lg shadow-sm\">\n        <div className=\"grid grid-cols-1 md:grid-cols-3 gap-3\">\n          <select\n            className=\"border p-2 w-full\"\n            value={itemId}\n            onChange={e => setItemId(e.target.value)}\n          >\n            <option value=\"\">Select Item</option>\n            {items.map(i => (\n              <option key={i.id} value={i.id}>\n                {i.name} ({i.description})\n              </option>\n            ))}\n          </select>\n\n          <input\n            className=\"border p-2 w-full\"\n            placeholder=\"Rate\"\n            value={rate}\n            onChange={e => setRate(e.target.value)}\n          />\n\n          <input\n            type=\"date\"\n            className=\"border p-2 w-full\"\n            value={date}\n            onChange={e => setDate(e.target.value)}\n          />\n        </div>\n\n        <div className=\"flex gap-2\">\n          <button\n            onClick={saveRate}\n            className=\"bg-blue-600 text-white px-4 py-2 flex-1\"\n          >\n            {editingId ? \"Update Rate\" : \"Save Rate\"}\n          </button>\n          {editingId && (\n            <button\n              onClick={resetForm}\n              className=\"bg-gray-600 text-white px-4 py-2\"\n            >\n              Cancel\n            </button>\n          )}\n        </div>\n      </div>\n\n      {/* LIST */}\n      <div className=\"bg-white border rounded overflow-x-auto\">\n        <table className=\"w-full text-sm min-w-[600px]\">\n          <thead className=\"bg-gray-100\">\n            <tr>\n              <th className=\"border p-2 text-left\">Date</th>\n              <th className=\"border p-2 text-left\">Item</th>\n              <th className=\"border p-2 text-right\">Rate</th>\n              <th className=\"border p-2 text-center\">Actions</th>\n            </tr>\n          </thead>\n          <tbody>\n            {rates.length === 0 ? (\n              <tr>\n                <td colSpan={4} className=\"p-4 text-center text-gray-400\">\n                  No rates found\n                </td>\n              </tr>\n            ) : (\n              rates.map(r => (\n                <tr key={r.id} className=\"border-t hover:bg-gray-50\">\n                  <td className=\"border p-2\">\n                    {new Date(r.date).toLocaleDateString()}\n                  </td>\n                  <td className=\"border p-2\">\n                    {r.item.name} {r.item.description ? `(${r.item.description})` : \"\"}\n                  </td>\n                  <td className=\"border p-2 text-right font-bold\">{r.rate.toLocaleString()}</td>\n                  <td className=\"border p-2 text-center space-x-2\">\n                    <button\n                      onClick={() => handleEdit(r)}\n                      className=\"text-blue-600 hover:text-blue-800 font-medium text-sm\"\n                    >\n                      Edit\n                    </button>\n                    <button\n                      onClick={() => handleDelete(r.id)}\n                      className=\"text-red-600 hover:text-red-800 font-medium text-sm\"\n                    >\n                      Delete\n                    </button>\n                  </td>\n                </tr>\n              ))\n            )}\n          </tbody>\n        </table>\n      </div>\n\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\dashboard\\stock-report\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\dashboard\\tax-configuration\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\dashboard\\test-enter\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\dashboard\\trial-balance\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\dashboard\\users\\UsersPageContent.tsx","messages":[],"suppressedMessages":[{"ruleId":"react-hooks/set-state-in-effect","severity":1,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nD:\\projects\\smart-business-accounts\\app\\dashboard\\users\\UsersPageContent.tsx:57:7\n  55 |   useEffect(() => {\n  56 |     if (currentUser?.role === \"ADMIN\") {\n> 57 |       reload();\n     |       ^^^^^^ Avoid calling setState() directly within an effect\n  58 |     } else {\n  59 |       setLoading(false);\n  60 |     }","line":57,"column":7,"nodeType":null,"endLine":57,"endColumn":13,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\dashboard\\users\\addusers\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\dashboard\\users\\logs\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\dashboard\\users\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\dashboard\\users\\roles\\page.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'me'. Either include it or remove the dependency array.","line":35,"column":6,"nodeType":"ArrayExpression","endLine":35,"endColumn":33,"suggestions":[{"desc":"Update the dependencies array to be: [isAdmin, me, me.id, me.role]","fix":{"range":[884,911],"text":"[isAdmin, me, me.id, me.role]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useEffect, useState } from \"react\";\r\nimport { PERMISSIONS } from \"@/lib/permissions\";\r\nimport { getCurrentUser } from \"@/lib/auth\";\r\n\r\ntype User = {\r\n  id: string;\r\n  name: string;\r\n  permissions: { permission: string }[];\r\n};\r\n\r\nexport default function AdminPermissionsPage() {\n  const me = getCurrentUser();\n  const isAdmin = me?.role === \"ADMIN\";\n\r\n  const [users, setUsers] = useState<User[]>([]);\r\n  const [selected, setSelected] = useState<User | null>(null);\r\n  const [checked, setChecked] = useState<string[]>([]);\r\n\r\n  // 🔐 load session ONCE\r\n  // 🔐 fetch users AFTER auth\r\n  useEffect(() => {\n    if (!me || !isAdmin) return;\n\n    fetch(\"/api/admin/user-permissions\", {\n      headers: {\n        \"x-user-role\": me.role,\n        \"x-user-id\": me.id,\n      },\n    })\n      .then(r => r.json())\n      .then(setUsers)\n      .catch(console.error);\n  }, [isAdmin, me?.id, me?.role]);\n\r\n  // ⛔ nothing renders until ready\r\n  if (!me || !isAdmin) {\r\n    return <div className=\"p-6 text-red-600\">Access denied</div>;\r\n  }\r\n\r\n  // ================= actions =================\r\n\r\n  const selectUser = (u: User) => {\r\n    setSelected(u);\r\n    setChecked(u.permissions.map(p => p.permission));\r\n  };\r\n\r\n  const toggle = (p: string) => {\r\n    setChecked(prev =>\r\n      prev.includes(p) ? prev.filter(x => x !== p) : [...prev, p]\r\n    );\r\n  };\r\n\r\n  const save = async () => {\r\n    if (!selected) return alert(\"Select a user\");\r\n\r\n    await fetch(\"/api/admin/user-permissions\", {\r\n      method: \"POST\",\r\n      headers: {\r\n        \"Content-Type\": \"application/json\",\r\n        \"x-user-role\": me.role,\r\n        \"x-user-id\": me.id,\r\n      },\r\n      body: JSON.stringify({\r\n        userId: selected.id,\r\n        permissions: checked,\r\n      }),\r\n    });\r\n\r\n    alert(\"Permissions saved\");\r\n  };\r\n\r\n  // ================= UI =================\r\n\r\n  return (\r\n    <div className=\"grid grid-cols-3 gap-6 p-6\">\r\n\r\n      {/* USERS */}\r\n      <div className=\"border rounded p-4\">\r\n        <h2 className=\"font-bold mb-3\">Users</h2>\r\n\r\n        {users.map(u => (\r\n          <div\r\n            key={u.id}\r\n            onClick={() => selectUser(u)}\r\n            className={`p-2 mb-1 cursor-pointer rounded\r\n              ${selected?.id === u.id ? \"bg-gray-200\" : \"hover:bg-gray-100\"}`}\r\n          >\r\n            {u.name}\r\n          </div>\r\n        ))}\r\n      </div>\r\n\r\n      {/* PERMISSIONS */}\r\n      <div className=\"col-span-2 border rounded p-4\">\r\n        {!selected ? (\r\n          <div className=\"text-gray-500\">Select a user</div>\r\n        ) : (\r\n          <>\r\n            <h2 className=\"font-bold mb-3\">\r\n              Permissions: {selected.name}\r\n            </h2>\r\n\r\n            {Object.values(PERMISSIONS).map(p => (\r\n              <label key={p} className=\"block\">\r\n                <input\r\n                  type=\"checkbox\"\r\n                  checked={checked.includes(p)}\r\n                  onChange={() => toggle(p)}\r\n                />\r\n                <span className=\"ml-2\">{p}</span>\r\n              </label>\r\n            ))}\r\n\r\n            <button\r\n              onClick={save}\r\n              className=\"mt-4 px-4 py-2 bg-black text-white\"\r\n            >\r\n              Save\r\n            </button>\r\n          </>\r\n        )}\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\layout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\view\\purchase-invoice\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\app\\view\\sales-invoice\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\components\\AdminGuard.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\components\\BarcodeWrapper.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\components\\GlobalSearch.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'query'. Either include it or remove the dependency array.","line":25,"column":6,"nodeType":"ArrayExpression","endLine":25,"endColumn":20,"suggestions":[{"desc":"Update the dependencies array to be: [query, searchParams]","fix":{"range":[805,819],"text":"[query, searchParams]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'pathname', 'performSearch', 'router', and 'searchParams'. Either include them or remove the dependency array.","line":62,"column":6,"nodeType":"ArrayExpression","endLine":62,"endColumn":13,"suggestions":[{"desc":"Update the dependencies array to be: [pathname, performSearch, query, router, searchParams]","fix":{"range":[1868,1875],"text":"[pathname, performSearch, query, router, searchParams]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState, useEffect, useRef } from \"react\";\r\nimport { useRouter, useSearchParams, usePathname } from \"next/navigation\";\r\nimport { getCurrentUser } from \"@/lib/auth\";\r\n\r\nexport default function GlobalSearch() {\r\n  const [query, setQuery] = useState(\"\");\r\n  const [results, setResults] = useState<Any>(null);\r\n  const [loading, setLoading] = useState(false);\r\n  const [showResults, setShowResults] = useState(false);\r\n  const searchRef = useRef<HTMLDivElement>(null);\r\n  const router = useRouter();\r\n  const searchParams = useSearchParams();\r\n  const pathname = usePathname();\r\n\r\n  // Sync from URL to input\r\n  useEffect(() => {\r\n    const q = searchParams.get(\"q\");\r\n    if (q && q !== query) {\r\n      setQuery(q);\r\n    } else if (!q && query) {\r\n      setQuery(\"\");\r\n    }\r\n  }, [searchParams]);\r\n\r\n  useEffect(() => {\r\n    function handleClickOutside(event: MouseEvent) {\r\n      if (searchRef.current && !searchRef.current.contains(event.target as Node)) {\r\n        setShowResults(false);\r\n      }\r\n    }\r\n\r\n    document.addEventListener(\"mousedown\", handleClickOutside);\r\n    return () => document.removeEventListener(\"mousedown\", handleClickOutside);\r\n  }, []);\r\n\r\n  useEffect(() => {\r\n    // Debounce search and URL update\r\n    const timeoutId = setTimeout(() => {\r\n      // Update URL\r\n      if (query !== (searchParams.get(\"q\") || \"\")) {\r\n        const params = new URLSearchParams(searchParams.toString());\r\n        if (query) {\r\n          params.set(\"q\", query);\r\n        } else {\r\n          params.delete(\"q\");\r\n        }\r\n        router.replace(`${pathname}?${params.toString()}`);\r\n      }\r\n\r\n      // Perform global search\r\n      if (query.length >= 2) {\r\n        performSearch();\r\n      } else {\r\n        setResults(null);\r\n        setShowResults(false);\r\n      }\r\n    }, 300);\r\n\r\n    return () => clearTimeout(timeoutId);\r\n  }, [query]);\r\n\r\n  async function performSearch() {\r\n    setLoading(true);\r\n    try {\r\n      const user = getCurrentUser();\r\n      const res = await fetch(`/api/search?q=${encodeURIComponent(query)}`, {\r\n        headers: { \"x-user-role\": user?.role || \"ADMIN\" },\r\n      });\r\n      const data = await res.json();\r\n      setResults(data);\r\n      setShowResults(true);\r\n    } catch (e) {\r\n      console.error(\"Search error:\", e);\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  }\r\n\r\n  function handleResultClick(url: string) {\r\n    setShowResults(false);\r\n    setQuery(\"\");\r\n    router.push(url);\r\n  }\r\n\r\n  const allResults = results\r\n    ? [\r\n        ...(results.accounts || []),\r\n        ...(results.items || []),\r\n        ...(results.salesInvoices || []),\r\n        ...(results.purchaseInvoices || []),\r\n        ...(results.vouchers || []),\r\n      ]\r\n    : [];\r\n\r\n  return (\r\n    <div ref={searchRef} className=\"relative w-full max-w-md\">\r\n      <div className=\"relative\">\r\n        <input\r\n          type=\"text\"\r\n          value={query}\r\n          onChange={(e) => setQuery(e.target.value)}\r\n          onFocus={() => query.length >= 2 && setShowResults(true)}\r\n          onKeyDown={(e) => {\r\n            if (e.key === 'Enter') {\r\n              e.preventDefault();\r\n              const invoicePattern = /^(SI|PI)-\\d+$/i;\r\n              if (invoicePattern.test(query)) {\r\n                // Force search immediately and open first result when ready\r\n                (async () => {\r\n                  await performSearch();\r\n                  const data = results;\r\n                  const merged = data\r\n                    ? [\r\n                        ...(data.accounts || []),\r\n                        ...(data.items || []),\r\n                        ...(data.salesInvoices || []),\r\n                        ...(data.purchaseInvoices || []),\r\n                        ...(data.vouchers || []),\r\n                      ]\r\n                    : [];\r\n                  if (merged.length > 0) {\r\n                    handleResultClick(merged[0].url);\r\n                  }\r\n                })();\r\n              } else if (allResults.length > 0) {\r\n                handleResultClick(allResults[0].url);\r\n              }\r\n            }\r\n          }}\r\n          placeholder=\"Search accounts, items, invoices...\"\r\n          className=\"w-full px-4 py-2 pl-10 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500\"\r\n        />\r\n        <div className=\"absolute left-3 top-2.5 text-gray-400\">🔍</div>\r\n        {loading && (\r\n          <div className=\"absolute right-3 top-2.5\">\r\n            <span className=\"animate-spin\">⏳</span>\r\n          </div>\r\n        )}\r\n      </div>\r\n\r\n      {showResults && allResults.length > 0 && (\r\n        <div className=\"absolute z-50 w-full mt-1 bg-white border rounded-lg shadow-lg max-h-96 overflow-y-auto\">\r\n          {results.accounts && results.accounts.length > 0 && (\r\n            <div className=\"p-2\">\r\n              <div className=\"text-xs font-bold text-gray-500 uppercase px-2 py-1\">\r\n                Accounts\r\n              </div>\r\n              {results.accounts.map((item: Any) => (\r\n                <div\r\n                  key={item.id}\r\n                  onClick={() => handleResultClick(item.url)}\r\n                  className=\"px-3 py-2 hover:bg-gray-100 cursor-pointer rounded\"\r\n                >\r\n                  <div className=\"font-medium\">{item.title}</div>\r\n                  <div className=\"text-xs text-gray-500\">{item.subtitle}</div>\r\n                </div>\r\n              ))}\r\n            </div>\r\n          )}\r\n\r\n          {results.items && results.items.length > 0 && (\r\n            <div className=\"p-2 border-t\">\r\n              <div className=\"text-xs font-bold text-gray-500 uppercase px-2 py-1\">\r\n                Items\r\n              </div>\r\n              {results.items.map((item: Any) => (\r\n                <div\r\n                  key={item.id}\r\n                  onClick={() => handleResultClick(item.url)}\r\n                  className=\"px-3 py-2 hover:bg-gray-100 cursor-pointer rounded\"\r\n                >\r\n                  <div className=\"font-medium\">{item.title}</div>\r\n                  <div className=\"text-xs text-gray-500\">{item.subtitle}</div>\r\n                </div>\r\n              ))}\r\n            </div>\r\n          )}\r\n\r\n          {results.salesInvoices && results.salesInvoices.length > 0 && (\r\n            <div className=\"p-2 border-t\">\r\n              <div className=\"text-xs font-bold text-gray-500 uppercase px-2 py-1\">\r\n                Sales Invoices\r\n              </div>\r\n              {results.salesInvoices.map((item: Any) => (\r\n                <div\r\n                  key={item.id}\r\n                  onClick={() => handleResultClick(item.url)}\r\n                  className=\"px-3 py-2 hover:bg-gray-100 cursor-pointer rounded\"\r\n                >\r\n                  <div className=\"font-medium\">{item.title}</div>\r\n                  <div className=\"text-xs text-gray-500\">{item.subtitle}</div>\r\n                </div>\r\n              ))}\r\n            </div>\r\n          )}\r\n\r\n          {results.purchaseInvoices && results.purchaseInvoices.length > 0 && (\r\n            <div className=\"p-2 border-t\">\r\n              <div className=\"text-xs font-bold text-gray-500 uppercase px-2 py-1\">\r\n                Purchase Invoices\r\n              </div>\r\n              {results.purchaseInvoices.map((item: Any) => (\r\n                <div\r\n                  key={item.id}\r\n                  onClick={() => handleResultClick(item.url)}\r\n                  className=\"px-3 py-2 hover:bg-gray-100 cursor-pointer rounded\"\r\n                >\r\n                  <div className=\"font-medium\">{item.title}</div>\r\n                  <div className=\"text-xs text-gray-500\">{item.subtitle}</div>\r\n                </div>\r\n              ))}\r\n            </div>\r\n          )}\r\n\r\n          {results.vouchers && results.vouchers.length > 0 && (\r\n            <div className=\"p-2 border-t\">\r\n              <div className=\"text-xs font-bold text-gray-500 uppercase px-2 py-1\">\r\n                Vouchers\r\n              </div>\r\n              {results.vouchers.map((item: Any) => (\r\n                <div\r\n                  key={item.id}\r\n                  onClick={() => handleResultClick(item.url)}\r\n                  className=\"px-3 py-2 hover:bg-gray-100 cursor-pointer rounded\"\r\n                >\r\n                  <div className=\"font-medium\">{item.title}</div>\r\n                  <div className=\"text-xs text-gray-500\">{item.subtitle}</div>\r\n                </div>\r\n              ))}\r\n            </div>\r\n          )}\r\n        </div>\r\n      )}\r\n\r\n      {showResults && query.length >= 2 && !loading && allResults.length === 0 && (\r\n        <div className=\"absolute z-50 w-full mt-1 bg-white border rounded-lg shadow-lg p-4 text-center text-gray-500\">\r\n          No results found\r\n        </div>\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\components\\QRCodeWrapper.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\components\\SimpleChart.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\components\\ui\\MobileTable.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\components\\ui\\ResponsiveContainer.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\components\\ui\\ResponsiveForm.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\eslint.config.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\global.d.ts","messages":[],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":6,"column":14,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":6,"endColumn":17,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[185,188],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[185,188],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\hooks\\useEnterKeySubmit.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\hooks\\useGlobalEnterNavigation.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\lib\\api.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\lib\\apiPermission.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\lib\\auth.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\lib\\email.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\lib\\export.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\lib\\hasPermission.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\lib\\log.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\lib\\logout.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\lib\\pdf-export.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\lib\\permissions-client.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\lib\\permissions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\lib\\prisma.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\lib\\requirePermission.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\lib\\requireRole.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\lib\\tenant.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\lib\\useRequirePermission.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\lib\\usepermissions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\next.config.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\postcss.config - Copy.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\postcss.config.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\projects\\smart-business-accounts\\prisma.config - Copy.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]}]
